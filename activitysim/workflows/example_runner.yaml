# activitysim workflow example_runner example_name=example_mtc

context_parser: pypyr.parser.keyvaluepairs

on_failure:
- name: activitysim.workflows.steps.py
  in:
    label: FAILURE
    py: |
      print("FAILURE")

steps:

- description: Setting default workflow parameters
  name: pypyr.steps.default
  in:
    defaults:
      example_name: example_mtc
      workspace: workspace
      create: True
      compile: True
      sharrow: True
      legacy: True
      tag:
      resume_after:
      fast: False
      compile_n_households: 1000
      main_n_households: 100000
      config_dirs: configs
      data_dir: data

- name: activitysim.workflows.steps.title
  in:
    label: "[bold blue]activitysim workflow example_runner {example_name}"

- name: activitysim.workflows.steps.py
  in:
    label: Make {workspace} directory if it does not exist
    py: |
      import os
      os.makedirs(f"{workspace}", exist_ok=True)

- activitysim.workflows.steps.make_tag

- name: activitysim.workflows.steps.cmd
  run: '{create}'
  in:
    cmd:
      label: "activitysim create {example_name}"
      run: python -m activitysim create -e {example_name} -d . --link
      cwd: "{workspace}"

- activitysim.workflows.steps.directory_prep

- description: write configs_sh_compile
  name: pypyr.steps.filewriteyaml
  run: '{compile}'
  in:
    fileWriteYaml:
      path: "{workspace}/{example_name}/configs_sh_compile/settings.yaml"
      payload:
        inherit_settings: True
        sharrow: test
        chunk_training_mode: disabled
        households_sample_size: '{compile_n_households}'
        cache_dir: cache

- description: Run activitysim to compile and test sharrow-enabled model
  name: activitysim.workflows.steps.run
  run: '{compile}'
  in:
    pre_config_dirs: configs_sh_compile
    output_dir: 'output-{tag}/output-compile'
    cwd: "{workspace}/{example_name}"
    label: "{example_name} -- sharrow compile"

- description: write configs_sh
  name: pypyr.steps.filewriteyaml
  run: '{sharrow}'
  in:
    fileWriteYaml:
      path: "{workspace}/{example_name}/configs_sh/settings.yaml"
      payload:
        inherit_settings: True
        sharrow: require
        cache_dir: cache
        households_sample_size: '{main_n_households}'

- description: Run activitysim to evaluate sharrow-enabled model
  name: activitysim.workflows.steps.run
  run: '{sharrow}'
  in:
    pre_config_dirs: configs_sh
    output_dir: 'output-{tag}/output-sharrow'
    cwd: "{workspace}/{example_name}"
    label: "{example_name} -- sharrow run"

- description: write.configs_sh
  name: pypyr.steps.filewriteyaml
  run: '{legacy}'
  in:
    fileWriteYaml:
      path: "{workspace}/{example_name}/configs_legacy/settings.yaml"
      payload:
        inherit_settings: True
        recode_pipeline_columns: False
        offset_preprocessing: False
        cache_dir: cache
        households_sample_size: '{main_n_households}'

- description: Run activitysim to evaluate legacy model
  name: activitysim.workflows.steps.run
  run: '{legacy}'
  in:
    pre_config_dirs: configs_legacy
    output_dir: 'output-{tag}/output-output-legacy'
    cwd: "{workspace}/{example_name}"
    label: "{example_name} -- legacy run"

- activitysim.workflows.steps.composite_log
#- activitysim.workflows.steps.contrast_report

- name: pypyr.steps.call
  in:
    call:
      groups: reporting
      success: report-save
      failure: report-save

################################################################################
reporting:

- name: activitysim.workflows.steps.contrast.load_tables
  in:
    common_output_directory: "{workspace}/{example_name}/output-{tag}"
    databases:
      sharrow: "output-sharrow"
      legacy: "output-legacy"
    tables:
      households:
        filename: final_households.csv
        index_col: household_id
      persons:
        filename: final_persons.csv
        index_col: person_id
      tours:
        filename: final_tours.csv
        index_col: tour_id
      trips:
        filename: final_trips.csv
        index_col: trip_id
      land_use:
        filename: final_land_use.csv
        index_col: zone_id

- name: activitysim.workflows.steps.contrast.load_skims
  in:
    common_directory: "{workspace}/{example_name}"

- name: activitysim.workflows.steps.contrast.init_report
  in:
    title: "{example_name} report"
    common_directory: "{workspace}/{example_name}"


#### Runtime and Data Inventory ####

- name: activitysim.workflows.steps.contrast.runtime
  in:
    common_output_directory: "{workspace}/{example_name}/output-{tag}"

- name: activitysim.workflows.steps.contrast.data_inventory


#### Tour Mode Choice ####

- name: activitysim.workflows.steps.contrast.section_title
  in:
    title: Tour Mode Choice

- name: activitysim.workflows.steps.contrast.nominal_choice_shares
  in:
    caption: Tour Mode Choice by Primary Purpose
    caption_level: 3
    tablename: tours
    nominal_col: tour_mode
    grouping: primary_purpose
    share_axis_label: Tour Mode Share

- name: activitysim.workflows.steps.contrast.nominal_choice_shares
  in:
    caption: Tour Mode Choice by Composition
    caption_level: 3
    tablename: tours
    nominal_col: tour_mode
    grouping: composition
    share_axis_label: Tour Mode Share


#### Trip Mode Choice ####

- name: activitysim.workflows.steps.contrast.section_title
  in:
    title: Trip Mode Choice

- name: activitysim.workflows.steps.contrast.nominal_choice_shares
  in:
    caption: Trip Mode Choice by Primary Purpose
    caption_level: 3
    tablename: trips
    nominal_col: trip_mode
    grouping: primary_purpose
    share_axis_label: Trip Mode Share

- name: activitysim.workflows.steps.contrast.nominal_choice_shares
  in:
    caption: Trip Mode Choice by Departure Time
    caption_level: 3
    tablename: trips
    nominal_col: trip_mode
    grouping: depart
    share_axis_label: Trip Mode Share


#### Trip Distance ####

- name: activitysim.workflows.steps.contrast.section_title
  in:
    title: Trip Distance

- name: activitysim.workflows.steps.contrast.attach_skim_data
  in:
    tablename: trips
    otaz_col: origin
    dtaz_col: destination
    time_col: depart
    skim_vars: DIST

- name: activitysim.workflows.steps.contrast.trip_distance
  in:
    caption: Trip Distance by Primary Purpose, <10 miles
    caption_level: 3
    grouping: primary_purpose
    dist_bins: 20
    dist_skim_name: DIST
    max_dist: 10

- name: activitysim.workflows.steps.contrast.trip_distance
  in:
    caption: Trip Distance by Primary Purpose
    caption_level: 3
    grouping: primary_purpose
    dist_bins: 20
    dist_skim_name: DIST


####  ####

- name: pypyr.steps.default
  in:
    defaults:
      workplace_zone_agg:

- name: activitysim.workflows.steps.contrast.section_title
  run: '{workplace_zone_agg}'
  in:
    title: Workplace Location

- name: activitysim.workflows.steps.contrast.district_to_district
  run: '{workplace_zone_agg}'
  in:
    progress_tag: Workplace Location
    tablename: persons
    caption: '{workplace_zone_agg[caption]}'
    caption_level: 3
    district_id: '{workplace_zone_agg[district_id]}'
    orig_label: home district
    dest_label: work district
    orig_col: home_zone_id
    dest_col: workplace_zone_id
    filter: workplace_zone_id >= 0
    data_dictionary:
    size_label: n_workers


################################################################################
report-save:
- name: activitysim.workflows.steps.contrast.save_report
  in:
    html_filename: "{workspace}/{example_name}/output-{tag}/report-{tag}.html"
