

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Core Components &#8212; ActivitySim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'core';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://activitysim.github.io/activitysim/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.5.1';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Benchmarking" href="benchmarking.html" />
    <link rel="prev" title="Write Trip Matrices" href="dev-guide/components/write_trip_matrices.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.5.1" />
    <meta name="docbuild:last-update" content="Nov 12, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">ActivitySim</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="users-guide/index.html">
    Users Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="users-guide/index.html">
    Users Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dev-guide/install.html">Developer Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="dev-guide/core-workflow.html">Workflow State</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="dev-guide/core-workflow-api.html">State API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.__init__.html">State.__init__</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.make_default.html">State.make_default</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.make_temp.html">State.make_temp</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.create_example.html">create_example</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.run.heading_level.html">State.run.heading_level</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.checkpoint.last_checkpoint.html">State.checkpoint.last_checkpoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.checkpoint.checkpoints.html">State.checkpoint.checkpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.checkpoint.store.html">State.checkpoint.store</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.initialize.html">State.tracing.initialize</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.register_traceable_table.html">State.tracing.register_traceable_table</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.deregister_traceable_table.html">State.tracing.deregister_traceable_table</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.write_csv.html">State.tracing.write_csv</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.trace_df.html">State.tracing.trace_df</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.trace_interaction_eval_results.html">State.tracing.trace_interaction_eval_results</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.get_trace_target.html">State.tracing.get_trace_target</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.trace_targets.html">State.tracing.trace_targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.has_trace_targets.html">State.tracing.has_trace_targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.dump_df.html">State.tracing.dump_df</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.delete_output_files.html">State.tracing.delete_output_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.tracing.delete_trace_files.html">State.tracing.delete_trace_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.extend.declare_table.html">State.extend.declare_table</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/core-workflow-steps.html">Workflow Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/core-workflow-table.html">Workflow Tables</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/using-sharrow.html">Using Sharrow</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/skim-dataset.html">Using Skim Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/checkpointing.html">Checkpointing</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Software Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/component-configs.html">Component Configuration</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="dev-guide/components/index.html">Components</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/input_checker.html">Input Checker</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/initialize.html">Initialize</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/initialize_los.html">Initialize LOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/initialize_tours.html">Initialize Tours</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/accessibility.html">Accessibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/auto_ownership.html">Auto Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/vehicle_type_choice.html">Vehicle Type Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/telecommute_frequency.html">Telecommute Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/cdap.html">Coordinated Daily Activity Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/mandatory_tour_frequency.html">Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/school_escorting.html">School Escorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/joint_tour_composition.html">Joint Tour Composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/joint_tour_participation.html">Joint Tour Participation</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/joint_tour_destination.html">Joint Tour Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/joint_tour_scheduling.html">Joint Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/non_mandatory_tour_frequency.html">Non-Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/non_mandatory_destination.html">Non-Mandatory Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/non_mandatory_scheduling.html">Non-Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/mandatory_scheduling.html">Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/disaggregate_accessibility.html">Disaggregate Accessibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/free_parking.html">Free Parking Eligibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/school_location_choice.html">School Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/transit_pass_ownership.html">Transit Pass Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/transit_pass_subsidy.html">Transit Pass Subsidy</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_destination.html">Trip Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/work_from_home.html">Work from Home</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/work_location_choice.html">Work Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/tour_mode_choice.html">Tour Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/atwork_subtour_frequency.html">At-work Subtours Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/atwork_subtour_destination.html">At-work Subtours Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/atwork_subtour_scheduling.html">At-work Subtour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/atwork_subtour_mode_choice.html">At-work Subtour Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/stop_frequency.html">Stop Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_purpose.html">Trip Purpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_destination.html">Trip Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_purpose_and_destination.html">Trip Purpose and Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_scheduling_choice.html">Trip Scheduling Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_departure_choice.html">Trip Departure Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/trip_mode_choice.html">Trip Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/parking_location_choice.html">Parking Location Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-guide/components/write_trip_matrices.html">Write Trip Matrices</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Core Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/build-docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide/changes.html">Change Log</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="dev-guide/index.html" class="nav-link">Developers</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Core Components</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="core-components">
<h1>Core Components<a class="headerlink" href="#core-components" title="Permalink to this heading">#</a></h1>
<p>ActivitySim’s core components include features for multiprocessing, data management,
utility expressions, choice models, person time window management, and helper
functions.  These core components include the multiprocessor, network LOS (skim) manager, the
data pipeline manager, the random number manager, the tracer, sampling
methods, simulation methods, model specification readers and expression
evaluators, choice models, timetable, transit virtual path builder, and helper functions.</p>
<section id="multiprocessing">
<span id="multiprocessing-in-detail"></span><h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this heading">#</a></h2>
<p>Parallelization using multiprocessing</p>
<section id="module-activitysim.core.mp_tasks">
<span id="api"></span><h3>API<a class="headerlink" href="#module-activitysim.core.mp_tasks" title="Permalink to this heading">#</a></h3>
<dl class="py data">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.MEM_TRACE_TICKS">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">MEM_TRACE_TICKS</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">5</span></em><a class="headerlink" href="#activitysim.core.mp_tasks.MEM_TRACE_TICKS" title="Permalink to this definition">#</a></dt>
<dd><p>mp_tasks - activitysim multiprocessing overview</p>
<p>Activitysim runs a list of models sequentially, performing various computational operations
on tables. Model steps can modify values in existing tables, add columns, or create additional
tables. Activitysim provides the facility, via expression files, to specify vectorized operations
on data tables. The ability to vectorize operations depends upon the independence of the
computations performed on the vectorized elements.</p>
<p>Python is agonizingly slow performing scalar operations sequentially on large datasets, so
vectorization (using pandas and/or numpy) is essential for good performance.</p>
<p>Fortunately most activity based model simulation steps are row independent at the household,
person, tour, or trip level. The decisions for one household are independent of the choices
made by other households. Thus it is (generally speaking) possible to run an entire simulation
on a household sample with only one household, and get the same result for that household as
you would running the simulation on a thousand households. (See the shared data section below
for an exception to this highly convenient situation.)</p>
<p>The random number generator supports this goal by providing streams of random numbers
for each households and person that are mutually independent and repeatable across model runs
and processes.</p>
<p>To the extent that simulation model steps are row independent, we can implement most simulations
as a series of vectorized operations on pandas DataFrames and numpy arrays. These vectorized
operations are much faster than sequential python because they are implemented by native code
(compiled C) and are to some extent multi-threaded. But the benefits of numpy multi-processing are
limited because they only apply to atomic numpy or pandas calls, and as soon as control returns
to python it is single-threaded and slow.</p>
<p>Multi-threading is not an attractive strategy to get around the python performance problem because
of the limitations imposed by python’s global interpreter lock (GIL). Rather than struggling with
python multi-threading, this module uses the python multiprocessing to parallelize certain models.</p>
<p>Because of activitysim’s modular and extensible architecture, we don’t hardwire the multiprocessing
architecture. The specification of which models should be run in parallel, how many processers
should be used, and the segmentation of the data between processes are all specified in the
settings config file. For conceptual simplicity, the single processing model as treated as
dominant (because even though in practice multiprocessing may be the norm for production runs,
the single-processing model will be used in development and debugging and keeping it dominant
will tend to concentrate the multiprocessing-specific code in one place and prevent multiprocessing
considerations from permeating the code base obscuring the model-specific logic.</p>
<p>The primary function of the multiprocessing settings are to identify distinct stages of
computation, and to specify how many simultaneous processes should be used to perform them,
and how the data to be treated should be apportioned between those processes. We assume that
the data can be apportioned between subprocesses according to the index of a single primary table
(e.g. households) or else are by derivative or dependent tables that reference that table’s index
(primary key) with a ref_col (foreign key) sharing the name of the primary table’s key.</p>
<p>Generally speaking, we assume that any new tables that are created are directly dependent on the
previously existing tables, and all rows in new tables are either attributable to previously
existing rows in the pipeline tables, or are global utility tables that are identical across
sub-processes.</p>
<p>Note: There are a few exceptions to ‘row independence’, such as school and location choice models,
where the model behavior is externally constrained or adjusted. For instance, we want school
location choice to match known aggregate school enrollments by zone. Similarly, a parking model
(not yet implemented) might be constrained by availability. These situations require special
handling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">models</span><span class="p">:</span>
  <span class="c1">### mp_initialize step</span>
  <span class="o">-</span> <span class="n">initialize_landuse</span>
  <span class="o">-</span> <span class="n">compute_accessibility</span>
  <span class="o">-</span> <span class="n">initialize_households</span>
  <span class="c1">### mp_households step</span>
  <span class="o">-</span> <span class="n">school_location</span>
  <span class="o">-</span> <span class="n">workplace_location</span>
  <span class="o">-</span> <span class="n">auto_ownership_simulate</span>
  <span class="o">-</span> <span class="n">free_parking</span>
  <span class="c1">### mp_summarize step</span>
  <span class="o">-</span> <span class="n">write_tables</span>

<span class="n">multiprocess_steps</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mp_initialize</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">initialize_landuse</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mp_households</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">school_location</span>
    <span class="n">num_processes</span><span class="p">:</span> <span class="mi">2</span>
    <span class="nb">slice</span><span class="p">:</span>
      <span class="n">tables</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">households</span>
        <span class="o">-</span> <span class="n">persons</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mp_summarize</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">write_tables</span>
</pre></div>
</div>
<p>The multiprocess_steps setting above annotates the models list to indicate that the simulation
should be broken into three steps.</p>
<p>The first multiprocess_step (mp_initialize) begins with the initialize_landuse step and is
implicity single-process because there is no ‘slice’ key indicating how to apportion the tables.
This first step includes all models listed in the ‘models’ setting up until the first step
in the next multiprocess_steps.</p>
<p>The second multiprocess_step (mp_households) starts with the school location model and continues
through auto_ownership_simulate. The ‘slice’ info indicates that the tables should be sliced by
households, and that persons is a dependent table and so and persons with a ref_col (foreign key
column with the same name as the Households table index) referencing a household record should be
taken to ‘belong’ to that household. Similarly, any other table that either share an index
(i.e. having the same name) with either the households or persons table, or have a ref_col to
either of their indexes, should also be considered a dependent table.</p>
<p>The num_processes setting of 2 indicates that the pipeline should be split in two, and half of the
households should be apportioned into each subprocess pipeline, and all dependent tables should
likewise be apportioned accordingly. All other tables (e.g. land_use) that do share an index (name)
or have a ref_col should be considered mirrored and be included in their entirety.</p>
<p>The primary table is sliced by num_processes-sized strides. (e.g. for num_processes == 2, the
sub-processes get every second record starting at offsets 0 and 1 respectively. All other dependent
tables slices are based (directly or indirectly) on this primary stride segmentation of the primary
table index.</p>
<p>Two separate sub-process are launched (num_processes == 2) and each passed the name of their
apportioned pipeline file. They execute independently and if they terminate successfully, their
contents are then coalesced into a single pipeline file whose tables should then be essentially
the same as it had been generated by a single process.</p>
<p>We assume that any new tables that are created by the sub-processes are directly dependent on the
previously primary tables or are mirrored. Thus we can coalesce the sub-process pipelines by
concatenating the primary and dependent tables and simply retaining any copy of the mirrored tables
(since they should all be identical.)</p>
<p>The third multiprocess_step (mp_summarize) then is handled in single-process mode and runs the
write_tables model, writing the results, but also leaving the tables in the pipeline, with
essentially the same tables and results as if the whole simulation had been run as a single process.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">allocate_shared_shadow_pricing_buffers</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers" title="Permalink to this definition">#</a></dt>
<dd><p>This is called by the main process to allocate memory buffer to share with subprocs</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>multiprocessing.RawArray</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">allocate_shared_shadow_pricing_buffers_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers_choice" title="Permalink to this definition">#</a></dt>
<dd><p>This is called by the main process to allocate memory buffer to share with subprocs</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>multiprocessing.RawArray</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.allocate_shared_skim_buffers">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">allocate_shared_skim_buffers</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.allocate_shared_skim_buffers" title="Permalink to this definition">#</a></dt>
<dd><p>This is called by the main process to allocate shared memory buffer to share with subprocs</p>
<p>Note: Buffers must be allocated BEFORE network_los.load_data</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_buffers</strong><span class="classifier">dict {&lt;skim_tag&gt;: &lt;multiprocessing.RawArray&gt;}</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.apportion_pipeline">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">apportion_pipeline</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">sub_proc_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.apportion_pipeline" title="Permalink to this definition">#</a></dt>
<dd><p>apportion pipeline for multiprocessing step</p>
<p>create pipeline files for sub_procs, apportioning data based on slice_rules</p>
<p>Called at the beginning of a multiprocess step prior to launching the sub-processes
Pipeline files have well known names (pipeline file name prefixed by subjob name)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>sub_proc_names</strong><span class="classifier">list[str]</span></dt><dd><p>names of the sub processes to apportion</p>
</dd>
<dt><strong>step_info</strong><span class="classifier">dict</span></dt><dd><p>step_info from multiprocess_steps for step we are apportioning pipeline tables for</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>creates apportioned pipeline files for each sub job</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.build_slice_rules">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">build_slice_rules</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">slice_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pipeline_tables</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.build_slice_rules" title="Permalink to this definition">#</a></dt>
<dd><p>based on slice_info for current step from run_list, generate a recipe for slicing
the tables in the pipeline (passed in tables parameter)</p>
<dl class="simple">
<dt>slice_info is a dict with two well-known keys:</dt><dd><p>‘tables’: required list of table names (order matters!)
‘except’: optional list of tables not to slice even if they have a sliceable index name</p>
</dd>
</dl>
<p>Note: tables listed in slice_info must appear in same order and before any others in tables dict</p>
<p>The index of the first table in the ‘tables’ list is the primary_slicer.</p>
<p>Any other tables listed are dependent tables with either ref_cols to the primary_slicer
or with the same index (i.e. having an index with the same name). This cascades, so any
tables dependent on the primary_table can in turn have dependent tables that will be sliced
by index or ref_col.</p>
<p>For instance, if the primary_slicer is households, then persons can be sliced because it
has a ref_col to (column with the same same name as) the household table index. And the
tours table can be sliced since it has a ref_col to persons. Tables can also be sliced
by index. For instance the person_windows table can be sliced because it has an index with
the same names as the persons table.</p>
<p>slice_info from multiprocess_steps</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">slice</span><span class="p">:</span>
  <span class="n">tables</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">households</span>
    <span class="o">-</span> <span class="n">persons</span>
</pre></div>
</div>
<p>tables from pipeline</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Table Name</p></th>
<th class="head"><p>Index</p></th>
<th class="head"><p>ref_col</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>households</p></td>
<td><p>household_id</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>persons</p></td>
<td><p>person_id</p></td>
<td><p>household_id</p></td>
</tr>
<tr class="row-even"><td><p>person_windows</p></td>
<td><p>person_id</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>accessibility</p></td>
<td><p>zone_id</p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>generated slice_rules dict</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">households</span><span class="p">:</span>
   <span class="n">slice_by</span><span class="p">:</span> <span class="n">primary</span>       <span class="o">&lt;-</span> <span class="n">primary</span> <span class="n">table</span> <span class="ow">is</span> <span class="n">sliced</span> <span class="ow">in</span> <span class="n">num_processors</span><span class="o">-</span><span class="n">sized</span> <span class="n">strides</span>
<span class="n">persons</span><span class="p">:</span>
   <span class="n">source</span><span class="p">:</span> <span class="n">households</span>
   <span class="n">slice_by</span><span class="p">:</span> <span class="n">column</span>
   <span class="n">column</span><span class="p">:</span>  <span class="n">household_id</span>   <span class="o">&lt;-</span> <span class="nb">slice</span> <span class="n">by</span> <span class="n">ref_col</span> <span class="p">(</span><span class="n">foreign</span> <span class="n">key</span><span class="p">)</span> <span class="n">to</span> <span class="n">households</span>
<span class="n">person_windows</span><span class="p">:</span>
   <span class="n">source</span><span class="p">:</span> <span class="n">persons</span>
   <span class="n">slice_by</span><span class="p">:</span> <span class="n">index</span>         <span class="o">&lt;-</span> <span class="nb">slice</span> <span class="n">by</span> <span class="n">index</span> <span class="n">of</span> <span class="n">persons</span> <span class="n">table</span>
<span class="n">accessibility</span><span class="p">:</span>
   <span class="n">slice_by</span><span class="p">:</span>               <span class="o">&lt;-</span> <span class="n">mirrored</span> <span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">dependent</span><span class="p">)</span> <span class="n">tables</span> <span class="n">don</span><span class="s1">&#39;t get sliced</span>
<span class="n">land_use</span><span class="p">:</span>
   <span class="n">slice_by</span><span class="p">:</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>slice_info</strong><span class="classifier">dict</span></dt><dd><p>‘slice’ info from run_list for this step</p>
</dd>
<dt><strong>pipeline_tables</strong><span class="classifier">dict {&lt;table_name&gt;, &lt;pandas.DataFrame&gt;}</span></dt><dd><p>dict of all tables from the pipeline keyed by table name</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>slice_rules</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.coalesce_pipelines">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">coalesce_pipelines</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">sub_proc_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">slice_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.coalesce_pipelines" title="Permalink to this definition">#</a></dt>
<dd><p>Coalesce the data in the sub_processes apportioned pipelines back into a single pipeline</p>
<p>We use slice_rules to distinguish sliced (apportioned) tables from mirrored tables.</p>
<p>Sliced tables are concatenated to create a single omnibus table with data from all sub_procs
but mirrored tables are the same across all sub_procs, so we can grab a copy from any pipeline.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>sub_proc_names</strong><span class="classifier">list[str]</span></dt><dd></dd>
<dt><strong>slice_info</strong><span class="classifier">dict</span></dt><dd><p>slice_info from multiprocess_steps</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>creates an omnibus pipeline with coalesced data from individual sub_proc pipelines</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.drop_breadcrumb">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">drop_breadcrumb</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">crumb</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.drop_breadcrumb" title="Permalink to this definition">#</a></dt>
<dd><p>Add (crumb: value) to specified step in breadcrumbs and flush breadcrumbs to file
run can be resumed with resume_after</p>
<p>Breadcrumbs provides a record of steps that have been run for use when resuming
Basically, we want to know which steps have been run, which phases completed
(i.e. apportion, simulate, coalesce). For multi-processed simulate steps, we also
want to know which sub-processes completed successfully, because if resume_after
is LAST_CHECKPOINT we don’t have to rerun the successful ones.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>step_name</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>crumb</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>value</strong><span class="classifier">yaml-writable value</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.get_breadcrumbs">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">get_breadcrumbs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">run_list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.get_breadcrumbs" title="Permalink to this definition">#</a></dt>
<dd><p>Read, validate, and annotate breadcrumb file from previous run</p>
<p>if resume_after specifies a model name, we need to determine which step it falls within,
drop any subsequent steps, and set the ‘simulate’ and ‘coalesce’ to None so</p>
<p>Extract from breadcrumbs file showing completed mp_households step with 2 processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">apportion</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">completed</span><span class="p">:</span> <span class="p">[</span><span class="n">mp_households_0</span><span class="p">,</span> <span class="n">mp_households_1</span><span class="p">]</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mp_households</span>
  <span class="n">simulate</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">coalesce</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>run_list</strong><span class="classifier">dict</span></dt><dd><p>validated and annotated run_list from settings</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>breadcrumbs</strong><span class="classifier">dict</span></dt><dd><p>validated and annotated breadcrumbs file from previous run</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.get_run_list">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">get_run_list</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.get_run_list" title="Permalink to this definition">#</a></dt>
<dd><p>validate and annotate run_list from settings</p>
<p>Assign defaults to missing settings (e.g. chunk_size)
Build individual step model lists based on step starts
If resuming, read breadcrumbs file for info on previous run execution status</p>
<p># annotated run_list with two steps, the second with 2 processors</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resume_after</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">multiprocess</span><span class="p">:</span> <span class="kc">True</span>
<span class="n">models</span><span class="p">:</span>
  <span class="o">-</span>  <span class="n">initialize_landuse</span>
  <span class="o">-</span>  <span class="n">compute_accessibility</span>
  <span class="o">-</span>  <span class="n">initialize_households</span>
  <span class="o">-</span>  <span class="n">school_location</span>
  <span class="o">-</span>  <span class="n">workplace_location</span>

<span class="n">multiprocess_steps</span><span class="p">:</span>
  <span class="n">step</span><span class="p">:</span> <span class="n">mp_initialize</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">initialize_landuse</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">mp_initialize</span>
    <span class="n">models</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">initialize_landuse</span>
       <span class="o">-</span> <span class="n">compute_accessibility</span>
       <span class="o">-</span> <span class="n">initialize_households</span>
    <span class="n">num_processes</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">step_num</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">step</span><span class="p">:</span> <span class="n">mp_households</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">school_location</span>
    <span class="nb">slice</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;households&#39;</span><span class="p">,</span> <span class="s1">&#39;persons&#39;</span><span class="p">]}</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">mp_households</span>
    <span class="n">models</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">school_location</span>
       <span class="o">-</span> <span class="n">workplace_location</span>
    <span class="n">num_processes</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="n">step_num</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>run_list</strong><span class="classifier">dict</span></dt><dd><p>validated and annotated run_list</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.mp_apportion_pipeline">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">mp_apportion_pipeline</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sub_proc_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.mp_apportion_pipeline" title="Permalink to this definition">#</a></dt>
<dd><p>mp entry point for apportion_pipeline</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>injectables</strong><span class="classifier">dict</span></dt><dd><p>injectables from parent</p>
</dd>
<dt><strong>sub_proc_names</strong><span class="classifier">list[str]</span></dt><dd><p>names of the sub processes to apportion</p>
</dd>
<dt><strong>step_info</strong><span class="classifier">dict</span></dt><dd><p>step_info for multiprocess_step we are apportioning</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.mp_coalesce_pipelines">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">mp_coalesce_pipelines</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sub_proc_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">slice_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.mp_coalesce_pipelines" title="Permalink to this definition">#</a></dt>
<dd><p>mp entry point for coalesce_pipeline</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>injectables</strong><span class="classifier">dict</span></dt><dd><p>injectables from parent</p>
</dd>
<dt><strong>sub_proc_names</strong><span class="classifier">list[str]</span></dt><dd><p>names of the sub processes to apportion</p>
</dd>
<dt><strong>slice_info</strong><span class="classifier">dict</span></dt><dd><p>slice_info from multiprocess_steps</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.mp_run_simulation">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">mp_run_simulation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">locutor</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">queue</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resume_after</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.mp_run_simulation" title="Permalink to this definition">#</a></dt>
<dd><p>mp entry point for run_simulation</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>locutor</strong></dt><dd></dd>
<dt><strong>queue</strong></dt><dd></dd>
<dt><strong>injectables</strong></dt><dd></dd>
<dt><strong>step_info</strong></dt><dd></dd>
<dt><strong>resume_after</strong><span class="classifier">bool</span></dt><dd></dd>
<dt><strong>kwargs</strong><span class="classifier">dict</span></dt><dd><p>shared_data_buffers passed as kwargs to avoid picking dict</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.mp_setup_skims">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">mp_setup_skims</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.mp_setup_skims" title="Permalink to this definition">#</a></dt>
<dd><p>Sub process to load skim data into shared_data</p>
<p>There is no particular necessity to perform this in a sub process instead of the parent
except to ensure that this heavyweight task has no side-effects (e.g. loading injectables)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>injectables</strong><span class="classifier">dict</span></dt><dd><p>injectables from parent</p>
</dd>
<dt><strong>kwargs</strong><span class="classifier">dict</span></dt><dd><p>shared_data_buffers passed as kwargs to avoid picking dict</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.parquet_pipeline_table_keys">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">parquet_pipeline_table_keys</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pipeline_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.parquet_pipeline_table_keys" title="Permalink to this definition">#</a></dt>
<dd><p>return dict of current (as of last checkpoint) pipeline tables
and their checkpoint-specific hdf5_keys</p>
<p>This facilitates reading pipeline tables directly from a ‘raw’ open pandas.HDFStore without
opening it as a pipeline (e.g. when apportioning and coalescing pipelines)</p>
<p>We currently only ever need to do this from the last checkpoint, so the ability to specify
checkpoint_name is not required, and thus omitted.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>checkpoint_name</strong><span class="classifier">name of the checkpoint</span></dt><dd></dd>
<dt><strong>checkpoint_tables</strong><span class="classifier">dict {&lt;table_name&gt;: &lt;table_path&gt;}</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.pipeline_table_keys">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">pipeline_table_keys</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pipeline_store</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.pipeline_table_keys" title="Permalink to this definition">#</a></dt>
<dd><p>return dict of current (as of last checkpoint) pipeline tables
and their checkpoint-specific hdf5_keys</p>
<p>This facilitates reading pipeline tables directly from a ‘raw’ open pandas.HDFStore without
opening it as a pipeline (e.g. when apportioning and coalescing pipelines)</p>
<p>We currently only ever need to do this from the last checkpoint, so the ability to specify
checkpoint_name is not required, and thus omitted.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>pipeline_store</strong><span class="classifier">open hdf5 pipeline_store</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>checkpoint_name</strong><span class="classifier">name of the checkpoint</span></dt><dd></dd>
<dt><strong>checkpoint_tables</strong><span class="classifier">dict {&lt;table_name&gt;: &lt;table_key&gt;}</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.print_run_list">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">print_run_list</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">run_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.print_run_list" title="Permalink to this definition">#</a></dt>
<dd><p>Print run_list to stdout or file (informational - not read back in)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>run_list</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>output_file</strong><span class="classifier">open file</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.read_breadcrumbs">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">read_breadcrumbs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.read_breadcrumbs" title="Permalink to this definition">#</a></dt>
<dd><p>Read breadcrumbs file from previous run</p>
<p>write_breadcrumbs wrote OrderedDict steps as list so ordered is preserved
(step names are duplicated in steps)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>breadcrumbs</strong><span class="classifier">OrderedDict</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.run_multiprocess">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">run_multiprocess</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.run_multiprocess" title="Permalink to this definition">#</a></dt>
<dd><p>run the steps in run_list, possibly resuming after checkpoint specified by resume_after</p>
<p>we never open the pipeline since that is all done within multi-processing steps -
mp_apportion_pipeline, run_sub_simulations, mp_coalesce_pipelines -
each of which opens the pipeline/s and closes it/them within the sub-process
This ‘feature’ makes the pipeline state a bit opaque to us, for better or worse…</p>
<p>Steps may be either single or multi process.
For multi-process steps, we need to apportion pipelines before running sub processes
and coalesce them afterwards</p>
<p>injectables arg allows propagation of setting values that were overridden on the command line
(parent process command line arguments are not available to sub-processes in Windows)</p>
<ul class="simple">
<li><p>allocate shared data buffers for skims and shadow_pricing</p></li>
<li><p>load shared skim data from OMX files</p></li>
<li><p>run each (single or multiprocess) step in turn</p></li>
</ul>
<p>Drop breadcrumbs along the way to facilitate resuming in a later run</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>run_list</strong><span class="classifier">dict</span></dt><dd><p>annotated run_list  (including prior run breadcrumbs if resuming)</p>
</dd>
<dt><strong>injectables</strong><span class="classifier">dict</span></dt><dd><p>dict of values to inject in sub-processes</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.run_simulation">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">run_simulation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">queue</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resume_after</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shared_data_buffer</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.run_simulation" title="Permalink to this definition">#</a></dt>
<dd><p>run step models as subtask</p>
<p>called once to run each individual sub process in multiprocess step</p>
<p>Unless actually resuming resuming, resume_after will be None for first step,
and then FINAL for subsequent steps so pipelines opened to resume where previous step left off</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>queue</strong><span class="classifier">multiprocessing.Queue</span></dt><dd></dd>
<dt><strong>step_info</strong><span class="classifier">dict</span></dt><dd><p>step_info for current step from multiprocess_steps</p>
</dd>
<dt><strong>resume_after</strong><span class="classifier">str or None</span></dt><dd></dd>
<dt><strong>shared_data_buffer</strong><span class="classifier">dict</span></dt><dd><p>dict of shared data (e.g. skims and shadow_pricing)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.run_sub_simulations">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">run_sub_simulations</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shared_data_buffers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">process_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resume_after</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">previously_completed</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fail_fast</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.run_sub_simulations" title="Permalink to this definition">#</a></dt>
<dd><p>Launch sub processes to run models in step according to specification in step_info.</p>
<p>If resume_after is LAST_CHECKPOINT, then pick up where previous run left off, using breadcrumbs
from previous run. If some sub-processes completed in the prior run, then skip rerunning them.</p>
<p>If resume_after specifies a checkpiont, skip checkpoints that precede the resume_after</p>
<p>Drop ‘completed’ breadcrumbs for this run as sub-processes terminate</p>
<p>Wait for all sub-processes to terminate and return list of those that completed successfully.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>injectables</strong><span class="classifier">dict</span></dt><dd><p>values to inject in subprocesses</p>
</dd>
<dt><strong>shared_data_buffers</strong><span class="classifier">dict</span></dt><dd><p>dict of shared_data for sub-processes (e.g. skim and shadow pricing data)</p>
</dd>
<dt><strong>step_info</strong><span class="classifier">dict</span></dt><dd><p>step_info from run_list</p>
</dd>
<dt><strong>process_names</strong><span class="classifier">list of str</span></dt><dd><p>list of sub process names to in parallel</p>
</dd>
<dt><strong>resume_after</strong><span class="classifier">str or None</span></dt><dd><p>name of simulation to resume after, or LAST_CHECKPOINT to resume where previous run left off</p>
</dd>
<dt><strong>previously_completed</strong><span class="classifier">list of str</span></dt><dd><p>names of processes that successfully completed in previous run</p>
</dd>
<dt><strong>fail_fast</strong><span class="classifier">bool</span></dt><dd><p>whether to raise error if a sub process terminates with nonzero exitcode</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>completed</strong><span class="classifier">list[str]</span></dt><dd><p>names of sub_processes that completed successfully</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.run_sub_task">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">run_sub_task</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">p</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.run_sub_task" title="Permalink to this definition">#</a></dt>
<dd><p>Run process p synchroneously,</p>
<p>Return when sub process terminates, or raise error if exitcode is nonzero</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>p</strong><span class="classifier">multiprocessing.Process</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.setup_injectables_and_logging">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">setup_injectables_and_logging</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">injectables</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></span><a class="headerlink" href="#activitysim.core.mp_tasks.setup_injectables_and_logging" title="Permalink to this definition">#</a></dt>
<dd><p>Setup injectables (passed by parent process) within sub process</p>
<p>we sometimes want only one of the sub-processes to perform an action (e.g. write shadow prices)
the locutor flag indicates that this sub process is the designated singleton spokesperson</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>injectables</strong><span class="classifier">dict {&lt;injectable_name&gt;: &lt;value&gt;}</span></dt><dd><p>dict of injectables passed by parent process</p>
</dd>
<dt><strong>locutor</strong><span class="classifier">bool</span></dt><dd><p>is this sub process the designated spokesperson</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>injects injectables</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mp_tasks.write_breadcrumbs">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mp_tasks.</span></span><span class="sig-name descname"><span class="pre">write_breadcrumbs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">breadcrumbs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mp_tasks.write_breadcrumbs" title="Permalink to this definition">#</a></dt>
<dd><p>Write breadcrumbs file with execution history of multiprocess run</p>
<p>Write steps as array so order is preserved (step names are duplicated in steps)</p>
<p>Extract from breadcrumbs file showing completed mp_households step with 2 processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">apportion</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">coalesce</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">completed</span><span class="p">:</span> <span class="p">[</span><span class="n">mp_households_0</span><span class="p">,</span> <span class="n">mp_households_1</span><span class="p">]</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mp_households</span>
  <span class="n">simulate</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>breadcrumbs</strong><span class="classifier">OrderedDict</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="data-management">
<h2>Data Management<a class="headerlink" href="#data-management" title="Permalink to this heading">#</a></h2>
<section id="input">
<h3>Input<a class="headerlink" href="#input" title="Permalink to this heading">#</a></h3>
<p>Input data table functions</p>
<section id="id1">
<h4>API<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.input"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.input.read_from_table_info">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.input.</span></span><span class="sig-name descname"><span class="pre">read_from_table_info</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">table_info</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="users-guide/_generated/activitysim.core.configuration.InputTable.html#activitysim.core.configuration.InputTable" title="activitysim.core.configuration.top.InputTable"><span class="pre">InputTable</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">state</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.input.read_from_table_info" title="Permalink to this definition">#</a></dt>
<dd><p>Read input text files and return cleaned up DataFrame.</p>
<p>table_info is a dictionary that specifies the following input params.</p>
<p>See input_table_list in settings.yaml in the example folder for a working example</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>key</p></th>
<th class="head" colspan="2"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>tablename</p></td>
<td colspan="2"><p>name of pipeline table in which to store dataframe</p></td>
</tr>
<tr class="row-odd"><td><p>filename</p></td>
<td colspan="2"><p>name of csv file to read (in data_dir)</p></td>
</tr>
<tr class="row-even"><td><p>index_col</p></td>
<td colspan="2"><p>name of column to set as dataframe index column</p></td>
</tr>
<tr class="row-odd"><td><p>h5_tablename</p></td>
<td colspan="2"><p>name of target table in HDF5 file</p></td>
</tr>
</tbody>
</table>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.input.read_input_file">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.input.</span></span><span class="sig-name descname"><span class="pre">read_input_file</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filepath</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">h5_tablename</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">csv_dtypes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.input.read_input_file" title="Permalink to this definition">#</a></dt>
<dd><p>Read data to a pandas DataFrame, inferring file type from filename extension.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.input.read_input_table">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.input.</span></span><span class="sig-name descname"><span class="pre">read_input_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">tablename</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">required</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.input.read_input_table" title="Permalink to this definition">#</a></dt>
<dd><p>Reads input table name and returns cleaned DataFrame.</p>
<p>Uses settings found in input_table_list in global settings file</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tablename</strong><span class="classifier">string</span></dt><dd></dd>
<dt><strong>settings</strong><span class="classifier">State</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas DataFrame</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="los">
<span id="los-in-detail"></span><h3>LOS<a class="headerlink" href="#los" title="Permalink to this heading">#</a></h3>
<p>Network Level of Service (LOS) data access</p>
<section id="id2">
<h4>API<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.los"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.los.</span></span><span class="sig-name descname"><span class="pre">Network_LOS</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">los_settings_file_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'network_los.yaml'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS" title="Permalink to this definition">#</a></dt>
<dd><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singleton</span> <span class="nb">object</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">skims</span> <span class="ow">and</span> <span class="n">skim</span><span class="o">-</span><span class="n">related</span> <span class="n">tables</span>

<span class="n">los_settings_file_name</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># e.g. &#39;network_los.yaml&#39;</span>
<span class="n">skim_dtype_name</span><span class="p">:</span><span class="nb">str</span>                 <span class="c1"># e.g. &#39;float32&#39;</span>

<span class="n">dict_factory_name</span><span class="p">:</span> <span class="nb">str</span>              <span class="c1"># e.g. &#39;NumpyArraySkimFactory&#39;</span>
<span class="n">zone_system</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># str (ONE_ZONE, TWO_ZONE, or THREE_ZONE)</span>
<span class="n">skim_time_periods</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># list of str e.g. [&#39;AM&#39;, &#39;MD&#39;, &#39;PM&#39;&#39;</span>

<span class="n">skims_info</span><span class="p">:</span> <span class="nb">dict</span>                    <span class="c1"># dict of SkimInfo keyed by skim_tag</span>
<span class="n">skim_buffers</span><span class="p">:</span> <span class="nb">dict</span>                  <span class="c1"># if multiprocessing, dict of multiprocessing.Array buffers keyed by skim_tag</span>
<span class="n">skim_dicts</span><span class="p">:</span> <span class="n">dice</span>                    <span class="c1"># dict of SkimDict keyed by skim_tag</span>

<span class="c1"># TWO_ZONE and THREE_ZONE</span>
<span class="n">maz_taz_df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>        <span class="c1"># DataFrame with two columns, MAZ and TAZ, mapping MAZ to containing TAZ</span>
<span class="n">maz_to_maz_df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>     <span class="c1"># maz_to_maz attributes for MazSkimDict sparse skims</span>
                                    <span class="c1"># indexed by synthetic omaz/dmaz index for faster get_mazpairs lookup)</span>
<span class="n">maz_ceiling</span><span class="p">:</span> <span class="nb">int</span>                    <span class="c1"># max maz_id + 1 (to compute synthetic omaz/dmaz index by get_mazpairs)</span>
<span class="n">max_blend_distance</span><span class="p">:</span> <span class="nb">dict</span>            <span class="c1"># dict of int maz_to_maz max_blend_distance values keyed by skim_tag</span>

<span class="c1"># THREE_ZONE only</span>
<span class="n">tap_df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="n">tap_lines_df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>      <span class="c1"># if specified in settings, list of transit lines served, indexed by TAP</span>
                                    <span class="c1"># use to prune maz_to_tap_dfs to drop more distant TAPS with redundant service</span>
                                    <span class="c1"># since a TAP can serve multiple lines, tap_lines_df TAP index is not unique</span>
<span class="n">maz_to_tap_dfs</span><span class="p">:</span> <span class="nb">dict</span>                <span class="c1"># dict of maz_to_tap DataFrames indexed by access mode (e.g. &#39;walk&#39;, &#39;drive&#39;)</span>
                                    <span class="c1"># maz_to_tap dfs have OMAZ and DMAZ columns plus additional attribute columns</span>
<span class="n">tap_tap_uid</span><span class="p">:</span> <span class="n">TapTapUidCalculator</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.allocate_shared_skim_buffers">
<span class="sig-name descname"><span class="pre">allocate_shared_skim_buffers</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.allocate_shared_skim_buffers" title="Permalink to this definition">#</a></dt>
<dd><p>Allocate multiprocessing.RawArray shared data buffers sized to hold data for the omx skims.
Only called when multiprocessing - BEFORE load_data()</p>
<p>Returns dict of allocated buffers so they can be added to mp_tasks can add them to dict of data
to be shared with subprocesses.</p>
<p>Note: we are only allocating storage, but not loading any skim data into it</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>dict of multiprocessing.RawArray keyed by skim_tag</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.create_skim_dict">
<span class="sig-name descname"><span class="pre">create_skim_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_override_offset_int</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.create_skim_dict" title="Permalink to this definition">#</a></dt>
<dd><p>Create a new SkimDict of type specified by skim_tag (e.g. ‘taz’, ‘maz’ or ‘tap’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>_override_offset_int</strong><span class="classifier">int, optional</span></dt><dd><p>Override the offset int for this dictionary.  Use this to set that
offset to zero when zone id’s have been pre-processed to be zero-based
contiguous integers.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>SkimDict or subclass (e.g. MazSkimDict)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.get_default_skim_dict">
<span class="sig-name descname"><span class="pre">get_default_skim_dict</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.get_default_skim_dict" title="Permalink to this definition">#</a></dt>
<dd><p>Get the default (non-transit) skim dict for the (1, 2, or 3) zone_system</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>TAZ SkimDict for ONE_ZONE, MazSkimDict for TWO_ZONE and THREE_ZONE</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.get_maz_to_taz_series">
<span class="sig-name descname"><span class="pre">get_maz_to_taz_series</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.get_maz_to_taz_series" title="Permalink to this definition">#</a></dt>
<dd><p>pd.Series: Index is the MAZ, value is the corresponding TAZ</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.get_mazpairs">
<span class="sig-name descname"><span class="pre">get_mazpairs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">omaz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dmaz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">attribute</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.get_mazpairs" title="Permalink to this definition">#</a></dt>
<dd><p>look up attribute values of maz od pairs in sparse maz_to_maz df</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>omaz: array-like list of omaz zone_ids</strong></dt><dd></dd>
<dt><strong>dmaz: array-like list of omaz zone_ids</strong></dt><dd></dd>
<dt><strong>attribute: str name of attribute column in maz_to_maz_df</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Numpy.ndarray: list of attribute values for od pairs</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.get_skim_dict">
<span class="sig-name descname"><span class="pre">get_skim_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.get_skim_dict" title="Permalink to this definition">#</a></dt>
<dd><p>Get SkimDict for the specified skim_tag (e.g. ‘taz’, ‘maz’, or ‘tap’)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>SkimDict or subclass (e.g. MazSkimDict) or SkimDataset</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.get_tappairs3d">
<span class="sig-name descname"><span class="pre">get_tappairs3d</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">otap</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtap</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dim3</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.get_tappairs3d" title="Permalink to this definition">#</a></dt>
<dd><p>TAP skim lookup</p>
<p>FIXME - why do we provide this for taps, but use skim wrappers for TAZ?</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>otap: pandas.Series</strong></dt><dd><p>origin (boarding tap) zone_ids</p>
</dd>
<dt><strong>dtap: pandas.Series</strong></dt><dd><p>dest (aligting tap) zone_ids</p>
</dd>
<dt><strong>dim3: pandas.Series or str</strong></dt><dd><p>dim3 (e.g. tod) str</p>
</dd>
<dt><strong>key</strong></dt><dd><p>skim key (e.g. ‘IWAIT_SET1’)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Numpy.ndarray: list of tap skim values for odt tuples</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.load_data">
<span class="sig-name descname"><span class="pre">load_data</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.load_data" title="Permalink to this definition">#</a></dt>
<dd><p>Load tables and skims from files specified in network_los settigns</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.load_settings">
<span class="sig-name descname"><span class="pre">load_settings</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.load_settings" title="Permalink to this definition">#</a></dt>
<dd><p>Read setting file and initialize object variables (see class docstring for list of object variables)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.load_shared_data">
<span class="sig-name descname"><span class="pre">load_shared_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shared_data_buffers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.load_shared_data" title="Permalink to this definition">#</a></dt>
<dd><p>Load omx skim data into shared_data buffers
Only called when multiprocessing - BEFORE any models are run or any call to load_data()</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>shared_data_buffers: dict of multiprocessing.RawArray keyed by skim_tag</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.load_skim_info">
<span class="sig-name descname"><span class="pre">load_skim_info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.load_skim_info" title="Permalink to this definition">#</a></dt>
<dd><p>read skim info from omx files into SkimInfo, and store in self.skims_info dict keyed by skim_tag</p>
<p>ONE_ZONE and TWO_ZONE systems have only TAZ skims
THREE_ZONE systems have both TAZ and TAP skims</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.map_maz_to_taz">
<span class="sig-name descname"><span class="pre">map_maz_to_taz</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">s</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.map_maz_to_taz" title="Permalink to this definition">#</a></dt>
<dd><p>Convert MAZ’s to TAZ’s</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>s</strong><span class="classifier">Array-like</span></dt><dd><p>Integer MAZ values</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pd.Series</dt><dd><p>Integer TAZ values</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.multiprocess">
<span class="sig-name descname"><span class="pre">multiprocess</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.multiprocess" title="Permalink to this definition">#</a></dt>
<dd><p>return True if this is a multiprocessing run (even if it is a main or single-process subprocess)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>bool</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.omx_file_names">
<span class="sig-name descname"><span class="pre">omx_file_names</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.omx_file_names" title="Permalink to this definition">#</a></dt>
<dd><p>Return list of omx file names from network_los settings file for the specified skim_tag (e.g. ‘taz’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag: str (e.g. ‘taz’)</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>list of str</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.skim_time_period_label">
<span class="sig-name descname"><span class="pre">skim_time_period_label</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">time_period</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fillna</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">as_cat</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">broadcast_to</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.skim_time_period_label" title="Permalink to this definition">#</a></dt>
<dd><p>convert time period times to skim time period labels (e.g. 9 -&gt; ‘AM’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>time_period</strong><span class="classifier">pandas Series</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series</dt><dd><p>string time period labels</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.zarr_file_name">
<span class="sig-name descname"><span class="pre">zarr_file_name</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.zarr_file_name" title="Permalink to this definition">#</a></dt>
<dd><p>Return zarr directory name from network_los settings file for the specified skim_tag (e.g. ‘taz’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag: str (e.g. ‘taz’)</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>str</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.los.Network_LOS.zarr_pre_encoding">
<span class="sig-name descname"><span class="pre">zarr_pre_encoding</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.los.Network_LOS.zarr_pre_encoding" title="Permalink to this definition">#</a></dt>
<dd><p>Return digital encoding pre-processing before writing to zarr for the specified skim_tag (e.g. ‘taz’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag: str (e.g. ‘taz’)</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>list or None</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="skims">
<h3>Skims<a class="headerlink" href="#skims" title="Permalink to this heading">#</a></h3>
<p>Skims data access</p>
<section id="id3">
<h4>API<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.skim_dict_factory"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.AbstractSkimFactory">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dict_factory.</span></span><span class="sig-name descname"><span class="pre">AbstractSkimFactory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory" title="Permalink to this definition">#</a></dt>
<dd><p>Provide access to skim data from store.</p>
<dl class="simple">
<dt>load_skim_info(skim_tag: str): dict</dt><dd><p>Read omx files for skim &lt;skim_tag&gt; (e.g. ‘TAZ’) and build skim_info dict</p>
</dd>
<dt>get_skim_data(skim_tag: str, skim_info: dict): SkimData</dt><dd><p>Read skim data from backing store and return it as a 3D ndarray quack-alike SkimData object</p>
</dd>
<dt>allocate_skim_buffer(skim_info, shared: bool): 1D array buffer sized for 3D SkimData</dt><dd><p>Allocate a ram skim buffer (ndarray or multiprocessing.Array) to use as frombuffer for SkimData</p>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.AbstractSkimFactory.allocate_skim_buffer">
<span class="sig-name descname"><span class="pre">allocate_skim_buffer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shared</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory.allocate_skim_buffer" title="Permalink to this definition">#</a></dt>
<dd><p>For multiprocessing</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.AbstractSkimFactory.supports_shared_data_for_multiprocessing">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">supports_shared_data_for_multiprocessing</span></span><a class="headerlink" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory.supports_shared_data_for_multiprocessing" title="Permalink to this definition">#</a></dt>
<dd><p>Does subclass support shareable data for multiprocessing</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>boolean</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.JitMemMapSkimData">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dict_factory.</span></span><span class="sig-name descname"><span class="pre">JitMemMapSkimData</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_cache_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.JitMemMapSkimData" title="Permalink to this definition">#</a></dt>
<dd><p>SkimData subclass for just-in-time memmap.</p>
<p>Since opening a memmap is fast, open the memmap read the data on demand and immediately close it.
This essentially eliminates RAM usage, but it means we are loading the data every time we access the skim,
which may be significantly slower, depending on patterns of usage.</p>
<dl class="py property">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.JitMemMapSkimData.shape">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">shape</span></span><a class="headerlink" href="#activitysim.core.skim_dict_factory.JitMemMapSkimData.shape" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>list-like shape tuple as returned by numpy.shape</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.MemMapSkimFactory">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dict_factory.</span></span><span class="sig-name descname"><span class="pre">MemMapSkimFactory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.MemMapSkimFactory" title="Permalink to this definition">#</a></dt>
<dd><p>The numpy.memmap docs states: The memmap object can be used anywhere an ndarray is accepted.
You might think that since memmap duck-types ndarray, we could simply wrap it in a SkimData object.</p>
<p>But, as the numpy.memmap docs also say: “Memory-mapped files are used for accessing
small segments of large files on disk, without reading the entire file into memory.”</p>
<p>The words “small segments” are not accidental, because, as you gradually access all the parts
of the memmapped array, memory usage increases as all the memory is loaded into RAM.</p>
<p>Under this scenario, the MemMapSkimFactory operates as a just-in-time loader, with no net savings
in RAM footprint (other than potentially avoiding loading any unused skims).</p>
<p>Alternatively, since opening a memmap is fast, you could just open the memmap read the data on demand,
and immediately close it. This essentially eliminates RAM usage, but it means you are loading the data
every time you access the skim, which, depending on you patterns of usage, may or may not be acceptable.</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.MemMapSkimFactory.get_skim_data">
<span class="sig-name descname"><span class="pre">get_skim_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.MemMapSkimFactory.get_skim_data" title="Permalink to this definition">#</a></dt>
<dd><p>Read skim data from backing store and return it as a 3D ndarray quack-alike SkimData object
(either a JitMemMapSkimData or a memmap backed SkimData object)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag: str</strong></dt><dd></dd>
<dt><strong>skim_info: string</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>SkimData or subclass</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.NumpyArraySkimFactory">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dict_factory.</span></span><span class="sig-name descname"><span class="pre">NumpyArraySkimFactory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory" title="Permalink to this definition">#</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.NumpyArraySkimFactory.allocate_skim_buffer">
<span class="sig-name descname"><span class="pre">allocate_skim_buffer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shared</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.allocate_skim_buffer" title="Permalink to this definition">#</a></dt>
<dd><p>Allocate a ram skim buffer to use as frombuffer for SkimData
If shared is True, return a shareable multiprocessing.RawArray, otherwise a numpy.ndarray</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_info: dict</strong></dt><dd></dd>
<dt><strong>shared: boolean</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>multiprocessing.RawArray or numpy.ndarray</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.NumpyArraySkimFactory.get_skim_data">
<span class="sig-name descname"><span class="pre">get_skim_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.get_skim_data" title="Permalink to this definition">#</a></dt>
<dd><p>Read skim data from backing store and return it as a 3D ndarray quack-alike SkimData object</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_tag: str</strong></dt><dd></dd>
<dt><strong>skim_info: dict</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>SkimData</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.NumpyArraySkimFactory.load_skims_to_buffer">
<span class="sig-name descname"><span class="pre">load_skims_to_buffer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_buffer</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.load_skims_to_buffer" title="Permalink to this definition">#</a></dt>
<dd><p>Load skims from disk store (omx or cache) into ram skim buffer (multiprocessing.RawArray or numpy.ndarray)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skim_info: doct</strong></dt><dd></dd>
<dt><strong>skim_buffer: 1D buffer sized to hold all skims (multiprocessing.RawArray or numpy.ndarray)</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.NumpyArraySkimFactory.supports_shared_data_for_multiprocessing">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">supports_shared_data_for_multiprocessing</span></span><a class="headerlink" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.supports_shared_data_for_multiprocessing" title="Permalink to this definition">#</a></dt>
<dd><p>Does subclass support shareable data for multiprocessing</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>boolean</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.SkimData">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dict_factory.</span></span><span class="sig-name descname"><span class="pre">SkimData</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dict_factory.SkimData" title="Permalink to this definition">#</a></dt>
<dd><p>A facade for 3D skim data exposing numpy indexing and shape
The primary purpose is to document and police the api used to access skim data
Subclasses using a different backing store to perform additional/alternative
only need to implement the methods exposed here.</p>
<p>For instance, to open/close memmapped files just in time, or to access backing data via an alternate api</p>
<dl class="py property">
<dt class="sig sig-object py" id="activitysim.core.skim_dict_factory.SkimData.shape">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">shape</span></span><a class="headerlink" href="#activitysim.core.skim_dict_factory.SkimData.shape" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>list-like shape tuple as returned by numpy.shape</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<span class="target" id="module-activitysim.core.skim_dictionary"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.DataFrameMatrix">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">DataFrameMatrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.DataFrameMatrix" title="Permalink to this definition">#</a></dt>
<dd><p>Utility class to allow a pandas dataframe to be treated like a 2-D array,
indexed by rowid, colname</p>
<p>For use in vectorized expressions where the desired values depend on both a row column selector
e.g. size_terms.get(df.dest_taz, df.purpose)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">])</span>

<span class="n">dfm</span> <span class="o">=</span> <span class="n">DataFrameMatrix</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">dfm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">103</span><span class="p">],</span> <span class="n">col_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">])</span>

<span class="n">returns</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.DataFrameMatrix.get">
<span class="sig-name descname"><span class="pre">get</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">col_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.DataFrameMatrix.get" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>row_ids - list of row_ids (df index values)</strong></dt><dd></dd>
<dt><strong>col_ids - list of column names, one per row_id,</strong></dt><dd><p>specifying column from which the value for that row should be retrieved</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>series with one row per row_id, with the value from the column specified in col_ids</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.MazSkimDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">MazSkimDict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">taz_skim_dict</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.MazSkimDict" title="Permalink to this definition">#</a></dt>
<dd><p>MazSkimDict provides a facade that allows skim-like lookup by maz orig,dest zone_id
when there are often too many maz zones to create maz skims.</p>
<p>Dependencies: network_los.load_data must have already loaded: taz skim_dict, maz_to_maz_df, and maz_taz_df</p>
<p>It performs lookups from a sparse list of maz-maz od pairs on selected attributes (e.g. WALKDIST)
where accuracy for nearby od pairs is critical. And is backed by a fallback taz skim dict
to return values of for more distant pairs (or for skims that are not attributes in the maz-maz table.)</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.MazSkimDict.get_skim_usage">
<span class="sig-name descname"><span class="pre">get_skim_usage</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.MazSkimDict.get_skim_usage" title="Permalink to this definition">#</a></dt>
<dd><p>return set of keys of skims looked up. e.g. {‘DIST’, ‘SOV’}</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>set:</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.MazSkimDict.lookup">
<span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.MazSkimDict.lookup" title="Permalink to this definition">#</a></dt>
<dd><p>Return list of skim values of skims(s) at orig/dest in skim with the specified key (e.g. ‘DIST’)</p>
<p>Look up in sparse table (backed by taz skims) if key is a sparse_key, otherwise look up in taz skims
For taz skim lookups, the offset_mapper will convert maz zone_ids directly to taz skim indexes.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>orig: list of orig zone_ids</strong></dt><dd></dd>
<dt><strong>dest: list of dest zone_ids</strong></dt><dd></dd>
<dt><strong>key: str</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Numpy.ndarray: list of skim values for od pairs</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.MazSkimDict.sparse_lookup">
<span class="sig-name descname"><span class="pre">sparse_lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.MazSkimDict.sparse_lookup" title="Permalink to this definition">#</a></dt>
<dd><p>Get impedence values for a set of origin, destination pairs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>orig</strong><span class="classifier">1D array</span></dt><dd></dd>
<dt><strong>dest</strong><span class="classifier">1D array</span></dt><dd></dd>
<dt><strong>key</strong><span class="classifier">str</span></dt><dd><p>skim key</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>values</strong><span class="classifier">numpy 1D array</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.OffsetMapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">OffsetMapper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">offset_int</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offset_list</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offset_series</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.OffsetMapper" title="Permalink to this definition">#</a></dt>
<dd><p>Utility to map skim zone ids to ordinal offsets (e.g. numpy array indices)</p>
<p>Can map either by a fixed offset (e.g. -1 to map 1-based to 0-based)
or by an explicit mapping of zone id to offset (slower but more flexible)</p>
<p>Internally, there are two representations:</p>
<dl class="simple">
<dt>offset_int:</dt><dd><p>int offset which when added to zone_id yields skim array index (e.g. -1 to map 1-based zones to 0-based index)</p>
</dd>
<dt>offset_series:</dt><dd><p>pandas series with zone_id index and skim array offset values. Ordinarily, index is just range(0, omx_size)
if series has duplicate offset values, this can map multiple zone_ids to a single skim array index
(e.g. can map maz zone_ids to corresponding taz skim offset)</p>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.OffsetMapper.map">
<span class="sig-name descname"><span class="pre">map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">zone_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.OffsetMapper.map" title="Permalink to this definition">#</a></dt>
<dd><p>map zone_ids to skim indexes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>zone_ids</strong><span class="classifier">list-like (numpy.ndarray, pandas.Int64Index, or pandas.Series)</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>offsets</strong><span class="classifier">numpy array of int</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.OffsetMapper.set_offset_int">
<span class="sig-name descname"><span class="pre">set_offset_int</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">offset_int</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_int" title="Permalink to this definition">#</a></dt>
<dd><p>specify int offset which when added to zone_id yields skim array index (e.g. -1 to map 1-based to 0-based)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>offset_int</strong><span class="classifier">int</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.OffsetMapper.set_offset_list">
<span class="sig-name descname"><span class="pre">set_offset_list</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">offset_list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_list" title="Permalink to this definition">#</a></dt>
<dd><p>Convenience method to set offset_series using an integer list the same size as target skim dimension
with implicit skim index mapping (e.g. an omx mapping as returned by omx_file.mapentries)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>offset_list</strong><span class="classifier">list of int</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.OffsetMapper.set_offset_series">
<span class="sig-name descname"><span class="pre">set_offset_series</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">offset_series</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_series" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>offset_series: pandas.Series</strong></dt><dd><p>series with zone_id index and skim array offset values (can map many zone_ids to skim array index)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.Skim3dWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">Skim3dWrapper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">orig_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dim3_key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.Skim3dWrapper" title="Permalink to this definition">#</a></dt>
<dd><p>This works the same as a SkimWrapper above, except the third dim3 is also supplied,
and a 3D lookup is performed using orig, dest, and dim3.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>skims: Skims</strong></dt><dd><p>This is the Skims object to wrap</p>
</dd>
<dt><strong>dim3_key</strong><span class="classifier">str</span></dt><dd><p>This identifies the column in the dataframe which is used to
select among Skim object using the SECOND item in each tuple (see
above for a more complete description)</p>
</dd>
</dl>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.Skim3dWrapper.set_df">
<span class="sig-name descname"><span class="pre">set_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.Skim3dWrapper.set_df" title="Permalink to this definition">#</a></dt>
<dd><p>Set the dataframe</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">DataFrame</span></dt><dd><p>The dataframe which contains the orig, dest, and dim3 values</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>self (to facilitiate chaining)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">SkimDict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict" title="Permalink to this definition">#</a></dt>
<dd><p>A SkimDict object is a wrapper around a dict of multiple skim objects,
where each object is identified by a key.</p>
<p>Note that keys are either strings or tuples of two strings (to support stacking of skims.)</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.get_skim_usage">
<span class="sig-name descname"><span class="pre">get_skim_usage</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.get_skim_usage" title="Permalink to this definition">#</a></dt>
<dd><p>return set of keys of skims looked up. e.g. {‘DIST’, ‘SOV’}</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>set:</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.lookup">
<span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.lookup" title="Permalink to this definition">#</a></dt>
<dd><p>Return list of skim values of skims(s) at orig/dest in skim with the specified key (e.g. ‘DIST’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>orig: list of orig zone_ids</strong></dt><dd></dd>
<dt><strong>dest: list of dest zone_ids</strong></dt><dd></dd>
<dt><strong>key: str</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Numpy.ndarray: list of skim values for od pairs</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.lookup_3d">
<span class="sig-name descname"><span class="pre">lookup_3d</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dim3</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.lookup_3d" title="Permalink to this definition">#</a></dt>
<dd><p>3D lookup of skim values of skims(s) at orig/dest for stacked skims indexed by dim3 selector</p>
<p>The idea is that skims may be stacked in groups with a base key and a dim3 key (usually a time of day key)</p>
<p>On import (from omx) skims stacks are represented by base and dim3 keys seperated by a double_underscore</p>
<p>e.g. DRV_COM_WLK_BOARDS__AM indicates base skim key DRV_COM_WLK_BOARDS with a time of day (dim3) of ‘AM’</p>
<p>Since all the skimsa re stored in a single contiguous 3D array, we can use the dim3 key as a third index
and thus rapidly get skim values for a list of (orig, dest, tod) tuples using index arrays (‘fancy indexing’)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>orig: list of orig zone_ids</strong></dt><dd></dd>
<dt><strong>dest: list of dest zone_ids</strong></dt><dd></dd>
<dt><strong>block_offsets: list with one dim3 key for each orig/dest pair</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Numpy.ndarray: list of skim values</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.wrap">
<span class="sig-name descname"><span class="pre">wrap</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.wrap" title="Permalink to this definition">#</a></dt>
<dd><p>return a SkimWrapper for self</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.wrap_3d">
<span class="sig-name descname"><span class="pre">wrap_3d</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">orig_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dim3_key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.wrap_3d" title="Permalink to this definition">#</a></dt>
<dd><p>return a SkimWrapper for self</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimDict.zone_ids">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">zone_ids</span></span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimDict.zone_ids" title="Permalink to this definition">#</a></dt>
<dd><p>Return list of zone_ids we grok in skim index order</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt>ndarray of int domain zone_ids</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.skim_dictionary.</span></span><span class="sig-name descname"><span class="pre">SkimWrapper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">skim_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">orig_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimWrapper" title="Permalink to this definition">#</a></dt>
<dd><p>A SkimWrapper object is an access wrapper around a SkimDict of multiple skim objects,
where each object is identified by a key.</p>
<p>This is just a way to simplify expression files by hiding the and orig, dest arguments
when the orig and dest vectors are in a dataframe with known column names (specified at init time)
The dataframe is identified by set_df because it may not be available (e.g. due to chunking)
at the time the SkimWrapper is instantiated.</p>
<p>When the user calls skims[key], key is an identifier for which skim
to use, and the object automatically looks up impedances of that skim
using the specified orig_key column in df as the origin and
the dest_key column in df as the destination.  In this way, the user
does not do the O-D lookup by hand and only specifies which skim to use
for this lookup.  This is the only purpose of this object: to
abstract away the O-D lookup and use skims by specifying which skim
to use in the expressions.</p>
<p>Note that keys are either strings or tuples of two strings (to support stacking of skims.)</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimWrapper.lookup">
<span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimWrapper.lookup" title="Permalink to this definition">#</a></dt>
<dd><p>Generally not called by the user - use __getitem__ instead</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>key</strong><span class="classifier">hashable</span></dt><dd><p>The key (identifier) for this skim object</p>
</dd>
<dt><strong>od</strong><span class="classifier">bool (optional)</span></dt><dd><p>od=True means lookup standard origin-destination skim value
od=False means lookup destination-origin skim value</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>impedances: pd.Series</dt><dd><p>A Series of impedances which are elements of the Skim object and
with the same index as df</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimWrapper.max">
<span class="sig-name descname"><span class="pre">max</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimWrapper.max" title="Permalink to this definition">#</a></dt>
<dd><p>return max skim value in either o-d or d-o direction</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimWrapper.reverse">
<span class="sig-name descname"><span class="pre">reverse</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimWrapper.reverse" title="Permalink to this definition">#</a></dt>
<dd><p>return skim value in reverse (d-o) direction</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.skim_dictionary.SkimWrapper.set_df">
<span class="sig-name descname"><span class="pre">set_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.skim_dictionary.SkimWrapper.set_df" title="Permalink to this definition">#</a></dt>
<dd><p>Set the dataframe</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">DataFrame</span></dt><dd><p>The dataframe which contains the origin and destination ids</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>self (to facilitiate chaining)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="random">
<span id="random-in-detail"></span><h3>Random<a class="headerlink" href="#random" title="Permalink to this heading">#</a></h3>
<p>ActivitySim’s random number generation has a number of important features unique to AB modeling:</p>
<ul class="simple">
<li><p>Regression testing, debugging - run the exact model with the same inputs and get exactly the same results.</p></li>
<li><p>Debugging models - run the exact model with the same inputs but with changes to expression files and get the same results except where the equations differ.</p></li>
<li><p>Since runs can take a while, the above cases need to work with a restartable pipeline.</p></li>
<li><p>Debugging Multithreading - run the exact model with different multithreading configurations and get the same results.</p></li>
<li><p>Repeatable household-level choices - results for a household are repeatable when run with different sample sizes</p></li>
<li><p>Repeatable household level results with different scenarios - results for a household are repeatable with different scenario configurations sequentially up to the point at which those differences emerge, and in alternate submodels in which those differences do not apply.</p></li>
</ul>
<p>Random number generation is done using the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.random.RandomState.html">numpy Mersenne Twister PNRG</a>.
ActivitySim seeds on-the-fly and uses a stream of random numbers seeded by the household id, person id, tour id, trip id, the model step offset, and the global seed.
The global seed can be set in the settings.yaml file using the <code class="docutils literal notranslate"><span class="pre">`rng_base_seed</span></code> option.
The logic for calculating the seed is something along the lines of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chooser_table</span><span class="o">.</span><span class="n">index</span> <span class="o">*</span> <span class="n">number_of_models_for_chooser</span> <span class="o">+</span> <span class="n">chooser_model_offset</span> <span class="o">+</span> <span class="n">global_seed_offset</span>

<span class="k">for</span> <span class="n">example</span>
  <span class="mi">1425</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">where</span><span class="p">:</span>
  <span class="mi">1425</span> <span class="o">=</span> <span class="n">household</span> <span class="n">table</span> <span class="n">index</span> <span class="o">-</span> <span class="n">households</span><span class="o">.</span><span class="n">id</span>
  <span class="mi">2</span> <span class="o">=</span> <span class="n">number</span> <span class="n">of</span> <span class="n">household</span> <span class="n">level</span> <span class="n">models</span> <span class="o">-</span> <span class="n">auto</span> <span class="n">ownership</span> <span class="ow">and</span> <span class="n">cdap</span>
  <span class="mi">0</span> <span class="o">=</span> <span class="n">first</span> <span class="n">household</span> <span class="n">model</span> <span class="o">-</span> <span class="n">auto</span> <span class="n">ownership</span>
  <span class="mi">1</span> <span class="o">=</span> <span class="k">global</span> <span class="n">seed</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">testing</span> <span class="n">the</span> <span class="n">same</span> <span class="n">model</span> <span class="n">under</span> <span class="n">different</span> <span class="n">random</span> <span class="k">global</span> <span class="n">seeds</span>
</pre></div>
</div>
<p>ActivitySim generates a separate, distinct, and stable random number stream for each tour type and tour number in order to maintain as much stability as is
possible across alternative scenarios.  This is done for trips as well, by direction (inbound versus outbound).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Random module contains max model steps constants by chooser type - household, person, tour, trip - needs to be equal to the number of chooser sub-models.</p>
</div>
<section id="id4">
<h4>API<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.random"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.random.</span></span><span class="sig-name descname"><span class="pre">SimpleChannel</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">channel_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">base_seed</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">domain_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel" title="Permalink to this definition">#</a></dt>
<dd><p>We need to ensure that we generate the same random streams (when re-run or even across
different simulations.) We do this by generating a random seed for each domain_df row
that is based on the domain_df index (which implies that generated tables like tours
and trips are also created with stable, predictable, repeatable row indexes.</p>
<p>Because we need to generate a distinct stream for each step, we can’t just use the
domain_df index - we need a strategy for handling multiple steps without generating
collisions between streams (i.e. choosing the same seed for more than one stream.)</p>
<p>The easiest way to do this would be to use an array of integers to seed the generator,
with a global seed, a channel seed, a row seed, and a step seed. Unfortunately, seeding
numpy RandomState with arrays is a LOT slower than with a single integer seed, and
speed matters because we reseed on-the-fly for every call because creating a different
RandomState object for each row uses too much memory (5K per RandomState object)</p>
<p>numpy random seeds are unsigned int32 so there are 4,294,967,295 available seeds.
That is probably just about enough to distribute evenly, for most cities, depending on the
number of households, persons, tours, trips, and steps.</p>
<p>So we use (global_seed + channel_seed + step_seed + row_index) % (1 &lt;&lt; 32)
to get an int32 seed rather than a tuple.</p>
<p>We do read in the whole households and persons tables at start time, so we could note the
max index values. But we might then want a way to ensure stability between the test, example,
and full datasets. I am punting on this for now.</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.begin_step">
<span class="sig-name descname"><span class="pre">begin_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.begin_step" title="Permalink to this definition">#</a></dt>
<dd><p>Reset channel state for a new state</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>step_name</strong><span class="classifier">str</span></dt><dd><p>pipeline step name for this step</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.choice_for_df">
<span class="sig-name descname"><span class="pre">choice_for_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">a</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">replace</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.choice_for_df" title="Permalink to this definition">#</a></dt>
<dd><p>Apply numpy.random.choice once for each row in df
using the appropriate random channel for each row.</p>
<p>Concatenate the the choice arrays for every row into a single 1-D ndarray
The resulting array will be of length: size * len(df.index)
This method is designed to support creation of a interaction_dataset</p>
<p>The columns in df are ignored; the index name and values are used to determine
which random number sequence to to use.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>df with index name and values corresponding to a registered channel</p>
</dd>
<dt><strong>step_name</strong><span class="classifier">str</span></dt><dd><p>current step name so we can update row_states seed info</p>
</dd>
<dt><strong>The remaining parameters are passed through as arguments to numpy.random.choice</strong></dt><dd></dd>
<dt><strong>a</strong><span class="classifier">1-D array-like or int</span></dt><dd><p>If an ndarray, a random sample is generated from its elements.
If an int, the random sample is generated as if a was np.arange(n)</p>
</dd>
<dt><strong>size</strong><span class="classifier">int or tuple of ints</span></dt><dd><p>Output shape</p>
</dd>
<dt><strong>replace</strong><span class="classifier">boolean</span></dt><dd><p>Whether the sample is with or without replacement</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">1-D ndarray of length: size * len(df.index)</span></dt><dd><p>The generated random samples for each row concatenated into a single (flat) array</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.extend_domain">
<span class="sig-name descname"><span class="pre">extend_domain</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">domain_df</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.extend_domain" title="Permalink to this definition">#</a></dt>
<dd><p>Extend or create row_state df by adding seed info for each row in domain_df</p>
<p>If extending, the index values of new tables must be disjoint so
there will be no ambiguity/collisions between rows</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>domain_df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>domain dataframe with index values for which random streams are to be generated
and well-known index name corresponding to the channel</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.init_row_states_for_step">
<span class="sig-name descname"><span class="pre">init_row_states_for_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">row_states</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.init_row_states_for_step" title="Permalink to this definition">#</a></dt>
<dd><p>initialize row states (in place) for new step</p>
<p>with stable, predictable, repeatable row_seeds for that domain_df index value</p>
<p>See notes on the seed generation strategy in class comment above.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>row_states</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.normal_for_df">
<span class="sig-name descname"><span class="pre">normal_for_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mu</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sigma</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lognormal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.normal_for_df" title="Permalink to this definition">#</a></dt>
<dd><p>Return a floating point random number in normal (or lognormal) distribution
for each row in df using the appropriate random channel for each row.</p>
<p>Subsequent calls (in the same step) will return the next rand for each df row</p>
<p>The resulting array will be the same length (and order) as df
This method is designed to support alternative selection from a probability array</p>
<p>The columns in df are ignored; the index name and values are used to determine
which random number sequence to to use.</p>
<p>If “true pseudo random” behavior is desired (i.e. NOT repeatable) the set_base_seed
method (q.v.) may be used to globally reseed all random streams.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pandas.DataFrame or Series</span></dt><dd><p>df or series with index name and values corresponding to a registered channel</p>
</dd>
<dt><strong>mu</strong><span class="classifier">float or pd.Series or array of floats with one value per df row</span></dt><dd></dd>
<dt><strong>sigma</strong><span class="classifier">float or array of floats with one value per df row</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>rands</strong><span class="classifier">2-D ndarray</span></dt><dd><p>array the same length as df, with n floats in range [0, 1) for each df row</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.random.SimpleChannel.random_for_df">
<span class="sig-name descname"><span class="pre">random_for_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.SimpleChannel.random_for_df" title="Permalink to this definition">#</a></dt>
<dd><p>Return n floating point random numbers in range [0, 1) for each row in df
using the appropriate random channel for each row.</p>
<p>Subsequent calls (in the same step) will return the next rand for each df row</p>
<p>The resulting array will be the same length (and order) as df
This method is designed to support alternative selection from a probability array</p>
<p>The columns in df are ignored; the index name and values are used to determine
which random number sequence to to use.</p>
<p>If “true pseudo random” behavior is desired (i.e. NOT repeatable) the set_base_seed
method (q.v.) may be used to globally reseed all random streams.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>df with index name and values corresponding to a registered channel</p>
</dd>
<dt><strong>n</strong><span class="classifier">int</span></dt><dd><p>number of rands desired per df row</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>rands</strong><span class="classifier">2-D ndarray</span></dt><dd><p>array the same length as df, with n floats in range [0, 1) for each df row</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.random.hash32">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.random.</span></span><span class="sig-name descname"><span class="pre">hash32</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">s</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.random.hash32" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>s: str</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>32 bit unsigned hash</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="tracing">
<span id="trace"></span><h3>Tracing<a class="headerlink" href="#tracing" title="Permalink to this heading">#</a></h3>
<p>Household tracer.  If a household trace ID is specified, then ActivitySim will output a
comprehensive set of trace files for all calculations for all household members:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hhtrace.log</span></code> - household trace log file, which specifies the CSV files traced. The order of output files is consistent with the model sequence.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">various</span> <span class="pre">CSV</span> <span class="pre">files</span></code> - every input, intermediate, and output data table - chooser, expressions/utilities, probabilities, choices, etc. - for the trace household for every sub-model</p></li>
</ul>
<p>With the set of output CSV files, the user can trace ActivitySim’s calculations in order to ensure they are correct and/or to
help debug data and/or logic errors.</p>
<section id="id5">
<h4>API<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.tracing"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.tracing.ElapsedTimeFormatter">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">ElapsedTimeFormatter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fmt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datefmt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">style</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'%'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validate</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">defaults</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.ElapsedTimeFormatter" title="Permalink to this definition">#</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.tracing.ElapsedTimeFormatter.format">
<span class="sig-name descname"><span class="pre">format</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">record</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.ElapsedTimeFormatter.format" title="Permalink to this definition">#</a></dt>
<dd><p>Format the specified record as text.</p>
<p>The record’s attribute dictionary is used as the operand to a
string formatting operation which yields the returned string.
Before formatting the dictionary, a couple of preparatory steps
are carried out. The message attribute of the record is computed
using LogRecord.getMessage(). If the formatting string uses the
time (as determined by a call to usesTime(), formatTime() is
called to format the event time. If there is exception information,
it is formatted using formatException() and appended to the message.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.delete_output_files">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">delete_output_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">file_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subdir</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.delete_output_files" title="Permalink to this definition">#</a></dt>
<dd><p>Delete files in output directory of specified type.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>state</strong><span class="classifier">Pipeline</span></dt><dd><p>The output directory is read from the Pipeline.</p>
</dd>
<dt><strong>file_type</strong><span class="classifier">str</span></dt><dd><p>File extension to delete.</p>
</dd>
<dt><strong>ignore</strong><span class="classifier">list[Path-like]</span></dt><dd><p>Specific files to leave alone.</p>
</dd>
<dt><strong>subdir</strong><span class="classifier">list[Path-like], optional</span></dt><dd><p>Subdirectories to scrub.  If not given, the top level output directory
plus the ‘log’ and ‘trace’ directories will be scrubbed.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.delete_trace_files">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">delete_trace_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.delete_trace_files" title="Permalink to this definition">#</a></dt>
<dd><p>Delete CSV files in output_dir</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.hh_id_for_chooser">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">hh_id_for_chooser</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.hh_id_for_chooser" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>id - scalar id (or list of ids) from chooser index</strong></dt><dd></dd>
<dt><strong>choosers - pandas dataframe whose index contains ids</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>scalar household_id or series of household_ids</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.no_results">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">no_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.no_results" title="Permalink to this definition">#</a></dt>
<dd><p>standard no-op to write tracing when a model produces no results</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.print_summary">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">print_summary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">describe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_counts</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.print_summary" title="Permalink to this definition">#</a></dt>
<dd><p>Print summary</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>label: str</strong></dt><dd><p>tracer name</p>
</dd>
<dt><strong>df: pandas.DataFrame</strong></dt><dd><p>traced dataframe</p>
</dd>
<dt><strong>describe: boolean</strong></dt><dd><p>print describe?</p>
</dd>
<dt><strong>value_counts: boolean</strong></dt><dd><p>print value counts?</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>Nothing</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.slice_ids">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">slice_ids</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.slice_ids" title="Permalink to this definition">#</a></dt>
<dd><p>slice a dataframe to select only records with the specified ids</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df: pandas.DataFrame</strong></dt><dd><p>traced dataframe</p>
</dd>
<dt><strong>ids: int or list of ints</strong></dt><dd><p>slice ids</p>
</dd>
<dt><strong>column: str</strong></dt><dd><p>column to slice (slice using index if None)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>df: pandas.DataFrame</dt><dd><p>sliced dataframe</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.tracing.trace_id_for_chooser">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.tracing.</span></span><span class="sig-name descname"><span class="pre">trace_id_for_chooser</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.tracing.trace_id_for_chooser" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>id - scalar id (or list of ids) from chooser index</strong></dt><dd></dd>
<dt><strong>choosers - pandas dataframe whose index contains ids</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>scalar household_id or series of household_ids</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
</section>
<section id="utility-expressions">
<span id="util-expressions"></span><h2>Utility Expressions<a class="headerlink" href="#utility-expressions" title="Permalink to this heading">#</a></h2>
<p>Much of the power of ActivitySim comes from being able to specify Python, pandas, and
numpy expressions for calculations. Refer to the pandas help for a general
introduction to expressions.  ActivitySim provides two ways to evaluate expressions:</p>
<ul class="simple">
<li><p>Simple table expressions are evaluated using <code class="docutils literal notranslate"><span class="pre">DataFrame.eval()</span></code>.  <a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.eval.html">pandas’ eval</a> operates on the current table.</p></li>
<li><p>Python expressions, denoted by beginning with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, are evaluated with <a class="reference external" href="https://docs.python.org/2/library/functions.html#eval">Python’s eval()</a>.</p></li>
</ul>
<p>Simple table expressions can only refer to columns in the current DataFrame.  Python expressions can refer to any Python objects currently in memory.</p>
<section id="conventions">
<h3>Conventions<a class="headerlink" href="#conventions" title="Permalink to this heading">#</a></h3>
<p>There are a few conventions for writing expressions in ActivitySim:</p>
<ul class="simple">
<li><p>each expression is applied to all rows in the table being operated on</p></li>
<li><p>expressions must be vectorized expressions and can use most numpy and pandas expressions</p></li>
<li><p>global constants are specified in the settings file</p></li>
<li><p>comments are specified with <code class="docutils literal notranslate"><span class="pre">#</span></code></p></li>
<li><p>you can refer to the current table being operated on as <code class="docutils literal notranslate"><span class="pre">df</span></code></p></li>
<li><p>often an object called <code class="docutils literal notranslate"><span class="pre">skims</span></code>, <code class="docutils literal notranslate"><span class="pre">skims_od</span></code>, or similar is available and is used to lookup the relevant skim information.  See <a class="reference internal" href="#los-in-detail"><span class="std std-ref">LOS</span></a> for more information.</p></li>
<li><p>when editing the CSV files in Excel, use single quote ‘ or space at the start of a cell to get Excel to accept the expression</p></li>
</ul>
</section>
<section id="example-expressions-file">
<h3>Example Expressions File<a class="headerlink" href="#example-expressions-file" title="Permalink to this heading">#</a></h3>
<p>An expressions file has the following basic form:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Label</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Expression</p></th>
<th class="head"><p>cars0</p></th>
<th class="head"><p>cars1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>util_drivers_2</p></td>
<td><p>2 Adults (age 16+)</p></td>
<td><p>drivers==2</p></td>
<td></td>
<td><p>coef_cars1_drivers_2</p></td>
</tr>
<tr class="row-odd"><td><p>util_persons_25_34</p></td>
<td><p>Persons age 25-34</p></td>
<td><p>num_young_adults</p></td>
<td></td>
<td><p>coef_cars1_persons_25_34</p></td>
</tr>
<tr class="row-even"><td><p>util_num_workers_clip_3</p></td>
<td><p>Number of workers, capped at 3</p></td>
<td><p>&#64;df.workers.clip(upper=3)</p></td>
<td></td>
<td><p>coef_cars1_num_workers_clip_3</p></td>
</tr>
<tr class="row-odd"><td><p>util_dist_0_1</p></td>
<td><p>Distance, from 0 to 1 miles</p></td>
<td><p>&#64;skims[‘DIST’].clip(1)</p></td>
<td></td>
<td><p>coef_dist_0_1</p></td>
</tr>
</tbody>
</table>
</div>
<p>In the <span class="xref std std-ref">tour_mode_choice</span> model expression file example shown below, the <code class="docutils literal notranslate"><span class="pre">&#64;c_ivt*(&#64;odt_skims['SOV_TIME']</span> <span class="pre">+</span> <span class="pre">dot_skims['SOV_TIME'])</span></code>
expression is travel time for the tour origin to destination at the tour start time plus the tour destination to tour origin at the tour end time.
The <code class="docutils literal notranslate"><span class="pre">odt_skims</span></code> and <code class="docutils literal notranslate"><span class="pre">dot_skims</span></code> objects are setup ahead-of-time to refer to the relevant skims for this model.  The <code class="docutils literal notranslate"><span class="pre">&#64;c_ivt</span></code> comes from the
tour mode choice coefficient file.  The tour mode choice model is a nested logit (NL) model and the nesting structure (including nesting
coefficients) is specified in the YAML settings file.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Label</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Expression</p></th>
<th class="head"><p>DRIVEALONEFREE</p></th>
<th class="head"><p>DRIVEALONEPAY</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>util_DRIVEALONEFREE_Unavailable</p></td>
<td><p>DRIVEALONEFREE - Unavailable</p></td>
<td><p>sov_available == False</p></td>
<td><p>-999</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>util_DRIVEALONEFREE_In_vehicle_time</p></td>
<td><p>DRIVEALONEFREE - In-vehicle time</p></td>
<td><p>odt_skims[‘SOV_TIME’] + dot_skims[‘SOV_TIME’]</p></td>
<td><p>coef_ivt</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>util_DRIVEALONEFREE_Unavailable_for_persons_less_than_16</p></td>
<td><p>DRIVEALONEFREE - Unavailable for persons less than 16</p></td>
<td><p>age &lt; 16</p></td>
<td><p>-999</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>util_DRIVEALONEFREE_Unavailable_for_joint_tours</p></td>
<td><p>DRIVEALONEFREE - Unavailable for joint tours</p></td>
<td><p>is_joint == True</p></td>
<td><p>-999</p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>Rows are vectorized expressions that will be calculated for every record in the current table being operated on</p></li>
<li><p>The Label column is the unique expression name (used for model estimation integration)</p></li>
<li><p>The Description column describes the expression</p></li>
<li><p>The Expression column contains a valid vectorized Python/pandas/numpy expression.  In the example above, <code class="docutils literal notranslate"><span class="pre">drivers</span></code> is a column in the current table.  Use <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> to refer to data outside the current table</p></li>
<li><p>There is a column for each alternative and its relevant coefficient from the submodel coefficient file</p></li>
</ul>
<p>There are some variations on this setup, but the functionality is similar.  For example,
in the example destination choice model, the size terms expressions file has market segments as rows and employment type
coefficients as columns.  Broadly speaking, there are currently four types of model expression configurations:</p>
<ul class="simple">
<li><p>Simple <a class="reference internal" href="#simulate"><span class="std std-ref">Simulate</span></a> choice model - select from a fixed set of choices defined in the specification file, such as the example above.</p></li>
<li><p><a class="reference internal" href="#simulate-with-interaction"><span class="std std-ref">Simulate with Interaction</span></a> choice model - combine the choice expressions with the choice alternatives files since the alternatives are not listed in the expressions file.  The <span class="xref std std-ref">non_mandatory_tour_destination_choice</span> model implements this approach.</p></li>
<li><p>Combinatorial choice model - first generate a set of alternatives based on a combination of alternatives across choosers, and then make choices.  The <span class="xref std std-ref">cdap</span> model implements this approach.</p></li>
</ul>
</section>
<section id="expressions">
<h3>Expressions<a class="headerlink" href="#expressions" title="Permalink to this heading">#</a></h3>
<p>The expressions class is often used for pre- and post-processor table annotation, which read a CSV file of expression, calculate
a number of additional table fields, and join the fields to the target table.  An example table annotation expressions
file is found in the example configuration files for households for the CDAP model -
<a class="reference external" href="https://github.com/activitysim/activitysim/blob/main/example/configs/annotate_households_cdap.csv">annotate_households_cdap.csv</a>.</p>
<span class="target" id="module-activitysim.core.expressions"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.expressions.annotate_preprocessors">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.expressions.</span></span><span class="sig-name descname"><span class="pre">annotate_preprocessors</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">BaseModel</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">preprocessor_setting_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'preprocessor'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.expressions.annotate_preprocessors" title="Permalink to this definition">#</a></dt>
<dd><p>Look through the preprocessor settings and apply the calculations to the dataframe.
This is generally called before the main model calculations to prepare the data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>state</strong><span class="classifier">workflow.State</span></dt><dd><p>The current state of the workflow.</p>
</dd>
<dt><strong>df</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>DataFrame to which the preprocessor settings will be applied.</p>
</dd>
<dt><strong>locals_dict</strong><span class="classifier">dict</span></dt><dd><p>Dictionary of local variables to be used in the expressions.</p>
</dd>
<dt><strong>skims</strong><span class="classifier">dict | None</span></dt><dd><p>Dictionary of skims to be used in the expressions.</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">PydanticBase | dict</span></dt><dd><p>Model settings containing the preprocessor settings.</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd><p>Label for tracing the operations.</p>
</dd>
<dt><strong>preprocessor_setting_name</strong><span class="classifier">str</span></dt><dd><p>Name of the preprocessor settings key in the model settings.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>None – dataframe is modified in place</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.expressions.annotate_tables">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.expressions.</span></span><span class="sig-name descname"><span class="pre">annotate_tables</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">BaseModel</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.expressions.annotate_tables" title="Permalink to this definition">#</a></dt>
<dd><p>Look through the annotate settings and apply the calculations to the tables.
This is generally called after the main model calculations to add data to output tables.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>state</strong><span class="classifier">workflow.State</span></dt><dd><p>The current state of the workflow.</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">PydanticBase | dict</span></dt><dd><p>Model settings containing the annotation settings for various tables.</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd><p>Label for tracing the operations.</p>
</dd>
<dt><strong>skims</strong><span class="classifier">dict | None</span></dt><dd><p>Dictionary of skims to be used in the expressions, if applicable.</p>
</dd>
<dt><strong>locals_dict</strong><span class="classifier">dict | None</span></dt><dd><p>Dictionary of local variables to be used in the expressions, if applicable.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>None – tables are modified in place</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.expressions.assign_columns">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.expressions.</span></span><span class="sig-name descname"><span class="pre">assign_columns</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.expressions.assign_columns" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate expressions in context of df and assign resulting target columns to df</p>
<p>Can add new or modify existing columns (if target same as existing df column name)</p>
<p>Parameters - same as for compute_columns except df must not be None
Returns - nothing since we modify df in place</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.expressions.compute_columns">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.expressions.</span></span><span class="sig-name descname"><span class="pre">compute_columns</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">BaseModel</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></span><a class="headerlink" href="#activitysim.core.expressions.compute_columns" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate expressions_spec in context of df, with optional additional pipeline tables in locals</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>or if None, expect name of pipeline table to be specified by DF in model_settings</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict or str</span></dt><dd><dl class="simple">
<dt>dict with keys:</dt><dd><p>DF - df_alias and (additionally, if df is None) name of pipeline table to load as df
SPEC - name of expressions file (csv suffix optional) if different from model_settings
TABLES - list of pipeline tables to load and make available as (read only) locals</p>
</dd>
<dt>str:</dt><dd><p>name of yaml file in configs_dir to load dict from</p>
</dd>
</dl>
</dd>
<dt><strong>locals_dict</strong><span class="classifier">dict, optional</span></dt><dd><p>dict of locals (e.g. utility functions) to add to the execution environment</p>
</dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>results: pandas.DataFrame</dt><dd><p>one column for each expression (except temps with ALL_CAP target names)
same index as df</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="sampling-with-interaction">
<h3>Sampling with Interaction<a class="headerlink" href="#sampling-with-interaction" title="Permalink to this heading">#</a></h3>
<p>Methods for expression handling, solving, and sampling (i.e. making multiple choices),
with interaction with the chooser table.</p>
<p>Sampling is done with replacement and a sample correction factor is calculated.  The factor is
calculated as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">freq</span> <span class="o">=</span> <span class="n">how</span> <span class="n">often</span> <span class="n">an</span> <span class="n">alternative</span> <span class="ow">is</span> <span class="n">sampled</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">the</span> <span class="n">pick_count</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">probability</span> <span class="n">of</span> <span class="n">the</span> <span class="n">alternative</span>
<span class="n">correction_factor</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">freq</span><span class="o">/</span><span class="n">prob</span><span class="p">)</span>

<span class="c1">#for example:</span>

<span class="n">freq</span>              <span class="mf">1.00</span>        <span class="mf">2.00</span>    <span class="mf">3.00</span>    <span class="mf">4.00</span>    <span class="mf">5.00</span>
<span class="n">prob</span>              <span class="mf">0.30</span>        <span class="mf">0.30</span>    <span class="mf">0.30</span>    <span class="mf">0.30</span>    <span class="mf">0.30</span>
<span class="n">correction</span> <span class="n">factor</span> <span class="mf">1.20</span>        <span class="mf">1.90</span>    <span class="mf">2.30</span>    <span class="mf">2.59</span>    <span class="mf">2.81</span>
</pre></div>
</div>
<p>As the alternative is oversampled, its utility goes up for final selection.  The unique set
of alternatives is passed to the final choice model and the correction factor is
included in the utility.</p>
<section id="id6">
<h4>API<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.interaction_sample"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.interaction_sample.interaction_sample">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.interaction_sample.</span></span><span class="sig-name descname"><span class="pre">interaction_sample</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">sample_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.14)"><span class="pre">int</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">alt_col_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_zero_probs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#activitysim.core.skim_dictionary.SkimWrapper" title="activitysim.core.skim_dictionary.SkimWrapper"><span class="pre">SkimWrapper</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="dev-guide/skim-dataset.html#activitysim.core.skim_dataset.DatasetWrapper" title="activitysim.core.skim_dataset.DatasetWrapper"><span class="pre">DatasetWrapper</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.14)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zone_layer</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">explicit_chunk_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.14)"><span class="pre">float</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.interaction_sample.interaction_sample" title="Permalink to this definition">#</a></dt>
<dd><p>Run a simulation in the situation in which alternatives must
be merged with choosers because there are interaction terms or
because alternatives are being sampled.</p>
<p>optionally (if chunk_size &gt; 0) iterates over choosers in chunk_size chunks</p>
<dl class="field-list">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>state</strong><span class="classifier">State</span></dt><dd></dd>
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of choosers</p>
</dd>
<dt><strong>alternatives</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of alternatives - will be merged with choosers and sampled</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A Pandas DataFrame that gives the specification of the variables to
compute and the coefficients for each variable.
Variable specifications must be in the table index and the
table should have only one column of coefficients.</p>
</dd>
<dt><strong>sample_size</strong><span class="classifier">int, optional</span></dt><dd><p>Sample alternatives with sample of given size.  By default is None,
which does not sample alternatives.</p>
</dd>
<dt><strong>alt_col_name: str</strong></dt><dd><p>name to give the sampled_alternative column</p>
</dd>
<dt><strong>skims</strong><span class="classifier">SkimWrapper or DatasetWrapper or None</span></dt><dd><p>The skims object is used to contain multiple matrices of
origin-destination impedances.  Make sure to also add it to the
locals_d below in order to access it in expressions.  The <em>only</em> job
of this method in regards to skims is to call set_df with the
dataframe that comes back from interacting choosers with
alternatives.  See the skims module for more documentation on how
the skims object is intended to be used.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd><p>if chunk_size &gt; 0 iterates over choosers in chunk_size chunks</p>
</dd>
<dt><strong>trace_label: str</strong></dt><dd><p>This is the label to be used  for trace log file entries and dump file names
when household tracing enabled. No tracing occurs if label is empty or None.</p>
</dd>
<dt><strong>zone_layer</strong><span class="classifier">{‘taz’, ‘maz’}, default ‘taz’</span></dt><dd><p>Specify which zone layer of the skims is to be used.  You cannot use the
‘maz’ zone layer in a one-zone model, but you can use the ‘taz’ layer in
a two- or three-zone model (e.g. for destination pre-sampling).</p>
</dd>
<dt><strong>explicit_chunk_size</strong><span class="classifier">float, optional</span></dt><dd><p>If &gt; 0, specifies the chunk size to use when chunking the interaction
simulation. If &lt; 1, specifies the fraction of the total number of choosers.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl>
<dt><strong>choices_df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A DataFrame where index should match the index of the choosers DataFrame
(except with sample_size rows for each choser row, one row for each alt sample)
and columns alt_col_name, prob, rand, pick_count</p>
<dl class="simple">
<dt>&lt;alt_col_name&gt;:</dt><dd><p>alt identifier from alternatives[&lt;alt_col_name&gt;</p>
</dd>
<dt>prob: float</dt><dd><p>the probability of the chosen alternative</p>
</dd>
<dt>pick_count<span class="classifier">int</span></dt><dd><p>number of duplicate picks for chooser, alt</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.interaction_sample.make_sample_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.interaction_sample.</span></span><span class="sig-name descname"><span class="pre">make_sample_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sample_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternative_count</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alt_col_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_zero_probs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.interaction_sample.make_sample_choices" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>probs</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>one row per chooser and one column per alternative</p>
</dd>
<dt><strong>alternatives</strong></dt><dd><p>dataframe with index containing alt ids</p>
</dd>
<dt><strong>sample_size</strong><span class="classifier">int</span></dt><dd><p>number of samples/choices to make</p>
</dd>
<dt><strong>alternative_count</strong></dt><dd></dd>
<dt><strong>alt_col_name</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

</section>
</section>
<section id="simulate">
<span id="id7"></span><h3>Simulate<a class="headerlink" href="#simulate" title="Permalink to this heading">#</a></h3>
<p>Methods for expression handling, solving, choosing (i.e. making choices) from a fixed set of choices
defined in the specification file.</p>
<section id="id8">
<h4>API<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.simulate"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.compute_base_probabilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">compute_base_probabilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">nested_probabilities</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nests</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.compute_base_probabilities" title="Permalink to this definition">#</a></dt>
<dd><p>compute base probabilities for nest leaves
Base probabilities will be the nest-adjusted probabilities of all leaves
This flattens or normalizes all the nested probabilities so that they have the proper global
relative values (the leaf probabilities sum to 1 for each row.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>nested_probabilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe with the nested probabilities for nest leafs and nodes</p>
</dd>
<dt><strong>nests</strong><span class="classifier">dict</span></dt><dd><p>Nest tree dict from the model spec yaml file</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.Dataframe</span></dt><dd><p>simple simulate spec so we can return columns in appropriate order</p>
</dd>
<dt><strong>Returns</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
<dt><strong>base_probabilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>nested_probabilities</cite> and columns for leaf base probabilities</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.compute_nested_exp_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">compute_nested_exp_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">raw_utilities</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.compute_nested_exp_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>compute exponentiated nest utilities based on nesting coefficients</p>
<p>For nest nodes this is the exponentiated logsum of alternatives adjusted by nesting coefficient</p>
<p>leaf &lt;- exp( raw_utility )
nest &lt;- exp( ln(sum of exponentiated raw_utility of leaves) * nest_coefficient)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>raw_utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe with the raw alternative utilities of all leaves
(what in non-nested logit would be the utilities of all the alternatives)</p>
</dd>
<dt><strong>nest_spec</strong><span class="classifier">dict</span></dt><dd><p>Nest tree dict from the model spec yaml file</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>nested_utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>raw_utilities</cite> and columns for exponentiated leaf and node utilities</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.compute_nested_probabilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">compute_nested_probabilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">nested_exp_utilities</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.compute_nested_probabilities" title="Permalink to this definition">#</a></dt>
<dd><p>compute nested probabilities for nest leafs and nodes
probability for nest alternatives is simply the alternatives’s local (to nest) probability
computed in the same way as the probability of non-nested alternatives in multinomial logit
i.e. the fractional share of the sum of the exponentiated utility of itself and its siblings
except in nested logit, its sib group is restricted to the nest</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>nested_exp_utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe with the exponentiated nested utilities of all leaves and nodes</p>
</dd>
<dt><strong>nest_spec</strong><span class="classifier">dict</span></dt><dd><p>Nest tree dict from the model spec yaml file</p>
</dd>
<dt><strong>Returns</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
<dt><strong>nested_probabilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>nested_exp_utilities</cite> and columns for leaf and node probabilities</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.dump_mapped_coefficients">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">dump_mapped_coefficients</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.dump_mapped_coefficients" title="Permalink to this definition">#</a></dt>
<dd><p>dump template_df with coefficient values</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_mnl">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_mnl</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom_chooser</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.14)"><span class="pre">tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_mnl" title="Permalink to this definition">#</a></dt>
<dd><p>Run a simulation for when the model spec does not involve alternative
specific data, e.g. there are no interactions with alternative
properties and no need to sample from alternatives.</p>
<p>Each row in spec computes a partial utility for each alternative,
by providing a spec expression (often a boolean 0-1 trigger)
and a column of utility coefficients for each alternative.</p>
<p>We compute the utility of each alternative by matrix-multiplication of eval results
with the utility coefficients in the spec alternative columns
yielding one row per chooser and one column per alternative</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A table of variable specifications and coefficient values.
Variable expressions should be in the table index and the table
should have a column for each alternative.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict or None</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>custom_chooser</strong><span class="classifier">function(state, probs, choosers, spec, trace_label) returns choices, rands</span></dt><dd><p>custom alternative to logit.make_choices</p>
</dd>
<dt><strong>estimator</strong><span class="classifier">Estimator object</span></dt><dd><p>called to report intermediate table results (used for estimation)</p>
</dd>
<dt><strong>trace_label: str</strong></dt><dd><p>This is the label to be used  for trace log file entries and dump file names
when household tracing enabled. No tracing occurs if label is empty or None.</p>
</dd>
<dt><strong>trace_choice_name: str</strong></dt><dd><p>This is the column label to be used in trace file csv dump of choices</p>
</dd>
<dt><strong>trace_column_names: str or list of str</strong></dt><dd><p>chooser columns to include when tracing expression_values</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>Index will be that of <cite>choosers</cite>, values will match the columns
of <cite>spec</cite>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_mnl_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_mnl_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_mnl_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>like eval_nl except return logsums instead of making choices</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>logsums</strong><span class="classifier">pandas.Series</span></dt><dd><p>Index will be that of <cite>choosers</cite>, values will be logsum across spec column values</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_nl">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_nl</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom_chooser</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.14)"><span class="pre">tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ChunkSizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_nl" title="Permalink to this definition">#</a></dt>
<dd><p>Run a nested-logit simulation for when the model spec does not involve alternative
specific data, e.g. there are no interactions with alternative
properties and no need to sample from alternatives.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A table of variable specifications and coefficient values.
Variable expressions should be in the table index and the table
should have a column for each alternative.</p>
</dd>
<dt><strong>nest_spec:</strong></dt><dd><p>dictionary specifying nesting structure and nesting coefficients
(from the model spec yaml file)</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict or None</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>custom_chooser</strong><span class="classifier">function(probs, choosers, spec, trace_label) returns choices, rands</span></dt><dd><p>custom alternative to logit.make_choices</p>
</dd>
<dt><strong>estimator</strong><span class="classifier">Estimator object</span></dt><dd><p>called to report intermediate table results (used for estimation)</p>
</dd>
<dt><strong>trace_label: str</strong></dt><dd><p>This is the label to be used  for trace log file entries and dump file names
when household tracing enabled. No tracing occurs if label is empty or None.</p>
</dd>
<dt><strong>trace_choice_name: str</strong></dt><dd><p>This is the column label to be used in trace file csv dump of choices</p>
</dd>
<dt><strong>trace_column_names: str or list of str</strong></dt><dd><p>chooser columns to include when tracing expression_values</p>
</dd>
<dt><strong>fastmath</strong><span class="classifier">bool, default True</span></dt><dd><p>Use fastmath for sharrow compiled code.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>Index will be that of <cite>choosers</cite>, values will match the columns
of <cite>spec</cite>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_nl_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_nl_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ChunkSizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_nl_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>like eval_nl except return logsums instead of making choices</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>logsums</strong><span class="classifier">pandas.Series</span></dt><dd><p>Index will be that of <cite>choosers</cite>, values will be nest logsum based on spec column values</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">have_trace_targets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_all_rows</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zone_layer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec_sh</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_sizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate a utility function as defined in a spec file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A table of variable specifications and coefficient values.
Variable expressions should be in the table index and the table
should have a column for each alternative.</p>
</dd>
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>locals_d</strong><span class="classifier">Dict or None</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with “&#64;”.</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>have_trace_targets</strong><span class="classifier">bool</span></dt><dd><p>Indicates if <cite>choosers</cite> has targets to trace</p>
</dd>
<dt><strong>trace_all_rows</strong><span class="classifier">bool</span></dt><dd><p>Trace all chooser rows, bypassing tracing.trace_targets</p>
</dd>
<dt><strong>estimator</strong></dt><dd><p>called to report intermediate table results (used for estimation)</p>
</dd>
<dt><strong>trace_column_names: str or list[str]</strong></dt><dd><p>chooser columns to include when tracing expression_values</p>
</dd>
<dt><strong>log_alt_losers</strong><span class="classifier">bool, default False</span></dt><dd><p>Write out expressions when all alternatives are unavailable.
This can be useful for model development to catch errors in
specifications. Enabling this check does not alter valid results
but slows down model runs.</p>
</dd>
<dt><strong>zone_layer</strong><span class="classifier">{‘taz’, ‘maz’}, optional</span></dt><dd><p>Specify which zone layer of the skims is to be used by sharrow.  You
cannot use the ‘maz’ zone layer in a one-zone model, but you can use
the ‘taz’ layer in a two- or three-zone model (e.g. for destination
pre-sampling). If not given, the default (lowest available) layer is
used.</p>
</dd>
<dt><strong>spec_sh</strong><span class="classifier">pandas.DataFrame, optional</span></dt><dd><p>An alternative <cite>spec</cite> modified specifically for use with sharrow.
This is meant to give the same result, but allows for some optimizations
or preprocessing outside the sharrow framework (e.g. to run the Python
based transit virtual path builder and cache relevant values).</p>
</dd>
<dt><strong>compute_settings</strong><span class="classifier">ComputeSettings, optional</span></dt><dd><p>Settings for sharrow. If not given, the default settings are used.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.eval_variables">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">eval_variables</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">exprs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.eval_variables" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate a set of variable expressions from a spec in the context
of a given data table.</p>
<p>There are two kinds of supported expressions: “simple” expressions are
evaluated in the context of the DataFrame using DataFrame.eval.
This is the default type of expression.</p>
<p>Python expressions are evaluated in the context of this function using
Python’s eval function. Because we use Python’s eval this type of
expression supports more complex operations than a simple expression.
Python expressions are denoted by beginning with the &#64; character.
Users should take care that these expressions must result in
a Pandas Series.</p>
<p># FIXME - for performance, it is essential that spec and expression_values
# FIXME - not contain booleans when dotted with spec values
# FIXME - or the arrays will be converted to dtype=object within dot()</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>exprs</strong><span class="classifier">sequence of str</span></dt><dd></dd>
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd><p>The trace label to use for performance logging. If None, performance
logging is not activated.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>variables</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>df</cite> and columns of eval results of <cite>exprs</cite>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.get_segment_coefficients">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">get_segment_coefficients</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filesystem</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="users-guide/_generated/activitysim.core.configuration.FileSystem.html#activitysim.core.configuration.FileSystem" title="activitysim.core.configuration.filesystem.FileSystem"><span class="pre">FileSystem</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">BaseModel</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.get_segment_coefficients" title="Permalink to this definition">#</a></dt>
<dd><p>Return a dict mapping generic coefficient names to segment-specific coefficient values</p>
<p>some specs mode_choice logsums have the same espression values with different coefficients for various segments
(e.g. eatout, .. ,atwork) and a template file that maps a flat list of coefficients into segment columns.</p>
<p>This allows us to provide a coefficient file with just the coefficients for a specific segment,
that works with generic coefficient names in the spec. For instance coef_ivt can take on the values
of segment-specific coefficients coef_ivt_school_univ, coef_ivt_work, coef_ivt_atwork,…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">coefficients_df</span>
                              <span class="n">value</span> <span class="n">constrain</span>
<span class="n">coefficient_name</span>
<span class="n">coef_ivt_eatout_escort_</span><span class="o">...</span>  <span class="o">-</span><span class="mf">0.0175</span>         <span class="n">F</span>
<span class="n">coef_ivt_school_univ</span>        <span class="o">-</span><span class="mf">0.0224</span>         <span class="n">F</span>
<span class="n">coef_ivt_work</span>               <span class="o">-</span><span class="mf">0.0134</span>         <span class="n">F</span>
<span class="n">coef_ivt_atwork</span>             <span class="o">-</span><span class="mf">0.0188</span>         <span class="n">F</span>

<span class="n">template_df</span>

<span class="n">coefficient_name</span>     <span class="n">eatout</span>                       <span class="n">school</span>                 <span class="n">school</span>                 <span class="n">work</span>
<span class="n">coef_ivt</span>             <span class="n">coef_ivt_eatout_escort_</span><span class="o">...</span>   <span class="n">coef_ivt_school_univ</span>   <span class="n">coef_ivt_school_univ</span>   <span class="n">coef_ivt_work</span>

<span class="n">For</span> <span class="n">school</span> <span class="n">segment</span> <span class="n">this</span> <span class="n">will</span> <span class="k">return</span> <span class="n">the</span> <span class="n">generic</span> <span class="n">coefficient</span> <span class="n">name</span> <span class="k">with</span> <span class="n">the</span> <span class="n">segment</span><span class="o">-</span><span class="n">specific</span> <span class="n">coefficient</span> <span class="n">value</span>
<span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="p">{</span><span class="s1">&#39;coef_ivt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0224</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.read_model_coefficient_template">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">read_model_coefficient_template</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filesystem</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="users-guide/_generated/activitysim.core.configuration.FileSystem.html#activitysim.core.configuration.FileSystem" title="activitysim.core.configuration.filesystem.FileSystem"><span class="pre">FileSystem</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="dev-guide/_generated/activitysim.core.configuration.logit.TemplatedLogitComponentSettings.html#activitysim.core.configuration.logit.TemplatedLogitComponentSettings" title="activitysim.core.configuration.logit.TemplatedLogitComponentSettings"><span class="pre">TemplatedLogitComponentSettings</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.read_model_coefficient_template" title="Permalink to this definition">#</a></dt>
<dd><p>Read the coefficient template specified by COEFFICIENT_TEMPLATE model setting</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.read_model_coefficients">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">read_model_coefficients</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filesystem</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="users-guide/_generated/activitysim.core.configuration.FileSystem.html#activitysim.core.configuration.FileSystem" title="activitysim.core.configuration.filesystem.FileSystem"><span class="pre">FileSystem</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">BaseLogitComponentSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.14)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">file_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></span><a class="headerlink" href="#activitysim.core.simulate.read_model_coefficients" title="Permalink to this definition">#</a></dt>
<dd><p>Read the coefficient file specified by COEFFICIENTS model setting</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.read_model_spec">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">read_model_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filesystem</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="users-guide/_generated/activitysim.core.configuration.FileSystem.html#activitysim.core.configuration.FileSystem" title="activitysim.core.configuration.filesystem.FileSystem"><span class="pre">FileSystem</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">file_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.read_model_spec" title="Permalink to this definition">#</a></dt>
<dd><p>Read a CSV model specification into a Pandas DataFrame or Series.</p>
<p>file_path : str   absolute or relative path to file</p>
<p>The CSV is expected to have columns for component descriptions
and expressions, plus one or more alternatives.</p>
<p>The CSV is required to have a header with column names. For example:</p>
<blockquote>
<div><p>Description,Expression,alt0,alt1,alt2</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd><p>name of spec_file is in model_settings[‘SPEC’] and file is relative to configs</p>
</dd>
<dt><strong>file_name</strong><span class="classifier">str</span></dt><dd><p>file_name id spec file in configs folder</p>
</dd>
<dt><strong>description_name</strong><span class="classifier">str, optional</span></dt><dd><p>Name of the column in <cite>fname</cite> that contains the component description.</p>
</dd>
<dt><strong>expression_name</strong><span class="classifier">str, optional</span></dt><dd><p>Name of the column in <cite>fname</cite> that contains the component expression.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>The description column is dropped from the returned data and the
expression values are set as the table index.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.set_skim_wrapper_targets">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">set_skim_wrapper_targets</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_partial_success</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.set_skim_wrapper_targets" title="Permalink to this definition">#</a></dt>
<dd><p>Add the dataframe to the SkimWrapper object so that it can be dereferenced
using the parameters of the skims object.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table to which to add skim data as new columns.
<cite>df</cite> is modified in-place.</p>
</dd>
<dt><strong>skims</strong><span class="classifier">SkimWrapper or Skim3dWrapper object, or a list or dict of skims</span></dt><dd><p>The skims object is used to contain multiple matrices of
origin-destination impedances.  Make sure to also add it to the
locals_d below in order to access it in expressions.  The <em>only</em> job
of this method in regards to skims is to call set_df with the
dataframe that comes back from interacting choosers with
alternatives.  See the skims module for more documentation on how
the skims object is intended to be used.</p>
</dd>
<dt><strong>allow_partial_success</strong><span class="classifier">bool, optional</span></dt><dd><p>If True (default), failures to set skim targets for some skim objects
(for example due to missing required columns in <cite>df</cite>) will be collected
and logged as warnings but will not raise an exception. If False, any
such failure will be raised immediately, preventing partial success.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.simple_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">simple_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom_chooser</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.simple_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Run an MNL or NL simulation for when the model spec does not involve alternative
specific data, e.g. there are no interactions with alternative
properties and no need to sample from alternatives.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.simple_simulate_by_chunk_id">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">simple_simulate_by_chunk_id</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom_chooser</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.simulate.simple_simulate_by_chunk_id" title="Permalink to this definition">#</a></dt>
<dd><p>chunk_by_chunk_id wrapper for simple_simulate</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.simulate.spec_for_segment">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.simulate.</span></span><span class="sig-name descname"><span class="pre">spec_for_segment</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Estimator</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec_file_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">coefficients_file_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></span><a class="headerlink" href="#activitysim.core.simulate.spec_for_segment" title="Permalink to this definition">#</a></dt>
<dd><p>Select spec for specified segment from omnibus spec containing columns for each segment</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>omnibus spec file with expressions in index and one column per segment</p>
</dd>
<dt><strong>segment_name</strong><span class="classifier">str</span></dt><dd><p>segment_name that is also column name in model_spec</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.dataframe</dt><dd><p>canonical spec file with expressions in index and single column with utility coefficients</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="simulate-with-interaction">
<span id="id9"></span><h3>Simulate with Interaction<a class="headerlink" href="#simulate-with-interaction" title="Permalink to this heading">#</a></h3>
<p>Methods for expression handling, solving, choosing (i.e. making choices),
with interaction with the chooser table.</p>
<section id="id10">
<h4>API<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.interaction_simulate"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.interaction_simulate.eval_interaction_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.interaction_simulate.</span></span><span class="sig-name descname"><span class="pre">eval_interaction_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_rows</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extra_data</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zone_layer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.interaction_simulate.eval_interaction_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>Compute the utilities for a single-alternative spec evaluated in the context of df</p>
<p>We could compute the utilities for interaction datasets just as we do for simple_simulate
specs with multiple alternative columns by calling eval_variables and then computing the
utilities by matrix-multiplication of eval results with the utility coefficients in the
spec alternative columns.</p>
<p>But interaction simulate computes the utilities of each alternative in the context of a
separate row in interaction dataset df, and so there is only one alternative in spec.
This turns out to be quite a bit faster (in this special case) than the pandas dot function.</p>
<p>For efficiency, we combine eval_variables and multiplication of coefficients into a single step,
so we don’t have to create a separate column for each partial utility. Instead, we simply
multiply the eval result by a single alternative coefficient and sum the partial utilities.</p>
<dl class="simple">
<dt>spec<span class="classifier">dataframe</span></dt><dd><p>one row per spec expression and one col with utility coefficient</p>
</dd>
<dt>df<span class="classifier">dataframe</span></dt><dd><p>cross join (cartesian product) of choosers with alternatives
combines columns of choosers and alternatives
len(df) == len(choosers) * len(alternatives)
index values (non-unique) are index values from alternatives df</p>
</dd>
<dt>interaction_utilities<span class="classifier">dataframe</span></dt><dd><p>the utility of each alternative is sum of the partial utilities determined by the
various spec expressions and their corresponding coefficients
yielding a dataframe  with len(interaction_df) rows and one utility column
having the same index as interaction_df (non-unique values from alternatives df)</p>
</dd>
<dt>zone_layer<span class="classifier">{‘taz’, ‘maz’}, default ‘taz’</span></dt><dd><p>Specify which zone layer of the skims is to be used.  You cannot use the
‘maz’ zone layer in a one-zone model, but you can use the ‘taz’ layer in
a two- or three-zone model (e.g. for destination pre-sampling).</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>df</cite> and a single column of utilities</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.interaction_simulate.interaction_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.interaction_simulate.</span></span><span class="sig-name descname"><span class="pre">interaction_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sample_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">explicit_chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.interaction_simulate.interaction_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Run a simulation in the situation in which alternatives must
be merged with choosers because there are interaction terms or
because alternatives are being sampled.</p>
<p>optionally (if chunk_size &gt; 0) iterates over choosers in chunk_size chunks</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of choosers</p>
</dd>
<dt><strong>alternatives</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of alternatives - will be merged with choosers, currently
without sampling</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A Pandas DataFrame that gives the specification of the variables to
compute and the coefficients for each variable.
Variable specifications must be in the table index and the
table should have only one column of coefficients.</p>
</dd>
<dt><strong>skims</strong><span class="classifier">Skims object</span></dt><dd><p>The skims object is used to contain multiple matrices of
origin-destination impedances.  Make sure to also add it to the
locals_d below in order to access it in expressions.  The <em>only</em> job
of this method in regards to skims is to call set_df with the
dataframe that comes back from interacting choosers with
alternatives.  See the skims module for more documentation on how
the skims object is intended to be used.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>sample_size</strong><span class="classifier">int, optional</span></dt><dd><p>Sample alternatives with sample of given size.  By default is None,
which does not sample alternatives.</p>
</dd>
<dt><strong>trace_label: str</strong></dt><dd><p>This is the label to be used  for trace log file entries and dump file names
when household tracing enabled. No tracing occurs if label is empty or None.</p>
</dd>
<dt><strong>trace_choice_name: str</strong></dt><dd><p>This is the column label to be used in trace file csv dump of choices</p>
</dd>
<dt><strong>explicit_chunk_size</strong><span class="classifier">float, optional</span></dt><dd><p>If &gt; 0, specifies the chunk size to use when chunking the interaction
simulation. If &lt; 1, specifies the fraction of the total number of choosers.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>A series where index should match the index of the choosers DataFrame
and values will match the index of the alternatives DataFrame -
choices are simulated in the standard Monte Carlo fashion</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="simulate-with-sampling-and-interaction">
<h3>Simulate with Sampling and Interaction<a class="headerlink" href="#simulate-with-sampling-and-interaction" title="Permalink to this heading">#</a></h3>
<p>Methods for expression handling, solving, sampling (i.e. making multiple choices),
and choosing (i.e. making choices), with interaction with the chooser table.</p>
<section id="id11">
<h4>API<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.interaction_sample_simulate"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.interaction_sample_simulate.interaction_sample_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.interaction_sample_simulate.</span></span><span class="sig-name descname"><span class="pre">interaction_sample_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choice_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_zero_probs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zero_prob_choice_val</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">log_alt_losers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_choice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">explicit_chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compute_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">ComputeSettings</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.interaction_sample_simulate.interaction_sample_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Run a simulation in the situation in which alternatives must
be merged with choosers because there are interaction terms or
because alternatives are being sampled.</p>
<p>optionally (if chunk_size &gt; 0) iterates over choosers in chunk_size chunks</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of choosers</p>
</dd>
<dt><strong>alternatives</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of alternatives - will be merged with choosers
index domain same as choosers, but repeated for each alternative</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>A Pandas DataFrame that gives the specification of the variables to
compute and the coefficients for each variable.
Variable specifications must be in the table index and the
table should have only one column of coefficients.</p>
</dd>
<dt><strong>skims</strong><span class="classifier">Skims object</span></dt><dd><p>The skims object is used to contain multiple matrices of
origin-destination impedances.  Make sure to also add it to the
locals_d below in order to access it in expressions.  The <em>only</em> job
of this method in regards to skims is to call set_df with the
dataframe that comes back from interacting choosers with
alternatives.  See the skims module for more documentation on how
the skims object is intended to be used.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd><p>if chunk_size &gt; 0 iterates over choosers in chunk_size chunks</p>
</dd>
<dt><strong>trace_label: str</strong></dt><dd><p>This is the label to be used  for trace log file entries and dump file names
when household tracing enabled. No tracing occurs if label is empty or None.</p>
</dd>
<dt><strong>trace_choice_name: str</strong></dt><dd><p>This is the column label to be used in trace file csv dump of choices</p>
</dd>
<dt><strong>skip_choice: bool</strong></dt><dd><p>This skips the logit choice step and simply returns the alternatives table with logsums
(used in disaggregate accessibility)</p>
</dd>
<dt><strong>explicit_chunk_size</strong><span class="classifier">float, optional</span></dt><dd><p>If &gt; 0, specifies the chunk size to use when chunking the interaction
simulation. If &lt; 1, specifies the fraction of the total number of choosers.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>if want_logsums is False:</dt><dd><dl class="simple">
<dt>choices<span class="classifier">pandas.Series</span></dt><dd><p>A series where index should match the index of the choosers DataFrame
and values will match the index of the alternatives DataFrame -
choices are simulated in the standard Monte Carlo fashion</p>
</dd>
</dl>
</dd>
<dt>if want_logsums is True:</dt><dd><dl class="simple">
<dt>choices<span class="classifier">pandas.DataFrame</span></dt><dd><p>choices[‘choice’] : same as choices series when logsums is False
choices[‘logsum’] : float logsum of choice utilities across alternatives</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="assign">
<h3>Assign<a class="headerlink" href="#assign" title="Permalink to this heading">#</a></h3>
<p>Alternative version of the expression evaluators in <a class="reference internal" href="#module-activitysim.core.simulate" title="activitysim.core.simulate"><code class="xref py py-mod docutils literal notranslate"><span class="pre">activitysim.core.simulate</span></code></a> that supports temporary variable assignment.
Temporary variables are identified in the expressions as starting with “_”, such as “_hh_density_bin”.  These
fields are not saved to the data pipeline store.  This feature is used by the <a class="reference internal" href="dev-guide/components/accessibility.html#accessibility"><span class="std std-ref">Accessibility</span></a> model.</p>
<section id="id12">
<h4>API<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.assign"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.assign.assign_variables">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.assign.</span></span><span class="sig-name descname"><span class="pre">assign_variables</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">assignment_expressions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df_alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_rows</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_log</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.assign.assign_variables" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate a set of variable expressions from a spec in the context
of a given data table.</p>
<p>Expressions are evaluated using Python’s eval function.
Python expressions have access to variables in locals_d (and df being
accessible as variable df.) They also have access to previously assigned
targets as the assigned target name.</p>
<p>lowercase variables starting with underscore are temp variables (e.g. _local_var)
and not returned except in trace_results</p>
<p>uppercase variables starting with underscore are temp singular variables (e.g. _LOCAL_SCALAR)
and not returned except in trace_assigned_locals
This is useful for defining general purpose local variables that don’t vary across
choosers or alternatives and therefore don’t need to be stored as series/columns
in the main choosers dataframe from which utilities are computed.</p>
<p>Users should take care that expressions (other than temp scalar variables) should result in
a Pandas Series (scalars will be automatically promoted to series.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>assignment_expressions</strong><span class="classifier">pandas.DataFrame of target assignment expressions</span></dt><dd><p>target: target column names
expression: pandas or python expression to evaluate</p>
</dd>
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of “python” expression.</p>
</dd>
<dt><strong>trace_rows: series or array of bools to use as mask to select target rows to trace</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>variables</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the index of <cite>df</cite> and columns named by target and containing
the result of evaluating expression</p>
</dd>
<dt><strong>trace_results</strong><span class="classifier">pandas.DataFrame or None</span></dt><dd><p>a dataframe containing the eval result values for each assignment expression</p>
</dd>
<dt><strong>trace_assigned_locals</strong><span class="classifier">dict or None</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.assign.evaluate_constants">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.assign.</span></span><span class="sig-name descname"><span class="pre">evaluate_constants</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">expressions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">constants</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.assign.evaluate_constants" title="Permalink to this definition">#</a></dt>
<dd><p>Evaluate a list of constant expressions - each one can depend on the one before
it.  These are usually used for the coefficients which have relationships
to each other.  So ivt=.7 and then ivt_lr=ivt*.9.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>expressions</strong><span class="classifier">Series</span></dt><dd><p>the index are the names of the expressions which are
used in subsequent evals - thus naming the expressions is required.</p>
</dd>
<dt><strong>constants</strong><span class="classifier">dict</span></dt><dd><p>will be passed as the scope of eval - usually a separate set of
constants are passed in here</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>d</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.assign.local_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.assign.</span></span><span class="sig-name descname"><span class="pre">local_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.assign.local_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>Dict of useful modules and functions to provides as locals for use in eval of expressions</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>utility_dict</strong><span class="classifier">dict</span></dt><dd><p>name, entity pairs of locals</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.assign.read_assignment_spec">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.assign.</span></span><span class="sig-name descname"><span class="pre">read_assignment_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">description_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'Description'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'Target'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expression_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'Expression'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.assign.read_assignment_spec" title="Permalink to this definition">#</a></dt>
<dd><p>Read a CSV model specification into a Pandas DataFrame or Series.</p>
<p>The CSV is expected to have columns for component descriptions
targets, and expressions,</p>
<p>The CSV is required to have a header with column names. For example:</p>
<blockquote>
<div><p>Description,Target,Expression</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>file_name</strong><span class="classifier">path-like</span></dt><dd><p>Name of a CSV spec file.</p>
</dd>
<dt><strong>description_name</strong><span class="classifier">str, optional</span></dt><dd><p>Name of the column in <cite>fname</cite> that contains the component description.</p>
</dd>
<dt><strong>target_name</strong><span class="classifier">str, optional</span></dt><dd><p>Name of the column in <cite>fname</cite> that contains the component target.</p>
</dd>
<dt><strong>expression_name</strong><span class="classifier">str, optional</span></dt><dd><p>Name of the column in <cite>fname</cite> that contains the component expression.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe with three columns: [‘description’ ‘target’ ‘expression’]</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.assign.uniquify_key">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.assign.</span></span><span class="sig-name descname"><span class="pre">uniquify_key</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'{}</span> <span class="pre">({})'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.assign.uniquify_key" title="Permalink to this definition">#</a></dt>
<dd><p>rename key so there are no duplicates with keys in dict</p>
<p>e.g. if there is already a key named “dog”, the second key will be reformatted to “dog (2)”</p>
</dd></dl>

</section>
</section>
</section>
<section id="choice-models">
<h2>Choice Models<a class="headerlink" href="#choice-models" title="Permalink to this heading">#</a></h2>
<section id="logit">
<span id="logit-in-detail"></span><h3>Logit<a class="headerlink" href="#logit" title="Permalink to this heading">#</a></h3>
<p>Multinomial logit (MNL) or Nested logit (NL) choice model.  These choice models depend on the foundational components of ActivitySim, such
as the expressions and data handling described in the <a class="reference internal" href="howitworks.html#id1"><span class="std std-ref">Execution Flow</span></a> section.</p>
<p>To specify and solve an MNL model:</p>
<ul class="simple">
<li><p>either specify <code class="docutils literal notranslate"><span class="pre">LOGIT_TYPE:</span> <span class="pre">MNL</span></code> in the model configuration YAML file or omit the setting</p></li>
<li><p>call either <code class="docutils literal notranslate"><span class="pre">simulate.simple_simulate()</span></code> or <code class="docutils literal notranslate"><span class="pre">simulate.interaction_simulate()</span></code> depending if the alternatives are interacted with the choosers or because alternatives are sampled</p></li>
</ul>
<p>To specify and solve an NL model:</p>
<ul class="simple">
<li><p>specify <code class="docutils literal notranslate"><span class="pre">LOGIT_TYPE:</span> <span class="pre">NL</span></code> in the model configuration YAML file</p></li>
<li><p>specify the nesting structure via the NESTS setting in the model configuration YAML file.  An example nested logit NESTS entry can be found in <code class="docutils literal notranslate"><span class="pre">example/configs/tour_mode_choice.yaml</span></code></p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">simulate.simple_simulate()</span></code>.  The <code class="docutils literal notranslate"><span class="pre">simulate.interaction_simulate()</span></code> functionality is not yet supported for NL.</p></li>
</ul>
<section id="id13">
<h4>API<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.logit"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.logit.Nest">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">Nest</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.Nest" title="Permalink to this definition">#</a></dt>
<dd><p>Data for a nest-logit node or leaf</p>
<p>This object is passed on yield when iterate over nest nodes (branch or leaf)
The nested logit design is stored in a yaml file as a tree of dict objects,
but using an object to pass the nest data makes the code a little more readable</p>
<p>An example nest specification is in the example tour mode choice model
yaml configuration file - example/configs/tour_mode_choice.yaml.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.count_nests">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">count_nests</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.count_nests" title="Permalink to this definition">#</a></dt>
<dd><p>count the nests in nest_spec, return 0 if nest_spec is none</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.each_nest">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">each_nest</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="dev-guide/_generated/activitysim.core.configuration.logit.LogitNestSpec.html#activitysim.core.configuration.logit.LogitNestSpec" title="activitysim.core.configuration.logit.LogitNestSpec"><span class="pre">LogitNestSpec</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">post_order</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.each_nest" title="Permalink to this definition">#</a></dt>
<dd><p>Iterate over each nest or leaf node in the tree (of subtree)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>nest_spec</strong><span class="classifier">dict or LogitNestSpec</span></dt><dd><p>Nest tree dict from the model spec yaml file</p>
</dd>
<dt><strong>type</strong><span class="classifier">str</span></dt><dd><p>Nest class type to yield
None yields all nests
‘leaf’ yields only leaf nodes
‘branch’ yields only branch nodes</p>
</dd>
<dt><strong>post_order</strong><span class="classifier">Bool</span></dt><dd><p>Should we iterate over the nodes of the tree in post-order or pre-order?
(post-order means we yield the alternatives sub-tree before current node.)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Yields<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>nest</strong><span class="classifier">Nest</span></dt><dd><p>Nest object with info about the current node (nest or leaf)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.interaction_dataset">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">interaction_dataset</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sample_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alt_index_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chooser_index_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.interaction_dataset" title="Permalink to this definition">#</a></dt>
<dd><p>Combine choosers and alternatives into one table for the purposes
of creating interaction variables and/or sampling alternatives.</p>
<p>Any duplicate column names in choosers table will be renamed with an ‘_chooser’ suffix.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>alternatives</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>sample_size</strong><span class="classifier">int, optional</span></dt><dd><p>If sampling from alternatives for each chooser, this is
how many to sample.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>alts_sample</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Merged choosers and alternatives with data repeated either
len(alternatives) or <cite>sample_size</cite> times.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.make_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">make_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choosers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_bad_probs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.14)"><span class="pre">tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v2.3.3)"><span class="pre">Series</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#activitysim.core.logit.make_choices" title="Permalink to this definition">#</a></dt>
<dd><p>Make choices for each chooser from among a set of alternatives.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>probs</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rows for choosers and columns for the alternatives from which they
are choosing. Values are expected to be valid probabilities across
each row, e.g. they should sum to 1.</p>
</dd>
<dt><strong>trace_choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>the choosers df (for interaction_simulate) to facilitate the reporting of hh_id
by report_bad_choices because it can’t deduce hh_id from the interaction_dataset
which is indexed on index values from alternatives df</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>Maps chooser IDs (from <cite>probs</cite> index) to a choice, where the choice
is an index into the columns of <cite>probs</cite>.</p>
</dd>
<dt><strong>rands</strong><span class="classifier">pandas.Series</span></dt><dd><p>The random numbers used to make the choices (for debugging, tracing)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.report_bad_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">report_bad_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">bad_row_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">msg</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choosers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">raise_error</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.report_bad_choices" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>bad_row_map</strong></dt><dd></dd>
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>utils or probs dataframe</p>
</dd>
<dt><strong>msg</strong><span class="classifier">str</span></dt><dd><p>message describing the type of bad choice that necessitates error being thrown</p>
</dd>
<dt><strong>trace_choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>the choosers df (for interaction_simulate) to facilitate the reporting of hh_id
because we  can’t deduce hh_id from the interaction_dataset which is indexed on index
values from alternatives df</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>raises RuntimeError</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.utils_to_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">utils_to_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiated</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_zero_probs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.utils_to_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>Convert a table of utilities to logsum series.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rows should be choosers and columns should be alternatives.</p>
</dd>
<dt><strong>exponentiated</strong><span class="classifier">bool</span></dt><dd><p>True if utilities have already been exponentiated</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>logsums</strong><span class="classifier">pandas.Series</span></dt><dd><p>Will have the same index as <cite>utils</cite>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.logit.utils_to_probs">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.logit.</span></span><span class="sig-name descname"><span class="pre">utils_to_probs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiated</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_zero_probs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choosers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">overflow_protection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">return_logsums</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.14)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.logit.utils_to_probs" title="Permalink to this definition">#</a></dt>
<dd><p>Convert a table of utilities to probabilities.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rows should be choosers and columns should be alternatives.</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str, optional</span></dt><dd><p>label for tracing bad utility or probability values</p>
</dd>
<dt><strong>exponentiated</strong><span class="classifier">bool</span></dt><dd><p>True if utilities have already been exponentiated</p>
</dd>
<dt><strong>allow_zero_probs</strong><span class="classifier">bool</span></dt><dd><p>if True value rows in which all utility alts are EXP_UTIL_MIN will result
in rows in probs to have all zero probability (and not sum to 1.0)
This is for the benefit of calculating probabilities of nested logit nests</p>
</dd>
<dt><strong>trace_choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>the choosers df (for interaction_simulate) to facilitate the reporting of hh_id
by report_bad_choices because it can’t deduce hh_id from the interaction_dataset
which is indexed on index values from alternatives df</p>
</dd>
<dt><strong>overflow_protection</strong><span class="classifier">bool, default True</span></dt><dd><p>Always shift utility values such that the maximum utility in each row is
zero.  This constant per-row shift should not fundamentally alter the
computed probabilities, but will ensure that an overflow does not occur
that will create infinite or NaN values.  This will also provide effective
protection against underflow; extremely rare probabilities will round to
zero, but by definition they are extremely rare and losing them entirely
should not impact the simulation in a measureable fashion, and at least one
(and sometimes only one) alternative is guaranteed to have non-zero
probability, as long as at least one alternative has a finite utility value.
If utility values are certain to be well-behaved and non-extreme, enabling
overflow_protection will have no benefit but impose a modest computational
overhead cost.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>probs</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have the same index and columns as <cite>utils</cite>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
</section>
<section id="person-time-windows">
<span id="time-windows"></span><h2>Person Time Windows<a class="headerlink" href="#person-time-windows" title="Permalink to this heading">#</a></h2>
<p>The departure time and duration models require person time windows. Time windows are adjacent time
periods that are available for travel. Time windows are stored in a timetable table and each row is
a person and each time period (in the case of MTC TM1 is 5am to midnight in 1 hr increments) is a column.
Each column is coded as follows:</p>
<ul class="simple">
<li><p>0 - unscheduled, available</p></li>
<li><p>2 - scheduled, start of a tour, is available as the last period of another tour</p></li>
<li><p>4 - scheduled, end of a tour, is available as the first period of another tour</p></li>
<li><p>6 - scheduled, end or start of a tour, available for this period only</p></li>
<li><p>7 - scheduled, unavailable, middle of a tour</p></li>
</ul>
<p>A good example of a time window expression is <code class="docutils literal notranslate"><span class="pre">&#64;tt.previous_tour_ends(df.person_id,</span> <span class="pre">df.start)</span></code>.  This
uses the person id and the tour start period to check if a previous tour ends in the same time period.</p>
<section id="id14">
<h3>API<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h3>
<span class="target" id="module-activitysim.core.timetable"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.timetable.</span></span><span class="sig-name descname"><span class="pre">TimeTable</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">windows_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable" title="Permalink to this definition">#</a></dt>
<dd><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tdd_alts_df</span>      <span class="n">tdd_footprints_df</span>
<span class="n">start</span>  <span class="n">end</span>      <span class="s1">&#39;0&#39;</span> <span class="s1">&#39;1&#39;</span> <span class="s1">&#39;2&#39;</span> <span class="s1">&#39;3&#39;</span> <span class="s1">&#39;4&#39;</span><span class="o">...</span>
<span class="mi">5</span>      <span class="mi">5</span>    <span class="o">==&gt;</span>  <span class="mi">0</span>   <span class="mi">6</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span>
<span class="mi">5</span>      <span class="mi">6</span>    <span class="o">==&gt;</span>  <span class="mi">0</span>   <span class="mi">2</span>   <span class="mi">4</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span>
<span class="mi">5</span>      <span class="mi">7</span>    <span class="o">==&gt;</span>  <span class="mi">0</span>   <span class="mi">2</span>   <span class="mi">7</span>   <span class="mi">4</span>   <span class="mi">0</span> <span class="o">...</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.adjacent_window_after">
<span class="sig-name descname"><span class="pre">adjacent_window_after</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.adjacent_window_after" title="Permalink to this definition">#</a></dt>
<dd><p>Return number of adjacent periods after specified period that are available
(not in the middle of another tour.)</p>
<p>Implements MTC TM1 macro &#64;&#64;adjWindowAfterThisPeriodAlt
Function name is kind of a misnomer, but parallels that used in MTC TM1 UECs</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series int</dt><dd><p>Number of adjacent windows indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.adjacent_window_before">
<span class="sig-name descname"><span class="pre">adjacent_window_before</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.adjacent_window_before" title="Permalink to this definition">#</a></dt>
<dd><p>Return number of adjacent periods before specified period that are available
(not in the middle of another tour.)</p>
<p>Implements MTC TM1 macro &#64;&#64;getAdjWindowBeforeThisPeriodAlt
Function name is kind of a misnomer, but parallels that used in MTC TM1 UECs</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series int</dt><dd><p>Number of adjacent windows indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.adjacent_window_run_length">
<span class="sig-name descname"><span class="pre">adjacent_window_run_length</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">before</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.adjacent_window_run_length" title="Permalink to this definition">#</a></dt>
<dd><p>Return the number of adjacent periods before or after specified period
that are available (not in the middle of another tour.)</p>
<p>Internal DRY method to implement adjacent_window_before and adjacent_window_after</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
<dt><strong>before</strong><span class="classifier">bool</span></dt><dd><p>Specify desired run length is of adjacent window before (True) or after (False)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.assign">
<span class="sig-name descname"><span class="pre">assign</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.assign" title="Permalink to this definition">#</a></dt>
<dd><p>Assign tours (represented by tdd alt ids) to persons</p>
<p>Updates self.windows numpy array. Assignments will not ‘take’ outside this object
until/unless replace_table called or updated timetable retrieved by get_windows_df</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>tdds</strong><span class="classifier">pandas series</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.assign_footprints">
<span class="sig-name descname"><span class="pre">assign_footprints</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">footprints</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.assign_footprints" title="Permalink to this definition">#</a></dt>
<dd><p>assign footprints for specified window_row_ids</p>
<p>This method is used for initialization of joint_tour timetables based on the
combined availability of the joint tour participants</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series</span></dt><dd><p>series of window_row_ids index irrelevant, but we want to use map()</p>
</dd>
<dt><strong>footprints</strong><span class="classifier">numpy array</span></dt><dd><p>with one row per window_row_id and one column per time period</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.assign_subtour_mask">
<span class="sig-name descname"><span class="pre">assign_subtour_mask</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.assign_subtour_mask" title="Permalink to this definition">#</a></dt>
<dd><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">index</span>     <span class="n">window_row_ids</span>   <span class="n">tdds</span>
<span class="mi">20973389</span>  <span class="mi">20973389</span>           <span class="mi">26</span>
<span class="mi">44612864</span>  <span class="mi">44612864</span>            <span class="mi">3</span>
<span class="mi">48954854</span>  <span class="mi">48954854</span>            <span class="mi">7</span>

<span class="n">tour</span> <span class="n">footprints</span>
<span class="p">[[</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">4</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">4</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">4</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]]</span>

<span class="n">subtour_mask</span>
<span class="p">[[</span><span class="mi">7</span> <span class="mi">7</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span><span class="p">]</span>
<span class="p">[</span><span class="mi">7</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span><span class="p">]</span>
<span class="p">[</span><span class="mi">7</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span> <span class="mi">7</span><span class="p">]]</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.begin_transaction">
<span class="sig-name descname"><span class="pre">begin_transaction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">transaction_loggers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.begin_transaction" title="Permalink to this definition">#</a></dt>
<dd><p>begin a transaction for an estimator or list of estimators
this permits rolling timetable back to the state at the start of the transaction
so that timetables can be built for scheduling override choices</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.max_time_block_available">
<span class="sig-name descname"><span class="pre">max_time_block_available</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.max_time_block_available" title="Permalink to this definition">#</a></dt>
<dd><p>determine the length of the maximum time block available in the persons day</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids: pandas.Series</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.Series with same index as window_row_ids, and integer max_run_length of</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.previous_tour_begins">
<span class="sig-name descname"><span class="pre">previous_tour_begins</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.previous_tour_begins" title="Permalink to this definition">#</a></dt>
<dd><p>Does a previously scheduled tour begin in the specified period?</p>
<p>Implements MTC TM1 &#64;&#64;prevTourBeginsThisArrivalPeriodAlt</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series boolean</dt><dd><p>indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.previous_tour_ends">
<span class="sig-name descname"><span class="pre">previous_tour_ends</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.previous_tour_ends" title="Permalink to this definition">#</a></dt>
<dd><p>Does a previously scheduled tour end in the specified period?</p>
<p>Implements MTC TM1 &#64;&#64;prevTourEndsThisDeparturePeriodAlt</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one period per window_row_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series boolean</dt><dd><p>indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.remaining_periods_available">
<span class="sig-name descname"><span class="pre">remaining_periods_available</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">starts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ends</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.remaining_periods_available" title="Permalink to this definition">#</a></dt>
<dd><p>Determine number of periods remaining available after the time window from starts to ends
is hypothetically scheduled</p>
<p>Implements MTC TM1 &#64;&#64;remainingPeriodsAvailableAlt</p>
<p>The start and end periods will always be available after scheduling, so ignore them.
The periods between start and end must be currently unscheduled, so assume they will become
unavailable after scheduling this window.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>starts</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one per window_row_id)</p>
</dd>
<dt><strong>ends</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one per window_row_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>available</strong><span class="classifier">pandas Series int</span></dt><dd><p>number periods available indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.replace_table">
<span class="sig-name descname"><span class="pre">replace_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.replace_table" title="Permalink to this definition">#</a></dt>
<dd><p>Save or replace windows_df  DataFrame to pipeline with saved table name
(specified when object instantiated.)</p>
<p>This is a convenience function in case caller instantiates object in one context
(e.g. dependency injection) where it knows the pipeline table name, but wants to
checkpoint the table in another context where it does not know that name.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.slice_windows_by_row_id">
<span class="sig-name descname"><span class="pre">slice_windows_by_row_id</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.slice_windows_by_row_id" title="Permalink to this definition">#</a></dt>
<dd><p>return windows array slice containing rows for specified window_row_ids
(in window_row_ids order)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.tour_available">
<span class="sig-name descname"><span class="pre">tour_available</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.tour_available" title="Permalink to this definition">#</a></dt>
<dd><p>test whether time window allows tour with specific tdd alt’s time window</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>tdds</strong><span class="classifier">pandas series</span></dt><dd><p>series of tdd_alt ids, index irrelevant</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>available</strong><span class="classifier">pandas Series of bool</span></dt><dd><p>with same index as window_row_ids.index (presumably tour_id, but we don’t care)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.timetable.TimeTable.window_periods_in_states">
<span class="sig-name descname"><span class="pre">window_periods_in_states</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">periods</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">states</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.TimeTable.window_periods_in_states" title="Permalink to this definition">#</a></dt>
<dd><p>Return boolean array indicating whether specified window periods are in list of states.</p>
<p>Internal DRY method to implement previous_tour_ends and previous_tour_begins</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>window_row_ids</strong><span class="classifier">pandas Series int</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>periods</strong><span class="classifier">pandas series int</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one period per window_row_id)</p>
</dd>
<dt><strong>states</strong><span class="classifier">list of int</span></dt><dd><p>presumably (e.g. I_EMPTY, I_START…)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas Series boolean</dt><dd><p>indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.timetable.create_timetable_windows">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.timetable.</span></span><span class="sig-name descname"><span class="pre">create_timetable_windows</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">rows</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.create_timetable_windows" title="Permalink to this definition">#</a></dt>
<dd><p>create an empty (all available) timetable with one window row per rows.index</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>rows - pd.DataFrame or Series</strong></dt><dd><p>all we care about is the index</p>
</dd>
<dt><strong>tdd_alts - pd.DataFrame</strong></dt><dd><p>We expect a start and end column, and create a timetable to accomodate all alts
(with on window of padding at each end)</p>
</dd>
<dt><strong>so if start is 5 and end is 23, we return something like this:</strong></dt><dd><p>4  5  6  7  8  9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24</p>
</dd>
<dt><strong>person_id</strong></dt><dd></dd>
<dt><strong>30       0  0  0  0  0  0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</strong></dt><dd></dd>
<dt><strong>109      0  0  0  0  0  0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pd.DataFrame indexed by rows.index, and one column of int8 for each time window (plus padding)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.timetable.sharrow_tt_remaining_periods_available">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.timetable.</span></span><span class="sig-name descname"><span class="pre">sharrow_tt_remaining_periods_available</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tt_windows</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tt_row_mapper</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">window_row_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">starter</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ender</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.sharrow_tt_remaining_periods_available" title="Permalink to this definition">#</a></dt>
<dd><p>Number of periods remaining available after hypothetical scheduling</p>
<p>This is what’s left after a new tour or trip from <cite>starts</cite> to
<cite>ends</cite> is hypothetically scheduled.</p>
<p>Implements MTC TM1 &#64;&#64;remainingPeriodsAvailableAlt</p>
<p>The start and end periods will always be available after
scheduling, so ignore them. The periods between start and end
must be currently unscheduled, so assume they will become
unavailable after scheduling this window.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tt_windows</strong><span class="classifier">array[int8], 2 dimensions</span></dt><dd><p>Array of currently scheduled stuff</p>
</dd>
<dt><strong>tt_row_mapper</strong><span class="classifier">numba.typed.Dict[int,int]</span></dt><dd><p>Maps value in the <cite>window_row_ids</cite> to row positions in <cite>windows</cite>.</p>
</dd>
<dt><strong>window_row_id</strong><span class="classifier">int</span></dt><dd><p>An identifier for which window row to use.</p>
</dd>
<dt><strong>starter</strong><span class="classifier">int</span></dt><dd><p>The starting period of the new tour that will block windows.</p>
</dd>
<dt><strong>ender</strong><span class="classifier">int</span></dt><dd><p>The ending period of the new tour that will block windows.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>int</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.timetable.tt_remaining_periods_available">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.timetable.</span></span><span class="sig-name descname"><span class="pre">tt_remaining_periods_available</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tt</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">starts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ends</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.tt_remaining_periods_available" title="Permalink to this definition">#</a></dt>
<dd><p>Number of periods remaining available after hypothetical scheduling</p>
<p>That is, what’s left after something from starts to ends is
hypothetically scheduled</p>
<p>Implements MTC TM1 &#64;&#64;remainingPeriodsAvailableAlt</p>
<p>The start and end periods will always be available after
scheduling, so ignore them. The periods between start and end
must be currently unscheduled, so assume they will become
unavailable after scheduling this window.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tt</strong><span class="classifier">TimeTable</span></dt><dd></dd>
<dt><strong>window_row_ids</strong><span class="classifier">pandas.Series[int]</span></dt><dd><p>series of window_row_ids indexed by tour_id</p>
</dd>
<dt><strong>starts</strong><span class="classifier">pandas.Series[int]</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one per window_row_id)</p>
</dd>
<dt><strong>ends</strong><span class="classifier">pandas.Series[int]</span></dt><dd><p>series of tdd_alt ids, index irrelevant (one per window_row_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>available</strong><span class="classifier">pandas Series int</span></dt><dd><p>number periods available indexed by window_row_ids.index</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.timetable.tt_slice_windows_by_row_id">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.timetable.</span></span><span class="sig-name descname"><span class="pre">tt_slice_windows_by_row_id</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tt_window_row_ix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tt_windows</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">window_row_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.timetable.tt_slice_windows_by_row_id" title="Permalink to this definition">#</a></dt>
<dd><p>return windows array slice containing rows for specified window_row_ids
(in window_row_ids order)</p>
</dd></dl>

</section>
</section>
<section id="transit-virtual-path-builder">
<span id="id15"></span><h2>Transit Virtual Path Builder<a class="headerlink" href="#transit-virtual-path-builder" title="Permalink to this heading">#</a></h2>
<p>Transit virtual path builder (TVPB) for three zone system (see <span class="xref std std-ref">multiple_zone_systems</span>) transit path utility calculations.
TAP to TAP skims and walk access and egress times between MAZs and TAPs are input to the
demand model.  ActivitySim then assembles the total transit path utility based on the user specified TVPB
expression files for the respective components:</p>
<ul class="simple">
<li><p>from MAZ to first boarding TAP +</p></li>
<li><p>from first boarding to final alighting TAP +</p></li>
<li><p>from alighting TAP to destination MAZ</p></li>
</ul>
<p>This assembling is done via the TVPB, which considers all the possible combinations of nearby boarding and alighting TAPs for each origin
destination MAZ pair and selects the user defined N best paths to represent the transit mode.  After selecting N best paths, the logsum across
N best paths is calculated and exposed to the mode choice models and a random number is drawn and a path is chosen. The boarding TAP,
alighting TAP, and TAP to TAP skim set for the chosen path is saved to the chooser table.</p>
<p>The initialize TVPB submodel (see <span class="xref std std-ref">initialize_los</span>) pre-computes TAP to TAP total utilities for the user defined attribute_segments,
which are typically demographic segment (for example household income bin), time-of-day, and access/egress mode.  This submodel can be
run in both single process and multiprocess mode, with single process excellent for development/debugging and multiprocess excellent
for application.  ActivitySim saves the pre-calculated TAP to TAP total utilities to a memory mapped cache file for reuse by downstream models
such as tour mode choice.  In tour mode choice, the pre-computed TAP to TAP total utilities for the attribute_segment, along with the
access and egress impedances, are used to evaluate the best N TAP pairs for each origin MAZ destination MAZ pair being evaluated.
Assembling the total transit path impedance and then picking the best N is quick since it is done in a de-duplicated manner within
each chunk of multiprocessed choosers.</p>
<p>A model with TVPB can take considerably longer to run than a traditional TAZ based model since it does an order of magnitude more
calculations.  Thus, it is important to be mindful of your approach to your network model as well, especially the number of TAPs
accessible to each MAZ, which is the key determinant of runtime.</p>
<section id="id16">
<h3>API<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h3>
<span class="target" id="module-activitysim.core.pathbuilder"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.TransitVirtualPathBuilder">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.pathbuilder.</span></span><span class="sig-name descname"><span class="pre">TransitVirtualPathBuilder</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder" title="Permalink to this definition">#</a></dt>
<dd><p>Transit virtual path builder for three zone systems</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.TransitVirtualPathBuilder.compute_tap_tap_utilities">
<span class="sig-name descname"><span class="pre">compute_tap_tap_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">recipe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">access_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">egress_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chooser_attributes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder.compute_tap_tap_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>create transit_df and compute utilities for all atap-btap pairs between omaz in access and dmaz in egress_df
compute the utilities using the tap_tap utility expressions file specified in tap_tap_settings</p>
<p>transit_df contains all possible access omaz/btap to egress dmaz/atap transit path pairs for each chooser</p>
<p>trace should be True as we don’t encourage/support dynamic utility computation except when tracing
(precompute being fairly fast)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>recipe: str</strong></dt><dd><p>‘recipe’ key in network_los.yaml TVPB_SETTINGS e.g. tour_mode_choice</p>
</dd>
<dt><strong>access_df: pandas.DataFrame</strong></dt><dd><p>dataframe with ‘idx’ and ‘omaz’ columns</p>
</dd>
<dt><strong>egress_df: pandas.DataFrame</strong></dt><dd><p>dataframe with ‘idx’ and ‘dmaz’ columns</p>
</dd>
<dt><strong>chooser_attributes: pandas.DataFrame</strong></dt><dd></dd>
<dt><strong>path_info</strong></dt><dd></dd>
<dt><strong>trace_label: str</strong></dt><dd></dd>
<dt><strong>trace: boolean</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>transit_df: pandas.dataframe</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.TransitVirtualPathBuilder.lookup_tap_tap_utilities">
<span class="sig-name descname"><span class="pre">lookup_tap_tap_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">recipe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maz_od_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">access_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">egress_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chooser_attributes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder.lookup_tap_tap_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>create transit_df and compute utilities for all atap-btap pairs between omaz in access and dmaz in egress_df
look up the utilities in the precomputed tap_cache data (which is indexed by uid_calculator unique_ids)
(unique_id can used as a zero-based index into the data array)</p>
<p>transit_df contains all possible access omaz/btap to egress dmaz/atap transit path pairs for each chooser</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>recipe</strong></dt><dd></dd>
<dt><strong>maz_od_df</strong></dt><dd></dd>
<dt><strong>access_df</strong></dt><dd></dd>
<dt><strong>egress_df</strong></dt><dd></dd>
<dt><strong>chooser_attributes</strong></dt><dd></dd>
<dt><strong>path_info</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.pathbuilder.</span></span><span class="sig-name descname"><span class="pre">TransitVirtualPathLogsumWrapper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pathbuilder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">orig_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tod_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">recipe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_choices</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper" title="Permalink to this definition">#</a></dt>
<dd><p>Transit virtual path builder logsum wrapper for three zone systems</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper.set_df">
<span class="sig-name descname"><span class="pre">set_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper.set_df" title="Permalink to this definition">#</a></dt>
<dd><p>Set the dataframe</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">DataFrame</span></dt><dd><p>The dataframe which contains the origin and destination ids</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>self (to facilitiate chaining)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder.compute_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.pathbuilder.</span></span><span class="sig-name descname"><span class="pre">compute_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_constants</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder.compute_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>Compute utilities</p>
</dd></dl>

</section>
<section id="module-activitysim.core.pathbuilder_cache">
<span id="cache-api"></span><h3>Cache API<a class="headerlink" href="#module-activitysim.core.pathbuilder_cache" title="Permalink to this heading">#</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.pathbuilder_cache.</span></span><span class="sig-name descname"><span class="pre">TVPBCache</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="#activitysim.core.los.Network_LOS" title="activitysim.core.los.Network_LOS"><span class="pre">Network_LOS</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">uid_calculator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache_tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache" title="Permalink to this definition">#</a></dt>
<dd><p>Transit virtual path builder cache for three zone systems</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache.allocate_data_buffer">
<span class="sig-name descname"><span class="pre">allocate_data_buffer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shared</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache.allocate_data_buffer" title="Permalink to this definition">#</a></dt>
<dd><p>allocate fully_populated_shape data buffer for cached data</p>
<p>if shared, return a multiprocessing.Array that can be shared across subprocesses
if not shared, return a numpy ndarrray</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>shared: boolean</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>multiprocessing.Array or numpy ndarray sized to hole fully_populated utility array</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache.cleanup">
<span class="sig-name descname"><span class="pre">cleanup</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache.cleanup" title="Permalink to this definition">#</a></dt>
<dd><p>Called prior to</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache.close">
<span class="sig-name descname"><span class="pre">close</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trace</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache.close" title="Permalink to this definition">#</a></dt>
<dd><p>write any changes, free data, and mark as closed</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache.get_data_and_lock_from_buffers">
<span class="sig-name descname"><span class="pre">get_data_and_lock_from_buffers</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache.get_data_and_lock_from_buffers" title="Permalink to this definition">#</a></dt>
<dd><p>return shared data buffer previously allocated by allocate_data_buffer and injected mp_tasks.run_simulation
Returns
——-
either multiprocessing.Array and lock or multiprocessing.RawArray and None according to RAWARRAY</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TVPBCache.open">
<span class="sig-name descname"><span class="pre">open</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TVPBCache.open" title="Permalink to this definition">#</a></dt>
<dd><p>open STATIC cache and populate with cached data</p>
<dl class="simple">
<dt>if multiprocessing</dt><dd><p>always STATIC cache with data fully_populated preloaded shared data buffer</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TapTapUidCalculator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.pathbuilder_cache.</span></span><span class="sig-name descname"><span class="pre">TapTapUidCalculator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator" title="Permalink to this definition">#</a></dt>
<dd><p>Transit virtual path builder TAP to TAP unique ID calculator for three zone systems</p>
<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_od_dataframe">
<span class="sig-name descname"><span class="pre">get_od_dataframe</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">scalar_attributes</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_od_dataframe" title="Permalink to this definition">#</a></dt>
<dd><p>return tap-tap od dataframe with unique_id index for ‘skim_offset’ for scalar_attributes</p>
<p>i.e. a dataframe which may be used to compute utilities, together with scalar or column attributes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>scalar_attributes: dict of scalar attribute name:value pairs</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.Dataframe</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_unique_ids">
<span class="sig-name descname"><span class="pre">get_unique_ids</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scalar_attributes</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_unique_ids" title="Permalink to this definition">#</a></dt>
<dd><p>compute canonical unique_id for each row in df
btap and atap will be in dataframe, but the other attributes may be either df columns or scalar_attributes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df: pandas DataFrame</strong></dt><dd><p>with btap, atap, and optionally additional attribute columns</p>
</dd>
<dt><strong>scalar_attributes: dict</strong></dt><dd><p>dict of scalar attributes e.g. {‘tod’: ‘AM’, ‘demographic_segment’: 0}</p>
</dd>
<dt><strong>Returns</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
<dt><strong>ndarray of integer uids</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="visualization">
<span id="id17"></span><h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this heading">#</a></h2>
<p>Visualization capabilities are provided with SimWrapper, a standalone browser-based software that creates interactive, graphical visualizations of ActivitySim outputs. SimWrapper builds graphs and other visualization components from CSV summary tables that are produced by the <em>summarize</em> model step. Once the model run is complete, Simwrapper can be started and stopped at any time, independent of ActivitySim to visualize outputs. The tool currently allows users to view dashboards for multiple model runs side-by-side in the browser. The ability to compute and visualize the differences between two model runs is a planned future enhancement.</p>
<p>To use set up the summarize model to produce tables for SimWrapper, add <code class="docutils literal notranslate"><span class="pre">summarize</span></code> to the list of models in <code class="docutils literal notranslate"><span class="pre">configs_mp/settings.yaml</span></code> and add the following files to the <cite>config</cite> directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">summarize.yaml</span></code>: configuration for the summarize model step</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">summarize.csv:</span></code> expression file containing the final aggregations that will be generated at the end of the model run</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">summarize_preprocessor.csv</span></code>: intermediate expression file used to add columns, including skim summaries, to the <code class="docutils literal notranslate"><span class="pre">trips_merged</span></code> pipeline table</p></li>
</ul>
<p>In the output directory, add a new summarize directory, which must contain:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dashboard-1-summary.yaml</span></code>: configuration for the layout and formatting of charts and other objects in the dashboard</p></li>
<li><p>Additional <code class="docutils literal notranslate"><span class="pre">dashboard-\*.yaml</span></code> files may be used to configure additional dashboard tabs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">topsheet.yaml</span></code>: configuration for calculated statistics in the ‘At-a-Glance’ table at the top of the dashboard</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">/output/summarize</span></code> directory may also contain one or more .geojson files to support map-based visualizations in the dashboard.</p></li>
</ul>
<p>At present, example versions of all of the items above are located in the prototype MTC example model: <code class="docutils literal notranslate"><span class="pre">/activitysim/examples/prototype_mtc</span></code>. Complete documentation for configuring dashboards is available in the <a class="reference external" href="https://simwrapper.github.io/docs/simwrapper-intro">SimWrapper Docs</a>.</p>
<section id="configure-the-summarize-model">
<h3>Configure the Summarize Model<a class="headerlink" href="#configure-the-summarize-model" title="Permalink to this heading">#</a></h3>
<section id="summary-expressions">
<h4>Summary Expressions<a class="headerlink" href="#summary-expressions" title="Permalink to this heading">#</a></h4>
<p>Example configuration files for the summarize model step (as listed above) are included in prototype MTC example. These files will need to be adjusted to produce customized SimWrapper dashboards. These files are structured as standard ActivitySim expression (CSV) and configuration (YAML) files. More detailed information about configuration of the summarize model step is available in the Models documentation.</p>
<p>You may wish to manipulate the default expression files to suit your particular needs. Expression files are formatted as CSVs and structured according to ActivitySim conventions with three columns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Description</span></code>: Brief description of expression. Non-functional and may be left blank.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Output</span></code>: Name of expression output. Will be used to name either the CSV or local variable storing the expression output.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Expression</span></code>: Python expression that will be evaluated to produce the output.</p></li>
</ul>
<p>Rows with output values that begin with an alphanumeric character will be saved to a CSV (e.g., <code class="docutils literal notranslate"><span class="pre">output_name</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">output_name.csv</span></code>). These expressions must yield a Pandas Series, DataFrame, or another object with a <code class="docutils literal notranslate"><span class="pre">to_csv</span></code> method.</p>
<p>Rows with output values that begin with underscores (e.g., <code class="docutils literal notranslate"><span class="pre">_output_name</span></code>) will be stored as temporary variables in the local namespace so they can be used in following expressions. Expressions defining temporary variables can produce any data type. Users are encouraged to follow the ActivitySim convention using capitals to denote constants (e.g., <code class="docutils literal notranslate"><span class="pre">_TEMP_CONSTANT</span></code>), though this convention is not formally enforced for summarize expressions.</p>
<p>Summarize expressions can make use of several convenience functions for binning numeric Pandas Series’ into quantiles, equal intervals, or manually-specified ranges. These functions are available in the local namespace used to evaluate summarize expressions (as well as for preprocessing the <code class="docutils literal notranslate"><span class="pre">trips_merged</span></code> table; see below), so they can be used directly in summary expressions. These functions include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">quantiles</span></code>: Construct quantiles from a Series given a number of bins.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spaced_intervals</span></code>: Construct evenly-spaced intervals from a Series given a starting value and bin size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">equal_intervals</span></code>: Construct equally-spaced intervals across the entire range of a Series.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">manual_breaks</span></code>: Classify numeric data in a Series into manually-defined bins.</p></li>
</ul>
<p>For example population density quintiles could be calculated with the expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quantiles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">land_use</span><span class="o">.</span><span class="n">TOTPOP</span><span class="o">/</span><span class="n">land_use</span><span class="o">.</span><span class="n">TOTACRE</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">label_format</span><span class="p">:</span><span class="s1">&#39;</span><span class="si">{rank}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">label_format</span></code> parameter uses f-string formatting to specify how bins should be labeled. Several named variables are automatically available in the local namespace for use in labels:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">left</span></code>: Left extent, or minimum, of the bin range</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mid</span></code>: Center of the bin range</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">right</span></code>: Right extent, or maximum, of the bin range</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rank</span></code>: Numeric rank of the bin, with 1 being the lowest rank</p></li>
</ul>
<p>By default, bins are labeled with their extents using the following f-string: <code class="docutils literal notranslate"><span class="pre">'{left:,.2f}</span> <span class="pre">-</span> <span class="pre">{right:,.2f}'</span></code>. The <code class="docutils literal notranslate"><span class="pre">'{rank}'</span></code> option demonstrated above would label each bin with its ordinal rank. Numeric labels are converted to numeric data types, if possible.</p>
<p>Examples of each summarize function are included in the <code class="docutils literal notranslate"><span class="pre">summarize.csv</span></code> expression file for the prototype MTC example. Consult the docstrings for each function in the <code class="docutils literal notranslate"><span class="pre">/activitysim/abm/models/summarize.py</span></code> module for complete specification of parameters.</p>
</section>
<section id="preprocessing">
<h4>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading">#</a></h4>
<p>Pipeline tables available for summarization can be preprocessed to include columns that bin or aggregate existing columns into categories or add skim data related to trips or tours. Preprocessing is configured both in <code class="docutils literal notranslate"><span class="pre">summarize.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">summarize_preprocessor.csv</span></code>.</p>
<p>Binning and aggregation operations that should take place <em>before</em> expressions are calculated, in order to produce a new column in a pipeline table, can be specified in <code class="docutils literal notranslate"><span class="pre">summarize.yaml</span></code>. This can be useful for reducing clutter and redundancy in the summary expressions file.</p>
<p>Binning during the preprocessing stage uses the same convenience functions available for expression files but specifies them in the configuration YAML. To calculate manually-defined income categories, for example, the YAML would include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>persons_merged:                      # Pipeline table on which to operate
  BIN:
    # Manually-specified bins
    - column: income                 # Column on which to operate
      label: income_category         # New column to make
      type: manual_breaks            # Binning function
      bin_breaks:                    # Must include lower and upper extents;
        - 0                          # (One more value than the number of bins)
        - 25000
        - 50000
        - 75000
        - 100000
        - 999999
      bin_labels:                    # (optional)
        - Very Low Income ($0-$25k)
        - Low Income ($25k-$50k)
        - Medium Income ($50k-$75k)
        - High Income ($75k-$100k)
        - Very High Income (&gt;$100k)
</pre></div>
</div>
<p>Example uses of each binning function are included in the <code class="docutils literal notranslate"><span class="pre">summarize.yaml</span></code> configuration file in the prototype MTC example.</p>
<p>Table columns can also be aggregated, or “remapped,” during the preprocessing stage. Aggregations are specified in the configuration YAML using a key-value  structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trips_merged</span><span class="p">:</span>                        <span class="c1"># Pipeline table on which to operate</span>
  <span class="n">AGGREGATE</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">column</span><span class="p">:</span> <span class="n">major_trip_mode</span>        <span class="c1"># Column on which to operate</span>
      <span class="n">label</span><span class="p">:</span> <span class="n">major_trip_mode</span>         <span class="c1"># New column to make</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="n">DRIVEALONEFREE</span><span class="p">:</span> <span class="n">SOV</span>          <span class="c1"># Keys: Existing values to map from</span>
        <span class="n">DRIVEALONEPAY</span><span class="p">:</span> <span class="n">SOV</span>           <span class="c1"># Values: New values to map to</span>
        <span class="n">SHARED2FREE</span><span class="p">:</span> <span class="n">HOV</span>
        <span class="n">SHARED2PAY</span><span class="p">:</span> <span class="n">HOV</span>
        <span class="n">SHARED3FREE</span><span class="p">:</span> <span class="n">HOV</span>
        <span class="n">SHARED3PAY</span><span class="p">:</span> <span class="n">HOV</span>
        <span class="n">WALK_LOC</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">WALK_LRF</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">WALK_EXP</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">WALK_HVY</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">WALK_COM</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVE_LOC</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVE_LRF</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVE_EXP</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVE_HVY</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVE_COM</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">DRIVEACCESS</span><span class="p">:</span> <span class="n">Transit</span>
        <span class="n">WALK</span><span class="p">:</span> <span class="n">Non</span><span class="o">-</span><span class="n">Motorized</span>
        <span class="n">BIKE</span><span class="p">:</span> <span class="n">Non</span><span class="o">-</span><span class="n">Motorized</span>
        <span class="n">TAXI</span><span class="p">:</span> <span class="n">Ride</span> <span class="n">Hail</span>
        <span class="n">TNC_SINGLE</span><span class="p">:</span> <span class="n">Ride</span> <span class="n">Hail</span>
        <span class="n">TNC_SHARED</span><span class="p">:</span> <span class="n">Ride</span> <span class="n">Hail</span>
</pre></div>
</div>
<p>Trip-level skim data are also made available in the preprocessing stage by attaching columns to the <code class="docutils literal notranslate"><span class="pre">trips_merged</span></code> table based on expressions in <code class="docutils literal notranslate"><span class="pre">summarize_preprocessor.csv</span></code>. This process uses skim wrappers indexed by origin, destination, and time of day to gather distance, time, and cost data and each trip, enabling calculation of variables such as vehicle miles traveled (VMT). Preprocessing expressions are interpreted with standard ActivitySim annotation methods, including definition of scalar and vector temporary variables based on underscores and capitalization. The preprocessor expressions included in the prototype MTC example demonstrate calculation of a number of skim-based variables involving distance, time, and cost. The system for joining skim data to trips is currently configured for the one-zone MTC example model and will need to be generalized for multi-zone systems in future work.</p>
</section>
</section>
<section id="install-and-run-simwrapper">
<h3>Install and Run Simwrapper<a class="headerlink" href="#install-and-run-simwrapper" title="Permalink to this heading">#</a></h3>
<p>The SimWrapper Python package, which contains convenience functions for initiating the SimWrapper app in the browser and a local file server for accessing summary tables from this app, is automatically installed as a dependency of ActivitySim. However, you can also use SimWrapper independent of ActivitySim to, for example, visualize summaries on a different workstation. SimWrapper is available on both conda-forge and pip:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">simwrapper</span>
</pre></div>
</div>
<p>or</p>
<blockquote>
<div><p>&gt; pip install simwrapper</p>
</div></blockquote>
<p>The latest information about the Simwrapper package is available on its <a class="reference external" href="https://pypi.org/project/simwrapper/">PyPI page</a>.</p>
<p>To run SimWrapper, navigate on the command line to <code class="docutils literal notranslate"><span class="pre">output\summarize</span></code> within the model directory, or a directory where you may have copied outputs, and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">simwrapper</span> <span class="nb">open</span> <span class="n">asim</span>
</pre></div>
</div>
<p>This will start SimWrapper in your default browser. If this directory contains the appropriate configuration files for a dashboard (see above), the dashboard will open automatically. Otherwise, SimWrapper will show a file browser with the contents of the directory.</p>
</section>
<section id="navigate-simwrappper">
<h3>Navigate SimWrappper<a class="headerlink" href="#navigate-simwrappper" title="Permalink to this heading">#</a></h3>
<p>When Simwrapper launches, the dashboard is displayed in the scrollable field in the main part of the browser window, and there are
two sets of navigation controls.  The left-hand sidebar contains a menu of the available simulation outputs you can access from the
current directory, including a number of sample outputs:</p>
<img alt="_images/viz_nav-1.png" src="_images/viz_nav-1.png" />
<p>The header and tabs at the top of the page help you navigate within the simulation run that is currently being visualized:</p>
<img alt="_images/viz_nav-2.png" src="_images/viz_nav-2.png" />
<p>Clicking on ‘Details’ will switch from the visualizations view to a current directory listing to facilitate viewing and downloading of
the code and raw data used to create the dashboard:</p>
<img alt="_images/viz_nav-3.png" src="_images/viz_nav-3.png" />
<p>Clicking on ‘Topsheet’ returns you to the visualization graphics page.  The three buttons in the lower left corner provide additional
functionality to:</p>
<ol class="arabic simple">
<li><p>re-sync with the latest version of the output files,</p></li>
<li><p>toggle light theme vs. dark theme, and</p></li>
<li><p>split the visualization window into two separate panels like this:</p></li>
</ol>
<img alt="_images/viz_nav-4.png" src="_images/viz_nav-4.png" />
<p>Before starting the split-screen view, choose the model run that you want to appear in the right side pane (‘1-sf-run’ in the image above).
Then, click on the split view button to divide the window into two visualization panels.  Finally, use the left-hand navigation pane to
change the comparison run on the left side (‘2-nine-county’ in the image above).</p>
<p>Each side of the split screen has independent header navigation (Topsheet vs. Details) and independent vertical and horizontal scrolling.
However, panning and zooming on any one map object controls all maps on both sides of the split view at the same time:</p>
<img alt="_images/viz_nav-5.png" src="_images/viz_nav-5.png" />
</section>
</section>
<section id="helpers">
<span id="id18"></span><h2>Helpers<a class="headerlink" href="#helpers" title="Permalink to this heading">#</a></h2>
<section id="chunk">
<span id="chunk-in-detail"></span><span id="chunk-size"></span><span id="index-0"></span><h3>Chunk<a class="headerlink" href="#chunk" title="Permalink to this heading">#</a></h3>
<p>Chunking management.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The definition of chunk_size has changed from previous versions of ActivitySim.  The revised definition
of chunk_size simplifies model setup since it is the approximate amount of RAM available to
ActivitySim as opposed to the obscure number of doubles (64-bit numbers) in a chunk of a choosers table.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> is the approximate amount of RAM in bytes (1 Gigabyte or 1 GB is equal to 1,000,000,000 bytes) to allocate to ActivitySim for batch
processing choosers across all processes.  It is specified in bytes, for example <code class="docutils literal notranslate"><span class="pre">chunk_size:</span> <span class="pre">500_000_000_000</span></code> is 500 GBs.
If set <code class="docutils literal notranslate"><span class="pre">chunk_training_mode:</span> <span class="pre">disabled</span></code> then no chunking will be performed and ActivitySim will attempt to solve all the
choosers at once across all the processes.  Chunking is required when all the chooser data required to process all the
choosers cannot fit within the available RAM and so ActivitySim must split the choosers into batches and then process the batches in sequence.</p>
<p>Configuration of the <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> depends on several parameters:</p>
<ul class="simple">
<li><p>The amount of machine RAM</p></li>
<li><p>The number of machine processors (CPUs/cores)</p></li>
<li><p>The number of households (and number of zones for aggregate models)</p></li>
<li><p>The amount of headroom required for shared data across processes, such as the skims/network LOS data</p></li>
<li><p>The desired runtimes</p></li>
</ul>
<p>An example helps illustrate configuration of the <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>.  If the example model has 1 million households and the
current submodel is auto ownership, then there are 1 million choosers since every household participates in the auto
ownership model.  In single process mode, ActivitySim would create one chooser table with 1 million rows, assuming this table
and the additional extra data such as the skims can fit within the available memory (RAM).  If the 1 million row table cannot fit
within memory then chunking needs to be setup to split the choosers table into batches that are processed in sequence and small
enough to fit within the available memory.  For example, the choosers table is split into 2 chunks of 500,000 choosers each and then
processed in sequence.  In multi process mode, for example with 10 processes, ActivitySim splits the 1 million households into 10
mini processes each with 100,000 households.  Then for the auto ownership submodel, the chooser table within each process is the
100,000 choosers and there must be enough RAM to simultaneously solve all 10 processes with each 100,000 choosers at once.  If not,
then chunking can be setup so each mini process table of choosers is split into chunks for sequential processing, for example from
10 tables of 100,000 choosers to 20 tables of 50,000 choosers.</p>
<p>If the user desires the fastest runtimes possible given their hardware, model inputs, and model configuration, then ActivitySim
should be configured to use most of the CPUs/cores (physical, not virtual), most of the RAM, and with the <a class="reference internal" href="gettingstarted.html#mkl-settings"><span class="std std-ref">MKL Settings</span></a>. For
example, if the machine has 12 cores and 256 GB of RAM, then try configuring the model with <code class="docutils literal notranslate"><span class="pre">num_processes:</span> <span class="pre">10</span></code> and
<code class="docutils literal notranslate"><span class="pre">chunk_size:</span> <span class="pre">0</span></code> to start and seeing if the model can fit the problem into the available RAM.  If not, then try setting <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>
to something like 225 GB, <code class="docutils literal notranslate"><span class="pre">chunk_size:</span> <span class="pre">225_000_000_000</span></code>.  Experimentation of the desired configuration of the CPUs and RAM should be done
for each new machine and model setup (with respect to the number of households, skims, and model configuration).  In general, more processors
means faster runtimes and more RAM means faster runtimes, but the relationship of processors to RAM is not linear as processors can only
go so fast and because there is more to runtime than processors and RAM, including cache speed, disk speed, etc.  Also, the amount of RAM
to use is approximate and ActivitySim often pushes a bit above the user specified amount due to pandas/numpy memory spikes for
memory intensive operations and so it is recommended to leave some RAM unallocated.  The exact amount to leave unallocated depends on the
parameters above.</p>
<p>To configure chunking behavior, ActivitySim must first be trained with the model setup and machine.  To do so, first
run the model with <code class="docutils literal notranslate"><span class="pre">chunk_training_mode:</span> <span class="pre">training</span></code>.  This tracks the amount of memory used by each table by submodel and writes the results
to a cache file that is then re-used for production runs.  This training mode is significantly slower than production mode since it does
significantly more memory inspection.  For a training mode run, set <code class="docutils literal notranslate"><span class="pre">num_processors</span></code> to about 80% of the avaiable logical processors and <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>
to about 80% of the available RAM.  This will run the model and create the <code class="docutils literal notranslate"><span class="pre">chunk_cache.csv</span></code> file in outputcache for reuse.  After creating
the chunk cache file, the model can be run with <code class="docutils literal notranslate"><span class="pre">chunk_training_mode:</span> <span class="pre">production</span></code> and the desired <code class="docutils literal notranslate"><span class="pre">num_processors</span></code> and <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>.  The
model will read the chunk cache file from the outputcache folder, similar to how it reads cached skims if specified.
The software trains on the size of problem so the cache file can be re-used and only needs to be updated due to significant revisions in population,
expression, skims/network LOS, or changes in machine specs.  If run in production mode and no cache file is found then ActivitySim falls
back to training mode.  A third <code class="docutils literal notranslate"><span class="pre">chunk_training_mode</span></code> is adaptive, which if a cache file exists, runs the model with the starting cache
settings but also updates the cache settings based on additional memory inspection.  This may additionally improve the cache setttings to
reduce runtimes when run in production mode.  If <code class="docutils literal notranslate"><span class="pre">resume_after</span></code> is set, then the chunk cache file is not overwritten in cache directory
since the list of submodels would be incomplete.  A foruth <code class="docutils literal notranslate"><span class="pre">chunk_training_mode</span></code> is disabled, which assumes the model can be run without
chunking due to an abundance of RAM.</p>
<p>The following <code class="docutils literal notranslate"><span class="pre">chunk_methods</span></code> are supported to calculate memory overhead when chunking is enabled:</p>
<ul class="simple">
<li><p>bytes - expected rowsize based on actual size (as reported by numpy and pandas) of explicitly allocated data this can underestimate overhead due to transient data requirements of operations (e.g. merge, sort, transpose)</p></li>
<li><p>uss - expected rowsize based on change in (unique set size) (uss) both as a result of explicit data allocation, and readings by MemMonitor sniffer thread that measures transient uss during time-consuming numpy and pandas operations</p></li>
<li><p>hybrid_uss - hybrid_uss avoids problems with pure uss, especially with small chunk sizes (e.g. initial training chunks) as numpy may recycle cached blocks and show no increase in uss even though data was allocated and logged</p></li>
<li><p>rss - like uss, but for resident set size (rss), which is the portion of memory occupied by a process that is held in RAM</p></li>
<li><p>hybrid_rss - like hybrid_uss, but for rss</p></li>
</ul>
<p>RSS is reported by psutil.memory_info and USS is reported by psutil.memory_full_info.  USS is the memory which is private to
a process and which would be freed if the process were terminated.  This is the metric that most closely matches the rather
vague notion of memory “in use” (the meaning of which is difficult to pin down in operating systems with virtual memory
where memory can (but sometimes can’t) be swapped or mapped to disk.  <code class="docutils literal notranslate"><span class="pre">hybrid_uss</span></code> performs best and is most reliable and
is therefore the default.</p>
<p>Additional chunking settings:</p>
<ul class="simple">
<li><p>min_available_chunk_ratio: 0.05 - minimum fraction of total chunk_size to reserve for adaptive chunking</p></li>
<li><p>default_initial_rows_per_chunk: 500 - initial number of chooser rows for first chunk in training mode, when there is no pre-existing chunk_cache to set initial value, ordinarily bigger is better as long as it is not so big it causes memory issues (e.g. accessibility with lots of zones)</p></li>
<li><p>keep_chunk_logs: True - whether to preserve or delete subprocess chunk logs when they are consolidated at end of multiprocess run</p></li>
<li><p>keep_mem_logs: True - whether to preserve or delete subprocess mem logs when they are consolidated at end of multiprocess run</p></li>
</ul>
<section id="id19">
<h4>API<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.chunk"></span><dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.chunk.ChunkHistorian">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">ChunkHistorian</span></span><a class="headerlink" href="#activitysim.core.chunk.ChunkHistorian" title="Permalink to this definition">#</a></dt>
<dd><p>Utility for estimating row_size</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="activitysim.core.chunk.DEFAULT_CHUNK_METHOD">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">DEFAULT_CHUNK_METHOD</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'hybrid_uss'</span></em><a class="headerlink" href="#activitysim.core.chunk.DEFAULT_CHUNK_METHOD" title="Permalink to this definition">#</a></dt>
<dd><p>The chunk_cache table is a record of the memory usage and observed row_size required for chunking the various models.
The row size differs depending on whether memory usage is calculated by rss, uss, or explicitly allocated bytes.
We record all three during training so the mode can be changed without necessitating retraining.</p>
<p>tag,                               num_rows, rss,   uss,   bytes,    uss_row_size, hybrid_uss_row_size, bytes_row_size
atwork_subtour_frequency.simple,   3498,     86016, 81920, 811536,   24,           232,                 232
atwork_subtour_mode_choice.simple, 704,      20480, 20480, 1796608,  30,           2552,                2552
atwork_subtour_scheduling.tour_1,  701,      24576, 24576, 45294082, 36,           64614,               64614
atwork_subtour_scheduling.tour_n,  3,        20480, 20480, 97734,    6827,         32578,               32578
auto_ownership_simulate.simulate,  5000,     77824, 24576, 1400000,  5,            280,                 280</p>
<dl class="simple">
<dt>MODE_RETRAIN</dt><dd><p>rebuild chunk_cache table and save/replace in output/cache/chunk_cache.csv
preforms a complete rebuild of chunk_cache table by doing adaptive chunking starting with based on default initial
settings (see configuration.settings) and observing rss, uss, and allocated bytes to compute rows_size.
This will run somewhat slower than the other modes because of overhead of small first chunk, and possible
instability in the second chunk due to inaccuracies caused by small initial chunk_size sample</p>
</dd>
<dt>MODE_ADAPTIVE</dt><dd><p>Use the existing chunk_cache to determine the sizing for the first chunk for each model, but also use the
observed row_size to adjust the estimated row_size for subsequent chunks. At the end of hte run, writes the
updated chunk_cache to the output directory, but doesn’t overwrite the ‘official’ cache file. If the user wishes
they can replace the chunk_cache with the updated versions but this is not done automatically as it is not clear
this would be the desired behavior. (Might become clearer over time as this is exercised further.)</p>
</dd>
<dt>MODE_PRODUCTION</dt><dd><p>Since overhead changes we don’t necessarily want the same number of rows per chunk every time
but we do use the row_size from cache which we trust is stable
(the whole point of MODE_PRODUCTION is to avoid the cost of observing overhead)
which is stored in self.initial_row_size because initial_rows_per_chunk used it for the first chunk</p>
</dd>
<dt>MODE_CHUNKLESS</dt><dd><p>Do not do chunking, and also do not check or log memory usage, so ActivitySim can focus on performance
assuming there is abundant RAM.</p>
</dd>
<dt>MODE_EXPLICIT</dt><dd><p>Allow the user to explicitly set a chunk size (number of chooser row per chunk)
for each component. No assessment of overhead is made, and all responsibility
for monitoring RAM usage is and ensuring quality performance is transferred to the
model user.  If a component is missing an <cite>explicit_chunk</cite> setting, it is assumed
to be run in a single chunk.</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="activitysim.core.chunk.MemMonitor">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">MemMonitor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">stop_snooping</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/threading.html#threading.Event" title="(in Python v3.14)"><span class="pre">Event</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.chunk.MemMonitor" title="Permalink to this definition">#</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="activitysim.core.chunk.MemMonitor.run">
<span class="sig-name descname"><span class="pre">run</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.chunk.MemMonitor.run" title="Permalink to this definition">#</a></dt>
<dd><p>Method representing the thread’s activity.</p>
<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object’s constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.chunk.adaptive_chunked_choosers_and_alts">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">adaptive_chunked_choosers_and_alts</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.14)"><span class="pre">int</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">explicit_chunk_size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.14)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.chunk.adaptive_chunked_choosers_and_alts" title="Permalink to this definition">#</a></dt>
<dd><p>generator to iterate over choosers and alternatives in chunk_size chunks</p>
<p>like chunked_choosers, but also chunks alternatives
for use with sampled alternatives which will have different alternatives (and numbers of alts)</p>
<p>There may be up to sample_size (or as few as one) alternatives for each chooser
because alternatives may have been sampled more than once,  but pick_count for those
alternatives will always sum to sample_size.</p>
<p>When we chunk the choosers, we need to take care chunking the alternatives as there are
varying numbers of them for each chooser. Since alternatives appear in the same order
as choosers, we can use cumulative pick_counts to identify boundaries of sets of alternatives</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>alternatives</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>sample alternatives including pick_count column in same order as choosers</p>
</dd>
</dl>
</dd>
<dt class="field-even">Yields<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>i</strong><span class="classifier">int</span></dt><dd><p>one-based index of current chunk</p>
</dd>
<dt><strong>num_chunks</strong><span class="classifier">int</span></dt><dd><p>total number of chunks that will be yielded</p>
</dd>
<dt><strong>choosers</strong><span class="classifier">pandas DataFrame slice</span></dt><dd><p>chunk of choosers</p>
</dd>
<dt><strong>alternatives</strong><span class="classifier">pandas DataFrame slice</span></dt><dd><p>chunk of alternatives for chooser chunk</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.chunk.chunk_log">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">chunk_log</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">base</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.chunk.chunk_log" title="Permalink to this definition">#</a></dt>
<dd><p>Chunk management.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>chunk_tag</strong><span class="classifier">str, optional</span></dt><dd></dd>
<dt><strong>base</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Yields<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>ChunkSizer</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.chunk.overhead_for_chunk_method">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.chunk.</span></span><span class="sig-name descname"><span class="pre">overhead_for_chunk_method</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">overhead</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">method</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.chunk.overhead_for_chunk_method" title="Permalink to this definition">#</a></dt>
<dd><p>return appropriate overhead for row_size calculation based on current chunk_method</p>
<ul class="simple">
<li><p>by ChunkSizer.adaptive_rows_per_chunk to determine observed_row_size based on cum_overhead and cum_rows</p></li>
<li><p>by ChunkSizer.initial_rows_per_chunk to determine initial row_size using cached_history and current chunk_method</p></li>
<li><p>by consolidate_logs to add informational row_size column to cache file based on chunk_method for training run</p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>overhead: dict keyed by metric or DataFrame with columns</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>chunk_method overhead (possibly hybrid, depending on chunk_method)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="utilities">
<h3>Utilities<a class="headerlink" href="#utilities" title="Permalink to this heading">#</a></h3>
<p>Vectorized helper functions</p>
<section id="id20">
<h4>API<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.util"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.assign_in_place">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">assign_in_place</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">downcast_int</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">downcast_float</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.assign_in_place" title="Permalink to this definition">#</a></dt>
<dd><p>update existing row values in df from df2, adding columns to df if they are not there</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>assignment left-hand-side (dest)</p>
</dd>
<dt><strong>df2: pd.DataFrame</strong></dt><dd><p>assignment right-hand-side (source)</p>
</dd>
<dt><strong>downcast_int: bool</strong></dt><dd><p>if True, downcast int columns if possible</p>
</dd>
<dt><strong>downcast_float: bool</strong></dt><dd><p>if True, downcast float columns if possible</p>
</dd>
<dt><strong>Returns</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.auto_opt_pd_dtypes">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">auto_opt_pd_dtypes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df_</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">downcast_int</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">downcast_float</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">inplace</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v2.3.3)"><span class="pre">DataFrame</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#activitysim.core.util.auto_opt_pd_dtypes" title="Permalink to this definition">#</a></dt>
<dd><p>Automatically downcast Number dtypes for minimal possible,
will not touch other (datetime, str, object, etc)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>df_</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>assignment left-hand-side (dest)</p>
</dd>
<dt><strong>downcast_int: bool</strong></dt><dd><p>if True, downcast int columns if possible</p>
</dd>
<dt><strong>downcast_float: bool</strong></dt><dd><p>if True, downcast float columns if possible</p>
</dd>
<dt><strong>inplace: bool</strong></dt><dd><p>if False, will return a copy of input dataset</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><cite>None</cite> if <cite>inplace=True</cite> or dataframe if <cite>inplace=False</cite></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.drop_unused_columns">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">drop_unused_columns</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom_chooser</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sharrow_enabled</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">additional_columns</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.drop_unused_columns" title="Permalink to this definition">#</a></dt>
<dd><p>Drop unused columns from the chooser table, based on the spec and custom_chooser function.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.iprod">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">iprod</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ints</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.iprod" title="Permalink to this definition">#</a></dt>
<dd><p>Return the product of hte ints in the list or tuple as an unlimited precision python int</p>
<p>Specifically intended to compute arrray/buffer size for skims where np.proc might overflow for default dtypes.
(Narrowing rules for np.prod are different on Windows and linux)
an alternative to the unwieldy: int(np.prod(ints, dtype=np.int64))</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>ints: list or tuple of ints or int wannabees</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>returns python int</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.latest_file_modification_time">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">latest_file_modification_time</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filenames</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable" title="(in Python v3.14)"><span class="pre">Iterable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.latest_file_modification_time" title="Permalink to this definition">#</a></dt>
<dd><p>Find the most recent file modification time.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.left_merge_on_index_and_col">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">left_merge_on_index_and_col</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">left_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">right_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">join_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_col</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.left_merge_on_index_and_col" title="Permalink to this definition">#</a></dt>
<dd><p>like pandas left merge, but join on both index and a specified join_col</p>
<p>FIXME - for now return a series of ov values from specified right_df target_col</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>left_df</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>index name assumed to be same as that of right_df</p>
</dd>
<dt><strong>right_df</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>index name assumed to be same as that of left_df</p>
</dd>
<dt><strong>join_col</strong><span class="classifier">str</span></dt><dd><p>name of column to join on (in addition to index values)
should have same name in both dataframes</p>
</dd>
<dt><strong>target_col</strong><span class="classifier">str</span></dt><dd><p>name of column from right_df whose joined values should be returned as series</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>target_series</strong><span class="classifier">pandas Series</span></dt><dd><p>series of target_col values with same index as left_df
i.e. values joined to left_df from right_df with index of left_df</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.oldest_file_modification_time">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">oldest_file_modification_time</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filenames</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable" title="(in Python v3.14)"><span class="pre">Iterable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.oldest_file_modification_time" title="Permalink to this definition">#</a></dt>
<dd><p>Find the least recent file modification time.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.other_than">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">other_than</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">groups</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bools</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.other_than" title="Permalink to this definition">#</a></dt>
<dd><p>Construct a Series that has booleans indicating the presence of
something- or someone-else with a certain property within a group.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>groups</strong><span class="classifier">pandas.Series</span></dt><dd><p>A column with the same index as <cite>bools</cite> that defines the grouping
of <cite>bools</cite>. The <cite>bools</cite> Series will be used to index <cite>groups</cite> and
then the grouped values will be counted.</p>
</dd>
<dt><strong>bools</strong><span class="classifier">pandas.Series</span></dt><dd><p>A boolean Series indicating where the property of interest is present.
Should have the same index as <cite>groups</cite>.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>others</strong><span class="classifier">pandas.Series</span></dt><dd><p>A boolean Series with the same index as <cite>groups</cite> and <cite>bools</cite>
indicating whether there is something- or something-else within
a group with some property (as indicated by <cite>bools</cite>).</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.quick_loc_df">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">quick_loc_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">loc_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">attribute</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.quick_loc_df" title="Permalink to this definition">#</a></dt>
<dd><p>faster replacement for target_df.loc[loc_list] or target_df.loc[loc_list][attribute]</p>
<p>pandas DataFrame.loc[] indexing doesn’t scale for large arrays (e.g. &gt; 1,000,000 elements)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>loc_list</strong><span class="classifier">list-like (numpy.ndarray, pandas.Int64Index, or pandas.Series)</span></dt><dd></dd>
<dt><strong>target_df</strong><span class="classifier">pandas.DataFrame containing column named attribute</span></dt><dd></dd>
<dt><strong>attribute</strong><span class="classifier">name of column from loc_list to return (or none for all columns)</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.DataFrame or, if attribbute specified, pandas.Series</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.quick_loc_series">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">quick_loc_series</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">loc_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_series</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.quick_loc_series" title="Permalink to this definition">#</a></dt>
<dd><p>faster replacement for target_series.loc[loc_list]</p>
<p>pandas Series.loc[] indexing doesn’t scale for large arrays (e.g. &gt; 1,000,000 elements)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>loc_list</strong><span class="classifier">list-like (numpy.ndarray, pandas.Int64Index, or pandas.Series)</span></dt><dd></dd>
<dt><strong>target_series</strong><span class="classifier">pandas.Series</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.Series</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.read_csv">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">read_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filename</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.read_csv" title="Permalink to this definition">#</a></dt>
<dd><p>Simple read of a CSV file, much faster than pandas.read_csv</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.read_parquet">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">read_parquet</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filename</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.read_parquet" title="Permalink to this definition">#</a></dt>
<dd><p>Simple read of a parquet file</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.reindex">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">reindex</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">series1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">series2</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.reindex" title="Permalink to this definition">#</a></dt>
<dd><p>This reindexes the first series by the second series.  This is an extremely
common operation that does not appear to  be in Pandas at this time.
If anyone knows of an easier way to do this in Pandas, please inform the
UrbanSim developers.</p>
<p>The canonical example would be a parcel series which has an index which is
parcel_ids and a value which you want to fetch, let’s say it’s land_area.
Another dataset, let’s say of buildings has a series which indicate the
parcel_ids that the buildings are located on, but which does not have
land_area.  If you pass parcels.land_area as the first series and
buildings.parcel_id as the second series, this function returns a series
which is indexed by buildings and has land_area as values and can be
added to the buildings dataset.</p>
<p>In short, this is a join on to a different table using a foreign key
stored in the current table, but with only one attribute rather than
for a full dataset.</p>
<p>This is very similar to the pandas “loc” function or “reindex” function,
but neither of those functions return the series indexed on the current
table.  In both of those cases, the series would be indexed on the foreign
table and would require a second step to change the index.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>series1, series2</strong><span class="classifier">pandas.Series</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>reindexed</strong><span class="classifier">pandas.Series</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.reindex_i">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">reindex_i</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">series1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">series2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype=&lt;class</span> <span class="pre">'numpy.int8'&gt;</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.reindex_i" title="Permalink to this definition">#</a></dt>
<dd><p>version of reindex that replaces missing na values and converts to int
helpful in expression files that compute counts (e.g. num_work_tours)</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.to_csv">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">to_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filename</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">index</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.to_csv" title="Permalink to this definition">#</a></dt>
<dd><p>Simple write of a CSV file, much faster than pandas.DataFrame.to_csv</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.util.zarr_file_modification_time">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.util.</span></span><span class="sig-name descname"><span class="pre">zarr_file_modification_time</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">zarr_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.14)"><span class="pre">Path</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.util.zarr_file_modification_time" title="Permalink to this definition">#</a></dt>
<dd><p>Find the most recent file modification time inside a zarr dir.</p>
</dd></dl>

</section>
</section>
<section id="config">
<h3>Config<a class="headerlink" href="#config" title="Permalink to this heading">#</a></h3>
<p>Helper functions for configuring a model run</p>
<section id="id21">
<h4>API<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.config"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.config.filter_warnings">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.config.</span></span><span class="sig-name descname"><span class="pre">filter_warnings</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.config.filter_warnings" title="Permalink to this definition">#</a></dt>
<dd><p>set warning filter to ‘strict’ if specified in settings</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.config.future_component_settings">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.config.</span></span><span class="sig-name descname"><span class="pre">future_component_settings</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">T</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">future_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">T</span></span></span><a class="headerlink" href="#activitysim.core.config.future_component_settings" title="Permalink to this definition">#</a></dt>
<dd><p>Warn users of new required model settings, and substitute default values</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_name: str</strong></dt><dd><p>name of model</p>
</dd>
<dt><strong>model_settings: PydanticBase</strong></dt><dd><p>model_settings from settigns file</p>
</dd>
<dt><strong>future_settings: dict</strong></dt><dd><p>default values for new required settings</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.config.future_model_settings">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.config.</span></span><span class="sig-name descname"><span class="pre">future_model_settings</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">future_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.config.future_model_settings" title="Permalink to this definition">#</a></dt>
<dd><p>Warn users of new required model settings, and substitute default values</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_name: str</strong></dt><dd><p>name of model</p>
</dd>
<dt><strong>model_settings: dict</strong></dt><dd><p>model_settings from settigns file</p>
</dd>
<dt><strong>future_settings: dict</strong></dt><dd><p>default values for new required settings</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt>dict</dt><dd><p>model_settings with any missing future_settings added</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.config.get_logit_model_settings">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.config.</span></span><span class="sig-name descname"><span class="pre">get_logit_model_settings</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.configuration.logit.LogitComponentSettings.html#activitysim.core.configuration.logit.LogitComponentSettings" title="activitysim.core.configuration.logit.LogitComponentSettings"><span class="pre">LogitComponentSettings</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.14)"><span class="pre">dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.14)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.config.get_logit_model_settings" title="Permalink to this definition">#</a></dt>
<dd><p>Read nest spec (for nested logit) from model settings file</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>nests</strong><span class="classifier">dict</span></dt><dd><p>dictionary specifying nesting structure and nesting coefficients</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.config.get_model_constants">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.config.</span></span><span class="sig-name descname"><span class="pre">get_model_constants</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.config.get_model_constants" title="Permalink to this definition">#</a></dt>
<dd><p>Read constants from model settings file</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>constants</strong><span class="classifier">dict</span></dt><dd><p>dictionary of constants to add to locals for use by expressions in model spec</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="mem">
<h3>Mem<a class="headerlink" href="#mem" title="Permalink to this heading">#</a></h3>
<p>Helper functions for tracking memory usage</p>
<section id="id22">
<h4>API<a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.mem"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mem.consolidate_logs">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mem.</span></span><span class="sig-name descname"><span class="pre">consolidate_logs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mem.consolidate_logs" title="Permalink to this definition">#</a></dt>
<dd><p>Consolidate and aggregate subprocess mem logs</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.mem.shared_memory_size">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.mem.</span></span><span class="sig-name descname"><span class="pre">shared_memory_size</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_buffers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.mem.shared_memory_size" title="Permalink to this definition">#</a></dt>
<dd><p>return total size of the multiprocessing shared memory block in data_buffers</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"></dd>
</dl>
</dd></dl>

</section>
</section>
<section id="output">
<h3>Output<a class="headerlink" href="#output" title="Permalink to this heading">#</a></h3>
<p>Write output files and track skim usage.</p>
<section id="id23">
<h4>API<a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h4>
<span class="target" id="module-activitysim.core.steps.output"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.steps.output.coalesce_estimation_data_bundles">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.steps.output.</span></span><span class="sig-name descname"><span class="pre">coalesce_estimation_data_bundles</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#activitysim.core.steps.output.coalesce_estimation_data_bundles" title="Permalink to this definition">#</a></dt>
<dd><p>In estimation mode, estimation data bundles are written to separate subdirectories for each subprocess.
This model will go through each subdirectory and concat / copy the files to the parent directory.
This will only occur if the lowest level directory contains the multiprocess step names.
Only multiprocess step names are used because that’s how EDBs are written in estimation mode.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.steps.output.previous_write_data_dictionary">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.steps.output.</span></span><span class="sig-name descname"><span class="pre">previous_write_data_dictionary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.core.steps.output.previous_write_data_dictionary" title="Permalink to this definition">#</a></dt>
<dd><p>Write table_name, number of rows, columns, and bytes for each checkpointed table</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>output_dir: str</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.steps.output.track_skim_usage">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.steps.output.</span></span><span class="sig-name descname"><span class="pre">track_skim_usage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#activitysim.core.steps.output.track_skim_usage" title="Permalink to this definition">#</a></dt>
<dd><p>write statistics on skim usage (diagnostic to detect loading of un-needed skims)</p>
<p>FIXME - have not yet implemented a facility to avoid loading of unused skims</p>
<p>FIXME - if resume_after, this will only reflect skims used after resume</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>output_dir: str</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.steps.output.write_data_dictionary">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.steps.output.</span></span><span class="sig-name descname"><span class="pre">write_data_dictionary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#activitysim.core.steps.output.write_data_dictionary" title="Permalink to this definition">#</a></dt>
<dd><p>Write table schema for all tables</p>
<dl>
<dt>model settings</dt><dd><p>txt_format: output text file name (default data_dict.txt) or empty to suppress txt output
csv_format: output csv file name (default data_dict.tcsvxt) or empty to suppress txt output</p>
<p>schema_tables: list of tables to include in output (defaults to all checkpointed tables)</p>
</dd>
</dl>
<p>for each table, write column names, dtype, and checkpoint added)</p>
<p>text format writes individual table schemas to a single text file
csv format writes all tables together with an additional table_name column</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>output_dir: str</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.core.steps.output.write_tables">
<span class="sig-prename descclassname"><span class="pre">activitysim.core.steps.output.</span></span><span class="sig-name descname"><span class="pre">write_tables</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="dev-guide/_generated/activitysim.core.workflow.State.html#activitysim.core.workflow.State" title="activitysim.core.workflow.state.State"><span class="pre">State</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.14)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#activitysim.core.steps.output.write_tables" title="Permalink to this definition">#</a></dt>
<dd><p>Write pipeline tables as csv or parquet files (in output directory) as specified
by output_tables list in settings file. Output to parquet or a single h5 file is
also supported.</p>
<p>‘h5_store’ defaults to False, which means the output will be written out to csv.
‘file_type’ defaults to ‘csv’ but can also be used to specify ‘parquet’ or ‘h5’.
When ‘h5_store’ is set to True, ‘file_type’ is ingored and the outputs are written to h5.</p>
<p>‘output_tables’ can specify either a list of output tables to include or to skip
if no output_tables list is specified, then all checkpointed tables will be written</p>
<p>To write all output tables EXCEPT the households and persons tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_tables</span><span class="p">:</span>
  <span class="n">action</span><span class="p">:</span> <span class="n">skip</span>
  <span class="n">tables</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">households</span>
    <span class="o">-</span> <span class="n">persons</span>
</pre></div>
</div>
<p>To write ONLY the households table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_tables</span><span class="p">:</span>
  <span class="n">action</span><span class="p">:</span> <span class="n">include</span>
  <span class="n">tables</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">households</span>
</pre></div>
</div>
<p>To write tables into a single HDF5 store instead of individual CSVs, use the h5_store flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_tables</span><span class="p">:</span>
  <span class="n">h5_store</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">action</span><span class="p">:</span> <span class="n">include</span>
  <span class="n">tables</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">households</span>
</pre></div>
</div>
<p>To write tables to parquet files, use the file_type setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_tables</span><span class="p">:</span>
  <span class="n">file_type</span><span class="p">:</span> <span class="n">parquet</span>
  <span class="n">action</span><span class="p">:</span> <span class="n">include</span>
  <span class="n">tables</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">households</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>output_dir: str</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="tests">
<h3>Tests<a class="headerlink" href="#tests" title="Permalink to this heading">#</a></h3>
<p>See activitysim.core.test</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="dev-guide/components/write_trip_matrices.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Write Trip Matrices</p>
      </div>
    </a>
    <a class="right-next"
       href="benchmarking.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Benchmarking</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiprocessing">Multiprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#module-activitysim.core.mp_tasks">API</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.MEM_TRACE_TICKS"><code class="docutils literal notranslate"><span class="pre">MEM_TRACE_TICKS</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers"><code class="docutils literal notranslate"><span class="pre">allocate_shared_shadow_pricing_buffers()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.allocate_shared_shadow_pricing_buffers_choice"><code class="docutils literal notranslate"><span class="pre">allocate_shared_shadow_pricing_buffers_choice()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.allocate_shared_skim_buffers"><code class="docutils literal notranslate"><span class="pre">allocate_shared_skim_buffers()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.apportion_pipeline"><code class="docutils literal notranslate"><span class="pre">apportion_pipeline()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.build_slice_rules"><code class="docutils literal notranslate"><span class="pre">build_slice_rules()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.coalesce_pipelines"><code class="docutils literal notranslate"><span class="pre">coalesce_pipelines()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.drop_breadcrumb"><code class="docutils literal notranslate"><span class="pre">drop_breadcrumb()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.get_breadcrumbs"><code class="docutils literal notranslate"><span class="pre">get_breadcrumbs()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.get_run_list"><code class="docutils literal notranslate"><span class="pre">get_run_list()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.mp_apportion_pipeline"><code class="docutils literal notranslate"><span class="pre">mp_apportion_pipeline()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.mp_coalesce_pipelines"><code class="docutils literal notranslate"><span class="pre">mp_coalesce_pipelines()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.mp_run_simulation"><code class="docutils literal notranslate"><span class="pre">mp_run_simulation()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.mp_setup_skims"><code class="docutils literal notranslate"><span class="pre">mp_setup_skims()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.parquet_pipeline_table_keys"><code class="docutils literal notranslate"><span class="pre">parquet_pipeline_table_keys()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.pipeline_table_keys"><code class="docutils literal notranslate"><span class="pre">pipeline_table_keys()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.print_run_list"><code class="docutils literal notranslate"><span class="pre">print_run_list()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.read_breadcrumbs"><code class="docutils literal notranslate"><span class="pre">read_breadcrumbs()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.run_multiprocess"><code class="docutils literal notranslate"><span class="pre">run_multiprocess()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.run_simulation"><code class="docutils literal notranslate"><span class="pre">run_simulation()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.run_sub_simulations"><code class="docutils literal notranslate"><span class="pre">run_sub_simulations()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.run_sub_task"><code class="docutils literal notranslate"><span class="pre">run_sub_task()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.setup_injectables_and_logging"><code class="docutils literal notranslate"><span class="pre">setup_injectables_and_logging()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mp_tasks.write_breadcrumbs"><code class="docutils literal notranslate"><span class="pre">write_breadcrumbs()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-management">Data Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.input.read_from_table_info"><code class="docutils literal notranslate"><span class="pre">read_from_table_info()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.input.read_input_file"><code class="docutils literal notranslate"><span class="pre">read_input_file()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.input.read_input_table"><code class="docutils literal notranslate"><span class="pre">read_input_table()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#los">LOS</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS"><code class="docutils literal notranslate"><span class="pre">Network_LOS</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.allocate_shared_skim_buffers"><code class="docutils literal notranslate"><span class="pre">Network_LOS.allocate_shared_skim_buffers()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.create_skim_dict"><code class="docutils literal notranslate"><span class="pre">Network_LOS.create_skim_dict()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.get_default_skim_dict"><code class="docutils literal notranslate"><span class="pre">Network_LOS.get_default_skim_dict()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.get_maz_to_taz_series"><code class="docutils literal notranslate"><span class="pre">Network_LOS.get_maz_to_taz_series()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.get_mazpairs"><code class="docutils literal notranslate"><span class="pre">Network_LOS.get_mazpairs()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.get_skim_dict"><code class="docutils literal notranslate"><span class="pre">Network_LOS.get_skim_dict()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.get_tappairs3d"><code class="docutils literal notranslate"><span class="pre">Network_LOS.get_tappairs3d()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.load_data"><code class="docutils literal notranslate"><span class="pre">Network_LOS.load_data()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.load_settings"><code class="docutils literal notranslate"><span class="pre">Network_LOS.load_settings()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.load_shared_data"><code class="docutils literal notranslate"><span class="pre">Network_LOS.load_shared_data()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.load_skim_info"><code class="docutils literal notranslate"><span class="pre">Network_LOS.load_skim_info()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.map_maz_to_taz"><code class="docutils literal notranslate"><span class="pre">Network_LOS.map_maz_to_taz()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.multiprocess"><code class="docutils literal notranslate"><span class="pre">Network_LOS.multiprocess()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.omx_file_names"><code class="docutils literal notranslate"><span class="pre">Network_LOS.omx_file_names()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.skim_time_period_label"><code class="docutils literal notranslate"><span class="pre">Network_LOS.skim_time_period_label()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.zarr_file_name"><code class="docutils literal notranslate"><span class="pre">Network_LOS.zarr_file_name()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.los.Network_LOS.zarr_pre_encoding"><code class="docutils literal notranslate"><span class="pre">Network_LOS.zarr_pre_encoding()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#skims">Skims</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory"><code class="docutils literal notranslate"><span class="pre">AbstractSkimFactory</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory.allocate_skim_buffer"><code class="docutils literal notranslate"><span class="pre">AbstractSkimFactory.allocate_skim_buffer()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.AbstractSkimFactory.supports_shared_data_for_multiprocessing"><code class="docutils literal notranslate"><span class="pre">AbstractSkimFactory.supports_shared_data_for_multiprocessing</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.JitMemMapSkimData"><code class="docutils literal notranslate"><span class="pre">JitMemMapSkimData</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.JitMemMapSkimData.shape"><code class="docutils literal notranslate"><span class="pre">JitMemMapSkimData.shape</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.MemMapSkimFactory"><code class="docutils literal notranslate"><span class="pre">MemMapSkimFactory</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.MemMapSkimFactory.get_skim_data"><code class="docutils literal notranslate"><span class="pre">MemMapSkimFactory.get_skim_data()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory"><code class="docutils literal notranslate"><span class="pre">NumpyArraySkimFactory</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.allocate_skim_buffer"><code class="docutils literal notranslate"><span class="pre">NumpyArraySkimFactory.allocate_skim_buffer()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.get_skim_data"><code class="docutils literal notranslate"><span class="pre">NumpyArraySkimFactory.get_skim_data()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.load_skims_to_buffer"><code class="docutils literal notranslate"><span class="pre">NumpyArraySkimFactory.load_skims_to_buffer()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.NumpyArraySkimFactory.supports_shared_data_for_multiprocessing"><code class="docutils literal notranslate"><span class="pre">NumpyArraySkimFactory.supports_shared_data_for_multiprocessing</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.SkimData"><code class="docutils literal notranslate"><span class="pre">SkimData</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dict_factory.SkimData.shape"><code class="docutils literal notranslate"><span class="pre">SkimData.shape</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.DataFrameMatrix"><code class="docutils literal notranslate"><span class="pre">DataFrameMatrix</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.DataFrameMatrix.get"><code class="docutils literal notranslate"><span class="pre">DataFrameMatrix.get()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.MazSkimDict"><code class="docutils literal notranslate"><span class="pre">MazSkimDict</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.MazSkimDict.get_skim_usage"><code class="docutils literal notranslate"><span class="pre">MazSkimDict.get_skim_usage()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.MazSkimDict.lookup"><code class="docutils literal notranslate"><span class="pre">MazSkimDict.lookup()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.MazSkimDict.sparse_lookup"><code class="docutils literal notranslate"><span class="pre">MazSkimDict.sparse_lookup()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.OffsetMapper"><code class="docutils literal notranslate"><span class="pre">OffsetMapper</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.OffsetMapper.map"><code class="docutils literal notranslate"><span class="pre">OffsetMapper.map()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_int"><code class="docutils literal notranslate"><span class="pre">OffsetMapper.set_offset_int()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_list"><code class="docutils literal notranslate"><span class="pre">OffsetMapper.set_offset_list()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.OffsetMapper.set_offset_series"><code class="docutils literal notranslate"><span class="pre">OffsetMapper.set_offset_series()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.Skim3dWrapper"><code class="docutils literal notranslate"><span class="pre">Skim3dWrapper</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.Skim3dWrapper.set_df"><code class="docutils literal notranslate"><span class="pre">Skim3dWrapper.set_df()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict"><code class="docutils literal notranslate"><span class="pre">SkimDict</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.get_skim_usage"><code class="docutils literal notranslate"><span class="pre">SkimDict.get_skim_usage()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.lookup"><code class="docutils literal notranslate"><span class="pre">SkimDict.lookup()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.lookup_3d"><code class="docutils literal notranslate"><span class="pre">SkimDict.lookup_3d()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.wrap"><code class="docutils literal notranslate"><span class="pre">SkimDict.wrap()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.wrap_3d"><code class="docutils literal notranslate"><span class="pre">SkimDict.wrap_3d()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimDict.zone_ids"><code class="docutils literal notranslate"><span class="pre">SkimDict.zone_ids</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimWrapper"><code class="docutils literal notranslate"><span class="pre">SkimWrapper</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimWrapper.lookup"><code class="docutils literal notranslate"><span class="pre">SkimWrapper.lookup()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimWrapper.max"><code class="docutils literal notranslate"><span class="pre">SkimWrapper.max()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimWrapper.reverse"><code class="docutils literal notranslate"><span class="pre">SkimWrapper.reverse()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.skim_dictionary.SkimWrapper.set_df"><code class="docutils literal notranslate"><span class="pre">SkimWrapper.set_df()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random">Random</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel"><code class="docutils literal notranslate"><span class="pre">SimpleChannel</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.begin_step"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.begin_step()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.choice_for_df"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.choice_for_df()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.extend_domain"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.extend_domain()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.init_row_states_for_step"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.init_row_states_for_step()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.normal_for_df"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.normal_for_df()</span></code></a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.SimpleChannel.random_for_df"><code class="docutils literal notranslate"><span class="pre">SimpleChannel.random_for_df()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.random.hash32"><code class="docutils literal notranslate"><span class="pre">hash32()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing">Tracing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.ElapsedTimeFormatter"><code class="docutils literal notranslate"><span class="pre">ElapsedTimeFormatter</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.ElapsedTimeFormatter.format"><code class="docutils literal notranslate"><span class="pre">ElapsedTimeFormatter.format()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.delete_output_files"><code class="docutils literal notranslate"><span class="pre">delete_output_files()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.delete_trace_files"><code class="docutils literal notranslate"><span class="pre">delete_trace_files()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.hh_id_for_chooser"><code class="docutils literal notranslate"><span class="pre">hh_id_for_chooser()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.no_results"><code class="docutils literal notranslate"><span class="pre">no_results()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.print_summary"><code class="docutils literal notranslate"><span class="pre">print_summary()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.slice_ids"><code class="docutils literal notranslate"><span class="pre">slice_ids()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.tracing.trace_id_for_chooser"><code class="docutils literal notranslate"><span class="pre">trace_id_for_chooser()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#utility-expressions">Utility Expressions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conventions">Conventions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-expressions-file">Example Expressions File</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expressions">Expressions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.expressions.annotate_preprocessors"><code class="docutils literal notranslate"><span class="pre">annotate_preprocessors()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.expressions.annotate_tables"><code class="docutils literal notranslate"><span class="pre">annotate_tables()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.expressions.assign_columns"><code class="docutils literal notranslate"><span class="pre">assign_columns()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.expressions.compute_columns"><code class="docutils literal notranslate"><span class="pre">compute_columns()</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-with-interaction">Sampling with Interaction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.interaction_sample.interaction_sample"><code class="docutils literal notranslate"><span class="pre">interaction_sample()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.interaction_sample.make_sample_choices"><code class="docutils literal notranslate"><span class="pre">make_sample_choices()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate">Simulate</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.compute_base_probabilities"><code class="docutils literal notranslate"><span class="pre">compute_base_probabilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.compute_nested_exp_utilities"><code class="docutils literal notranslate"><span class="pre">compute_nested_exp_utilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.compute_nested_probabilities"><code class="docutils literal notranslate"><span class="pre">compute_nested_probabilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.dump_mapped_coefficients"><code class="docutils literal notranslate"><span class="pre">dump_mapped_coefficients()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_mnl"><code class="docutils literal notranslate"><span class="pre">eval_mnl()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_mnl_logsums"><code class="docutils literal notranslate"><span class="pre">eval_mnl_logsums()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_nl"><code class="docutils literal notranslate"><span class="pre">eval_nl()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_nl_logsums"><code class="docutils literal notranslate"><span class="pre">eval_nl_logsums()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_utilities"><code class="docutils literal notranslate"><span class="pre">eval_utilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.eval_variables"><code class="docutils literal notranslate"><span class="pre">eval_variables()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.get_segment_coefficients"><code class="docutils literal notranslate"><span class="pre">get_segment_coefficients()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.read_model_coefficient_template"><code class="docutils literal notranslate"><span class="pre">read_model_coefficient_template()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.read_model_coefficients"><code class="docutils literal notranslate"><span class="pre">read_model_coefficients()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.read_model_spec"><code class="docutils literal notranslate"><span class="pre">read_model_spec()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.set_skim_wrapper_targets"><code class="docutils literal notranslate"><span class="pre">set_skim_wrapper_targets()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.simple_simulate"><code class="docutils literal notranslate"><span class="pre">simple_simulate()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.simple_simulate_by_chunk_id"><code class="docutils literal notranslate"><span class="pre">simple_simulate_by_chunk_id()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.simulate.spec_for_segment"><code class="docutils literal notranslate"><span class="pre">spec_for_segment()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-with-interaction">Simulate with Interaction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.interaction_simulate.eval_interaction_utilities"><code class="docutils literal notranslate"><span class="pre">eval_interaction_utilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.interaction_simulate.interaction_simulate"><code class="docutils literal notranslate"><span class="pre">interaction_simulate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-with-sampling-and-interaction">Simulate with Sampling and Interaction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.interaction_sample_simulate.interaction_sample_simulate"><code class="docutils literal notranslate"><span class="pre">interaction_sample_simulate()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assign">Assign</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.assign.assign_variables"><code class="docutils literal notranslate"><span class="pre">assign_variables()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.assign.evaluate_constants"><code class="docutils literal notranslate"><span class="pre">evaluate_constants()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.assign.local_utilities"><code class="docutils literal notranslate"><span class="pre">local_utilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.assign.read_assignment_spec"><code class="docutils literal notranslate"><span class="pre">read_assignment_spec()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.assign.uniquify_key"><code class="docutils literal notranslate"><span class="pre">uniquify_key()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#choice-models">Choice Models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logit">Logit</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.Nest"><code class="docutils literal notranslate"><span class="pre">Nest</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.count_nests"><code class="docutils literal notranslate"><span class="pre">count_nests()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.each_nest"><code class="docutils literal notranslate"><span class="pre">each_nest()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.interaction_dataset"><code class="docutils literal notranslate"><span class="pre">interaction_dataset()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.make_choices"><code class="docutils literal notranslate"><span class="pre">make_choices()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.report_bad_choices"><code class="docutils literal notranslate"><span class="pre">report_bad_choices()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.utils_to_logsums"><code class="docutils literal notranslate"><span class="pre">utils_to_logsums()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.logit.utils_to_probs"><code class="docutils literal notranslate"><span class="pre">utils_to_probs()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#person-time-windows">Person Time Windows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">API</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable"><code class="docutils literal notranslate"><span class="pre">TimeTable</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.adjacent_window_after"><code class="docutils literal notranslate"><span class="pre">TimeTable.adjacent_window_after()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.adjacent_window_before"><code class="docutils literal notranslate"><span class="pre">TimeTable.adjacent_window_before()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.adjacent_window_run_length"><code class="docutils literal notranslate"><span class="pre">TimeTable.adjacent_window_run_length()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.assign"><code class="docutils literal notranslate"><span class="pre">TimeTable.assign()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.assign_footprints"><code class="docutils literal notranslate"><span class="pre">TimeTable.assign_footprints()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.assign_subtour_mask"><code class="docutils literal notranslate"><span class="pre">TimeTable.assign_subtour_mask()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.begin_transaction"><code class="docutils literal notranslate"><span class="pre">TimeTable.begin_transaction()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.max_time_block_available"><code class="docutils literal notranslate"><span class="pre">TimeTable.max_time_block_available()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.previous_tour_begins"><code class="docutils literal notranslate"><span class="pre">TimeTable.previous_tour_begins()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.previous_tour_ends"><code class="docutils literal notranslate"><span class="pre">TimeTable.previous_tour_ends()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.remaining_periods_available"><code class="docutils literal notranslate"><span class="pre">TimeTable.remaining_periods_available()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.replace_table"><code class="docutils literal notranslate"><span class="pre">TimeTable.replace_table()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.slice_windows_by_row_id"><code class="docutils literal notranslate"><span class="pre">TimeTable.slice_windows_by_row_id()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.tour_available"><code class="docutils literal notranslate"><span class="pre">TimeTable.tour_available()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.TimeTable.window_periods_in_states"><code class="docutils literal notranslate"><span class="pre">TimeTable.window_periods_in_states()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.create_timetable_windows"><code class="docutils literal notranslate"><span class="pre">create_timetable_windows()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.sharrow_tt_remaining_periods_available"><code class="docutils literal notranslate"><span class="pre">sharrow_tt_remaining_periods_available()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.tt_remaining_periods_available"><code class="docutils literal notranslate"><span class="pre">tt_remaining_periods_available()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.timetable.tt_slice_windows_by_row_id"><code class="docutils literal notranslate"><span class="pre">tt_slice_windows_by_row_id()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transit-virtual-path-builder">Transit Virtual Path Builder</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">API</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder"><code class="docutils literal notranslate"><span class="pre">TransitVirtualPathBuilder</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder.compute_tap_tap_utilities"><code class="docutils literal notranslate"><span class="pre">TransitVirtualPathBuilder.compute_tap_tap_utilities()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.TransitVirtualPathBuilder.lookup_tap_tap_utilities"><code class="docutils literal notranslate"><span class="pre">TransitVirtualPathBuilder.lookup_tap_tap_utilities()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper"><code class="docutils literal notranslate"><span class="pre">TransitVirtualPathLogsumWrapper</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.TransitVirtualPathLogsumWrapper.set_df"><code class="docutils literal notranslate"><span class="pre">TransitVirtualPathLogsumWrapper.set_df()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder.compute_utilities"><code class="docutils literal notranslate"><span class="pre">compute_utilities()</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#module-activitysim.core.pathbuilder_cache">Cache API</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache"><code class="docutils literal notranslate"><span class="pre">TVPBCache</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache.allocate_data_buffer"><code class="docutils literal notranslate"><span class="pre">TVPBCache.allocate_data_buffer()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache.cleanup"><code class="docutils literal notranslate"><span class="pre">TVPBCache.cleanup()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache.close"><code class="docutils literal notranslate"><span class="pre">TVPBCache.close()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache.get_data_and_lock_from_buffers"><code class="docutils literal notranslate"><span class="pre">TVPBCache.get_data_and_lock_from_buffers()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TVPBCache.open"><code class="docutils literal notranslate"><span class="pre">TVPBCache.open()</span></code></a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator"><code class="docutils literal notranslate"><span class="pre">TapTapUidCalculator</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_od_dataframe"><code class="docutils literal notranslate"><span class="pre">TapTapUidCalculator.get_od_dataframe()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.pathbuilder_cache.TapTapUidCalculator.get_unique_ids"><code class="docutils literal notranslate"><span class="pre">TapTapUidCalculator.get_unique_ids()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-the-summarize-model">Configure the Summarize Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-expressions">Summary Expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-and-run-simwrapper">Install and Run Simwrapper</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#navigate-simwrappper">Navigate SimWrappper</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helpers">Helpers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chunk">Chunk</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.ChunkHistorian"><code class="docutils literal notranslate"><span class="pre">ChunkHistorian</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.DEFAULT_CHUNK_METHOD"><code class="docutils literal notranslate"><span class="pre">DEFAULT_CHUNK_METHOD</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.MemMonitor"><code class="docutils literal notranslate"><span class="pre">MemMonitor</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.MemMonitor.run"><code class="docutils literal notranslate"><span class="pre">MemMonitor.run()</span></code></a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.adaptive_chunked_choosers_and_alts"><code class="docutils literal notranslate"><span class="pre">adaptive_chunked_choosers_and_alts()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.chunk_log"><code class="docutils literal notranslate"><span class="pre">chunk_log()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.chunk.overhead_for_chunk_method"><code class="docutils literal notranslate"><span class="pre">overhead_for_chunk_method()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#utilities">Utilities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.assign_in_place"><code class="docutils literal notranslate"><span class="pre">assign_in_place()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.auto_opt_pd_dtypes"><code class="docutils literal notranslate"><span class="pre">auto_opt_pd_dtypes()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.drop_unused_columns"><code class="docutils literal notranslate"><span class="pre">drop_unused_columns()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.iprod"><code class="docutils literal notranslate"><span class="pre">iprod()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.latest_file_modification_time"><code class="docutils literal notranslate"><span class="pre">latest_file_modification_time()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.left_merge_on_index_and_col"><code class="docutils literal notranslate"><span class="pre">left_merge_on_index_and_col()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.oldest_file_modification_time"><code class="docutils literal notranslate"><span class="pre">oldest_file_modification_time()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.other_than"><code class="docutils literal notranslate"><span class="pre">other_than()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.quick_loc_df"><code class="docutils literal notranslate"><span class="pre">quick_loc_df()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.quick_loc_series"><code class="docutils literal notranslate"><span class="pre">quick_loc_series()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.read_csv"><code class="docutils literal notranslate"><span class="pre">read_csv()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.read_parquet"><code class="docutils literal notranslate"><span class="pre">read_parquet()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.reindex"><code class="docutils literal notranslate"><span class="pre">reindex()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.reindex_i"><code class="docutils literal notranslate"><span class="pre">reindex_i()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.to_csv"><code class="docutils literal notranslate"><span class="pre">to_csv()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.util.zarr_file_modification_time"><code class="docutils literal notranslate"><span class="pre">zarr_file_modification_time()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#config">Config</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.config.filter_warnings"><code class="docutils literal notranslate"><span class="pre">filter_warnings()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.config.future_component_settings"><code class="docutils literal notranslate"><span class="pre">future_component_settings()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.config.future_model_settings"><code class="docutils literal notranslate"><span class="pre">future_model_settings()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.config.get_logit_model_settings"><code class="docutils literal notranslate"><span class="pre">get_logit_model_settings()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.config.get_model_constants"><code class="docutils literal notranslate"><span class="pre">get_model_constants()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mem">Mem</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mem.consolidate_logs"><code class="docutils literal notranslate"><span class="pre">consolidate_logs()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.mem.shared_memory_size"><code class="docutils literal notranslate"><span class="pre">shared_memory_size()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">API</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.steps.output.coalesce_estimation_data_bundles"><code class="docutils literal notranslate"><span class="pre">coalesce_estimation_data_bundles()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.steps.output.previous_write_data_dictionary"><code class="docutils literal notranslate"><span class="pre">previous_write_data_dictionary()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.steps.output.track_skim_usage"><code class="docutils literal notranslate"><span class="pre">track_skim_usage()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.steps.output.write_data_dictionary"><code class="docutils literal notranslate"><span class="pre">write_data_dictionary()</span></code></a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#activitysim.core.steps.output.write_tables"><code class="docutils literal notranslate"><span class="pre">write_tables()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tests">Tests</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/core.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.5.1.dev10+g5963d038c, documentation last updated Nov 12, 2025.<br/>
</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>