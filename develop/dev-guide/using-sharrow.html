
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Using Sharrow &#8212; ActivitySim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=86d88d25" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=58c79ce1"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'dev-guide/using-sharrow';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://activitysim.github.io/activitysim/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3.0';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Skim Dataset" href="skim-dataset.html" />
    <link rel="prev" title="cached_object" href="_generated/activitysim.core.workflow.cached_object.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Mar 07, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ActivitySim</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../users-guide/index.html">
                        Users Guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developers
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../users-guide/index.html">
                        Users Guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developers
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Developer Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="core-workflow.html">Workflow State</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="core-workflow-api.html">State API</a></li>
<li class="toctree-l2"><a class="reference internal" href="core-workflow-steps.html">Workflow Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="core-workflow-table.html">Workflow Tables</a></li>
</ul>
</li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Using Sharrow</a></li>
<li class="toctree-l1"><a class="reference internal" href="skim-dataset.html">Using Skim Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpointing.html">Checkpointing</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Software Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="component-configs.html">Component Configuration</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="components/index.html">Components</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="components/initialize.html">Initialize</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/initialize_los.html">Initialize LOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/initialize_tours.html">Initialize Tours</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/accessibility.html">Accessibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/auto_ownership.html">Auto Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/vehicle_type_choice.html">Vehicle Type Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/telecommute_frequency.html">Telecommute Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/cdap.html">Coordinated Daily Activity Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/mandatory_tour_frequency.html">Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/school_escorting.html">School Escorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/joint_tour_composition.html">Joint Tour Composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/joint_tour_participation.html">Joint Tour Participation</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/joint_tour_destination.html">Joint Tour Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/joint_tour_scheduling.html">Joint Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/non_mandatory_tour_frequency.html">Non-Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/non_mandatory_destination.html">Non-Mandatory Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/non_mandatory_scheduling.html">Non-Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/mandatory_scheduling.html">Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/disaggregate_accessibility.html">Disaggregate Accessibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/free_parking.html">Free Parking Eligibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/school_location_choice.html">School Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/transit_pass_ownership.html">Transit Pass Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/transit_pass_subsidy.html">Transit Pass Subsidy</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_destination.html">Trip Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/work_from_home.html">Work from Home</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/work_location_choice.html">Work Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/tour_mode_choice.html">Tour Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/atwork_subtour_frequency.html">At-work Subtours Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/atwork_subtour_destination.html">At-work Subtours Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/atwork_subtour_scheduling.html">At-work Subtour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/atwork_subtour_mode_choice.html">At-work Subtour Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/stop_frequency.html">Stop Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_purpose.html">Trip Purpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_destination.html">Trip Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_purpose_and_destination.html">Trip Purpose and Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_scheduling_choice.html">Trip Scheduling Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_departure_choice.html">Trip Departure Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/trip_mode_choice.html">Trip Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/parking_location_choice.html">Parking Location Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="components/write_trip_matrices.html">Write Trip Matrices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../core.html">Core Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-docs.html">Documentation</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Developers</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Using Sharrow</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="using-sharrow">
<h1>Using Sharrow<a class="headerlink" href="#using-sharrow" title="Link to this heading">#</a></h1>
<p>This page will walk through an exercise of running a model with <code class="docutils literal notranslate"><span class="pre">sharrow</span></code>.</p>
<section id="how-it-works">
<h2>How it Works<a class="headerlink" href="#how-it-works" title="Link to this heading">#</a></h2>
<p>Sharrow accelerates ActivitySim in part by using numba to create optimized and
pre-compiled versions of utility specification files, and caching those bits
of code to disk.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Running the compiler needs to be done in single-process mode, otherwise the
various process all do the compiling and compete to write to the same cache
location on disk, which is likely to fail.  You can safely run in
multiprocessing mode after all the compilation for all model components is
complete.</p>
</div>
</section>
<section id="model-design-requirements">
<h2>Model Design Requirements<a class="headerlink" href="#model-design-requirements" title="Link to this heading">#</a></h2>
<p>Activating the <code class="docutils literal notranslate"><span class="pre">sharrow</span></code> optimizations also requires using the new
<a class="reference internal" href="skim-dataset.html#skim-datasets"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">SkimDataset</span></code></span></a> interface for skims instead of the legacy
<a class="reference internal" href="../core.html#activitysim.core.skim_dictionary.SkimDict" title="activitysim.core.skim_dictionary.SkimDict"><span class="xref myst py py-class"><code class="docutils literal notranslate"><span class="pre">SkimDict</span></code></span></a>, and internally
recoding zones into a zero-based contiguous indexing scheme.</p>
<section id="zero-based-recoding-of-zones">
<h3>Zero-based Recoding of Zones<a class="headerlink" href="#zero-based-recoding-of-zones" title="Link to this heading">#</a></h3>
<p>Using sharrow requires recoding zone id’s to be zero-based contiguous index
values, at least for internal usage.  This recoding needs to be written into
the input table list explicitly.  For example, the following snippet of a
<code class="docutils literal notranslate"><span class="pre">settings.yaml</span></code> settings file shows the process of recoding zone ids in
the input files.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">input_table_list</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use</span>
<span class="w">    </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.csv</span>
<span class="w">    </span><span class="nt">index_col</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zone_id</span>
<span class="w">    </span><span class="nt">recode_columns</span><span class="p">:</span>
<span class="w">      </span><span class="nt">zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zero-based</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">households</span>
<span class="w">    </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">households.csv</span>
<span class="w">    </span><span class="nt">index_col</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">household_id</span>
<span class="w">    </span><span class="nt">recode_columns</span><span class="p">:</span>
<span class="w">      </span><span class="nt">home_zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
</pre></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">land_use</span></code> table, the <code class="docutils literal notranslate"><span class="pre">zone_id</span></code> field is marked for recoding explicitly
as <code class="docutils literal notranslate"><span class="pre">zero-based</span></code>, which will turn whatever nominal id’s appear in that column into
zero-based index values, as well as store a mapping of the original values that
is used to recode and decode zone id’s when used elsewhere.</p>
<p>The first “elsewhere” recoding is in the households input table, where we will
map the <code class="docutils literal notranslate"><span class="pre">home_zone_id</span></code> to the new zone id’s by pointing the recoding instruction
at the <code class="docutils literal notranslate"><span class="pre">land_use.zone_id</span></code> field.  If zone id’s appear in other input files, they
need to be recoded in those fields as well, using the same process.</p>
<p>The other places where we need to handle zone id’s is in output files.  The
following snippet of a <code class="docutils literal notranslate"><span class="pre">settings.yaml</span></code> settings file shows how those id’s are
decoded in various output files.  Generally, for columns that are fully populated
with zone id’s (e.g. tour and trip ends) we can apply the <code class="docutils literal notranslate"><span class="pre">decode_columns</span></code> settings
to reverse the mapping and restore the nominal zone id’s globally for the entire
column of data.  For columns where there is some missing data flagged by negative
values, the “nonnegative” filter is prepended to the instruction.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">output_tables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">include</span>
<span class="w">  </span><span class="nt">tables</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use</span>
<span class="w">      </span><span class="nt">decode_columns</span><span class="p">:</span>
<span class="w">        </span><span class="nt">zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">households</span>
<span class="w">      </span><span class="nt">decode_columns</span><span class="p">:</span>
<span class="w">        </span><span class="nt">home_zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">persons</span>
<span class="w">      </span><span class="nt">decode_columns</span><span class="p">:</span>
<span class="w">        </span><span class="nt">home_zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">        </span><span class="nt">school_zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nonnegative | land_use.zone_id</span>
<span class="w">        </span><span class="nt">workplace_zone_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nonnegative | land_use.zone_id</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tours</span>
<span class="w">      </span><span class="nt">decode_columns</span><span class="p">:</span>
<span class="w">        </span><span class="nt">origin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tablename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trips</span>
<span class="w">      </span><span class="nt">decode_columns</span><span class="p">:</span>
<span class="w">        </span><span class="nt">origin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">land_use.zone_id</span>
</pre></div>
</div>
</section>
</section>
<section id="measuring-performance">
<h2>Measuring Performance<a class="headerlink" href="#measuring-performance" title="Link to this heading">#</a></h2>
<p>Testing with sharrow requires two steps: test mode and production mode.</p>
<p>In test mode, the code is run to compile all the spec files and
ascertain whether the functions are working correctly.  Test mode is expected
to be slow, potentially much slower than older versions of ActivitySim,
especially for models with small populations and zone systems, as the compile
time is a function of the complexity of the utility functions and <em>not</em> a
function of the number of households or zones. Once the compile and test is
complete, production mode can then just run the pre-compiled functions with
sharrow, which is much faster.</p>
<p>It is possible to run test mode and production mode independently using the
existing <code class="docutils literal notranslate"><span class="pre">activitysim</span> <span class="pre">run</span></code> command line tool, pointing that tool to the test
and production configurations directories as appropriate.</p>
<p>To generate a meaningful measure of performance enhancement, it is necessary
to compare the runtimes in production mode against equivalent runtimes with
sharrow disabled.  This is facilitated by the <code class="docutils literal notranslate"><span class="pre">activitysim</span> <span class="pre">workflow</span></code> command
line tool, which permits the use of pre-made batches of activitysim runs, as
well as automatic report generation from the results.  For more details on the
use of this tool, see <a class="reference internal" href="workflows.html#workflows"><span class="std std-ref">workflows</span></a>.</p>
</section>
<section id="sharrow-compatability-and-limitations">
<h2>Sharrow Compatability and Limitations<a class="headerlink" href="#sharrow-compatability-and-limitations" title="Link to this heading">#</a></h2>
<p>In general, utility specification files contain a sequence of :ref:<code class="docutils literal notranslate"><span class="pre">expressions</span></code> that
are evaluated for each row in a main DataFrame.  In legacy ActivitySim,
there are two fundamental evaluation modes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code>, which is the default, and</p></li>
<li><p>plain Python <code class="docutils literal notranslate"><span class="pre">eval</span></code>, which is used when the expression is prefixed with an <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> symbol.</p></li>
</ul>
<p>Under the <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code> mode, expressions are evaluated within the context
of the current main dataframe only. References can be made to other columns
in that dataframe directly, i.e. if the dataframe contains a column named “income”,
the expression can reference that value as “income”.  However, the expression can
<em>only</em> reference other values that are stored in the current row of the dataframe.
The available syntax for these expressions is a subset of regular python, see the
<a class="reference external" href="https://pandas.pydata.org/docs/user_guide/enhancingperf.html#supported-syntax">supported syntax</a>
section of the pandas documentation for details.</p>
<p>Under the plain <code class="docutils literal notranslate"><span class="pre">eval</span></code> mode, expressions are evaluated within a broader context
that potentially includes other variables (which other variables is component
dependent) and constants defined in the model settings file.  References to
columns in the main dataframe must be made indirectly via attribution, i.e. if
the dataframe contains a column named “income”, the expression needs to reference
that value as “df.income”.  Typically, references to skims, time tables, and anything
else that isn’t the simple original dataframe use this mode.  While it is sometimes
not as fast as <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.eval</span></code>, this mode is far more flexible, as you
can write basically any valid Python expression, including calling other functions,
accessing or manipulating table metadata, indexes, or adjacent rows, etc.</p>
<p>Within sharrow, the distinction between these two modes is ignored, as sharrow
uses a completely different evaluation system routed through numba. The <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> prefix
does not need to be stripped or added anywhere, it is simply ignored. The expression
can reference other columns of the main dataframe directly or indirectly, so that
either “income” or “df.income” is a valid reference to that column in the main
dataframe.  You can also reference other variables, including skims as usual for each component
and constants defined in in the model settings file.  Within scheduling models,
references can also be made to the timetable as “tt”, accessing that interfaces
methods to compute presence and length of adjacent and available time windows.
However, you <em>cannot</em> write arbitrary Python code.  External functions are not allowed unless they have
already been compiled with numba’s <code class="docutils literal notranslate"><span class="pre">njit</span></code> wrapper.  Typically, unless specifically
constructed to be allowed for a model component, cross-referencing, merging or
reindexing against tables other than the main dataframe is not allowed. Such
customizations will generally require a custom extension.</p>
<p>Sharrow only runs for utility specification files.  ActivitySim also features the
ability to apply pre-processors and post-processors to annotate tables, which use
specification files that look very similar to utility specifications.  These
functions do <em>not</em> run through sharrow, and are a great place to relocate expressions
that need to run arbitrary code or join data from other tables.</p>
<section id="temporary-variables">
<h3>Temporary Variables<a class="headerlink" href="#temporary-variables" title="Link to this heading">#</a></h3>
<p>Temporary variables can be created from <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> mode expressions by adding a variable
name beginning with an underscore before the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">_stops_on_leg&#64;df.trip_count-1</span></code>.</p>
<p>In legacy mode, temporary variables are useful but they can consume substantial
memory, as the variable is computed and stored for every row in the entire dataframe
before it can be used in other expressions.  In sharrow, temporary variables are
allocated, used, and freed for each row separately, so no extra memory is required.</p>
</section>
<section id="switchable-expressions">
<h3>Switchable Expressions<a class="headerlink" href="#switchable-expressions" title="Link to this heading">#</a></h3>
<p>As a general rule, it is best to write each utility expression in a manner that
is cross-compatible between sharrow and legacy evaluation modes, even if that
means transitioning a few expressions or parts of expressions into preprocessors.</p>
<p>However, sometimes this is not possible or makes writing the expressions excessively
complex.  In this case, it is possible to write a toggling expression, where the
individual expression evaluated is different for sharrow and legacy modes.  The
special comment string <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">sharrow:</span></code> splits the expression, with everything before this
comment evaluated under the legacy process, and everything after evaluated only
when sharrow is enabled.</p>
<p>An example of a switching expression is found in the trip destination utilities found
in several examples:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>`@np.log1p(size_terms.get(df.alt_dest, df.purpose)) # sharrow: np.log1p(size_terms[&#39;sizearray&#39;])`
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">size_terms</span></code> is a DataFrameMatrix class instance, a special class written into
ActivitySim to facilitate reading from a DataFrame as it it were a 2-d array.  As it
is a special purpose class written in Python, the numba compiler cannot handle it directly.
Fortunately, sharrow provides an alternative: passing the size terms as a xarray <code class="docutils literal notranslate"><span class="pre">DataArray</span></code>.
This has a slightly different interface, so the sharrow and legacy evaluation modes require
different expressions. The switching expression is used to handle the DataFrameMatrix
on the left (before “# sharrow:”) and the DataArray on the right.</p>
</section>
<section id="performance-considerations">
<h3>Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">#</a></h3>
<p>Sharrow is usually expected to bring significant performance gains to ActivitySim.
However, the numba engine beneath sharrow has a few known performance limitations,
most notably when using <a class="reference external" href="https://numba.readthedocs.io/en/stable/reference/pysupported.html#str">strings</a>.
To enhance performance, it is best to limit the number of string operations,
including simple equality checks (e.g. <code class="docutils literal notranslate"><span class="pre">df.tour_purpose</span> <span class="pre">==</span> <span class="pre">'work'</span></code>).  Ideally,
such string operations won’t appear in utility specifications at all, or if they
do appear, they are executed only once and stored in a temporary value for re-use
as needed.</p>
<p>For models with utility expressions that include a lot of string comparisons,
(e.g. because they are built for the legacy <code class="docutils literal notranslate"><span class="pre">pandas.eval</span></code> interpreter and have not
been updated) sharrow can be disabled by setting <code class="docutils literal notranslate"><span class="pre">sharrow_skip:</span> <span class="pre">true</span></code> in the
component’s configuration yaml file.</p>
</section>
<section id="multiprocessing-performance">
<h3>Multiprocessing Performance<a class="headerlink" href="#multiprocessing-performance" title="Link to this heading">#</a></h3>
<p>Sharrow leverages a number of performance enhancing techniques, including
parallelization of various computations. This multi-threading can provide significant
benefits within a single-process, but if enabled alongside ActivitySim’s multiprocessing
paradigm, the multi-threading does more harm than good, as too many threads will
compete for limited computational resources. To avoid this, the user should completely
disable multi-threading and rely exclusively on multiprocessing to generate parallelism.
This can be done by setting a number of thread-limiting environment variables before
running Python, or immediately at the start of a Python script before ActivitySim
is loaded:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MKL_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENBLAS_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NUMBA_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;VECLIB_MAXIMUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NUMEXPR_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
</pre></div>
</div>
</section>
<section id="limited-tracing-and-estimation-mode-capabilities">
<h3>Limited Tracing and Estimation Mode Capabilities<a class="headerlink" href="#limited-tracing-and-estimation-mode-capabilities" title="Link to this heading">#</a></h3>
<p>When running sharrow-optimized code, large parts of certain calculations are routed
through numba to enhance speed and reduce memory footprint.  Many intermediate arrays
are not created, or are allocated and released by numba in a manner not visible to the
general Python interpreter.  As a result, in many places the “trace” capabilities of
ActivitySim are limited.  These capabilities output intermediate calculations in
extreme detail and are typically only used in debugging and model development, not
in production model runs that need to be optimized for speed.  Tracing features can
be re-enabled by switching sharrow off or by using “test” mode, which runs both sharrow
and legacy evaluations together to confirm they are substantially identical.  In this
fashion, detailed tracing (albeit slow) remains available for users on all models when
needed.</p>
<p>Similar constraints apply to estimation mode, as complete estimation mode output
capabilities are not yet integrated with the sharrow engine.  Estimation mode remains
fully available when running with sharrow disabled.</p>
</section>
<section id="arithmetic-on-logical-values">
<h3>Arithmetic on Logical Values<a class="headerlink" href="#arithmetic-on-logical-values" title="Link to this heading">#</a></h3>
<p>In expressions written in specification files, boolean values must be treated with
care.  When an expression is evaluated in the legacy implementation, the addition
of two boolean values will be processed according to numpy logic, such that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">])</span>
</pre></div>
</div>
<p>When the same expression is evaluated using sharrow, the expression is evaluated
using Pythonesque rules, such that logical values are implicitly upcast to integers,
giving:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span> <span class="o">+</span> <span class="kc">True</span> <span class="o">==</span> <span class="mi">2</span>
<span class="kc">True</span> <span class="o">+</span> <span class="kc">False</span> <span class="o">==</span> <span class="mi">1</span>
<span class="kc">False</span> <span class="o">+</span> <span class="kc">True</span> <span class="o">==</span> <span class="mi">1</span>
<span class="kc">False</span> <span class="o">+</span> <span class="kc">False</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>If this value is later upcast to a number and used in a mathematical calculation
(e.g. multiplied by a float-valued coefficient), obviously the results will vary,
as in the first case the result is never other than 1 or 0, but in the latter case
the result can also be 2.  This mismatch can be readily avoided by wrapping the
term in an extra logic gate, which will evaluate the same in both environments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kc">True</span> <span class="o">+</span> <span class="kc">True</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">==</span> <span class="kc">True</span>
<span class="p">(</span><span class="kc">True</span> <span class="o">+</span> <span class="kc">False</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">==</span> <span class="kc">True</span>
<span class="p">(</span><span class="kc">False</span> <span class="o">+</span> <span class="kc">True</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">==</span> <span class="kc">True</span>
<span class="p">(</span><span class="kc">False</span> <span class="o">+</span> <span class="kc">False</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">==</span> <span class="kc">False</span>
</pre></div>
</div>
</section>
</section>
<section id="digital-encoding">
<span id="id1"></span><h2>Digital Encoding<a class="headerlink" href="#digital-encoding" title="Link to this heading">#</a></h2>
<p>Sharrow is compatible with and able to efficiently use
<a class="reference external" href="https://activitysim.github.io/sharrow/walkthrough/encoding.html">digital encoding</a>.
These encodings are applied to data either prospectively (i.e. before ActivitySim
ever sees the skim data), or dynamically within a run using the
<code class="docutils literal notranslate"><span class="pre">taz_skims.digital-encoding</span></code> or <code class="docutils literal notranslate"><span class="pre">taz_skims.zarr-digital-encoding</span></code> settings in
the <code class="docutils literal notranslate"><span class="pre">network_los.yaml</span></code> settings file.  The only difference between these two
settings is that the former applies this digital encoding internally every
time you run the model, while the latter applies it prior to caching encoded
skims to disk in Zarr format (and then reuses those values without re-encoding
on subsequent runs with the same data).  Dictionary encoding (especially joint
dictionary encodings) can take a long time to prepare, so caching the values can
be useful. As read/write speeds for zarr files are fast, you usually won’t
notice a meaningful performance degradation when caching, so the default is
generally to use <code class="docutils literal notranslate"><span class="pre">zarr-digital-encoding</span></code>.</p>
<p>Very often, data can be expressed adequately with far less memory than is
needed to store a standard 32-bit floating point representation.  There are
two simple ways to reduce the memory footprint for data: fixed point
encoding, or dictionary encoding.</p>
<section id="fixed-point-encoding">
<h3>Fixed Point Encoding<a class="headerlink" href="#fixed-point-encoding" title="Link to this heading">#</a></h3>
<p>In fixed point encoding, which is also sometimes called scaled integers,
data is multiplied by some factor, then rounded to the nearest integer.
The integer is stored in memory instead of a floating point value, but the
original value can be (approximately) restored by reversing the process.
An offset factor can also be applied, so that the domain of values does not
need to start at zero.</p>
<p>For example, instead of storing matrix table values as 32-bit floating point values,
they could be multiplied by a scale factor (e.g., 100)
and then converted to 16-bit integers. This uses half the
RAM and can still express any value (to two decimal point
precision) up to positive or negative 327.68.  If the lowest
values in that range are never needed, it can also be shifted,
moving both the bottom and top limits by a fixed amount. Then,
for a particular scale $\mu$ and shift $\xi$ (stored in metadata),
from any array element $i$ the implied (original) value $x$
can quickly be recovered by evaluating $(i / \mu) - \xi$.</p>
<p>Fixed point digital encoding can be applied to matrix tables in the skims
using options in the <code class="docutils literal notranslate"><span class="pre">network_los.yaml</span></code> settings file.  Making transformations
currently also requires shifting the data from OMX to ZARR file formats;
future versions of ActivitySim may accept digitally encoded data directly
from external sources.</p>
<p>To apply the default 16-bit encoding to individual named skim variables in the
TAZ skims, just give their names under the <code class="docutils literal notranslate"><span class="pre">zarr-digital-encoding</span></code> setting
like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">taz_skims</span><span class="p">:</span>
<span class="w">    </span><span class="nt">omx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.omx</span>
<span class="w">    </span><span class="nt">zarr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.zarr</span>
<span class="w">    </span><span class="nt">zarr-digital-encoding</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SOV_TIME</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HOV2_TIME</span>
</pre></div>
</div>
<p>If some variables can use less RAM and still be represented adequately with only
8-bit integers, you can specify the bitwidth as well:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">taz_skims</span><span class="p">:</span>
<span class="w">    </span><span class="nt">omx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.omx</span>
<span class="w">    </span><span class="nt">zarr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.zarr</span>
<span class="w">    </span><span class="nt">zarr-digital-encoding</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SOV_TIME</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HOV2_TIME</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SOV_TOLL</span>
<span class="w">          </span><span class="nt">bitwidth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HOV2_TOLL</span>
<span class="w">          </span><span class="nt">bitwidth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</pre></div>
</div>
<p>If groups of similarly named variables should have the same encoding applied,
they can be identifed by regular expressions (“regex”) instead of explicitly
giving each name.  For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">taz_skims</span><span class="p">:</span>
<span class="w">    </span><span class="nt">omx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.omx</span>
<span class="w">    </span><span class="nt">zarr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.zarr</span>
<span class="w">    </span><span class="nt">zarr-digital-encoding</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.*_TIME</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.*_TOLL</span>
<span class="w">          </span><span class="nt">bitwidth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</pre></div>
</div>
</section>
<section id="dictionary-encoding">
<h3>Dictionary Encoding<a class="headerlink" href="#dictionary-encoding" title="Link to this heading">#</a></h3>
<p>For dictionary encoding, a limited number of unique values are stored in a
lookup array, and then each encoded value is stored as the position of the
value (or its closest approximation) in the lookup array.  If there are fewer
than 256 unique values, this can allow the storage of those values to any level
of precision (even float64 if needed) while using only a single byte per array
element, plus a small fixed amount of overhead for the dictionary itself.  The
overhead memory doesn’t scale with the dimensions of the array, so this works
particularly well for models with thousands of zones.</p>
<p>Dictionary encoding can be applied to a single variable in a similar fashion as
fixed point encoding, giving the dictionary bit width in the <code class="docutils literal notranslate"><span class="pre">by_dict</span></code> setting,
or as an additional setting value.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">taz_skims</span><span class="p">:</span>
<span class="w">    </span><span class="nt">omx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.omx</span>
<span class="w">    </span><span class="nt">zarr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.zarr</span>
<span class="w">    </span><span class="nt">zarr-digital-encoding</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TRANSIT_FARE</span>
<span class="w">          </span><span class="nt">by_dict</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TRANSIT_XFERS</span>
<span class="w">          </span><span class="nt">by_dict</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">bitwidth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</pre></div>
</div>
<p>The most dramatic memory savings can be found when the categorical correlation
(also known as <a class="reference external" href="https://en.wikipedia.org/wiki/Cram%C3%A9r%27s_V">Cramér’s V</a>)
between multiple variables is high.  In this case, we can encode more than one
matrix table using the same dictionary lookup indexes.  There may be some
duplication in the lookup table, (e.g. if FARE and XFER are joint encoded,
and if a FARE of 2.25 can be matched with either 0 or 1 XFER, the 2.25 would
appear twice in the lookup array for FARE, once for each value of XFER.)</p>
<p>Since it is the lookup <em>indexes</em> that scale with the number of zones and consume most
of the memory for large zone systems, putting multiple variables together into one
set of indexes can save a ton of memory, so long as the overhead of the lookup array
does not combinatorially explode (hence the need for categorical correlation).</p>
<p>Practical testing for large zone systems suggest this method of encoding can
reduce the footprint of some low variance data tables (especially transit data)
by 95% or more.</p>
<p>Applying joint dictionary encoding requires more than one variable name, so only
the <code class="docutils literal notranslate"><span class="pre">regex</span></code> form works here. Use wildcards to match on name patterns, or select a
few specific names by joining them with the pipe operator (|).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">taz_skims</span><span class="p">:</span>
<span class="w">    </span><span class="nt">omx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.omx</span>
<span class="w">    </span><span class="nt">zarr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skims.zarr</span>
<span class="w">    </span><span class="nt">zarr-digital-encoding</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.*_FARE|.*_WAIT|.*_XFERS</span>
<span class="w">          </span><span class="nt">joint_dict</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FERRYTIME|FERRYFARE|FERRYWAIT</span>
<span class="w">          </span><span class="nt">joint_dict</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>For more details on all the settings available for digital encoding, see
<a class="reference internal" href="../users-guide/_generated/activitysim.core.configuration.DigitalEncoding.html#activitysim.core.configuration.DigitalEncoding" title="activitysim.core.configuration.network.DigitalEncoding"><span class="xref myst py py-obj">DigitalEncoding</span></a>.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="_generated/activitysim.core.workflow.cached_object.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">cached_object</p>
      </div>
    </a>
    <a class="right-next"
       href="skim-dataset.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using Skim Dataset</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-it-works">How it Works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-design-requirements">Model Design Requirements</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zero-based-recoding-of-zones">Zero-based Recoding of Zones</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-performance">Measuring Performance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sharrow-compatability-and-limitations">Sharrow Compatability and Limitations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporary-variables">Temporary Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#switchable-expressions">Switchable Expressions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-considerations">Performance Considerations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiprocessing-performance">Multiprocessing Performance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limited-tracing-and-estimation-mode-capabilities">Limited Tracing and Estimation Mode Capabilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arithmetic-on-logical-values">Arithmetic on Logical Values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#digital-encoding">Digital Encoding</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fixed-point-encoding">Fixed Point Encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dictionary-encoding">Dictionary Encoding</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/dev-guide/using-sharrow.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.3.0b2.dev27+g6d817bea, documentation last updated Mar 07, 2024.<br/>
</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>