
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Models &#8212; ActivitySim 1.2.1.dev7+g08c7ab2f</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/design-tabs.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Components" href="dev-guide/components/index.html" />
    <link rel="prev" title="Software Development" href="development.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="index.html">
<p class="title">ActivitySim</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="users-guide/index.html">
  Users Guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="dev-guide/index.html">
  Developers
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        1.2.1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables models and {'json_url': 'https://activitysim.github.io/activitysim/switcher.json', 'version_match': '1.2.1'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "models.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://activitysim.github.io/activitysim/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "models.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "1.2.1") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dev-guide/install.html">
   Developer Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dev-guide/using-sharrow.html">
   Using Sharrow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dev-guide/skim-dataset.html">
   Using Skim Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dev-guide/workflows.html">
   Workflows
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="development.html">
   Software Development
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Models
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="dev-guide/components/index.html">
   Components
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="dev-guide/components/trip_destination.html">
     Trip Destination
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="core.html">
   Core Components
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="benchmarking.html">
   Benchmarking
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialize">
   Initialize
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialize-tvpb">
   Initialize LOS
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accessibility">
   Accessibility
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#disaggregate-accessibility">
   Disaggregate Accessibility
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#work-from-home">
   Work From Home
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#work-location">
   School Location
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id7">
   Work Location
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shadow-pricing">
   Shadow Pricing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transit-pass-subsidy">
   Transit Pass Subsidy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transit-pass-ownership">
   Transit Pass Ownership
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#auto-ownership">
   Auto Ownership
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vehicle-type-choice">
   Vehicle Type Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#telecommute-frequency">
   Telecommute Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#free-parking-eligibility">
   Free Parking Eligibility
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#coordinated-daily-activity-pattern">
   Coordinated Daily Activity Pattern
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mandatory-tour-frequency">
   Mandatory Tour Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#representative-logsums">
   Mandatory Tour Scheduling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#school-escorting">
   School Escorting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joint-tour-frequency">
   Joint Tour Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joint-tour-composition">
   Joint Tour Composition
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joint-tour-participation">
   Joint Tour Participation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joint-tour-destination-choice">
   Joint Tour Destination Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joint-tour-scheduling">
   Joint Tour Scheduling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#non-mandatory-tour-frequency">
   Non-Mandatory Tour Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#non-mandatory-tour-destination-choice">
   Non-Mandatory Tour Destination Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#non-mandatory-tour-scheduling">
   Non-Mandatory Tour Scheduling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vehicle-allocation">
   Vehicle Allocation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tour-mode-choice">
   Tour Mode Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#at-work-subtours-frequency">
   At-work Subtours Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#at-work-subtours-destination-choice">
   At-work Subtours Destination Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#at-work-subtour-scheduling">
   At-work Subtour Scheduling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#at-work-subtour-mode">
   At-work Subtour Mode
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#intermediate-stop-frequency">
   Intermediate Stop Frequency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-purpose">
   Trip Purpose
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-destination-choice">
   Trip Destination Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-purpose-and-destination">
   Trip Purpose and Destination
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-scheduling-probablistic">
   Trip Scheduling (Probablistic)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-scheduling-choice-logit-choice">
   Trip Scheduling Choice (Logit Choice)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-departure-choice-logit-choice">
   Trip Departure Choice (Logit Choice)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trip-mode-choice">
   Trip Mode Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parking-location-choice">
   Parking Location Choice
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-trip-matrices">
   Write Trip Matrices
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#util">
   Util
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id33">
     CDAP
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimation">
     Estimation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.logsums">
     Logsums
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.mode">
     Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.overlap">
     Overlap
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.tour_destination">
     Tour Destination
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.tour_frequency">
     Tour Frequency
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.trip">
     Trip
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-activitysim.abm.models.util.vectorize_tour_scheduling">
     Vectorize Tour Scheduling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tests">
   Tests
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="models">
<span id="index-0"></span><span id="id1"></span><h1>Models<a class="headerlink" href="#models" title="Permalink to this headline">#</a></h1>
<p>The currently implemented example ActivitySim AB models are described below.  See the example
model <a class="reference internal" href="examples.html#sub-model-spec-files"><span class="std std-ref">Sub-Model Specification Files</span></a>, <a class="reference internal" href="examples.html#arc-sub-model-spec-files"><span class="std std-ref">Example ARC Sub-Model Specification Files</span></a>, and <a class="reference internal" href="examples.html#semcog-sub-model-spec-files"><span class="std std-ref">Example SEMCOG Sub-Model Specification Files</span></a> for more information.</p>
<section id="initialize">
<span id="initialize-tours"></span><span id="initialize-households"></span><span id="initialize-landuse"></span><h2>Initialize<a class="headerlink" href="#initialize" title="Permalink to this headline">#</a></h2>
<p>The initialize model isn’t really a model, but rather a few data processing steps in the data pipeline.
The initialize data processing steps code variables used in downstream models, such as household and person
value-of-time.  This step also pre-loads the land_use, households, persons, and person_windows tables because
random seeds are set differently for each step and therefore the sampling of households depends on which step
they are initially loaded in.</p>
<p>The main interface to the initialize land use step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_landuse()</span></code>
function. The main interface to the initialize household step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_households()</span></code>
function.  The main interface to the initialize tours step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_tours()</span></code>
function.  These functions are registered as Inject steps in the example Pipeline.</p>
<span class="target" id="module-activitysim.abm.models.initialize"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.initialize.preload_injectables">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize.</span></span><span class="sig-name descname"><span class="pre">preload_injectables</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize.preload_injectables" title="Permalink to this definition">#</a></dt>
<dd><p>preload bulky injectables up front - stuff that isn’t inserted into the pipeline</p>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.initialize_tours"></span></section>
<section id="initialize-tvpb">
<span id="initialize-los"></span><span id="id2"></span><h2>Initialize LOS<a class="headerlink" href="#initialize-tvpb" title="Permalink to this headline">#</a></h2>
<p>The initialize LOS model isn’t really a model, but rather a series of data processing steps in the data pipeline.
The initialize LOS model does two things:</p>
<blockquote>
<div><ul class="simple">
<li><p>Loads skims and cache for later if desired</p></li>
<li><p>Loads network LOS inputs for transit virtual path building (see <a class="reference internal" href="core.html#transit-virtual-path-builder"><span class="std std-ref">Transit Virtual Path Builder</span></a>), pre-computes tap-to-tap total utilities and cache for later if desired</p></li>
</ul>
</div></blockquote>
<p>The main interface to the initialize LOS step is the <a class="reference internal" href="#activitysim.abm.models.initialize_los.initialize_los" title="activitysim.abm.models.initialize_los.initialize_los"><code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_los()</span></code></a>
function.  The main interface to the initialize TVPB step is the <a class="reference internal" href="#activitysim.abm.models.initialize_los.initialize_tvpb" title="activitysim.abm.models.initialize_los.initialize_tvpb"><code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_tvpb()</span></code></a>
function.  These functions are registered as Inject steps in the example Pipeline.</p>
<span class="target" id="module-activitysim.abm.models.initialize_los"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.initialize_los.initialize_los">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize_los.</span></span><span class="sig-name descname"><span class="pre">initialize_los</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize_los.initialize_los" title="Permalink to this definition">#</a></dt>
<dd><p>Currently, this step is only needed for THREE_ZONE systems in which the tap_tap_utilities are precomputed
in the (presumably subsequent) initialize_tvpb step.</p>
<p>Adds attribute_combinations_df table to the pipeline so that it can be used to as the slicer
for multiprocessing the initialize_tvpb s.tep</p>
<p>FIXME - this step is only strictly necessary when multiprocessing, but initialize_tvpb would need to be tweaked
FIXME - to instantiate attribute_combinations_df if the pipeline table version were not available.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.initialize_los.initialize_tvpb">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize_los.</span></span><span class="sig-name descname"><span class="pre">initialize_tvpb</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">attribute_combinations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize_los.initialize_tvpb" title="Permalink to this definition">#</a></dt>
<dd><p>Initialize STATIC tap_tap_utility cache and write mmap to disk.</p>
<p>uses pipeline attribute_combinations table created in initialize_los to determine which attribute tuples
to compute utilities for.</p>
<p>if we are single-processing, this will be the entire set of attribute tuples required to fully populate cache</p>
<p>if we are multiprocessing, then the attribute_combinations will have been sliced and we compute only a subset
of the tuples (and the other processes will compute the rest). All process wait until the cache is fully
populated before returning, and the locutor process writes the results.</p>
<p>FIXME - if we did not close this, we could avoid having to reload it from mmap when single-process?</p>
</dd></dl>

</section>
<section id="accessibility">
<span id="id3"></span><h2>Accessibility<a class="headerlink" href="#accessibility" title="Permalink to this headline">#</a></h2>
<p>The accessibilities model is an aggregate model that calculates multiple origin-based accessibility
measures by origin zone to all destination zones.</p>
<p>The accessibility measure first multiplies an employment variable by a mode-specific decay function.  The
product reflects the difficulty of accessing the activities the farther (in terms of round-trip travel time)
the jobs are from the location in question. The products to each destination zone are next summed over
each origin zone, and the logarithm of the product mutes large differences.  The decay function on
the walk accessibility measure is steeper than automobile or transit.  The minimum accessibility is zero.</p>
<p>Level-of-service variables from three time periods are used, specifically the AM peak period (6 am to 10 am), the
midday period (10 am to 3 pm), and the PM peak period (3 pm to 7 pm).</p>
<p><em>Inputs</em></p>
<ul class="simple">
<li><p>Highway skims for the three periods.  Each skim is expected to include a table named “TOLLTIMEDA”, which is the drive alone in-vehicle travel time for automobiles willing to pay a “value” (time-savings) toll.</p></li>
<li><p>Transit skims for the three periods.  Each skim is expected to include the following tables: (i) “IVT”, in-vehicle time; (ii) “IWAIT”, initial wait time; (iii) “XWAIT”, transfer wait time; (iv) “WACC”, walk access time; (v) “WAUX”, auxiliary walk time; and, (vi) “WEGR”, walk egress time.</p></li>
<li><p>Zonal data with the following fields: (i) “TOTEMP”, total employment; (ii) “RETEMPN”, retail trade employment per the NAICS classification.</p></li>
</ul>
<p><em>Outputs</em></p>
<ul class="simple">
<li><p>taz, travel analysis zone number</p></li>
<li><p>autoPeakRetail, the accessibility by automobile during peak conditions to retail employment for this TAZ</p></li>
<li><p>autoPeakTotal, the accessibility by automobile during peak conditions to all employment</p></li>
<li><p>autoOffPeakRetail, the accessibility by automobile during off-peak conditions to retail employment</p></li>
<li><p>autoOffPeakTotal, the accessibility by automobile during off-peak conditions to all employment</p></li>
<li><p>transitPeakRetail, the accessibility by transit during peak conditions to retail employment</p></li>
<li><p>transitPeakTotal, the accessibility by transit during peak conditions to all employment</p></li>
<li><p>transitOffPeakRetail, the accessiblity by transit during off-peak conditions to retail employment</p></li>
<li><p>transitOffPeakTotal, the accessiblity by transit during off-peak conditions to all employment</p></li>
<li><p>nonMotorizedRetail, the accessibility by walking during all time periods to retail employment</p></li>
<li><p>nonMotorizedTotal, the accessibility by walking during all time periods to all employment</p></li>
</ul>
<p>The main interface to the accessibility model is the
<a class="reference internal" href="#activitysim.abm.models.accessibility.compute_accessibility" title="activitysim.abm.models.accessibility.compute_accessibility"><code class="xref py py-func docutils literal notranslate"><span class="pre">compute_accessibility()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">skims</span></code> | Result Table: <code class="docutils literal notranslate"><span class="pre">accessibility</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">O-D,</span> <span class="pre">D-O</span></code></p>
<span class="target" id="module-activitysim.abm.models.accessibility"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.accessibility.compute_accessibility">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.accessibility.</span></span><span class="sig-name descname"><span class="pre">compute_accessibility</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">land_use</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">accessibility</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_od</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.accessibility.compute_accessibility" title="Permalink to this definition">#</a></dt>
<dd><p>Compute accessibility for each zone in land use file using expressions from accessibility_spec</p>
<p>The actual results depend on the expressions in accessibility_spec, but this is initially
intended to permit implementation of the mtc accessibility calculation as implemented by
Accessibility.job</p>
<p>Compute measures of accessibility used by the automobile ownership model.
The accessibility measure first multiplies an employment variable by a mode-specific decay
function.  The product reflects the difficulty of accessing the activities the farther
(in terms of round-trip travel time) the jobs are from the location in question. The products
to each destination zone are next summed over each origin zone, and the logarithm of the
product mutes large differences.  The decay function on the walk accessibility measure is
steeper than automobile or transit.  The minimum accessibility is zero.</p>
</dd></dl>

</section>
<section id="disaggregate-accessibility">
<span id="id4"></span><h2>Disaggregate Accessibility<a class="headerlink" href="#disaggregate-accessibility" title="Permalink to this headline">#</a></h2>
<p>The disaggregate accessibility model is an extension of the base accessibility model.
While the base accessibility model is based on a mode-specific decay function and uses fixed market
segments in the population (i.e., income), the disaggregate accessibility model extracts the actual
destination choice logsums by purpose (i.e., mandatory fixed school/work location and non-mandatory
tour destinations by purpose) from the actual model calculations using a user-defined proto-population.
This enables users to include features that may be more critical to destination
choice than just income (e.g., automobile ownership).</p>
<dl class="simple">
<dt>Inputs:</dt><dd><ul class="simple">
<li><p>disaggregate_accessibility.yaml - Configuration settings for disaggregate accessibility model.</p></li>
<li><p>annotate.csv [optional] - Users can specify additional annotations specific to disaggregate accessibility. For example, annotating the proto-population tables.</p></li>
</ul>
</dd>
<dt>Outputs:</dt><dd><ul class="simple">
<li><p>final_disaggregate_accessibility.csv [optional]</p></li>
<li><p>final_non_mandatory_tour_destination_accesibility.csv [optional]</p></li>
<li><p>final_workplace_location_accessibility.csv [optional]</p></li>
<li><p>final_school_location_accessibility.csv [optional]</p></li>
<li><p>final_proto_persons.csv [optional]</p></li>
<li><p>final_proto_households.csv [optional]</p></li>
<li><p>final_proto_tours.csv [optional]</p></li>
</ul>
</dd>
</dl>
<p>The above tables are created in the model pipeline, but the model will not save
any outputs unless specified in settings.yaml - output_tables. Users can return
the proto population tables for inspection, as well as the raw logsum accessibilities
for mandatory school/work and non-mandatory destinations. The logsums are then merged
at the household level in final_disaggregate_accessibility.csv, which each tour purpose
logsums shown as separate columns.</p>
<p><strong>Usage</strong>
The disaggregate accessibility model is run as a model step in the model list.
There are two necessary steps:</p>
<p><code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">initialize_proto_population</span></code> | <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">compute_disaggregate_accessibility</span></code></p>
<p>The reason the steps must be separate is to enable multiprocessing.
The proto-population must be fully generated and initialized before activitysim
slices the tables into separate threads. These steps must also occur before
initialize_households in order to avoid conflict with the shadow_pricing model.</p>
<p>The model steps can be run either as part the activitysim model run, or setup
to run as a standalone run to pre-computing the accessibility values.
For standalone implementations, the final_disaggregate_accessibility.csv is read
into the pipeline and initialized with the initialize_household model step.</p>
<dl class="simple">
<dt><strong>Configuration of disaggregate_accessibility.yaml:</strong></dt><dd><ul class="simple">
<li><p>CREATE_TABLES - Users define the variables to be generated for PROTO_HOUSEHOLDS, PROTO_PERSONS, and PROTO_TOURS tables. These tables must include all basic fields necessary for running the actual model. Additional fields can be annotated in pre-processing using the annotation settings of this file. The base variables in each table are defined using the following parameters:</p>
<ul>
<li><p>VARIABLES - The base variable, must be a value or a list. Results in the cartesian product (all non-repeating combinations) of the fields.</p></li>
<li><p>mapped_fields [optional] - For non-combinatorial fields, users can map a variable to the fields generated in VARIABLES (e.g., income category bins mapped to median dollar values).</p></li>
<li><p>filter_rows [optional] - Users can also filter rows using pandas expressions if specific variable combinations are not desired.</p></li>
<li><p>JOIN_ON [required only for PROTO_TOURS] - specify the persons variable to join the tours to (e.g., person_number).</p></li>
</ul>
</li>
<li><p>MERGE_ON - User specified fields to merge the proto-population logsums onto the full synthetic population. The proto-population should be designed such that the logsums are able to be joined exactly on these variables specified to the full population. Users specify the to join on using:</p>
<ul>
<li><p>by: An exact merge will be attempted using these discrete variables.</p></li>
<li><p>asof [optional]: The model can peform an “asof” join for continuous variables, which finds the nearest value. This method should not be necessary since synthetic populations are all discrete.</p></li>
<li><p>method [optional]: Optional join method can be “soft”, default is None. For cases where a full inner join is not possible, a Naive Bayes clustering method is fast but discretely constrained method. The proto-population is treated as the “training data” to match the synthetic population value to the best possible proto-population candidate. The Some refinement may be necessary to make this procedure work.</p></li>
</ul>
</li>
<li><p>annotate_proto_tables [optional] - Annotation configurations if users which to modify the proto-population beyond basic generation in the YAML.</p></li>
<li><p>DESTINATION_SAMPLE_SIZE - The <em>destination</em> sample size (0 = all zones), e.g., the number of destination zone alternatives sampled for calculating the destination logsum. Decimal values &lt; 1 will be interpreted as a percentage, e.g., 0.5 = 50% sample.</p></li>
<li><p>ORIGIN_SAMPLE_SIZE - The <em>origin</em> sample size (0 = all zones), e.g., the number of origins where logsum is calculated. Origins without a logsum will draw from the nearest zone with a logsum. This parameter is useful for systems with a large number of zones with similar accessibility. Decimal values &lt; 1 will be interpreted as a percentage, e.g., 0.5 = 50% sample.</p></li>
<li><p>ORIGIN_SAMPLE_METHOD - The method in which origins are sampled. Population weighted sampling can be TAZ-based or “TAZ-agnostic” using KMeans clustering. The potential advantage of KMeans is to provide a more geographically even spread of MAZs sampled that do not rely on TAZ hierarchies. Unweighted sampling is also possible using ‘uniform’ and ‘uniform-taz’.</p>
<ul>
<li><p>None [Default] - Sample zones weighted by population, ensuring at least one TAZ is sampled per MAZ. If n-samples &gt; n-tazs then sample 1 MAZ from each TAZ until n-remaining-samples &lt; n-tazs, then sample n-remaining-samples TAZs and sample an MAZ within each of those TAZs. If n-samples &lt; n-tazs, then it proceeds to the above ‘then’ condition.</p></li>
<li><p>“kmeans” - K-Means clustering is performed on the zone centroids (must be provided as maz_centroids.csv), weighted by population. The clustering yields k XY coordinates weighted by zone population for n-samples = k-clusters specified. Once k new cluster centroids are found, these are then approximated into the nearest available zone centroid and used to calculate accessibilities on. By default, the k-means method is run on 10 different initial cluster seeds (n_init) using using “k-means++” seeding algorithm (<a class="reference external" href="https://en.wikipedia.org/wiki/K-means%2B%2B">https://en.wikipedia.org/wiki/K-means%2B%2B</a>). The k-means method runs for max_iter iterations (default=300).</p></li>
<li><p>“uniform” - Unweighted sample of N zones independent of each other.</p></li>
<li><p>“uniform-taz” - Unweighted sample of 1 zone per taz up to the N samples specified.</p></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
<section id="work-from-home">
<span id="id5"></span><h2>Work From Home<a class="headerlink" href="#work-from-home" title="Permalink to this headline">#</a></h2>
<p>Telecommuting is defined as workers who work from home instead of going
to work. It only applies to workers with a regular workplace outside of home.
The telecommute model consists of two submodels - this work from home model and a
person <a class="reference internal" href="#telecommute-frequency"><span class="std std-ref">Telecommute Frequency</span></a> model. This model predicts for all workers whether they
usually work from home.</p>
<p>The work from home model includes the ability to adjust a work from home alternative
constant to attempt to realize a work from home percent for what-if type analysis.
This iterative single process procedure takes as input a number of iterations, a filter on
the choosers to use for the calculation, a target work from home percent, a tolerance percent
for convergence, and the name of the coefficient to adjust.  An example setup is provided and
the coefficient adjustment at each iteration is:
<code class="docutils literal notranslate"><span class="pre">new_coefficient</span> <span class="pre">=</span> <span class="pre">log(</span> <span class="pre">target_percent</span> <span class="pre">/</span> <span class="pre">current_percent</span> <span class="pre">)</span> <span class="pre">+</span> <span class="pre">current_coefficient</span></code>.</p>
<p>The main interface to the work from home model is the
<a class="reference internal" href="#module-activitysim.abm.models.work_from_home" title="activitysim.abm.models.work_from_home"><code class="xref py py-func docutils literal notranslate"><span class="pre">work_from_home()</span></code></a> function.  This
function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">work_from_home</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.work_from_home"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.work_from_home.work_from_home">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.work_from_home.</span></span><span class="sig-name descname"><span class="pre">work_from_home</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.work_from_home.work_from_home" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts whether a person (worker) works from home. The output
from this model is TRUE (if works from home) or FALSE (works away from home).
The workplace location choice is overridden for workers who work from home
and set to -1.</p>
</dd></dl>

</section>
<section id="work-location">
<span id="school-location"></span><span id="id6"></span><h2>School Location<a class="headerlink" href="#work-location" title="Permalink to this headline">#</a></h2>
<p>The usual school location choice models assign a usual school location for the primary
mandatory activity of each child and university student in the
synthetic population. The models are composed of a set of accessibility-based parameters
(including one-way distance between home and primary destination and the tour mode choice
logsum - the expected maximum utility in the mode choice model which is given by the
logarithm of the sum of exponentials in the denominator of the logit formula) and size terms,
which describe the quantity of grade-school or university opportunities in each possible
destination.</p>
<dl class="simple">
<dt>The school location model is made up of four steps:</dt><dd><ul class="simple">
<li><p>sampling - selects a sample of alternative school locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative school location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final school location, this time with the mode choice logsum included.</p></li>
<li><p>shadow prices - compare modeled zonal destinations to target zonal size terms and calculate updated shadow prices.</p></li>
</ul>
</dd>
</dl>
<p>These steps are repeated until shadow pricing convergence criteria are satisfied or a max number of iterations is reached.  See <a class="reference internal" href="#shadow-pricing"><span class="std std-ref">Shadow Pricing</span></a>.</p>
<p>School location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">placeholder_multiple_zone</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interfaces to the model is the <a class="reference internal" href="#activitysim.abm.models.location_choice.school_location" title="activitysim.abm.models.location_choice.school_location"><code class="xref py py-func docutils literal notranslate"><span class="pre">school_location()</span></code></a> function.
This function is registered as an Inject step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">school_taz</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">AM</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
</section>
<section id="id7">
<h2>Work Location<a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h2>
<p>The usual work location choice models assign a usual work location for the primary
mandatory activity of each employed person in the
synthetic population. The models are composed of a set of accessibility-based parameters
(including one-way distance between home and primary destination and the tour mode choice
logsum - the expected maximum utility in the mode choice model which is given by the
logarithm of the sum of exponentials in the denominator of the logit formula) and size terms,
which describe the quantity of work opportunities in each possible destination.</p>
<dl class="simple">
<dt>The work location model is made up of four steps:</dt><dd><ul class="simple">
<li><p>sample - selects a sample of alternative work locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative work location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final work location, this time with the mode choice logsum included.</p></li>
<li><p>shadow prices - compare modeled zonal destinations to target zonal size terms and calculate updated shadow prices.</p></li>
</ul>
</dd>
</dl>
<p>These steps are repeated until shadow pricing convergence criteria are satisfied or a max number of iterations is reached.  See <a class="reference internal" href="#shadow-pricing"><span class="std std-ref">Shadow Pricing</span></a>.</p>
<p>Work location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">placeholder_multiple_zone</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interfaces to the model is the <a class="reference internal" href="#activitysim.abm.models.location_choice.workplace_location" title="activitysim.abm.models.location_choice.workplace_location"><code class="xref py py-func docutils literal notranslate"><span class="pre">workplace_location()</span></code></a> function.
This function is registered as an Inject step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">workplace_taz</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">AM</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">PM</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.location_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.iterate_location_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">iterate_location_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.iterate_location_choice" title="Permalink to this definition">#</a></dt>
<dd><p>iterate run_location_choice updating shadow pricing until convergence criteria satisfied
or max_iterations reached.</p>
<p>(If use_shadow_pricing not enabled, then just iterate once)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>persons_merged</strong><span class="classifier">injected table</span></dt><dd></dd>
<dt><strong>persons</strong><span class="classifier">injected table</span></dt><dd></dd>
<dt><strong>network_los</strong><span class="classifier">los.Network_LOS</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>locutor</strong><span class="classifier">bool</span></dt><dd><p>whether this process is the privileged logger of shadow_pricing when multiprocessing</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>adds choice column model_settings[‘DEST_CHOICE_COLUMN_NAME’]</dt><dd></dd>
<dt>adds logsum column model_settings[‘DEST_CHOICE_LOGSUM_COLUMN_NAME’]- if provided</dt><dd></dd>
<dt>adds annotations to persons table</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.run_location_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">run_location_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shadow_price_calculator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_sample_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_choice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_choice" title="Permalink to this definition">#</a></dt>
<dd><p>Run the three-part location choice algorithm to generate a location choice for each chooser</p>
<p>Handle the various segments separately and in turn for simplicity of expression files</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons_merged_df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>persons table merged with households and land_use</p>
</dd>
<dt><strong>network_los</strong><span class="classifier">los.Network_LOS</span></dt><dd></dd>
<dt><strong>shadow_price_calculator</strong><span class="classifier">ShadowPriceCalculator</span></dt><dd><p>to get size terms</p>
</dd>
<dt><strong>want_logsums</strong><span class="classifier">boolean</span></dt><dd></dd>
<dt><strong>want_sample_table</strong><span class="classifier">boolean</span></dt><dd></dd>
<dt><strong>estimator: Estimator object</strong></dt><dd></dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame indexed by persons_merged_df.index</span></dt><dd><p>‘choice’ : location choices (zone ids)
‘logsum’ : float logsum of choice utilities across alternatives</p>
</dd>
<dt>logsums optional &amp; only returned if DEST_CHOICE_LOGSUM_COLUMN_NAME specified in model_settings</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.run_location_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">run_location_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">location_sample_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>add logsum column to existing location_sample table</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_zone_id) pair
in location_sample, and computing the logsum of all the utilities</p>
<table class="table">
<colgroup>
<col style="width: 16%" />
<col style="width: 20%" />
<col style="width: 23%" />
<col style="width: 17%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>PERID</p></th>
<th class="head"><p>dest_zone_id</p></th>
<th class="head"><p>rand</p></th>
<th class="head"><p>pick_count</p></th>
<th class="head"><p>logsum (added)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>23750</p></td>
<td><p>14</p></td>
<td><p>0.565502716034</p></td>
<td><p>4</p></td>
<td><p>1.85659498857</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>23750</p></td>
<td rowspan="2"><p>16</p></td>
<td rowspan="2"><p>0.711135838871</p></td>
<td rowspan="2"><p>6</p></td>
<td rowspan="2"><p>1.92315598631</p></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2"><p>…</p></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td><p>23751</p></td>
<td><p>12</p></td>
<td><p>0.408038878552</p></td>
<td><p>1</p></td>
<td><p>2.40612135416</p></td>
</tr>
<tr class="row-even"><td><p>23751</p></td>
<td><p>14</p></td>
<td><p>0.972732479292</p></td>
<td><p>2</p></td>
<td><p>1.44009018355</p></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.run_location_sample">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">run_location_sample</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_sample" title="Permalink to this definition">#</a></dt>
<dd><p>select a sample of alternative locations.</p>
<p>Logsum calculations are expensive, so we build a table of persons * all zones
and then select a sample subset of potential locations</p>
<p>The sample subset is generated by making multiple choices (&lt;sample_size&gt; number of choices)
which results in sample containing up to &lt;sample_size&gt; choices for each choose (e.g. person)
and a pick_count indicating how many times that choice was selected for that chooser.)</p>
<p>person_id,  dest_zone_id, rand,            pick_count
23750,      14,           0.565502716034,  4
23750,      16,           0.711135838871,  6
…
23751,      12,           0.408038878552,  1
23751,      14,           0.972732479292,  2</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.run_location_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">run_location_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">location_sample_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_choice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>run location model on location_sample annotated with mode_choice logsum
to select a dest zone from sample alternatives</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame indexed by persons_merged_df.index</span></dt><dd><p>choice : location choices (zone ids)
logsum : float logsum of choice utilities across alternatives</p>
</dd>
<dt>logsums optional &amp; only returned if DEST_CHOICE_LOGSUM_COLUMN_NAME specified in model_settings</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.school_location">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">school_location</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.school_location" title="Permalink to this definition">#</a></dt>
<dd><p>School location choice model</p>
<p>iterate_location_choice adds location choice column and annotations to persons table</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.workplace_location">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">workplace_location</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.workplace_location" title="Permalink to this definition">#</a></dt>
<dd><p>workplace location choice model</p>
<p>iterate_location_choice adds location choice column and annotations to persons table</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.location_choice.write_estimation_specs">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></span><span class="sig-name descname"><span class="pre">write_estimation_specs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">settings_file</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.write_estimation_specs" title="Permalink to this definition">#</a></dt>
<dd><p>write sample_spec, spec, and coefficients to estimation data bundle</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong></dt><dd></dd>
<dt><strong>settings_file</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="shadow-pricing">
<span id="index-1"></span><span id="id8"></span><h2>Shadow Pricing<a class="headerlink" href="#shadow-pricing" title="Permalink to this headline">#</a></h2>
<p>The shadow pricing calculator used by work and school location choice.</p>
<p><strong>Turning on and saving shadow prices</strong></p>
<p>Shadow pricing is activated by setting the <code class="docutils literal notranslate"><span class="pre">use_shadow_pricing</span></code> to True in the settings.yaml file.
Once this setting has been activated, ActivitySim will search for shadow pricing configuration in
the shadow_pricing.yaml file. When shadow pricing is activated, the shadow pricing outputs will be
exported by the tracing engine. As a result, the shadow pricing output files will be prepended with
<code class="docutils literal notranslate"><span class="pre">trace</span></code> followed by the iteration number the results represent. For example, the shadow pricing
outputs for iteration 3 of the school location model will be called
<code class="docutils literal notranslate"><span class="pre">trace.shadow_price_school_shadow_prices_3.csv</span></code>.</p>
<p>In total, ActivitySim generates three types of output files for each model with shadow pricing:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">trace.shadow_price_&lt;model&gt;_desired_size.csv</span></code> The size terms by zone that the ctramp and daysim
methods are attempting to target. These equal the size term columns in the land use data
multiplied by size term coefficients.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trace.shadow_price_&lt;model&gt;_modeled_size_&lt;iteration&gt;.csv</span></code> These are the modeled size terms after
the iteration of shadow pricing identified by the &lt;iteration&gt; number. In other words, these are
the predicted choices by zone and segment for the model after the iteration completes. (Not
applicable for <code class="docutils literal notranslate"><span class="pre">simulation</span></code> option.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trace.shadow_price_&lt;model&gt;_shadow_prices_&lt;iteration&gt;.csv</span></code> The actual shadow price for each zone
and segment after the &lt;iteration&gt; of shadow pricing. This is the file that can be used to warm
start the shadow pricing mechanism in ActivitySim. (Not applicable for <code class="docutils literal notranslate"><span class="pre">simulation</span></code> option.)</p></li>
</ul>
<p>There are three shadow pricing methods in activitysim: <code class="docutils literal notranslate"><span class="pre">ctramp</span></code>, <code class="docutils literal notranslate"><span class="pre">daysim</span></code>, and <code class="docutils literal notranslate"><span class="pre">simulation</span></code>.
The first two methods try to match model output with workplace/school location model size terms,
while the last method matches model output with actual employment/enrollmment data.</p>
<p>The simulation approach operates the following steps.  First, every worker / student will be
assigned without shadow prices applied. The modeled share and the target share for each zone are
compared. If the zone is overassigned, a sample of people from the over-assigned zones will be
selected for re-simulation.  Shadow prices are set to -999 for the next iteration for overassigned
zones which removes the zone from the set of alternatives in the next iteration. The sampled people
will then be forced to choose from one of the under-assigned zones that still have the initial
shadow price of 0. (In this approach, the shadow price variable is really just a switch turning that
zone on or off for selection in the subsequent iterations. For this reason, warm-start functionality
for this approach is not applicable.)  This process repeats until the overall convergence criteria
is met or the maximum number of allowed iterations is reached.</p>
<p>Because the simulation approach only re-simulates workers / students who were over-assigned in the
previous iteration, run time is significantly less (~90%) than the CTRAMP or DaySim approaches which
re-simulate all workers and students at each iteration.</p>
<p><strong>shadow_pricing.yaml Attributes</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shadow_pricing_models</span></code> List model_selectors and model_names of models that use shadow pricing.
This list identifies which size_terms to preload which must be done in single process mode, so
predicted_size tables can be scaled to population</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOAD_SAVED_SHADOW_PRICES</span></code> global switch to enable/disable loading of saved shadow prices. From
the above example, this would be trace.shadow_price_&lt;model&gt;_shadow_prices_&lt;iteration&gt;.csv renamed
and stored in the <code class="docutils literal notranslate"><span class="pre">data_dir</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_ITERATIONS</span></code> If no loaded shadow prices, maximum number of times shadow pricing can be run
on each model before proceeding to the next model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_ITERATIONS_SAVED</span></code> If loaded shadow prices, maximum number of times shadow pricing can be
run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SIZE_THRESHOLD</span></code> Ignore zones in failure calculation (ctramp or daysim method) with smaller size
term value than size_threshold.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TARGET_THRESHOLD</span></code> Ignore zones in failure calculation (simulation method) with smaller
employment/enrollment than target_threshold.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PERCENT_TOLERANCE</span></code> Maximum percent difference between modeled and desired size terms</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FAIL_THRESHOLD</span></code> percentage of zones exceeding the PERCENT_TOLERANCE considered a failure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHADOW_PRICE_METHOD</span></code> [ctramp | daysim | simulation]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workplace_segmentation_targets</span></code> dict matching school segment to landuse employment column
target. Only used as part of simulation option. If mutiple segments list the same target column,
the segments will be added together for comparison. (Same with the school option below.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">school_segmentation_targets</span></code> dict matching school segment to landuse enrollment column target.
Only used as part of simulation option.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DAMPING_FACTOR</span></code> On each iteration, ActivitySim will attempt to adjust the model to match
desired size terms. The number is multiplied by adjustment factor to dampen or amplify the
ActivitySim calculation. (only for CTRAMP)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DAYSIM_ABSOLUTE_TOLERANCE</span></code> Absolute tolerance for DaySim option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DAYSIM_PERCENT_TOLERANCE</span></code> Relative tolerance for DaySim option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WRITE_ITERATION_CHOICES</span></code> [True | False ] Writes the choices of each person out to the trace
folder. Used for debugging or checking itration convergence. WARNING: every person is written for
each sub-process so the disc space can get large.</p></li>
</ul>
<span class="target" id="module-activitysim.abm.tables.shadow_pricing"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.block_name">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">block_name</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.block_name" title="Permalink to this definition">#</a></dt>
<dd><p>return canonical block name for model_selector</p>
<p>Ordinarily and ideally this would just be model_selector, but since mp_tasks saves all
shared data blocks in a common dict to pass to sub-tasks, we want to be able override
block naming convention to handle any collisions between model_selector names and skim names.
Until and unless that happens, we just use model_selector name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_selector</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>block_name</strong><span class="classifier">str</span></dt><dd><p>canonical block name</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">buffers_for_shadow_pricing</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shadow_pricing_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing" title="Permalink to this definition">#</a></dt>
<dd><p>Allocate shared_data buffers for multiprocess shadow pricing</p>
<p>Allocates one buffer per model_selector.
Buffer datatype and shape specified by shadow_pricing_info</p>
<p>buffers are multiprocessing.Array (RawArray protected by a multiprocessing.Lock wrapper)
We don’t actually use the wrapped version as it slows access down and doesn’t provide
protection for numpy-wrapped arrays, but it does provide a convenient way to bundle
RawArray and an associated lock. (ShadowPriceCalculator uses the lock to coordinate access to
the numpy-wrapped RawArray.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>shadow_pricing_info</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>data_buffers</strong><span class="classifier">dict {&lt;model_selector&gt;</span><span class="classifier">&lt;shared_data_buffer&gt;}</span></dt><dd></dd>
<dt>dict of multiprocessing.Array keyed by model_selector</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">buffers_for_shadow_pricing_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shadow_pricing_choice_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing_choice" title="Permalink to this definition">#</a></dt>
<dd><p>Same as above buffers_for_shadow_price function except now we need to store
the actual choices for the simulation based shadow pricing method</p>
<p>This allocates a multiprocessing.Array that can store the choice for each person
and then wraps a dataframe around it.  That means the dataframe can be shared
and accessed across all threads.
Parameters
———-
shadow_pricing_info : dict
Returns
——-</p>
<blockquote>
<div><p>data_buffers : dict {&lt;model_selector&gt; : &lt;shared_data_buffer&gt;}
dict of multiprocessing.Array keyed by model_selector</p>
<blockquote>
<div><p>and wrapped in a pandas dataframe</p>
</div></blockquote>
</div></blockquote>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.get_shadow_pricing_choice_info">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">get_shadow_pricing_choice_info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.get_shadow_pricing_choice_info" title="Permalink to this definition">#</a></dt>
<dd><p>return dict with info about dtype and shapes of desired and modeled size tables</p>
<p>block shape is (num_zones, num_segments + 1)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>shadow_pricing_info: dict</dt><dd><p>dtype: &lt;sp_dtype&gt;,
block_shapes: dict {&lt;model_selector&gt;: &lt;block_shape&gt;}</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.get_shadow_pricing_info">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">get_shadow_pricing_info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.get_shadow_pricing_info" title="Permalink to this definition">#</a></dt>
<dd><p>return dict with info about dtype and shapes of desired and modeled size tables</p>
<p>block shape is (num_zones, num_segments + 1)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>shadow_pricing_info: dict</dt><dd><p>dtype: &lt;sp_dtype&gt;,
block_shapes: dict {&lt;model_selector&gt;: &lt;block_shape&gt;}</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.load_shadow_price_calculator">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">load_shadow_price_calculator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.load_shadow_price_calculator" title="Permalink to this definition">#</a></dt>
<dd><p>Initialize ShadowPriceCalculator for model_selector (e.g. school or workplace)</p>
<p>If multiprocessing, get the shared_data buffer to coordinate global_desired_size
calculation across sub-processes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>spc</strong><span class="classifier">ShadowPriceCalculator</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.logger">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">logger</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.tables.shadow_pricing</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.logger" title="Permalink to this definition">#</a></dt>
<dd><p>ShadowPriceCalculator and associated utility methods</p>
<p>See docstrings for documentation on:</p>
<p>update_shadow_prices      how shadow_price coefficients are calculated
synchronize_modeled_size  interprocess communication to compute aggregate modeled_size
check_fit                 convergence criteria for shadow_pric iteration</p>
<p>Import concepts and variables:</p>
<dl class="simple">
<dt>model_selector: str</dt><dd><p>Identifies a specific location choice model (e.g. ‘school’, ‘workplace’)
The various models work similarly, but use different expression files, model settings, etc.</p>
</dd>
<dt>segment: str</dt><dd><p>Identifies a specific demographic segment of a model (e.g. ‘elementary’ segment of ‘school’)
Models can have different size term coefficients (in destinatin_choice_size_terms file) and
different utility coefficients in models’s location and location_sample csv expression files</p>
</dd>
</dl>
<p>size_table: pandas.DataFrame</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">shadow_price_data_from_buffers</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_buffers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shadow_pricing_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>data_buffers</strong><span class="classifier">dict of {&lt;model_selector&gt;</span><span class="classifier">&lt;multiprocessing.Array&gt;}</span></dt><dd><p>multiprocessing.Array is simply a convenient way to bundle Array and Lock
we extract the lock and wrap the RawArray in a numpy array for convenience in indexing
The shared data buffer has shape (&lt;num_zones, &lt;num_segments&gt; + 1)
extra column is for reverse semaphores with TALLY_CHECKIN and TALLY_CHECKOUT</p>
</dd>
<dt><strong>shadow_pricing_info</strong><span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>dict of useful info</dt><dd><p>dtype: sp_dtype,
block_shapes : OrderedDict({&lt;model_selector&gt;: &lt;shape tuple&gt;})
dict mapping model_selector to block shape (including extra column for semaphores)
e.g. {‘school’: (num_zones, num_segments + 1)</p>
</dd>
</dl>
</dd>
<dt><strong>model_selector</strong><span class="classifier">str</span></dt><dd><p>location type model_selector (e.g. school or workplace)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>shared_data, shared_data_lock</dt><dd><p>shared_data : multiprocessing.Array or None (if single process)
shared_data_lock : numpy array wrapping multiprocessing.RawArray or None (if single process)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">shadow_price_data_from_buffers_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_buffers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shadow_pricing_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers_choice" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>data_buffers</strong><span class="classifier">dict of {&lt;model_selector&gt;</span><span class="classifier">&lt;multiprocessing.Array&gt;}</span></dt><dd><p>multiprocessing.Array is simply a convenient way to bundle Array and Lock
we extract the lock and wrap the RawArray in a numpy array for convenience in indexing
The shared data buffer has shape (&lt;num_zones, &lt;num_segments&gt; + 1)
extra column is for reverse semaphores with TALLY_CHECKIN and TALLY_CHECKOUT</p>
</dd>
<dt><strong>shadow_pricing_info</strong><span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>dict of useful info</dt><dd><p>dtype: sp_dtype,
block_shapes : OrderedDict({&lt;model_selector&gt;: &lt;shape tuple&gt;})
dict mapping model_selector to block shape (including extra column for semaphores)
e.g. {‘school’: (num_zones, num_segments + 1)</p>
</dd>
</dl>
</dd>
<dt><strong>model_selector</strong><span class="classifier">str</span></dt><dd><p>location type model_selector (e.g. school or workplace)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>shared_data, shared_data_lock</dt><dd><p>shared_data : multiprocessing.Array or None (if single process)
shared_data_lock : numpy array wrapping multiprocessing.RawArray or None (if single process)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.tables.shadow_pricing.size_table_name">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></span><span class="sig-name descname"><span class="pre">size_table_name</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.size_table_name" title="Permalink to this definition">#</a></dt>
<dd><p>Returns canonical name of injected destination desired_size table</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_selector</strong><span class="classifier">str</span></dt><dd><p>e.g. school or workplace</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>table_name</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="transit-pass-subsidy">
<span id="id9"></span><h2>Transit Pass Subsidy<a class="headerlink" href="#transit-pass-subsidy" title="Permalink to this headline">#</a></h2>
<p>The transit fare discount model is defined as persons who purchase or are
provided a transit pass.  The transit fare discount consists of two submodels - this
transit pass subsidy model and a person <a class="reference internal" href="#transit-pass-ownership"><span class="std std-ref">Transit Pass Ownership</span></a> model.  The
result of this model can be used to condition downstream models such as the
person <a class="reference internal" href="#transit-pass-ownership"><span class="std std-ref">Transit Pass Ownership</span></a> model and the tour and trip mode choice models
via fare discount adjustments.</p>
<p>The main interface to the transit pass subsidy model is the
<a class="reference internal" href="#module-activitysim.abm.models.transit_pass_subsidy" title="activitysim.abm.models.transit_pass_subsidy"><code class="xref py py-func docutils literal notranslate"><span class="pre">transit_pass_subsidy()</span></code></a> function.  This
function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">transit_pass_subsidy</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.transit_pass_subsidy"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.transit_pass_subsidy.transit_pass_subsidy">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.transit_pass_subsidy.</span></span><span class="sig-name descname"><span class="pre">transit_pass_subsidy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.transit_pass_subsidy.transit_pass_subsidy" title="Permalink to this definition">#</a></dt>
<dd><p>Transit pass subsidy model.</p>
</dd></dl>

</section>
<section id="transit-pass-ownership">
<span id="id10"></span><h2>Transit Pass Ownership<a class="headerlink" href="#transit-pass-ownership" title="Permalink to this headline">#</a></h2>
<p>The transit fare discount is defined as persons who purchase or are
provided a transit pass.  The transit fare discount consists of two submodels - this
transit pass ownership model and a person <a class="reference internal" href="#transit-pass-subsidy"><span class="std std-ref">Transit Pass Subsidy</span></a> model. The
result of this model can be used to condition downstream models such as the tour and trip
mode choice models via fare discount adjustments.</p>
<p>The main interface to the transit pass ownership model is the
<a class="reference internal" href="#module-activitysim.abm.models.transit_pass_ownership" title="activitysim.abm.models.transit_pass_ownership"><code class="xref py py-func docutils literal notranslate"><span class="pre">transit_pass_ownership()</span></code></a> function.  This
function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">transit_pass_ownership</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.transit_pass_ownership"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.transit_pass_ownership.transit_pass_ownership">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.transit_pass_ownership.</span></span><span class="sig-name descname"><span class="pre">transit_pass_ownership</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.transit_pass_ownership.transit_pass_ownership" title="Permalink to this definition">#</a></dt>
<dd><p>Transit pass ownership model.</p>
</dd></dl>

</section>
<section id="auto-ownership">
<span id="id11"></span><h2>Auto Ownership<a class="headerlink" href="#auto-ownership" title="Permalink to this headline">#</a></h2>
<p>The auto ownership model selects a number of autos for each household in the simulation.
The primary model components are household demographics, zonal density, and accessibility.</p>
<p>The main interface to the auto ownership model is the
<a class="reference internal" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="activitysim.abm.models.auto_ownership.auto_ownership_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">auto_ownership_simulate()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">households</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">auto_ownership</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.auto_ownership"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.auto_ownership.auto_ownership_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.auto_ownership.</span></span><span class="sig-name descname"><span class="pre">auto_ownership_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Auto ownership is a standard model which predicts how many cars a household
with given characteristics owns</p>
</dd></dl>

</section>
<section id="vehicle-type-choice">
<span id="id12"></span><h2>Vehicle Type Choice<a class="headerlink" href="#vehicle-type-choice" title="Permalink to this headline">#</a></h2>
<p>The vehicle type choice model selects a vehicle type for each household vehicle. A vehicle type
is a combination of the vehicle’s body type, age, and fuel type.  For example, a 13 year old
gas powered van would have a vehicle type of <em>van_13_gas</em>.</p>
<p>There are two vehicle type choice model structures implemented:</p>
<ol class="arabic simple">
<li><p>Simultaneous choice of body type, age, and fuel type.</p></li>
<li><p>Simultaneous choice of body type and age, with fuel type assigned from a probability distribution.</p></li>
</ol>
<p>The <em>vehicle_type_choice.yaml</em> file contains the following model specific options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SPEC</span></code>: Filename for input utility expressions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COEFS</span></code>: Filename for input utility expression coefficients</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOGIT_TYPE</span></code>: Specifies whether you are using a nested or multinomial logit structure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">combinatorial_alts</span></code>: Specifies the alternatives for the choice model.
Has sub-categories of <code class="docutils literal notranslate"><span class="pre">body_type</span></code>, <code class="docutils literal notranslate"><span class="pre">age</span></code>, and <code class="docutils literal notranslate"><span class="pre">fuel_type</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PROBS_SPEC</span></code>: Filename for input fuel type probabilities. Supplying probabilities
corresponds to implementation structure 2 above, and not supplying probabilities would correspond to implementation structure 1.
If provided, the <code class="docutils literal notranslate"><span class="pre">fuel_type</span></code> category in <code class="docutils literal notranslate"><span class="pre">combinatorial_alts</span></code>
will be excluded from the model alternatives such that only body type and age are selected.  Input <code class="docutils literal notranslate"><span class="pre">PROBS_SPEC</span></code> table will have an index
column named <em>vehicle_type</em> which is a combination of body type and age in the form <code class="docutils literal notranslate"><span class="pre">{body</span> <span class="pre">type}_{age}</span></code>.  Subsequent column names
specify the fuel type that will be added and the column values are the probabilities of that fuel type.
The vehicle type model will select a fuel type for each vehicle based on the provided probabilities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VEHICLE_TYPE_DATA_FILE</span></code>: Filename for input vehicle type data. Must have columns <code class="docutils literal notranslate"><span class="pre">body_type</span></code>, <code class="docutils literal notranslate"><span class="pre">fuel_type</span></code>, and <code class="docutils literal notranslate"><span class="pre">vehicle_year</span></code>.
Vehicle <code class="docutils literal notranslate"><span class="pre">age</span></code> is computed using the <code class="docutils literal notranslate"><span class="pre">FLEET_YEAR</span></code> option. Data for every alternative specified in the <code class="docutils literal notranslate"><span class="pre">combinatorial_alts</span></code> option must be included
in the file. Vehicle type data file will be joined to the alternatives and can be used in the utility expressions if <code class="docutils literal notranslate"><span class="pre">PROBS_SPEC</span></code> is not provided.
If <code class="docutils literal notranslate"><span class="pre">PROBS_SPEC</span></code> is provided, the vehicle type data will be joined after a vehicle type is decided so the data can be used in downstream models.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COLS_TO_INCLUDE_IN_VEHICLE_TABLE</span></code>: List of columns from the vehicle type data file to include in the vehicle table that can be used in downstream models.
Examples of data that might be needed is vehicle range for the <a class="reference internal" href="#vehicle-allocation"><span class="std std-ref">Vehicle Allocation</span></a> model, auto operating costs to use in tour and trip mode choice,
and emissions data for post-model-run analysis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FLEET_YEAR</span></code>: Integer specifying the fleet year to be used in the model run. This is used to compute <code class="docutils literal notranslate"><span class="pre">age</span></code> in the
vehicle type data table where <code class="docutils literal notranslate"><span class="pre">age</span> <span class="pre">=</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">FLEET_YEAR</span> <span class="pre">-</span> <span class="pre">vehicle_year)</span></code>. Computing age on the fly with the <code class="docutils literal notranslate"><span class="pre">FLEET_YEAR</span></code> variable allows the
user flexibility to compile and share a single vehicle type data file containing all years and simply change the <code class="docutils literal notranslate"><span class="pre">FLEET_YEAR</span></code> to run
different scenario years.</p></li>
<li><p>Optional additional settings that work the same in other models are constants, expression preprocessor, and annotate tables.</p></li>
</ul>
<p>Input vehicle type data included in <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a> came from a variety of sources. The number of vehicle makes, models, MPG, and
electric vehicle range was sourced from the Enivornmental Protection Agency (EPA).  Additional data on vehicle costs were derived from the
National Household Travel Survey. Auto operating costs in the vehicle type data file were a sum of fuel costs and maintenance costs.
Fuel costs were calculated from MPG assuming a $3.00 cost for a gallon of gas. When MPG was not available to calculate fuel costs,
the closest year, vehicle type, or body type available was used. Maintenance costs were taken from AAA’s
<a class="reference external" href="https://exchange.aaa.com/wp-content/uploads/2017/08/17-0013_Your-Driving-Costs-Brochure-2017-FNL-CX-1.pdf">2017 driving cost study</a>.
Size categories within body types were averaged, e.g. car was an average of AAA’s small, medium, and large sedan categories.
Motorcycles were assigned the small sedan maintenance costs since they were not included in AAA’s report.
Maintenance costs were not varied by vehicle year. (According to
<a class="reference external" href="https://www.bls.gov/opub/btn/volume-3/pdf/americans-aging-autos.pdf">data from the U.S. Bureau of Labor Statistics</a>,
there was no consistent relationship between vehicle age and maintenance costs.)</p>
<p>Using the above methodology, the average auto operating costs of vehicles output from <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a> was 18.4 cents.
This value is very close to the auto operating cost of 18.3 cents used in <a class="reference internal" href="examples.html#prototype-mtc"><span class="std std-ref">prototype_mtc</span></a>.
Non-household vehicles in prototype_mtc_extended use the auto operating cost of 18.3 cents used in prototype_mtc.
Users are encouraged to make their own assumptions and calculate auto operating costs as they see fit.</p>
<p>The distribution of fuel type probabilities included in <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a> are computed directly from the National Household Travel Survey data
and include the entire US. Therefore, there is “lumpiness” in probabilities due to poor statistics in the data for some vehicle types.
The user is encouraged to adjust the probabilities to their modeling region and “smooth” them for more consistent results.</p>
<p>Further discussion of output results and model sensitivities can be found <a class="reference external" href="https://github.com/ActivitySim/activitysim/wiki/Project-Meeting-2022.05.05">here</a>.</p>
<span class="target" id="module-activitysim.abm.models.vehicle_type_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_households">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">annotate_vehicle_type_choice_households</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_households" title="Permalink to this definition">#</a></dt>
<dd><p>Add columns to the households table in the pipeline according to spec.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_persons">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">annotate_vehicle_type_choice_persons</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_persons" title="Permalink to this definition">#</a></dt>
<dd><p>Add columns to the persons table in the pipeline according to spec.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_vehicles">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">annotate_vehicle_type_choice_vehicles</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.annotate_vehicle_type_choice_vehicles" title="Permalink to this definition">#</a></dt>
<dd><p>Add columns to the vehicles table in the pipeline according to spec.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.append_probabilistic_vehtype_type_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">append_probabilistic_vehtype_type_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choices</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.append_probabilistic_vehtype_type_choices" title="Permalink to this definition">#</a></dt>
<dd><p>Select a fuel type for the provided body type and age of the vehicle.</p>
<p>Make probabilistic choices based on the <cite>PROBS_SPEC</cite> file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>selection of {body_type}_{age} to append vehicle type to</p>
</dd>
<dt><strong>probs_spec_file</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>table of chosen vehicle types</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.construct_model_alternatives">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">construct_model_alternatives</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts_cats_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vehicle_type_data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.construct_model_alternatives" title="Permalink to this definition">#</a></dt>
<dd><p>Construct the table of vehicle type alternatives.</p>
<p>Vehicle type data is joined to the alternatives table for use in utility expressions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>alts_cats_dict</strong><span class="classifier">dict</span></dt><dd><p>nested dictionary of vehicle body, age, and fuel options</p>
</dd>
<dt><strong>vehicle_type_data</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>alts_wide</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>includes column indicators and data for each alternative</p>
</dd>
<dt><strong>alts_long</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>rows just list the alternatives</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.get_combinatorial_vehicle_alternatives">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">get_combinatorial_vehicle_alternatives</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alts_cats_dict</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.get_combinatorial_vehicle_alternatives" title="Permalink to this definition">#</a></dt>
<dd><p>Build a pandas dataframe containing columns for each vehicle alternative.</p>
<p>Rows will correspond to the alternative number and will be 0 except for the
1 in the column corresponding to that alternative.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>alts_cats_dict</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>alts_wide</strong><span class="classifier">pd.DataFrame in wide format expanded using pandas get_dummies function</span></dt><dd></dd>
<dt><strong>alts_long</strong><span class="classifier">pd.DataFrame in long format</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.get_vehicle_type_data">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">get_vehicle_type_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vehicle_type_data_file</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.get_vehicle_type_data" title="Permalink to this definition">#</a></dt>
<dd><p>Read in the vehicle type data and computes the vehicle age.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>vehicle_type_data_file</strong><span class="classifier">str</span></dt><dd><p>name of vehicle type data file found in config folder</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>vehicle_type_data</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>table of vehicle type data with required body_type, age, and fuel_type columns</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.iterate_vehicle_type_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">iterate_vehicle_type_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">vehicles_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.iterate_vehicle_type_choice" title="Permalink to this definition">#</a></dt>
<dd><p>Select vehicle type for each household vehicle sequentially.</p>
<p>Iterate through household vehicle numbers and select a vehicle type of
the form {body_type}_{age}_{fuel_type}. The preprocessor is run for each
iteration on the entire chooser table, not just the one for the current
vehicle number.  This allows for computation of terms involving the presence
of other household vehicles.</p>
<p>Vehicle type data is read in according to the specification and joined to
the alternatives. It can optionally be included in the output vehicles table
by specifying the <cite>COLS_TO_INCLUDE_IN_VEHICLE_TABLE</cite> option in the model yaml.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>vehicles_merged</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd><p>vehicle list owned by each household merged with households table</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd><p>yaml model settings file as dict</p>
</dd>
<dt><strong>model_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>omnibus spec file with expressions in index and one column per segment</p>
</dd>
<dt><strong>locals_dict</strong><span class="classifier">dict</span></dt><dd><p>additional variables available when writing expressions</p>
</dd>
<dt><strong>estimator</strong><span class="classifier">Estimator object</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">orca.injectable</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>all_choices</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>single table of selected vehicle types and associated data</p>
</dd>
<dt><strong>all_choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>single table of chooser data with preprocessor variables included</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_type_choice.vehicle_type_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_type_choice.</span></span><span class="sig-name descname"><span class="pre">vehicle_type_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vehicles</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vehicles_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_type_choice.vehicle_type_choice" title="Permalink to this definition">#</a></dt>
<dd><p>Assign a vehicle type to each vehicle in the <cite>vehicles</cite> table.</p>
<p>If a “SIMULATION_TYPE” is set to simple_simulate in the
vehicle_type_choice.yaml config file, then the model specification .csv file
should contain one column of coefficients for each distinct alternative. This
format corresponds to ActivitySim’s <a class="reference internal" href="core.html#activitysim.core.simulate.simple_simulate" title="activitysim.core.simulate.simple_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.simulate.simple_simulate()</span></code></a>
format. Otherwise, this model will construct a table of alternatives, at run time,
based on all possible combinations of values of the categorical variables enumerated
as “combinatorial_alts” in the .yaml config. In this case, the model leverages
ActivitySim’s <a class="reference internal" href="core.html#module-activitysim.core.interaction_simulate" title="activitysim.core.interaction_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.interaction_simulate()</span></code></a> model design, in which
the model specification .csv has only one column of coefficients, and the utility
expressions can turn coefficients on or off based on attributes of either
the chooser _or_ the alternative.</p>
<p>As an optional second step, the user may also specify a “PROBS_SPEC” .csv file in
the main .yaml config, corresponding to a lookup table of additional vehicle
attributes and probabilities to be sampled and assigned to vehicles after the logit
choices have been made. The rows of the “PROBS_SPEC” file must include all body type
and vehicle age choices assigned in the logit model. These additional attributes are
concatenated with the selected alternative from the logit model to form a single
vehicle type name to be stored in the <cite>vehicles</cite> table as the vehicle_type column.</p>
<p>Only one household vehicle is selected at a time to allow for the introduction of
owned vehicle related attributes. For example, a household may be less likely to
own a second van if they already own one. The model is run sequentially through
household vehicle numbers. The preprocessor is run for each iteration on the entire
vehicles table to allow for computation of terms involving the presence of other
household vehicles.</p>
<p>The user may also augment the <cite>households</cite> or <cite>persons</cite> tables with new vehicle
type-based fields specified via expressions in “annotate_households_vehicle_type.csv”
and “annotate_persons_vehicle_type.csv”, respectively.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>households</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>vehicles</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>vehicles_merged</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">orca.injectable</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">orca.injectable</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="telecommute-frequency">
<span id="id13"></span><h2>Telecommute Frequency<a class="headerlink" href="#telecommute-frequency" title="Permalink to this headline">#</a></h2>
<p>Telecommuting is defined as workers who work from home instead of going to work. It only applies to
workers with a regular workplace outside of home. The telecommute model consists of two
submodels - a person <a class="reference internal" href="#work-from-home"><span class="std std-ref">Work From Home</span></a> model and this person telecommute frequency model.</p>
<p>For all workers that work out of the home, the telecommute models predicts the
level of telecommuting. The model alternatives are the frequency of telecommuting in
days per week (0 days, 1 day, 2 to 3 days, 4+ days).</p>
<p>The main interface to the work from home model is the
<a class="reference internal" href="#module-activitysim.abm.models.telecommute_frequency" title="activitysim.abm.models.telecommute_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">telecommute_frequency()</span></code></a> function.  This
function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">telecommute_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.telecommute_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.telecommute_frequency.telecommute_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.telecommute_frequency.</span></span><span class="sig-name descname"><span class="pre">telecommute_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.telecommute_frequency.telecommute_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the frequency of telecommute for a person (worker) who
does not works from home. The alternatives of this model are ‘No Telecommute’,
‘1 day per week’, ‘2 to 3 days per week’ and ‘4 days per week’. This model
reflects the choices of people who prefer a combination of working from home and
office during a week.</p>
</dd></dl>

</section>
<section id="free-parking-eligibility">
<span id="freeparking"></span><h2>Free Parking Eligibility<a class="headerlink" href="#free-parking-eligibility" title="Permalink to this headline">#</a></h2>
<p>The Free Parking Eligibility model predicts the availability of free parking at a person’s
workplace.  It is applied for people who work in zones that have parking charges, which are
generally located in the Central Business Districts. The purpose of the model is to adequately
reflect the cost of driving to work in subsequent models, particularly in mode choice.</p>
<p>The main interface to the free parking eligibility model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">free_parking()</span></code> function.  This function is registered
as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">free_parking_at_work</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.free_parking"></span></section>
<section id="coordinated-daily-activity-pattern">
<span id="cdap"></span><h2>Coordinated Daily Activity Pattern<a class="headerlink" href="#coordinated-daily-activity-pattern" title="Permalink to this headline">#</a></h2>
<p>The Coordinated Daily Activity Pattern (CDAP) model predicts the choice of daily activity pattern (DAP)
for each member in the household, simultaneously. The DAP is categorized in to three types as
follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>Mandatory: the person engages in travel to at least one out-of-home mandatory activity - work, university, or school. The mandatory pattern may also include non-mandatory activities such as separate home-based tours or intermediate stops on mandatory tours.</p></li>
<li><p>Non-mandatory: the person engages in only maintenance and discretionary tours, which, by definition, do not contain mandatory activities.</p></li>
<li><p>Home: the person does not travel outside the home.</p></li>
</ul>
</div></blockquote>
<p>The CDAP model is a sequence of vectorized table operations:</p>
<ul class="simple">
<li><p>create a person level table and rank each person in the household for inclusion in the CDAP model.  Priority is given to full time workers (up to two), then to part time workers (up to two workers, of any type), then to children (youngest to oldest, up to three).  Additional members up to five are randomly included for the CDAP calculation.</p></li>
<li><p>solve individual M/N/H utilities for each person</p></li>
<li><p>take as input an interaction coefficients table and then programmatically produce and write out the expression files for households size 1, 2, 3, 4, and 5 models independent of one another</p></li>
<li><p>select households of size 1, join all required person attributes, and then read and solve the automatically generated expressions</p></li>
<li><p>repeat for households size 2, 3, 4, and 5. Each model is independent of one another.</p></li>
</ul>
<p>The main interface to the CDAP model is the <a class="reference internal" href="#activitysim.abm.models.util.cdap.run_cdap" title="activitysim.abm.models.util.cdap.run_cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_cdap()</span></code></a>
function.  This function is called by the Inject step <code class="docutils literal notranslate"><span class="pre">cdap_simulate</span></code> which is
registered as an Inject step in the example Pipeline.  There are two cdap class definitions in
ActivitySim.  The first is at <a class="reference internal" href="#module-activitysim.abm.models.cdap" title="activitysim.abm.models.cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">cdap()</span></code></a> and contains the Inject
wrapper for running it as part of the model pipeline.  The second is
at <a class="reference internal" href="#module-activitysim.abm.models.util.cdap" title="activitysim.abm.models.util.cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">cdap()</span></code></a> and contains CDAP model logic.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">cdap_activity</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.cdap"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.cdap.cdap_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.cdap.</span></span><span class="sig-name descname"><span class="pre">cdap_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>CDAP stands for Coordinated Daily Activity Pattern, which is a choice of
high-level activity pattern for each person, in a coordinated way with other
members of a person’s household.</p>
<p>Because Python requires vectorization of computation, there are some specialized
routines in the cdap directory of activitysim for this purpose.  This module
simply applies those utilities using the simulation framework.</p>
</dd></dl>

</section>
<section id="mandatory-tour-frequency">
<span id="id14"></span><h2>Mandatory Tour Frequency<a class="headerlink" href="#mandatory-tour-frequency" title="Permalink to this headline">#</a></h2>
<p>The individual mandatory tour frequency model predicts the number of work and school tours
taken by each person with a mandatory DAP. The primary drivers of mandatory tour frequency
are demographics, accessibility-based parameters such as drive time to work, and household
automobile ownership.  It also creates mandatory tours in the data pipeline.</p>
<p>The main interface to the mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">mandatory_tour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.mandatory_tour_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.mandatory_tour_frequency.</span></span><span class="sig-name descname"><span class="pre">mandatory_tour_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the frequency of making mandatory trips (see the
alternatives above) - these trips include work and school in some combination.</p>
</dd></dl>

</section>
<section id="representative-logsums">
<span id="mandatory-tour-scheduling"></span><span id="id15"></span><h2>Mandatory Tour Scheduling<a class="headerlink" href="#representative-logsums" title="Permalink to this headline">#</a></h2>
<p>The mandatory tour scheduling model selects a tour departure and duration period (and therefore a
start and end period as well) for each mandatory tour.   The primary drivers in the model are
accessibility-based parameters such as the mode choice logsum for the departure/arrival hour
combination, demographics, and time pattern characteristics such as the time windows available
from previously scheduled tours. This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <code class="docutils literal notranslate"><span class="pre">prototype_mtc</span></code>, the modeled time periods for all submodels are hourly from 3 am to 3 am the next day, and any times before 5 am are shifted to time period 5, and any times after 11 pm are shifted to time period 23.</p>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">tour_departure_and_duration_segments.csv</span></code> is included in the configs, then the model
will use these representative start and end time periods when calculating mode choice logsums
instead of the specific start and end combinations for each alternative to reduce runtime.  This
feature, know as <code class="docutils literal notranslate"><span class="pre">representative</span> <span class="pre">logsums</span></code>, takes advantage of the fact that the mode choice logsum,
say, from 6 am to 2 pm is very similar to the logsum from 6 am to 3 pm, and 6 am to 4 pm, and so using
just 6 am to 3 pm (with the idea that 3 pm is the “representative time period”) for these alternatives is
sufficient for tour scheduling.  By reusing the 6 am to 3 pm mode choice logsum, ActivitySim saves
significant runtime.</p>
<p>The main interface to the mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">workplace_taz,</span> <span class="pre">school_taz,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.mandatory_scheduling"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.mandatory_scheduling.</span></span><span class="sig-name descname"><span class="pre">mandatory_tour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for mandatory tours</p>
</dd></dl>

</section>
<section id="school-escorting">
<span id="id16"></span><h2>School Escorting<a class="headerlink" href="#school-escorting" title="Permalink to this headline">#</a></h2>
<p>The school escort model determines whether children are dropped-off at or picked-up from school,
simultaneously with the chaperone responsible for chauffeuring the children,
which children are bundled together on half-tours, and the type of tour (pure escort versus rideshare).
The model is run after work and school locations have been chosen for all household members,
and after work and school tours have been generated and scheduled.
The model labels household members of driving age as potential ‘chauffeurs’ and children with school tours as potential ‘escortees’.
The model then attempts to match potential chauffeurs with potential escortees in a choice model whose alternatives
consist of ‘bundles’ of escortees with a chauffeur for each half tour.</p>
<p>School escorting is a household level decision – each household will choose an alternative from the <code class="docutils literal notranslate"><span class="pre">school_escorting_alts.csv</span></code> file,
with the first alternative being no escorting. This file contains the following columns:</p>
<table class="table">
<colgroup>
<col style="width: 41%" />
<col style="width: 59%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Column Name</p></th>
<th class="head"><p>Column Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Alt</p></td>
<td><p>Alternative number</p></td>
</tr>
<tr class="row-odd"><td><p>bundle[1,2,3]</p></td>
<td><p>bundle number for child 1,2, and 3</p></td>
</tr>
<tr class="row-even"><td><p>chauf[1,2,3]</p></td>
<td><p>chauffeur number for child 1,2, and 3
- 0 = child not escorted
- 1 = chauffeur 1 as ride share
- 2 = chauffeur 1 as pure escort
- 3 = chauffeur 2 as ride share
- 4 = chauffeur 3 as pure escort</p></td>
</tr>
<tr class="row-odd"><td><p>nbund[1,2]</p></td>
<td><ul class="simple">
<li><p>number of escorting bundles for chauffeur 1 and 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>nbundles</p></td>
<td><ul class="simple">
<li><p>total number of bundles</p></li>
<li><p>equals nbund1 + nbund2</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>nrs1</p></td>
<td><ul class="simple">
<li><p>number of ride share bundles for chauffeur 1</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>npe1</p></td>
<td><ul class="simple">
<li><p>number of pure escort bundles for chauffeur 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>nrs2</p></td>
<td><ul class="simple">
<li><p>number of ride share bundles for chauffeur 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>npe2</p></td>
<td><ul class="simple">
<li><p>number of pure escort bundles for chauffeur 2</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Description</p></td>
<td><ul class="simple">
<li><p>text description of alternative</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The model as currently implemented contains three escortees and two chauffeurs.
Escortees are students under age 16 with a mandatory tour whereas chaperones are all persons in the household over the age of 18.
For households that have more than three possible escortees, the three youngest children are selected for the model.
The two chaperones are selected as the adults of the household with the highest weight according to the following calculation:
<span class="math notranslate nohighlight">\(Weight = 100*personType + 10*gender + 1*age(0,1)\)</span>
Where <em>personType</em> is the person type number from 1 to 5, <em>gender</em> is 1 for male and 2 for female, and
<em>age</em> is a binary indicator equal to 1 if age is over 25 else 0.</p>
<p>The model is run sequentially three times, once in the outbound direction, once in the inbound direction,
and again in the outbound direction with additional conditions on what happened in the inbound direction.
There are therefore three sets of utility specifications, coefficients, and pre-processor files.
Each of these files is specified in the school_escorting.yaml file along with the number of escortees and number of chaperones.</p>
<p>There is also a constants section in the school_escorting.yaml file which contain two constants.
One which sets the maximum time bin difference to match school and work tours for ride sharing
and another to set the number of minutes per time bin.
In the <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a> example, these are set to 1 and 60 respectively.</p>
<p>After a school escorting alternative is chosen for the inbound and outbound direction, the model will
create the tours and trips associated with the decision.  Pure escort tours are created,
and the mandatory tour start and end times are changed to match the school escort bundle start and end times.
(Outbound tours have their start times matched and inbound tours have their end times matched.)
Escortee drop-off / pick-up order is determined by the distance from home to the school locations.
They are ordered from smallest to largest in the outbound direction, and largest to smallest in the inbound direction.
Trips are created for each half-tour that includes school escorting according to the provided order.</p>
<p>The created pure escort tours are joined to the already created mandatory tour table in the pipeline
and are also saved separately to the pipeline under the table name “school_escort_tours”.
Created school escorting trips are saved to the pipeline under the table name “school_escort_trips”.
By saving these to the pipeline, their data can be queried in downstream models to set correct purposes,
destinations, and schedules to satisfy the school escorting model choice.</p>
<p>There are a host of downstream model changes that are involved when including the school escorting model.
The following list contains the models that are changed in some way when school escorting is included:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Joint tour scheduling:</strong> Joint tours are not allowed to be scheduled over school escort tours.
This happens automatically by updating the timetable object with the updated mandatory tour times
and created pure escort tour times after the school escorting model is run.
There were no code or config changes in this model, but it is still affected by school escorting.</p></li>
<li><p><strong>Non-Mandatory tour frequency:</strong>  Pure school escort tours are joined to the tours created in the
non-mandatory tour frequency model and tour statistics (such as tour_count and tour_num) are re-calculated.</p></li>
<li><p><strong>Non-Mandatory tour destination:</strong> Since the primary destination of pure school escort tours is known,
they are removed from the choosers table and have their destination set according to the destination inschool_escort_tours table.  They are also excluded from the estimation data bundle.</p></li>
<li><p><strong>Non-Mandatory tour scheduling:</strong> Pure escort tours need to have the non-escorting portion of their tour scheduled.
This is done by inserting availability conditions in the model specification that ensures the alternative
chosen for the start of the tour is equal to the alternative start time for outbound tours and the end time
is equal to the alternative end time for the inbound tours.  There are additional terms that ensure the tour
does not overlap with subsequent school escorting tours as well.  Beware – If the availability conditions
in the school escorting model are not set correctly, the tours created may not be consistent with each other
and this model will fail.</p></li>
<li><p><strong>Tour mode choice:</strong> Availability conditions are set in tour mode choice to prohibit the drive alone mode
if the tour contains an escortee and the shared-ride 2 mode if the tour contains more than one escortee.</p></li>
<li><p><strong>Stop Frequency:</strong> No stops are allowed on half-tours that include school escorting.
This is enforced by adding availability conditions in the stop frequency model.  After the stop frequency
model is run, the school escorting trips are merged from the trips created by the stop frequency model
and a new stop frequency is computed along with updated trip numbers.</p></li>
<li><p><strong>Trip purpose, destination, and scheduling:</strong> Trip purpose, destination, and departure times are known
for school escorting trips.  As such they are removed from their respective chooser tables and the estimation
data bundles, and set according to the values in the school_escort_trips table residing in the pipeline.</p></li>
<li><p><strong>Trip mode choice:</strong> Like in tour mode choice, availability conditions are set to prohibit trip containing
an escortee to use the drive alone mode or the shared-ride 2 mode for trips with more than one escortee.</p></li>
</ul>
</div></blockquote>
<p>Many of the changes discussed in the above list are handled in the code and the user is not required to make any
changes when implementing the school escorting model.  However, it is the users responsibility to include the
changes in the following model configuration files for models downstream of the school escorting model:</p>
<table class="table">
<colgroup>
<col style="width: 51%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>File Name(s)</p></th>
<th class="head"><p>Change(s) Needed</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li><p><cite>non_mandatory_tour_scheduling_annotate_tours_preprocessor.csv</cite></p></li>
<li><p><cite>tour_scheduling_nonmandatory.csv</cite></p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>Set availability conditions based on those times</p></li>
<li><p>Do not schedule over other school escort tours</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><cite>tour_mode_choice_annotate_choosers_preprocessor.csv</cite></p></li>
<li><p><cite>tour_mode_choice.csv</cite></p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>count number of escortees on tour by parsing the</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">escort_participants</span></code> column
- set mode choice availability based on number of escortees</p>
</td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li><p><cite>stop_frequency_school.csv</cite></p></li>
<li><p><cite>stop_frequency_work.csv</cite></p></li>
<li><p><cite>stop_frequency_univ.csv</cite></p></li>
<li><p><cite>stop_frequency_escort.csv</cite></p></li>
</ul>
</td>
<td><p>Do not allow stops for half-tours that include school escorting</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><cite>trip_mode_choice_annotate_trips_preprocessor.csv</cite></p></li>
<li><p><cite>trip_mode_choice.csv</cite></p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>count number of escortees on trip by parsing the</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">escort_participants</span></code> column
- set mode choice availability based on number of escortees</p>
</td>
</tr>
</tbody>
</table>
<p>When not including the school escorting model, all of the escort trips to and from school are counted implicitly in
escort tours determined in the non-mandatory tour frequency model. Thus, when including the school escort model and
accounting for these tours explicitly, extra care should be taken not to double count them in the non-mandatory
tour frequency model. The non-mandatory tour frequency model should be re-evaluated and likely changed to decrease
the number of escort tours generated by that model.  This was not implemented in the <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a>
implementation due to a lack of data surrounding the number of escort tours in the region.</p>
<span class="target" id="module-activitysim.abm.models.school_escorting"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.school_escorting.check_alts_consistency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.school_escorting.</span></span><span class="sig-name descname"><span class="pre">check_alts_consistency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_escorting.check_alts_consistency" title="Permalink to this definition">#</a></dt>
<dd><p>Checking to ensure that the alternatives file is consistent with
the number of chaperones and escortees set in the model settings.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.school_escorting.create_bundle_attributes">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.school_escorting.</span></span><span class="sig-name descname"><span class="pre">create_bundle_attributes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">row</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_escorting.create_bundle_attributes" title="Permalink to this definition">#</a></dt>
<dd><p>Parse a bundle to determine escortee numbers and tour info.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.school_escorting.create_school_escorting_bundles_table">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.school_escorting.</span></span><span class="sig-name descname"><span class="pre">create_school_escorting_bundles_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">stage</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_escorting.create_school_escorting_bundles_table" title="Permalink to this definition">#</a></dt>
<dd><p>Creates a table that has one row for every school escorting bundle.
Additional calculations are performed to help facilitate tour and
trip creation including escortee order, times, etc.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>households pre-processed for the school escorting model</p>
</dd>
<dt><strong>tours</strong><span class="classifier">pd.Dataframe</span></dt><dd><p>mandatory tours</p>
</dd>
<dt><strong>stage</strong><span class="classifier">str</span></dt><dd><p>inbound or outbound_cond</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>bundles</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>one school escorting bundle per row</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.school_escorting.determine_escorting_participants">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.school_escorting.</span></span><span class="sig-name descname"><span class="pre">determine_escorting_participants</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_escorting.determine_escorting_participants" title="Permalink to this definition">#</a></dt>
<dd><p>Determining which persons correspond to chauffer 1..n and escortee 1..n.
Chauffers are those with the highest weight given by:
weight = 100 * person type +  10 * gender + 1*(age &gt; 25)
and escortees are selected youngest to oldest.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.school_escorting.school_escorting">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.school_escorting.</span></span><span class="sig-name descname"><span class="pre">school_escorting</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_escorting.school_escorting" title="Permalink to this definition">#</a></dt>
<dd><p>school escorting model</p>
<p>The school escorting model determines whether children are dropped-off at or
picked-up from school, simultaneously with the driver responsible for
chauffeuring the children, which children are bundled together on half-tours,
and the type of tour (pure escort versus rideshare).</p>
<p>Run iteratively for an outbound choice, an inbound choice, and an outbound choice
conditional on the inbound choice. The choices for inbound and outbound conditional
are used to create school escort tours and trips.</p>
<p>Updates / adds the following tables to the pipeline:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">households</span> <span class="k">with</span> <span class="n">school</span> <span class="n">escorting</span> <span class="n">choice</span>
<span class="o">-</span> <span class="n">tours</span> <span class="n">including</span> <span class="n">pure</span> <span class="n">school</span> <span class="n">escorting</span>
<span class="o">-</span> <span class="n">school_escort_tours</span> <span class="n">which</span> <span class="n">contains</span> <span class="n">only</span> <span class="n">pure</span> <span class="n">school</span> <span class="n">escort</span> <span class="n">tours</span>
<span class="o">-</span> <span class="n">school_escort_trips</span>
<span class="o">-</span> <span class="n">timetable</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">joint</span> <span class="n">tours</span> <span class="n">scheduled</span> <span class="n">over</span> <span class="n">school</span> <span class="n">escort</span> <span class="n">tours</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="joint-tour-frequency">
<span id="id17"></span><h2>Joint Tour Frequency<a class="headerlink" href="#joint-tour-frequency" title="Permalink to this headline">#</a></h2>
<p>The joint tour generation models are divided into three sub-models: the joint tour frequency
model, the party composition model, and the person participation model. In the joint tour
frequency model, the household chooses the purposes and number (up to two) of its fully joint
travel tours.  It also creates joints tours in the data pipeline.</p>
<p>The main interface to the joint tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_frequency.joint_tour_frequency" title="activitysim.abm.models.joint_tour_frequency.joint_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_frequency()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">households</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">num_hh_joint_tours</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_frequency.joint_tour_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_frequency.</span></span><span class="sig-name descname"><span class="pre">joint_tour_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_frequency.joint_tour_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the frequency of making fully joint trips (see the
alternatives above).</p>
</dd></dl>

</section>
<section id="joint-tour-composition">
<span id="id18"></span><h2>Joint Tour Composition<a class="headerlink" href="#joint-tour-composition" title="Permalink to this headline">#</a></h2>
<p>In the joint tour party composition model, the makeup of the travel party (adults, children, or
mixed - adults and children) is determined for each joint tour.  The party composition determines the
general makeup of the party of participants in each joint tour in order to allow the micro-simulation
to faithfully represent the prevalence of adult-only, children-only, and mixed joint travel tours
for each purpose while permitting simplicity in the subsequent person participation model.</p>
<p>The main interface to the joint tour composition model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_composition.joint_tour_composition" title="activitysim.abm.models.joint_tour_composition.joint_tour_composition"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_composition()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">composition</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_composition"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_composition.joint_tour_composition">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_composition.</span></span><span class="sig-name descname"><span class="pre">joint_tour_composition</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_composition.joint_tour_composition" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the makeup of the travel party (adults, children, or mixed).</p>
</dd></dl>

</section>
<section id="joint-tour-participation">
<span id="id19"></span><h2>Joint Tour Participation<a class="headerlink" href="#joint-tour-participation" title="Permalink to this headline">#</a></h2>
<p>In the joint tour person participation model, each eligible person sequentially makes a
choice to participate or not participate in each joint tour.  Since the party composition model
determines what types of people are eligible to join a given tour, the person participation model
can operate in an iterative fashion, with each household member choosing to join or not to join
a travel party independent of the decisions of other household members. In the event that the
constraints posed by the result of the party composition model are not met, the person
participation model cycles through the household members multiple times until the required
types of people have joined the travel party.</p>
<p>This step also creates the <code class="docutils literal notranslate"><span class="pre">joint_tour_participants</span></code> table in the pipeline, which stores the
person ids for each person on the tour.</p>
<p>The main interface to the joint tour participation model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_participation.joint_tour_participation" title="activitysim.abm.models.joint_tour_participation.joint_tour_participation"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_participation()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">number_of_participants,</span> <span class="pre">person_id</span> <span class="pre">(for</span> <span class="pre">the</span> <span class="pre">point</span> <span class="pre">person)</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_participation"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_participation.joint_tour_participation">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_participation.</span></span><span class="sig-name descname"><span class="pre">joint_tour_participation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_participation.joint_tour_participation" title="Permalink to this definition">#</a></dt>
<dd><p>Predicts for each eligible person to participate or not participate in each joint tour.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_participation.participants_chooser">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_participation.</span></span><span class="sig-name descname"><span class="pre">participants_chooser</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">probs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_participation.participants_chooser" title="Permalink to this definition">#</a></dt>
<dd><p>custom alternative to logit.make_choices for simulate.simple_simulate</p>
<p>Choosing participants for mixed tours is trickier than adult or child tours becuase we
need at least one adult and one child participant in a mixed tour. We call logit.make_choices
and then check to see if the tour statisfies this requirement, and rechoose for any that
fail until all are satisfied.</p>
<p>In principal, this shold always occur eventually, but we fail after MAX_ITERATIONS,
just in case there is some failure in program logic (haven’t seen this occur.)</p>
<p>The return values are the same as logit.make_choices</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>probs</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rows for choosers and columns for the alternatives from which they
are choosing. Values are expected to be valid probabilities across
each row, e.g. they should sum to 1.</p>
</dd>
<dt><strong>choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>simple_simulate choosers df</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>simple_simulate spec df
We only need spec so we can know the column index of the ‘participate’ alternative
indicating that the participant has been chosen to participate in the tour</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>choices, rands</dt><dd><p>choices, rands as returned by logit.make_choices (in same order as probs)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="joint-tour-destination-choice">
<span id="id20"></span><h2>Joint Tour Destination Choice<a class="headerlink" href="#joint-tour-destination-choice" title="Permalink to this headline">#</a></h2>
<p>The joint tour destination choice model operate similarly to the usual work and
school location choice model, selecting the primary destination for travel tours. The only
procedural difference between the models is that the usual work and school location choice
model selects the usual location of an activity whether or not the activity is undertaken during the
travel day, while the joint tour destination choice model selects the location for an
activity which has already been generated.</p>
<p>The tour’s primary destination is the location of the activity that is assumed to provide the greatest
impetus for engaging in the travel tour. In the household survey, the primary destination was not asked, but
rather inferred from the pattern of stops in a closed loop in the respondents’ travel diaries. The
inference was made by weighing multiple criteria including a defined hierarchy of purposes, the
duration of activities, and the distance from the tour origin. The model operates in the reverse
direction, designating the primary purpose and destination and then adding intermediate stops
based on spatial, temporal, and modal characteristics of the inbound and outbound journeys to
the primary destination.</p>
<dl class="simple">
<dt>The joint tour destination choice model is made up of three model steps:</dt><dd><ul class="simple">
<li><p>sample - selects a sample of alternative locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final location, this time with the mode choice logsum included.</p></li>
</ul>
</dd>
</dl>
<p>Joint tour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">placeholder_multiple_zone</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interface to the model is the <a class="reference internal" href="#activitysim.abm.models.joint_tour_destination.joint_tour_destination" title="activitysim.abm.models.joint_tour_destination.joint_tour_destination"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_destination()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how
to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.joint_tour_destination"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_destination.joint_tour_destination">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_destination.</span></span><span class="sig-name descname"><span class="pre">joint_tour_destination</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_destination.joint_tour_destination" title="Permalink to this definition">#</a></dt>
<dd><p>Given the tour generation from the above, each tour needs to have a
destination, so in this case tours are the choosers (with the associated
person that’s making the tour)</p>
</dd></dl>

</section>
<section id="joint-tour-scheduling">
<span id="id21"></span><h2>Joint Tour Scheduling<a class="headerlink" href="#joint-tour-scheduling" title="Permalink to this headline">#</a></h2>
<p>The joint tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each joint tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>. The primary drivers in the
models are accessibility-based parameters such
as the auto travel time for the departure/arrival hour combination, demographics, and time
pattern characteristics such as the time windows available from previously scheduled tours.
The joint tour scheduling model does not use mode choice logsums.</p>
<p>The main interface to the joint tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling" title="activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_scheduling()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: `` TAZ, destination, MD time period, MD time period``</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_scheduling"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">joint_tour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the departure time and duration of each joint tour</p>
</dd></dl>

</section>
<section id="non-mandatory-tour-frequency">
<span id="id22"></span><h2>Non-Mandatory Tour Frequency<a class="headerlink" href="#non-mandatory-tour-frequency" title="Permalink to this headline">#</a></h2>
<p>The non-mandatory tour frequency model selects the number of non-mandatory tours made by each person on the simulation day.
It also adds non-mandatory tours to the tours in the data pipeline. The individual non-mandatory tour frequency model
operates in two stages:</p>
<blockquote>
<div><ul class="simple">
<li><p>A choice is made using a random utility model between combinations of tours containing zero, one, and two or more escort tours, and between zero and one or more tours of each other purpose.</p></li>
<li><p>Up to two additional tours of each purpose are added according to fixed extension probabilities.</p></li>
</ul>
</div></blockquote>
<p>The main interface to the non-mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">non_mandatory_tour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_tour_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.non_mandatory_tour_frequency.extend_tour_counts">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_tour_frequency.</span></span><span class="sig-name descname"><span class="pre">extend_tour_counts</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.extend_tour_counts" title="Permalink to this definition">#</a></dt>
<dd><p>extend tour counts based on a probability table</p>
<p>counts can only be extended if original count is between 1 and 4
and tours can only be extended if their count is at the max possible
(e.g. 2 for escort, 1 otherwise) so escort might be increased to 3 or 4
and other tour types might be increased to 2 or 3</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons: pandas dataframe</strong></dt><dd><p>(need this for join columns)</p>
</dd>
<dt><strong>tour_counts: pandas dataframe</strong></dt><dd><p>one row per person, once column per tour_type</p>
</dd>
<dt><strong>alternatives</strong></dt><dd><p>alternatives from nmtv interaction_simulate
only need this to know max possible frequency for a tour type</p>
</dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>extended tour_counts</dt><dd></dd>
<dt>tour_counts looks like this:</dt><dd><p>escort  shopping  othmaint  othdiscr    eatout    social</p>
</dd>
<dt>parent_id</dt><dd></dd>
<dt>2588676         2         0         0         1         1         0</dt><dd></dd>
<dt>2588677         0         1         0         1         0         0</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_tour_frequency.</span></span><span class="sig-name descname"><span class="pre">non_mandatory_tour_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the frequency of making non-mandatory trips
(alternatives for this model come from a separate csv file which is
configured by the user) - these trips include escort, shopping, othmaint,
othdiscr, eatout, and social trips in various combination.</p>
</dd></dl>

</section>
<section id="non-mandatory-tour-destination-choice">
<span id="id23"></span><h2>Non-Mandatory Tour Destination Choice<a class="headerlink" href="#non-mandatory-tour-destination-choice" title="Permalink to this headline">#</a></h2>
<p>The non-mandatory tour destination choice model chooses a destination zone for
non-mandatory tours.  The three step (sample, logsums, final choice) process also used for
mandatory tour destination choice is used for non-mandatory tour destination choice.</p>
<p>Non-mandatory tour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">placeholder_multiple_zone</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interface to the non-mandatory tour destination choice model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination" title="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_destination()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a>
for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_destination"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_destination.</span></span><span class="sig-name descname"><span class="pre">non_mandatory_tour_destination</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination" title="Permalink to this definition">#</a></dt>
<dd><p>Given the tour generation from the above, each tour needs to have a
destination, so in this case tours are the choosers (with the associated
person that’s making the tour)</p>
</dd></dl>

</section>
<section id="non-mandatory-tour-scheduling">
<span id="id24"></span><h2>Non-Mandatory Tour Scheduling<a class="headerlink" href="#non-mandatory-tour-scheduling" title="Permalink to this headline">#</a></h2>
<p>The non-mandatory tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each non-mandatory tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.  Includes support
for <a class="reference internal" href="#representative-logsums"><span class="std std-ref">Mandatory Tour Scheduling</span></a>.</p>
<p>The main interface to the non-mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">destination,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_scheduling"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_scheduling.</span></span><span class="sig-name descname"><span class="pre">non_mandatory_tour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for non-mandatory tours</p>
</dd></dl>

</section>
<section id="vehicle-allocation">
<span id="id25"></span><h2>Vehicle Allocation<a class="headerlink" href="#vehicle-allocation" title="Permalink to this headline">#</a></h2>
<p>The vehicle allocation model selects which vehicle would be used for a tour of given occupancy. The alternatives for the vehicle
allocation model consist of the vehicles owned by the household and an additional non household vehicle option. (Zero-auto
households would be assigned the non-household vehicle option since there are no owned vehicles in the household).
A vehicle is selected for each occupancy level set by the user such that different tour modes that have different occupancies could see different operating
characteristics. The output of the vehicle allocation model is appended to the tour table with column names <code class="docutils literal notranslate"><span class="pre">vehicle_occup_{occupancy}</span></code> and the values are
the vehicle type selected.</p>
<p>In <a class="reference internal" href="examples.html#prototype-mtc-extended"><span class="std std-ref">prototype_mtc_extended</span></a>, three occupancy levels are used: 1, 2, and 3.5.  The auto operating cost
for occupancy level 1 is used in the drive alone mode and drive to transit modes. Occupancy levels 2 and 3.5 are used for shared
ride 2 and shared ride 3+ auto operating costs, respectively.  Auto operating costs are selected in the mode choice pre-processors by selecting the allocated
vehicle type data from the vehicles table. If the allocated vehicle type was the non-household vehicle, the auto operating costs uses
the previous default value from <a class="reference internal" href="examples.html#prototype-mtc"><span class="std std-ref">prototype_mtc</span></a>. All trips and atwork subtours use the auto operating cost of the parent tour.  Functionality
was added in tour and atwork subtour mode choice to annotate the tour table and create a <code class="docutils literal notranslate"><span class="pre">selected_vehicle</span></code> which denotes the actual vehicle used.
If the tour mode does not include a vehicle, then the <code class="docutils literal notranslate"><span class="pre">selected_vehicle</span></code> entry is left blank.</p>
<p>The current implementation does not account for possible use of the household vehicles by other household members.  Thus, it is possible for a
selected vehicle to be used in two separate tours at the same time.</p>
<span class="target" id="module-activitysim.abm.models.vehicle_allocation"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_allocation.annotate_vehicle_allocation">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_allocation.</span></span><span class="sig-name descname"><span class="pre">annotate_vehicle_allocation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_allocation.annotate_vehicle_allocation" title="Permalink to this definition">#</a></dt>
<dd><p>Add columns to the tours table in the pipeline according to spec.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_allocation.get_skim_dict">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_allocation.</span></span><span class="sig-name descname"><span class="pre">get_skim_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_allocation.get_skim_dict" title="Permalink to this definition">#</a></dt>
<dd><p>Returns a dictionary of skim wrappers to use in expression writing.</p>
<p>Skims have origin as home_zone_id and destination as the tour destination.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>network_los</strong><span class="classifier">activitysim.core.los.Network_LOS object</span></dt><dd></dd>
<dt><strong>choosers</strong><span class="classifier">pd.DataFrame</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>skims</strong><span class="classifier">dict</span></dt><dd><p>index is skim wrapper name, value is the skim wrapper</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.vehicle_allocation.vehicle_allocation">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.vehicle_allocation.</span></span><span class="sig-name descname"><span class="pre">vehicle_allocation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vehicles</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.vehicle_allocation.vehicle_allocation" title="Permalink to this definition">#</a></dt>
<dd><p>Selects a vehicle for each occupancy level for each tour.</p>
<p>Alternatives consist of the up to the number of household vehicles plus one
option for non-household vehicles.</p>
<p>The model will be run once for each tour occupancy defined in the model yaml.
Output tour table will columns added for each occupancy level.</p>
<p>The user may also augment the <cite>tours</cite> tables with new vehicle
type-based fields specified via the annotate_tours option.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>households</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>vehicles</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>vehicles_merged</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>tours</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>tours_merged</strong><span class="classifier">orca.DataFrameWrapper</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">orca.injectable</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">orca.injectable</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="tour-mode-choice">
<span id="id26"></span><h2>Tour Mode Choice<a class="headerlink" href="#tour-mode-choice" title="Permalink to this headline">#</a></h2>
<p>The mandatory, non-mandatory, and joint tour mode choice model assigns to each tour the “primary” mode that
is used to get from the origin to the primary destination. The tour-based modeling approach requires a reconsideration
of the conventional mode choice structure. Instead of a single mode choice model used in a four-step
structure, there are two different levels where the mode choice decision is modeled: (a) the
tour mode level (upper-level choice); and, (b) the trip mode level (lower-level choice conditional
upon the upper-level choice).</p>
<p>The mandatory, non-mandatory, and joint tour mode level represents the decisions that apply to the entire tour, and
that will affect the alternatives available for each individual trip or joint trip. These decisions include the choice to use a private
car versus using public transit, walking, or biking; whether carpooling will be considered; and
whether transit will be accessed by car or by foot. Trip-level decisions correspond to details of
the exact mode used for each trip, which may or may not change over the trips in the tour.</p>
<p>The mandatory, non-mandatory, and joint tour mode choice structure is a nested logit model which separates
similar modes into different nests to more accurately model the cross-elasticities between the alternatives. The
eighteen modes are incorporated into the nesting structure specified in the model settings file. The
first level of nesting represents the use a private car, non-motorized
means, or transit. In the second level of nesting, the auto nest is divided into vehicle occupancy
categories, and transit is divided into walk access and drive access nests. The final level splits
the auto nests into free or pay alternatives and the transit nests into the specific line-haul modes.</p>
<p>The primary variables are in-vehicle time, other travel times, cost (the influence of which is derived
from the automobile in-vehicle time coefficient and the persons’ modeled value of time),
characteristics of the destination zone, demographics, and the household’s level of auto
ownership.</p>
<p>The main interface to the mandatory, non-mandatory, and joint tour mode model is the
<a class="reference internal" href="#activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate" title="activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">tour_mode_choice_simulate()</span></code></a> function.  This function is
called in the Inject step <code class="docutils literal notranslate"><span class="pre">tour_mode_choice_simulate</span></code> and is registered as an Inject step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">destination,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.tour_mode_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.append_tour_leg_trip_mode_choice_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">append_tour_leg_trip_mode_choice_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.append_tour_leg_trip_mode_choice_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>Creates trip mode choice logsum column in tours table for each tour mode and leg</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pd.DataFrame</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>Adds two * n_modes logsum columns to each tour row, e.g. “logsum_DRIVE_outbound”</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.create_logsum_trips">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">create_logsum_trips</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.create_logsum_trips" title="Permalink to this definition">#</a></dt>
<dd><p>Construct table of trips from half-tours (1 inbound, 1 outbound) for each tour-mode.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>segment_column_name</strong><span class="classifier">str</span></dt><dd><p>column in tours table used for segmenting model spec</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>pandas.DataFrame</dt><dd><p>Table of trips: 2 per tour, with O/D and purpose inherited from tour</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.get_alts_from_segmented_nested_logit">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">get_alts_from_segmented_nested_logit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.get_alts_from_segmented_nested_logit" title="Permalink to this definition">#</a></dt>
<dd><p>Infer alts from logit spec</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>segment_column_name</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>list</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.get_trip_mc_logsums_for_all_modes">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">get_trip_mc_logsums_for_all_modes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.get_trip_mc_logsums_for_all_modes" title="Permalink to this definition">#</a></dt>
<dd><p>Creates pseudo-trips from tours and runs trip mode choice to get logsums</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd></dd>
<dt><strong>segment_column_name</strong><span class="classifier">str</span></dt><dd><p>column in tours table used for segmenting model spec</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pd.DataFrame</span></dt><dd><p>Adds two * n_modes logsum columns to each tour row, e.g. “logsum_DRIVE_outbound”</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.logger">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">logger</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.models.tour_mode_choice</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.logger" title="Permalink to this definition">#</a></dt>
<dd><p>Tour mode choice is run for all tours to determine the transportation mode that
will be used for the tour</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">tour_mode_choice_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Tour mode choice simulate</p>
</dd></dl>

</section>
<section id="at-work-subtours-frequency">
<span id="atwork-subtour-frequency"></span><h2>At-work Subtours Frequency<a class="headerlink" href="#at-work-subtours-frequency" title="Permalink to this headline">#</a></h2>
<p>The at-work subtour frequency model selects the number of at-work subtours made for each work tour.
It also creates at-work subtours by adding them to the tours table in the data pipeline.
These at-work sub-tours are travel tours taken during the workday with their origin at the work
location, rather than from home. Explanatory variables include employment status,
income, auto ownership, the frequency of other tours, characteristics of the parent work tour, and
characteristics of the workplace zone.</p>
<p>Choosers: work tours
Alternatives: none, 1 eating out tour, 1 business tour, 1 maintenance tour, 2 business tours, 1 eating out tour + 1 business tour
Dependent tables: household, person, accessibility
Outputs: work tour subtour frequency choice, at-work tours table (with only tour origin zone at this point)</p>
<p>The main interface to the at-work subtours frequency model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_frequency()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">atwork_subtour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_frequency.</span></span><span class="sig-name descname"><span class="pre">atwork_subtour_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the frequency of making at-work subtour tours
(alternatives for this model come from a separate csv file which is
configured by the user).</p>
</dd></dl>

</section>
<section id="at-work-subtours-destination-choice">
<span id="atwork-subtour-destination"></span><h2>At-work Subtours Destination Choice<a class="headerlink" href="#at-work-subtours-destination-choice" title="Permalink to this headline">#</a></h2>
<p>The at-work subtours destination choice model is made up of three model steps:</p>
<blockquote>
<div><ul class="simple">
<li><p>sample - selects a sample of alternative locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final location, this time with the mode choice logsum included.</p></li>
</ul>
</div></blockquote>
<p>At-work subtour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">placeholder_multiple_zone</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Table: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<p>The main interface to the at-work subtour destination model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_destination()</span></code>
function.  This function is registered as an Inject step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_destination"></span></section>
<section id="at-work-subtour-scheduling">
<span id="atwork-subtour-scheduling"></span><h2>At-work Subtour Scheduling<a class="headerlink" href="#at-work-subtour-scheduling" title="Permalink to this headline">#</a></h2>
<p>The at-work subtours scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each at-work subtour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>This model is the same as the mandatory tour scheduling model except it operates on the at-work tours and
constrains the alternative set to available person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.  The at-work subtour scheduling model does not use mode choice logsums.
The at-work subtour frequency model can choose multiple tours so this model must process all first tours and then second
tours since isFirstAtWorkTour is an explanatory variable.</p>
<p>Choosers: at-work tours
Alternatives: alternative departure time and arrival back at origin time pairs WITHIN the work tour departure time and arrival time back at origin AND the person time window. If no time window is available for the tour, make the first and last time periods within the work tour available, make the choice, and log the number of times this occurs.
Dependent tables: skims, person, land use, work tour
Outputs: at-work tour departure time and arrival back at origin time, updated person time windows</p>
<p>The main interface to the at-work subtours scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_scheduling()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_scheduling"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_scheduling.</span></span><span class="sig-name descname"><span class="pre">atwork_subtour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for at work subtours tours</p>
</dd></dl>

</section>
<section id="at-work-subtour-mode">
<span id="atwork-subtour-mode-choice"></span><h2>At-work Subtour Mode<a class="headerlink" href="#at-work-subtour-mode" title="Permalink to this headline">#</a></h2>
<p>The at-work subtour mode choice model assigns a travel mode to each at-work subtour using the <a class="reference internal" href="#tour-mode-choice"><span class="std std-ref">Tour Mode Choice</span></a> model.</p>
<p>The main interface to the at-work subtour mode choice model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice" title="activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_mode_choice()</span></code></a>
function.  This function is called in the Inject step <code class="docutils literal notranslate"><span class="pre">atwork_subtour_mode_choice</span></code> and
is registered as an Inject step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tour</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">tour_mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">destination,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_mode_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_mode_choice.</span></span><span class="sig-name descname"><span class="pre">atwork_subtour_mode_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice" title="Permalink to this definition">#</a></dt>
<dd><p>At-work subtour mode choice simulate</p>
</dd></dl>

</section>
<section id="intermediate-stop-frequency">
<span id="id27"></span><h2>Intermediate Stop Frequency<a class="headerlink" href="#intermediate-stop-frequency" title="Permalink to this headline">#</a></h2>
<p>The stop frequency model assigns to each tour the number of intermediate destinations a person
will travel to on each leg of the tour from the origin to tour primary destination and back.
The model incorporates the ability for more than one stop in each direction,
up to a maximum of 3, for a total of 8 trips per tour (four on each tour leg).</p>
<p>Intermediate stops are not modeled for drive-transit tours because doing so can have unintended
consequences because of the difficulty of tracking the location of the vehicle. For example,
consider someone who used a park and ride for work and then took transit to an intermediate
shopping stop on the way home. Without knowing the vehicle location, it cannot be determined
if it is reasonable to allow the person to drive home. Even if the tour were constrained to allow
driving only on the first and final trip, the trip home from an intermediate stop may not use the
same park and ride where the car was dropped off on the outbound leg, which is usually as close
as possible to home because of the impracticality of coding drive access links from every park
and ride lot to every zone.</p>
<p>This model also creates a trips table in the pipeline for later models.</p>
<p>The main interface to the intermediate stop frequency model is the
<a class="reference internal" href="#activitysim.abm.models.stop_frequency.stop_frequency" title="activitysim.abm.models.stop_frequency.stop_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">stop_frequency()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">stop_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.stop_frequency"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.stop_frequency.stop_frequency">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.stop_frequency.</span></span><span class="sig-name descname"><span class="pre">stop_frequency</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">stop_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.stop_frequency.stop_frequency" title="Permalink to this definition">#</a></dt>
<dd><p>stop frequency model</p>
<p>For each tour, shoose a number of intermediate inbound stops and outbound stops.
Create a trip table with inbound and outbound trips.</p>
<p>Thus, a tour with stop_frequency ‘2out_0in’ will have two outbound and zero inbound stops,
and four corresponding trips: three outbound, and one inbound.</p>
<p>Adds stop_frequency str column to trips, with fields</p>
<p>creates trips table with columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">person_id</span>
<span class="o">-</span> <span class="n">household_id</span>
<span class="o">-</span> <span class="n">tour_id</span>
<span class="o">-</span> <span class="n">primary_purpose</span>
<span class="o">-</span> <span class="n">atwork</span>
<span class="o">-</span> <span class="n">trip_num</span>
<span class="o">-</span> <span class="n">outbound</span>
<span class="o">-</span> <span class="n">trip_count</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="trip-purpose">
<span id="id28"></span><h2>Trip Purpose<a class="headerlink" href="#trip-purpose" title="Permalink to this headline">#</a></h2>
<p>For trip other than the last trip outbound or inbound, assign a purpose based on an
observed frequency distribution.  The distribution is segmented by tour purpose, tour
direction and person type. Work tours are also segmented by departure or arrival time period.</p>
<p>The main interface to the trip purpose model is the
<a class="reference internal" href="#activitysim.abm.models.trip_purpose.trip_purpose" title="activitysim.abm.models.trip_purpose.trip_purpose"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_purpose()</span></code></a>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">purpose</span></code> | Skims Keys: NA</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trip purpose and trip destination choice can be run iteratively together via <a class="reference internal" href="#trip-purpose-and-destination-model"><span class="std std-ref">Trip Purpose and Destination</span></a>.</p>
</div>
<span class="target" id="module-activitysim.abm.models.trip_purpose"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_purpose.choose_intermediate_trip_purpose">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></span><span class="sig-name descname"><span class="pre">choose_intermediate_trip_purpose</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_join_cols</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_depart_time</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.choose_intermediate_trip_purpose" title="Permalink to this definition">#</a></dt>
<dd><p>chose purpose for intermediate trips based on probs_spec
which assigns relative weights (summing to 1) to the possible purpose choices</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>purpose: pandas.Series of purpose (str) indexed by trip_id</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_purpose.run_trip_purpose">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></span><span class="sig-name descname"><span class="pre">run_trip_purpose</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.run_trip_purpose" title="Permalink to this definition">#</a></dt>
<dd><p>trip purpose - main functionality separated from model step so it can be called iteratively</p>
<p>For each intermediate stop on a tour (i.e. trip other than the last trip outbound or inbound)
each trip is assigned a purpose based on an observed frequency distribution</p>
<p>The distribution should always be segmented by tour purpose and tour direction. By default it is also
segmented by person type. The join columns can be overwritten using the “probs_join_cols” parameter in
the model settings. The model will attempt to segment by trip depart time as well if necessary
and depart time ranges are specified in the probability lookup table.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>purpose: pandas.Series of purpose (str) indexed by trip_id</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_purpose.trip_purpose">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></span><span class="sig-name descname"><span class="pre">trip_purpose</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.trip_purpose" title="Permalink to this definition">#</a></dt>
<dd><p>trip purpose model step - calls run_trip_purpose to run the actual model</p>
<p>adds purpose column to trips</p>
</dd></dl>

</section>
<section id="trip-destination-choice">
<span id="id29"></span><h2>Trip Destination Choice<a class="headerlink" href="#trip-destination-choice" title="Permalink to this headline">#</a></h2>
<p>See <a class="reference internal" href="dev-guide/components/trip_destination.html#component-trip-destination"><span class="std std-ref">Trip Destination</span></a>.</p>
</section>
<section id="trip-purpose-and-destination">
<span id="trip-purpose-and-destination-model"></span><h2>Trip Purpose and Destination<a class="headerlink" href="#trip-purpose-and-destination" title="Permalink to this headline">#</a></h2>
<p>After running trip purpose and trip destination separately, the two model can be ran together in an iterative fashion on
the remaining failed trips (i.e. trips that cannot be assigned a destination).  Each iteration uses new random numbers.</p>
<p>The main interface to the trip purpose model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">trip_purpose_and_destination()</span></code>
function.  This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">purpose,</span> <span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">(tour</span> <span class="pre">primary)</span> <span class="pre">destination,</span> <span class="pre">dest_taz,</span> <span class="pre">trip_period</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_purpose_and_destination"></span></section>
<section id="trip-scheduling-probablistic">
<span id="trip-scheduling"></span><h2>Trip Scheduling (Probablistic)<a class="headerlink" href="#trip-scheduling-probablistic" title="Permalink to this headline">#</a></h2>
<p>For each trip, assign a departure hour based on an input lookup table of percents by tour purpose,
direction (inbound/outbound), tour hour, and trip index.</p>
<blockquote>
<div><ul class="simple">
<li><p>The tour hour is the tour start hour for outbound trips and the tour end hour for inbound trips.  The trip index is the trip sequence on the tour, with up to four trips per half tour</p></li>
<li><p>For outbound trips, the trip depart hour must be greater than or equal to the previously selected trip depart hour</p></li>
<li><p>For inbound trips, trips are handled in reverse order from the next-to-last trip in the leg back to the first. The tour end hour serves as the anchor time point from which to start assigning trip time periods.</p></li>
<li><p>Outbound trips on at-work subtours are assigned the tour depart hour and inbound trips on at-work subtours are assigned the tour end hour.</p></li>
</ul>
</div></blockquote>
<p>The assignment of trip depart time is run iteratively up to a max number of iterations since it is possible that
the time period selected for an earlier trip in a half-tour makes selection of a later trip time
period impossible (or very low probability). Thus, the sampling is re-run until a feasible set of trip time
periods is found. If a trip can’t be scheduled after the max iterations, then the trip is assigned
the previous trip’s choice (i.e. assumed to happen right after the previous trip) or dropped, as configured by the user.
The trip scheduling model does not use mode choice logsums.</p>
<p>Alternatives: Available time periods in the tour window (i.e. tour start and end period).  When processing stops on
work tours, the available time periods is constrained by the at-work subtour start and end period as well.</p>
<p>The main interface to the trip scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.trip_scheduling.trip_scheduling" title="activitysim.abm.models.trip_scheduling.trip_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_scheduling()</span></code></a> function.
This function is registered as an Inject step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">depart</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.trip_scheduling"></span><dl class="py data">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.logger">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">logger</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.models.trip_scheduling</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.logger" title="Permalink to this definition">#</a></dt>
<dd><p>StopDepartArrivePeriodModel</p>
<p>StopDepartArriveProportions.csv
tourpurp,isInbound,interval,trip,p1,p2,p3,p4,p5…p40</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.schedule_trips_in_leg">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">schedule_trips_in_leg</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outbound</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_last_iteration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.schedule_trips_in_leg" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>outbound</strong></dt><dd></dd>
<dt><strong>trips</strong></dt><dd></dd>
<dt><strong>probs_spec</strong></dt><dd></dd>
<dt><strong>depart_alt_base</strong></dt><dd></dd>
<dt><strong>is_last_iteration</strong></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>choices: pd.Series</dt><dd><p>depart choice for trips, indexed by trip_id</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.set_stop_num">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">set_stop_num</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.set_stop_num" title="Permalink to this definition">#</a></dt>
<dd><p>Convert trip_num to stop_num in order to work with duration-based
probs that are keyed on stop num. For outbound trips, trip n chooses
the duration of stop n-1 (the trip origin). For inbound trips, trip n
chooses the duration of stop n (the trip destination). This means
outbound trips technically choose a departure time while inbound trips
choose an arrival.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.set_tour_hour">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">set_tour_hour</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.set_tour_hour" title="Permalink to this definition">#</a></dt>
<dd><p>add columns ‘tour_hour’, ‘earliest’, ‘latest’ to trips</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips: pd.DataFrame</strong></dt><dd></dd>
<dt><strong>tours: pd.DataFrame</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>modifies trips in place</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.trip_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">trip_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.trip_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>Trip scheduling assigns depart times for trips within the start, end limits of the tour.</p>
<p>The algorithm is simplistic:</p>
<p>The first outbound trip starts at the tour start time, and subsequent outbound trips are
processed in trip_num order, to ensure that subsequent trips do not depart before the
trip that preceeds them.</p>
<p>Inbound trips are handled similarly, except in reverse order, starting with the last trip,
and working backwards to ensure that inbound trips do not depart after the trip that
succeeds them.</p>
<p>The probability spec assigns probabilities for depart times, but those possible departs must
be clipped to disallow depart times outside the tour limits, the departs of prior trips, and
in the case of work tours, the start/end times of any atwork subtours.</p>
<p>Scheduling can fail if the probability table assigns zero probabilities to all the available
depart times in a trip’s depart window. (This could be avoided by giving every window a small
probability, rather than zero, but the existing mtctm1 prob spec does not do this. I believe
this is due to the its having been generated from a small household travel survey sample
that lacked any departs for some time periods.)</p>
<p>Rescheduling the trips that fail (along with their inbound or outbound leg-mates) can sometimes
fix this problem, if it was caused by an earlier trip’s depart choice blocking a subsequent
trip’s ability to schedule a depart within the resulting window. But it can also happen if
a tour is very short (e.g. one time period) and the prob spec having a zero probability for
that tour hour.</p>
<p>Therefore we need to handle trips that could not be scheduled. There are two ways (at least)
to solve this problem:</p>
<p>1) choose_most_initial
simply assign a depart time to the trip, even if it has a zero probability. It makes
most sense, in this case, to assign the ‘most initial’ depart time, so that subsequent trips
are minimally impacted. This can be done in the final iteration, thus affecting only the
trips that could no be scheduled by the standard approach</p>
<p>2) drop_and_cleanup
drop trips that could no be scheduled, and adjust their leg mates, as is done for failed
trips in trip_destination.</p>
<p>Which option is applied is determined by the FAILFIX model setting</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_scheduling.update_tour_earliest">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></span><span class="sig-name descname"><span class="pre">update_tour_earliest</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outbound_choices</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.update_tour_earliest" title="Permalink to this definition">#</a></dt>
<dd><p>Updates “earliest” column for inbound trips based on
the maximum outbound trip departure time of the tour.
This is done to ensure inbound trips do not depart
before the last outbound trip of a tour.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips: pd.DataFrame</strong></dt><dd></dd>
<dt><strong>outbound_choices: pd.Series</strong></dt><dd><p>time periods depart choices, one per trip (except for trips with
zero probs)</p>
</dd>
<dt><strong>Returns</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
<dt><strong>modifies trips in place</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="trip-scheduling-choice-logit-choice">
<span id="trip-scheduling-choice"></span><h2>Trip Scheduling Choice (Logit Choice)<a class="headerlink" href="#trip-scheduling-choice-logit-choice" title="Permalink to this headline">#</a></h2>
<p>This model uses a logit-based formulation to determine potential trip windows for the three
main components of a tour.</p>
<ul class="simple">
<li><p>Outbound Leg: The time from leaving the origin location to the time second to last outbound stop.</p></li>
<li><p>Main Leg: The time window from the last outbound stop through the main tour destination to the first inbound stop.</p></li>
<li><p>Inbound Leg: The time window from the first inbound stop to the tour origin location.</p></li>
</ul>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">outbound_duration</span></code>, <code class="docutils literal notranslate"><span class="pre">main_leg_duration</span></code>, <code class="docutils literal notranslate"><span class="pre">inbound_duration</span></code> | Skims Keys: NA</p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="trip-departure-choice-logit-choice">
<span id="trip-departure-choice"></span><h2>Trip Departure Choice (Logit Choice)<a class="headerlink" href="#trip-departure-choice-logit-choice" title="Permalink to this headline">#</a></h2>
<p>Used in conjuction with Trip Scheduling Choice (Logit Choice), this model chooses departure
time periods consistent with the time windows for the appropriate leg of the trip.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">depart</span></code> | Skims Keys: NA</p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="trip-mode-choice">
<span id="id30"></span><h2>Trip Mode Choice<a class="headerlink" href="#trip-mode-choice" title="Permalink to this headline">#</a></h2>
<p>The trip mode choice model assigns a travel mode for each trip on a given tour. It
operates similarly to the tour mode choice model, but only certain trip modes are available for
each tour mode. The correspondence rules are defined according to the following principles:</p>
<blockquote>
<div><ul class="simple">
<li><p>Pay trip modes are only available for pay tour modes (for example, drive-alone pay is only available at the trip mode level if drive-alone pay is selected as a tour mode).</p></li>
<li><p>The auto occupancy of the tour mode is determined by the maximum occupancy across all auto trips that make up the tour. Therefore, the auto occupancy for the tour mode is the maximum auto occupancy for any trip on the tour.</p></li>
<li><p>Transit tours can include auto shared-ride trips for particular legs. Therefore, ‘casual carpool’, wherein travelers share a ride to work and take transit back to the tour origin, is explicitly allowed in the tour/trip mode choice model structure.</p></li>
<li><p>The walk mode is allowed for any trip.</p></li>
<li><p>The availability of transit line-haul submodes on transit tours depends on the skimming and tour mode choice hierarchy. Free shared-ride modes are also available in walk-transit tours, albeit with a low probability. Paid shared-ride modes are not allowed on transit tours because no stated preference data is available on the sensitivity of transit riders to automobile value tolls, and no observed data is available to verify the number of people shifting into paid shared-ride trips on transit tours.</p></li>
</ul>
</div></blockquote>
<p>The trip mode choice models explanatory variables include household and person variables, level-of-service
between the trip origin and destination according to the time period for the tour leg, urban form
variables, and alternative-specific constants segmented by tour mode.</p>
<p>The main interface to the trip mode choice model is the
<a class="reference internal" href="#activitysim.abm.models.trip_mode_choice.trip_mode_choice" title="activitysim.abm.models.trip_mode_choice.trip_mode_choice"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_mode_choice()</span></code></a> function.  This function
is registered as an Inject step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">trip_mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">destination,</span> <span class="pre">trip_period</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_mode_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_mode_choice.trip_mode_choice">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_mode_choice.</span></span><span class="sig-name descname"><span class="pre">trip_mode_choice</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_mode_choice.trip_mode_choice" title="Permalink to this definition">#</a></dt>
<dd><p>Trip mode choice - compute trip_mode (same values as for tour_mode) for each trip.</p>
<p>Modes for each primary tour putpose are calculated separately because they have different
coefficient values (stored in trip_mode_choice_coefficients.csv coefficient file.)</p>
<p>Adds trip_mode column to trip table</p>
</dd></dl>

</section>
<section id="parking-location-choice">
<span id="id31"></span><h2>Parking Location Choice<a class="headerlink" href="#parking-location-choice" title="Permalink to this headline">#</a></h2>
<p>The parking location choice model selects a parking location for specified trips. While the model does not
require parking location be applied to any specific set of trips, it is usually applied for drive trips to
specific zones (e.g., CBD) in the model.</p>
<p>The model provides provides a filter for both the eligible choosers and eligible parking location zone. The
trips dataframe is the chooser of this model. The zone selection filter is applied to the land use zones
dataframe.</p>
<p>If this model is specified in the pipeline, the <a class="reference internal" href="#id32">Write Trip Matrices</a> step will using the parking location
choice results to build trip tables in lieu of the trip destination.</p>
<p>The main interface to the trip mode choice model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">parking_location_choice()</span></code> function.  This function
is registered as an Inject step, and it is available from the pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write
logsums for estimation.</p>
<p><strong>Skims</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">odt_skims</span></code>: Origin to Destination by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dot_skims</span></code>: Destination to Origin by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opt_skims</span></code>: Origin to Parking Zone by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pdt_skims</span></code>: Parking Zone to Destination by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">od_skims</span></code>: Origin to Destination</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">do_skims</span></code>: Destination to Origin</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">op_skims</span></code>: Origin to Parking Zone</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pd_skims</span></code>: Parking Zone to Destination</p></li>
</ul>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code></p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CHOOSER_FILTER_COLUMN_NAME</span></code></dt><dd><p>Boolean field on the chooser table defining which choosers are eligible to parking location choice model. If no
filter is specified, all choosers (trips) are eligible for the model.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CHOOSER_SEGMENT_COLUMN_NAME</span></code></dt><dd><p>Column on the chooser table defining the parking segment for the logit model</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SEGMENTS</span></code></dt><dd><p>List of eligible chooser segments in the logit specification</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ALTERNATIVE_FILTER_COLUMN_NAME</span></code></dt><dd><p>Boolean field used to filter land use zones as eligible parking location choices. If no filter is specified,
then all land use zones are considered as viable choices.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ALT_DEST_COL_NAME</span></code></dt><dd><p>The column name to append with the parking location choice results. For choosers (trips) ineligible for this
model, a -1 value will be placed in column.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TRIP_ORIGIN</span></code></dt><dd><p>Origin field on the chooser trip table</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TRIP_DESTINATION</span></code></dt><dd><p>Destination field on the chooser trip table</p>
</dd>
</dl>
</li>
</ul>
<span class="target" id="module-activitysim.abm.models.parking_location_choice"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.parking_location_choice.parking_destination_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></span><span class="sig-name descname"><span class="pre">parking_destination_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.parking_destination_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>Chose destination from destination_sample (with od_logsum and dp_logsum columns added)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>choices - pandas.Series</dt><dd><p>destination alt chosen</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.parking_location_choice.parking_location">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></span><span class="sig-name descname"><span class="pre">parking_location</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">land_use</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.parking_location" title="Permalink to this definition">#</a></dt>
<dd><p>Given a set of trips, each trip needs to have a parking location if
it is eligible for remote parking.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.parking_location_choice.wrap_skims">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></span><span class="sig-name descname"><span class="pre">wrap_skims</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.wrap_skims" title="Permalink to this definition">#</a></dt>
<dd><p>wrap skims of trip destination using origin, dest column names from model settings.
Various of these are used by destination_sample, compute_logsums, and destination_simulate
so we create them all here with canonical names.</p>
<p>Note that compute_logsums aliases their names so it can use the same equations to compute
logsums from origin to alt_dest, and from alt_dest to primarly destination</p>
<p>odt_skims - SkimStackWrapper: trip origin, trip alt_dest, time_of_day
dot_skims - SkimStackWrapper: trip alt_dest, trip origin, time_of_day
dpt_skims - SkimStackWrapper: trip alt_dest, trip primary_dest, time_of_day
pdt_skims - SkimStackWrapper: trip primary_dest,trip alt_dest, time_of_day
od_skims - SkimDictWrapper: trip origin, trip alt_dest
dp_skims - SkimDictWrapper: trip alt_dest, trip primary_dest</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>dict containing skims, keyed by canonical names relative to tour orientation</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="write-trip-matrices">
<span id="id32"></span><h2>Write Trip Matrices<a class="headerlink" href="#write-trip-matrices" title="Permalink to this headline">#</a></h2>
<p>Write open matrix (OMX) trip matrices for assignment.  Reads the trips table post preprocessor and run expressions
to code additional data fields, with one data fields for each matrix specified.  The matrices are scaled by a
household level expansion factor, which is the household sample rate by default, which is calculated when
households are read in at the beginning of a model run.  The main interface to write trip
matrices is the <a class="reference internal" href="#activitysim.abm.models.trip_matrices.write_trip_matrices" title="activitysim.abm.models.trip_matrices.write_trip_matrices"><code class="xref py py-func docutils literal notranslate"><span class="pre">write_trip_matrices()</span></code></a> function.  This function
is registered as an Inject step in the example Pipeline.</p>
<p>If the <a class="reference internal" href="#id31">Parking Location Choice</a> model is defined in the pipeline, the parking location zone will be used in
lieu of the destination zone.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result: <code class="docutils literal notranslate"><span class="pre">omx</span> <span class="pre">trip</span> <span class="pre">matrices</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">destination</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_matrices"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_matrices.annotate_trips">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></span><span class="sig-name descname"><span class="pre">annotate_trips</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.annotate_trips" title="Permalink to this definition">#</a></dt>
<dd><p>Add columns to local trips table. The annotator has
access to the origin/destination skims and everything
defined in the model settings CONSTANTS.</p>
<p>Pipeline tables can also be accessed by listing them under
TABLES in the preprocessor settings.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_matrices.write_matrices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></span><span class="sig-name descname"><span class="pre">write_matrices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">aggregate_trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zone_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">orig_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_tap</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.write_matrices" title="Permalink to this definition">#</a></dt>
<dd><p>Write aggregated trips to OMX format.</p>
<p>The MATRICES setting lists the new OMX files to write.
Each file can contain any number of ‘tables’, each specified by a
table key (‘name’) and a trips table column (‘data_field’) to use
for aggregated counts.</p>
<p>Any data type may be used for columns added in the annotation phase,
but the table ‘data_field’s must be summable types: ints, floats, bools.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.trip_matrices.write_trip_matrices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></span><span class="sig-name descname"><span class="pre">write_trip_matrices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.write_trip_matrices" title="Permalink to this definition">#</a></dt>
<dd><p>Write trip matrices step.</p>
<p>Adds boolean columns to local trips table via annotation expressions,
then aggregates trip counts and writes OD matrices to OMX.  Save annotated
trips table to pipeline if desired.</p>
<p>Writes taz trip tables for one and two zone system.  Writes taz and tap
trip tables for three zone system.  Add <code class="docutils literal notranslate"><span class="pre">is_tap:True</span></code> to the settings file
to identify an output matrix as tap level trips as opposed to taz level trips.</p>
<p>For one zone system, uses the land use table for the set of possible tazs.
For two zone system, uses the taz skim zone names for the set of possible tazs.
For three zone system, uses the taz skim zone names for the set of possible tazs
and uses the tap skim zone names for the set of possible taps.</p>
</dd></dl>

</section>
<section id="util">
<span id="utility-steps"></span><h2>Util<a class="headerlink" href="#util" title="Permalink to this headline">#</a></h2>
<p>Additional helper classes</p>
<section id="id33">
<h3>CDAP<a class="headerlink" href="#id33" title="Permalink to this headline">#</a></h3>
<span class="target" id="module-activitysim.abm.models.util.cdap"></span><dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.add_interaction_column">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">add_interaction_column</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_tup</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_interaction_column" title="Permalink to this definition">#</a></dt>
<dd><p>Add an interaction column in place to choosers, listing the ptypes of the persons in p_tup</p>
<p>The name of the interaction column will be determined by the cdap_ranks from p_tup,
and the rows in the column contain the ptypes of those persons in that household row.</p>
<p>For instance, for p_tup = (1,3) choosers interaction column name will be ‘p1_p3’</p>
<p>For a household where person 1 is part-time worker (ptype=2) and person 3 is infant (ptype 8)
the corresponding row value interaction code will be 28</p>
<p>We take advantage of the fact that interactions are symmetrical to simplify spec expressions:
We name the interaction_column in increasing pnum (cdap_rank) order (p1_p2 and not p3_p1)
And we format row values in increasing ptype order (28 and not 82)
This simplifies the spec expressions as we don’t have to test for p1_p3 == 28 | p1_p3 == 82</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>household choosers, indexed on _hh_index_
choosers should contain columns ptype_p1, ptype_p2 for each cdap_rank person in hh</p>
</dd>
<dt><strong>p_tup</strong><span class="classifier">int tuple</span></dt><dd><p>tuple specifying the cdap_ranks for the interaction column
p_tup = (1,3) means persons with cdap_rank 1 and 3</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.add_pn">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">add_pn</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pnum</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_pn" title="Permalink to this definition">#</a></dt>
<dd><p>return the canonical column name for the indiv_util column or columns
in merged hh_chooser df for individual with cdap_rank pnum</p>
<p>e.g. M_p1, ptype_p2 but leave _hh_id_ column unchanged</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.assign_cdap_rank">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">assign_cdap_rank</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">person_type_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.assign_cdap_rank" title="Permalink to this definition">#</a></dt>
<dd><p>Assign an integer index, cdap_rank, to each household member. (Starting with 1, not 0)</p>
<p>Modifies persons df in place</p>
<p>The cdap_rank order is important, because cdap only assigns activities to the first
MAX_HHSIZE persons in each household.</p>
<p>This will preferentially be two working adults and the three youngest children.</p>
<p>Rank is assigned starting at 1. This necessitates some care indexing, but is preferred as
it follows the convention of 1-based pnums in expression files.</p>
<p>According to the documentation of reOrderPersonsForCdap in mtctm2.abm.ctramp
HouseholdCoordinatedDailyActivityPatternModel:</p>
<p>“Method reorders the persons in the household for use with the CDAP model,
which only explicitly models the interaction of five persons in a HH. Priority
in the reordering is first given to full time workers (up to two), then to
part time workers (up to two workers, of any type), then to children (youngest
to oldest, up to three). If the method is called for a household with less
than 5 people, the cdapPersonArray is the same as the person array.”</p>
<p>We diverge from the above description in that a cdap_rank is assigned to all persons,
including ‘extra’ household members, whose activity is assigned subsequently.
The pair _hh_id_, cdap_rank will uniquely identify each household member.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data. Must contain columns _hh_size_, _hh_id_, _ptype_, _age_</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>cdap_rank</strong><span class="classifier">pandas.Series</span></dt><dd><p>integer cdap_rank of every person, indexed on _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.build_cdap_spec">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">build_cdap_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.build_cdap_spec" title="Permalink to this definition">#</a></dt>
<dd><p>Build a spec file for computing utilities of alternative household member interaction patterns
for households of specified size.</p>
<p>We generate this spec automatically from a table of rules and coefficients because the
interaction rules are fairly simple and can be expressed compactly whereas
there is a lot of redundancy between the spec files for different household sizes, as well as
in the vectorized expression of the interaction alternatives within the spec file itself</p>
<dl class="simple">
<dt>interaction_coefficients has five columns:</dt><dd><dl class="simple">
<dt>activity</dt><dd><p>A single character activity type name (M, N, or H)</p>
</dd>
<dt>interaction_ptypes</dt><dd><p>List of ptypes in the interaction (in order of increasing ptype) or empty for wildcards
(meaning that the interaction applies to all ptypes in that size hh)</p>
</dd>
<dt>cardinality</dt><dd><p>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</p>
</dd>
<dt>slug</dt><dd><p>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is replaced with the numerical coefficient value after we dump the trace file</p>
</dd>
<dt>coefficient</dt><dd><p>The coefficient to apply for all hh interactions for this activity and set of ptypes</p>
</dd>
</dl>
</dd>
</dl>
<p>The generated spec will have the eval expression in the index, and a utility column for each
alternative (e.g. [‘HH’, ‘HM’, ‘HN’, ‘MH’, ‘MM’, ‘MN’, ‘NH’, ‘NM’, ‘NN’] for hhsize 2)</p>
<p>In order to be able to dump the spec in a human-friendly fashion to facilitate debugging the
cdap_interaction_coefficients table, we first populate utility columns in the spec file
with the coefficient slugs, dump the spec file, and then replace the slugs with coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>household size for which the spec should be built.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>spec: pandas.DataFrame</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.extra_hh_member_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">extra_hh_member_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_fixed_relative_proportions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.extra_hh_member_choices" title="Permalink to this definition">#</a></dt>
<dd><p>Generate the activity choices for the ‘extra’ household members who weren’t handled by cdap</p>
<p>Following the CTRAMP HouseholdCoordinatedDailyActivityPatternModel, “a separate,
simple cross-sectional distribution is looked up for the remaining household members”</p>
<p>The cdap_fixed_relative_proportions spec is handled like an activitysim logit utility spec,
EXCEPT that the values computed are relative proportions, not utilities
(i.e. values are not exponentiated before being normalized to probabilities summing to 1.0)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><dl class="simple">
<dt>Table of persons data indexed on _persons_index_</dt><dd><p>We expect, at least, columns [_hh_id_, _ptype_]</p>
</dd>
</dl>
</dd>
<dt><strong>cdap_fixed_relative_proportions</strong></dt><dd><p>spec to compute/specify the relative proportions of each activity (M, N, H)
that should be used to choose activities for additional household members
not handled by CDAP.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>dictionary of local variables that eval_variables adds to the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>list of alternatives chosen for all extra members, indexed by _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.hh_choosers">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">hh_choosers</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indiv_utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.hh_choosers" title="Permalink to this definition">#</a></dt>
<dd><p>Build a chooser table for calculating house utilities for all households of specified hhsize</p>
<p>The choosers table will have one row per household with columns containing the indiv_utils
for all non-extra (i.e. cdap_rank &lt;- MAX_HHSIZE) persons. That makes 3 columns for each
individual. e.g. the utilities of person with cdap_rank 1 will be included as M_p1, N_p1, H_p1</p>
<p>The chooser table will also contain interaction columns for all possible interactions involving
from 2 to 3 persons (actually MAX_INTERACTION_CARDINALITY, which is currently 3).</p>
<p>The interaction columns list the ptypes of the persons in the interaction set, sorted by ptype.
For instance the interaction between persons with cdap_rank 1 and three and ptypes will
be listed in a column named ‘p1_p3’ and for a household where persons p1 and p3 are 2 and 4
will a row value of 24 in the p1_p3 column.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>indiv_utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP utilities for each individual, ignoring interactions.
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>household size for which the choosers table should be built. Households with more than
MAX_HHSIZE members will be included with MAX_HHSIZE choosers since the are handled the
same, and the activities of the extra members are assigned afterwards</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>choosers households of hhsize with activity utility columns interaction columns
for all (non-extra) household members</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.household_activity_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">household_activity_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indiv_utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.household_activity_choices" title="Permalink to this definition">#</a></dt>
<dd><p>Calculate household utilities for each activity pattern alternative for households of hhsize
The resulting activity pattern for each household will be coded as a string of activity codes.
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>indiv_utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP utilities for each individual, ignoring interactions
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</dd>
<dt><strong>interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>the size of household for which activity perttern should be calculated (1..MAX_HHSIZE)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>the chosen cdap activity pattern for each household represented as a string (e.g. ‘MNH’)
with same index (_hh_index_) as utils</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.individual_utilities">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">individual_utilities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_indiv_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.individual_utilities" title="Permalink to this definition">#</a></dt>
<dd><p>Calculate CDAP utilities for all individuals.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of individual persons data.</p>
</dd>
<dt><strong>cdap_indiv_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP spec applied to individuals.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have index of <cite>persons</cite> and columns for each of the alternatives.
plus some ‘useful columns’ [_hh_id_, _ptype_, ‘cdap_rank’, _hh_size_]</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.preprocess_interaction_coefficients">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">preprocess_interaction_coefficients</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.preprocess_interaction_coefficients" title="Permalink to this definition">#</a></dt>
<dd><p>The input cdap_interaction_coefficients.csv file has three columns:</p>
<dl class="simple">
<dt>activity</dt><dd><p>A single character activity type name (M, N, or H)</p>
</dd>
<dt>interaction_ptypes</dt><dd><p>List of ptypes in the interaction (in order of increasing ptype)
Stars <cite>(***)</cite> instead of ptypes means the interaction applies to all ptypes in that size hh.</p>
</dd>
<dt>coefficient</dt><dd><p>The coefficient to apply for all hh interactions for this activity and set of ptypes</p>
</dd>
</dl>
<p>To facilitate building the spec for a given hh ssize, we add two additional columns:</p>
<dl class="simple">
<dt>cardinality</dt><dd><p>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</p>
</dd>
<dt>slug</dt><dd><p>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is then replaced with the numerical coefficient value prior to evaluation</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.run_cdap">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">run_cdap</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">person_type_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_indiv_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_fixed_relative_proportions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.run_cdap" title="Permalink to this definition">#</a></dt>
<dd><p>Choose individual activity patterns for persons.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data. Must contain at least a household ID, household size,
person type category, and age, plus any columns used in cdap_indiv_spec</p>
</dd>
<dt><strong>cdap_indiv_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP spec for individuals without taking any interactions into account.</p>
</dd>
<dt><strong>cdap_interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>cdap_fixed_relative_proportions</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Spec to for the relative proportions of each activity (M, N, H)
to choose activities for additional household members not handled by CDAP</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;
in either the cdap_indiv_spec or cdap_fixed_relative_proportions expression files</p>
</dd>
<dt><strong>chunk_size: int</strong></dt><dd><p>Chunk size or 0 for no chunking</p>
</dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd><p>hh_id to trace or None if no hh tracing</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd><p>label for tracing or None if no tracing</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe is indexed on _persons_index_ and has two columns:</p>
<dl class="simple">
<dt>cdap_activity<span class="classifier">str</span></dt><dd><p>activity for that person expressed as ‘M’, ‘N’, ‘H’</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></span><span class="sig-name descname"><span class="pre">unpack_cdap_indiv_activity_choices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hh_choices</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices" title="Permalink to this definition">#</a></dt>
<dd><p>Unpack the household activity choice list into choices for each (non-extra) household member</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data indexed on _persons_index_
We expect, at least, columns [_hh_id_, ‘cdap_rank’]</p>
</dd>
<dt><strong>hh_choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>household activity pattern is encoded as a string (of length hhsize) of activity codes
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>cdap_indiv_activity_choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>series contains one activity per individual hh member, indexed on _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="estimation">
<span id="table-annotation"></span><span id="index-2"></span><h3>Estimation<a class="headerlink" href="#estimation" title="Permalink to this headline">#</a></h3>
<p>See <a class="reference internal" href="estimation.html#estimation"><span class="std std-ref">Estimation</span></a> for more information.</p>
<span class="target" id="module-activitysim.abm.models.util.estimation"></span></section>
<section id="module-activitysim.abm.models.util.logsums">
<span id="logsums"></span><h3>Logsums<a class="headerlink" href="#module-activitysim.abm.models.util.logsums" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.logsums.compute_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.logsums.</span></span><span class="sig-name descname"><span class="pre">compute_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">in_period_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">out_period_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">duration_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.logsums.compute_logsums" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>tour_purpose</strong></dt><dd></dd>
<dt><strong>logsum_settings</strong></dt><dd></dd>
<dt><strong>model_settings</strong></dt><dd></dd>
<dt><strong>network_los</strong></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>logsums: pandas series</dt><dd><p>computed logsums with same index as choosers</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.mode">
<span id="mode"></span><h3>Mode<a class="headerlink" href="#module-activitysim.abm.models.util.mode" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.mode.mode_choice_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.mode.</span></span><span class="sig-name descname"><span class="pre">mode_choice_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.mode_choice_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>common method for  both tour_mode_choice and trip_mode_choice</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>spec</strong></dt><dd></dd>
<dt><strong>nest_spec</strong></dt><dd></dd>
<dt><strong>skims</strong></dt><dd></dd>
<dt><strong>locals_d</strong></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>mode_column_name</strong></dt><dd></dd>
<dt><strong>logsum_column_name</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
<dt><strong>trace_choice_name</strong></dt><dd></dd>
<dt><strong>estimator</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.mode.run_tour_mode_choice_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.mode.</span></span><span class="sig-name descname"><span class="pre">run_tour_mode_choice_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">constants</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.run_tour_mode_choice_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>This is a utility to run a mode choice model for each segment (usually
segments are tour/trip purposes).  Pass in the tours/trip that need a mode,
the Skim object, the spec to evaluate with, and any additional expressions
you want to use in the evaluation of variables.</p>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.overlap">
<span id="overlap"></span><h3>Overlap<a class="headerlink" href="#module-activitysim.abm.models.util.overlap" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.overlap.p2p_time_window_overlap">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.overlap.</span></span><span class="sig-name descname"><span class="pre">p2p_time_window_overlap</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">p1_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p2_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.overlap.p2p_time_window_overlap" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>p1_ids</strong></dt><dd></dd>
<dt><strong>p2_ids</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"></dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.overlap.rle">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.overlap.</span></span><span class="sig-name descname"><span class="pre">rle</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">a</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.overlap.rle" title="Permalink to this definition">#</a></dt>
<dd><p>Compute run lengths of values in rows of a two dimensional ndarry of ints.</p>
<p>We assume the first and last columns are buffer columns
(because this is the case for time windows)  and so don’t include them in results.</p>
<p>Return arrays giving row_id, start_pos, run_length, and value of each run of any length.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>a</strong><span class="classifier">numpy.ndarray of int shape(n, &lt;num_time_periods_in_a_day&gt;)</span></dt><dd><p>The input array would normally only have values of 0 or 1 to detect overlapping
time period availability but we don’t assume this, and will detect and report
runs of any values. (Might prove useful in future?…)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>row_id</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>start_pos</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>run_length</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>run_val</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.tour_destination">
<span id="tour-destination"></span><h3>Tour Destination<a class="headerlink" href="#module-activitysim.abm.models.util.tour_destination" title="Permalink to this headline">#</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_destination.SizeTermCalculator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></span><span class="sig-name descname"><span class="pre">SizeTermCalculator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">size_term_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.SizeTermCalculator" title="Permalink to this definition">#</a></dt>
<dd><p>convenience object to provide size_terms for a selector (e.g. non_mandatory)
for various segments (e.g. tour_type or purpose)
returns size terms for specified segment in df or series form</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_destination.choose_MAZ_for_TAZ">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></span><span class="sig-name descname"><span class="pre">choose_MAZ_for_TAZ</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">taz_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">MAZ_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.choose_MAZ_for_TAZ" title="Permalink to this definition">#</a></dt>
<dd><p>Convert taz_sample table with TAZ zone sample choices to a table with a MAZ zone chosen for each TAZ
choose MAZ probabilistically (proportionally by size_term) from set of MAZ zones in parent TAZ</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>taz_sample: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: &lt;DEST_TAZ&gt;, prob, pick_count</strong></dt><dd></dd>
<dt><strong>MAZ_size_terms: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: zone_id, dest_TAZ, size_term</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>dataframe with with duplicated index &lt;chooser_id_col&gt; and columns: &lt;DEST_MAZ&gt;, prob, pick_count</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_destination.run_destination_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></span><span class="sig-name descname"><span class="pre">run_destination_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.run_destination_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>add logsum column to existing tour_destination_sample table</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_zone_id) pair
in destination_sample, and computing the logsum of all the utilities</p>
<table class="table">
<colgroup>
<col style="width: 16%" />
<col style="width: 20%" />
<col style="width: 23%" />
<col style="width: 17%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>person_id</p></th>
<th class="head"><p>dest_zone_id</p></th>
<th class="head"><p>rand</p></th>
<th class="head"><p>pick_count</p></th>
<th class="head"><p>logsum (added)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>23750</p></td>
<td><p>14</p></td>
<td><p>0.565502716034</p></td>
<td><p>4</p></td>
<td><p>1.85659498857</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>23750</p></td>
<td rowspan="2"><p>16</p></td>
<td rowspan="2"><p>0.711135838871</p></td>
<td rowspan="2"><p>6</p></td>
<td rowspan="2"><p>1.92315598631</p></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2"><p>…</p></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td><p>23751</p></td>
<td><p>12</p></td>
<td><p>0.408038878552</p></td>
<td><p>1</p></td>
<td><p>2.40612135416</p></td>
</tr>
<tr class="row-even"><td><p>23751</p></td>
<td><p>14</p></td>
<td><p>0.972732479292</p></td>
<td><p>2</p></td>
<td><p>1.44009018355</p></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_destination.run_destination_simulate">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></span><span class="sig-name descname"><span class="pre">run_destination_simulate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec_segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_choice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.run_destination_simulate" title="Permalink to this definition">#</a></dt>
<dd><p>run destination_simulate on tour_destination_sample
annotated with mode_choice logsum to select a destination from sample alternatives</p>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.tour_frequency">
<span id="tour-frequency"></span><h3>Tour Frequency<a class="headerlink" href="#module-activitysim.abm.models.util.tour_frequency" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.create_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">create_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_category</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">parent_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'person_id'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.create_tours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the tours that were generated</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tour_counts: DataFrame</strong></dt><dd><p>table specifying how many tours of each type to create
one row per person (or parent_tour for atwork subtours)
one (int) column per tour_type, with number of tours to create</p>
</dd>
<dt><strong>tour_category</strong><span class="classifier">str</span></dt><dd><p>one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
<p>tours.tour_type       - tour type (e.g. school, work, shopping, eat)
tours.tour_type_num   - if there are two ‘school’ type tours, they will be numbered 1 and 2
tours.tour_type_count - number of tours of tour_type parent has (parent’s max tour_type_num)
tours.tour_num        - index of tour (of any type) for parent
tours.tour_count      - number of tours of any type) for parent (parent’s max tour_num)
tours.tour_category   - one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.process_atwork_subtours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">process_atwork_subtours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">work_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atwork_subtour_frequency_alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_atwork_subtours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the atwork_subtour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the subtours tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>work_tours: DataFrame</strong></dt><dd><p>A series which has parent work tour tour_id as the index and
columns with person_id and atwork_subtour_frequency.</p>
</dd>
<dt><strong>atwork_subtour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index with atwork_subtour_frequency values
and frequency counts for the subtours to be generated for that choice</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.process_joint_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">process_joint_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">joint_tour_frequency</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joint_tour_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">point_persons</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_joint_tours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the joint_tour_frequency column that comes out of
the model of the same name and turns into a DataFrame that represents the
joint tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>joint_tour_frequency</strong><span class="classifier">pandas.Series</span></dt><dd><p>household joint_tour_frequency (which came out of the joint tour frequency model)
indexed by household_id</p>
</dd>
<dt><strong>joint_tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index with joint_tour_frequency values
and frequency counts for the tours to be generated for that choice</p>
</dd>
<dt><strong>point_persons</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>table with columns for (at least) person_ids and home_zone_id indexed by household_id</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a tour identifier, a household_id
column, a tour_type column and tour_type_num and tour_num columns
which is set to 1 or 2 depending whether it is the first or second joint tour
made by the household.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.process_mandatory_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">process_mandatory_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mandatory_tour_frequency_alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_mandatory_tours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the mandatory_tour_frequency column that comes out of
the model of the same name and turns into a DataFrame that represents the
mandatory tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">DataFrame</span></dt><dd><p>Persons is a DataFrame which has a column call
mandatory_tour_frequency (which came out of the mandatory tour
frequency model) and a column is_worker which indicates the person’s
worker status.  The only valid values of the mandatory_tour_frequency
column to take are “work1”, “work2”, “school1”, “school2” and
“work_and_school”</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a tour identifier, a person_id
column, a tour_type column which is “work” or “school” and a tour_num
column which is set to 1 or 2 depending whether it is the first or
second mandatory tour made by the person.  The logic for whether the
work or school tour comes first given a “work_and_school” choice
depends on the is_worker column: work tours first for workers, second for non-workers</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">process_non_mandatory_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the non_mandatory_tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the non mandatory tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons: pandas.DataFrame</strong></dt><dd><p>persons table containing a non_mandatory_tour_frequency column
which has the index of the chosen alternative as the value</p>
</dd>
<dt><strong>non_mandatory_tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.tour_frequency.process_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></span><span class="sig-name descname"><span class="pre">process_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_frequency</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_category</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">parent_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'person_id'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_tours" title="Permalink to this definition">#</a></dt>
<dd><p>This method processes the tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the tours that were generated</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tour_frequency: Series</strong></dt><dd><p>A series which has &lt;parent_col&gt; as the index and the chosen alternative
index as the value</p>
</dd>
<dt><strong>tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</dd>
<dt><strong>tour_category</strong><span class="classifier">str</span></dt><dd><p>one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
<dt><strong>parent_col: str</strong></dt><dd><p>the name of the index (parent_tour_id for atwork subtours, otherwise person_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
<p>tours.tour_type       - tour type (e.g. school, work, shopping, eat)
tours.tour_type_num   - if there are two ‘school’ type tours, they will be numbered 1 and 2
tours.tour_type_count - number of tours of tour_type parent has (parent’s max tour_type_num)
tours.tour_num        - index of tour (of any type) for parent
tours.tour_count      - number of tours of any type) for parent (parent’s max tour_num)
tours.tour_category   - one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.trip">
<span id="trip"></span><h3>Trip<a class="headerlink" href="#module-activitysim.abm.models.util.trip" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.trip.cleanup_failed_trips">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></span><span class="sig-name descname"><span class="pre">cleanup_failed_trips</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.cleanup_failed_trips" title="Permalink to this definition">#</a></dt>
<dd><p>drop failed trips and cleanup fields in leg_mates:</p>
<p>trip_num        assign new ordinal trip num after failed trips are dropped
trip_count      assign new count of trips in leg, sans failed trips
first           update first flag as we may have dropped first trip (last trip can’t fail)
next_trip_id    assign id of next trip in leg after failed trips are dropped</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.trip.flag_failed_trip_leg_mates">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></span><span class="sig-name descname"><span class="pre">flag_failed_trip_leg_mates</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">col_name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.flag_failed_trip_leg_mates" title="Permalink to this definition">#</a></dt>
<dd><p>set boolean flag column of specified name to identify failed trip leg_mates in place</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.trip.generate_alternative_sizes">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></span><span class="sig-name descname"><span class="pre">generate_alternative_sizes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_duration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_trips</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.generate_alternative_sizes" title="Permalink to this definition">#</a></dt>
<dd><p>Builds a lookup Numpy array pattern sizes based on the
number of trips in the leg and the duration available
to the leg.
:param max_duration:
:param max_trips:
:return:</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.trip.get_time_windows">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></span><span class="sig-name descname"><span class="pre">get_time_windows</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">residual</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">level</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.get_time_windows" title="Permalink to this definition">#</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>residual</strong> – </p></li>
<li><p><strong>level</strong> – </p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.trip.initialize_from_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></span><span class="sig-name descname"><span class="pre">initialize_from_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">stop_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">addtl_tour_cols_to_preserve</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.initialize_from_tours" title="Permalink to this definition">#</a></dt>
<dd><p>Instantiates a trips table based on tour-level attributes: stop frequency,
tour origin, tour destination.</p>
</dd></dl>

</section>
<section id="module-activitysim.abm.models.util.vectorize_tour_scheduling">
<span id="vectorize-tour-scheduling"></span><h3>Vectorize Tour Scheduling<a class="headerlink" href="#module-activitysim.abm.models.util.vectorize_tour_scheduling" title="Permalink to this headline">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.compute_logsums">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">compute_logsums</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alt_tdd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.compute_logsums" title="Permalink to this definition">#</a></dt>
<dd><p>Compute logsums for the tour alt_tdds, which will differ based on their different start, stop
times of day, which translate to different odt_skim out_period and in_periods.</p>
<p>In mtctm1, tdds are hourly, but there are only 5 skim time periods, so some of the tdd_alts
will be the same, once converted to skim time periods. With 5 skim time periods there are
15 unique out-out period pairs but 190 tdd alternatives.</p>
<p>For efficiency, rather compute a lot of redundant logsums, we compute logsums for the unique
(out-period, in-period) pairs and then join them back to the alt_tdds.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">get_previous_tour_by_tourid</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">current_tour_window_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">previous_tour_by_window_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid" title="Permalink to this definition">#</a></dt>
<dd><p>Matches current tours with attributes of previous tours for the same
person.  See the return value below for more information.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>current_tour_window_ids</strong><span class="classifier">Series</span></dt><dd><p>A Series of parent ids for the tours we’re about make the choice for
- index should match the tours DataFrame.</p>
</dd>
<dt><strong>previous_tour_by_window_id</strong><span class="classifier">Series</span></dt><dd><p>A Series where the index is the parent (window) id and the value is the index
of the alternatives of the scheduling.</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>The alternatives of the scheduling.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>prev_alts</strong><span class="classifier">DataFrame</span></dt><dd><p>A DataFrame with an index matching the CURRENT tours we’re making a
decision for, but with columns from the PREVIOUS tour of the person
associated with each of the CURRENT tours.  Columns listed in PREV_TOUR_COLUMNS
from the alternatives will have “_previous” added as a suffix to keep
differentiated from the current alternatives that will be part of the
interaction.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.run_alts_preprocessor">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">run_alts_preprocessor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.run_alts_preprocessor" title="Permalink to this definition">#</a></dt>
<dd><p>run preprocessor on alts, as specified by ALTS_PREPROCESSOR in model_settings</p>
<p>we are agnostic on whether alts are merged or not</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings: dict</strong></dt><dd><p>yaml model settings file as dict</p>
</dd>
<dt><strong>alts: pandas.DataFrame</strong></dt><dd><p>tdd_alts or tdd_alts merged wiht choosers (we are agnostic)</p>
</dd>
<dt><strong>segment: string</strong></dt><dd><p>segment selector as understood by caller (e.g. logsum_tour_purpose)</p>
</dd>
<dt><strong>locals_dict: dict</strong></dt><dd><p>we let caller worry about what needs to be in it. though actually depends on modelers needs</p>
</dd>
<dt><strong>trace_label: string</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>alts: pandas.DataFrame</dt><dd><p>annotated copy of alts</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">schedule_tours</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable_window_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">previous_tour</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_owner_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_chunk_tag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sharrow_skip</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours" title="Permalink to this definition">#</a></dt>
<dd><p>chunking wrapper for _schedule_tours</p>
<p>While interaction_sample_simulate provides chunking support, the merged tours, persons
dataframe and the tdd_interaction_dataset are very big, so we want to create them inside
the chunking loop to minimize memory footprint. So we implement the chunking loop here,
and pass a chunk_size of 0 to interaction_sample_simulate to disable its chunking support.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">tdd_interaction_dataset</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choice_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">window_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset" title="Permalink to this definition">#</a></dt>
<dd><p>interaction_sample_simulate expects
alts index same as choosers (e.g. tour_id)
name of choice column in alts</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>must have person_id column and index on tour_id</p>
</dd>
<dt><strong>alts</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>alts index must be timetable tdd id</p>
</dd>
<dt><strong>timetable</strong><span class="classifier">TimeTable object</span></dt><dd></dd>
<dt><strong>choice_column</strong><span class="classifier">str</span></dt><dd><p>name of column to store alt index in alt_tdd DataFrame
(since alt_tdd is duplicate index on person_id but unique on person_id,alt_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>alt_tdd</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>columns: start, end , duration, &lt;choice_column&gt;
index: tour_id</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_joint_tour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">vectorize_joint_tour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">joint_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joint_tour_participants</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sharrow_skip</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_joint_tour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>Like vectorize_tour_scheduling but specifically for joint tours</p>
<p>joint tours have a few peculiarities necessitating separate treatment:</p>
<p>Timetable has to be initialized to set all timeperiods…</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of tours containing tour attributes, as well as a person_id
column to define the nth tour for each person.</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(or dict of specs keyed on tour_type if tour_types is not None)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the tours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
<dt><strong>persons_timetable</strong><span class="classifier">TimeTable</span></dt><dd><p>timetable updated with joint tours (caller should replace_table for it to persist)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">vectorize_subtour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subtours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sharrow_skip</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>Like vectorize_tour_scheduling but specifically for atwork subtours</p>
<p>subtours have a few peculiarities necessitating separate treatment:</p>
<p>Timetable has to be initialized to set all timeperiods outside parent tour footprint as
unavailable. So atwork subtour timewindows are limited to the footprint of the parent work
tour. And parent_tour_id’ column of tours is used instead of parent_id as timetable row_id.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>parent_tours</strong><span class="classifier">DataFrame</span></dt><dd><p>parent tours of the subtours (because we need to know the tdd of the parent tour to
assign_subtour_mask of timetable indexed by parent_tour id</p>
</dd>
<dt><strong>subtours</strong><span class="classifier">DataFrame</span></dt><dd><p>atwork subtours to schedule</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(all subtours share same spec regardless of subtour type)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the subtours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling">
<span class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></span><span class="sig-name descname"><span class="pre">vectorize_tour_scheduling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_segments</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_segment_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling" title="Permalink to this definition">#</a></dt>
<dd><p>The purpose of this method is fairly straightforward - it takes tours
and schedules them into time slots.  Alternatives should be specified so
as to define those time slots (usually with start and end times).</p>
<p>schedule_tours adds variables that can be used in the spec which have
to do with the previous tours per person.  Every column in the
alternatives table is appended with the suffix “_previous” and made
available.  So if your alternatives table has columns for start and end,
then start_previous and end_previous will be set to the start and end of
the most recent tour for a person.  The first time through,
start_previous and end_previous are undefined, so make sure to protect
with a tour_num &gt;= 2 in the variable computation.</p>
<p>FIXME - fix docstring: tour_segments, tour_segment_col</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of tours containing tour attributes, as well as a person_id
column to define the nth tour for each person.</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(or dict of specs keyed on tour_type if tour_types is not None)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the tours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
<dt><strong>timetable</strong><span class="classifier">TimeTable</span></dt><dd><p>persons timetable updated with tours (caller should replace_table for it to persist)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">#</a></h2>
<p>See <code class="docutils literal notranslate"><span class="pre">activitysim.abm.test</span></code> and <code class="docutils literal notranslate"><span class="pre">activitysim.abm.models.util.test</span></code></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="development.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Software Development</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="dev-guide/components/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Components</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.2.1.dev7+g08c7ab2f, documentation last updated Feb 06, 2023.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>