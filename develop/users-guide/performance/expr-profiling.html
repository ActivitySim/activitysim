

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Expression Profiling &#8212; ActivitySim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'users-guide/performance/expr-profiling';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://activitysim.github.io/activitysim/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.4.1';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Run the Primary Example" href="../run_primary_example.html" />
    <link rel="prev" title="Skims Data File Formatting" href="skim-data-format.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.4.1" />
    <meta name="docbuild:last-update" content="Sep 26, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ActivitySim</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../modelsetup.html">Model Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ways_to_run.html">Ways to Run the Model</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Runtime Performance</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="multiprocessing.html">Multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="multithreading.html">Multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="chunking.html">Chunking to Reduce Peak Memory Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="sharrow.html">Compiling with Sharrow</a></li>
<li class="toctree-l2"><a class="reference internal" href="skim-data-format.html">Skim Data Format</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Expression Profiling</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../run_primary_example.html">Run the Primary Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_anatomy.html">Anatomy of a Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howitworks.html">How the System Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_dev.html">Model Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_models.html">Example Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_performance.html">Example Model Performance Benchmarking</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../estimation-mode/index.html">Estimation Mode</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../estimation-mode/asim-est.html"> Running ActivitySim in Estimation Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../estimation-mode/larch.html"> Using Larch to Re-estimate Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../estimation-mode/larch-api.html"> ActivitySim Larch Tool API</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../other_examples.html">Other Example Models</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Users Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Runtime Performance</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Expression Profiling</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="expression-profiling">
<h1>Expression Profiling<a class="headerlink" href="#expression-profiling" title="Permalink to this heading">#</a></h1>
<p>Part of the appeal of ActivitySim is in its flexibility: it is possible to craft
a massive variety of mathematical forms and relationships through creative use
of the expressions found in most component spec files. But as we have all learned
from Spider-Man, with great power comes great responsibility. Users can write
arbitrary code in spec files, and the runtime performance of ActivitySim will
depend on the parsimony and efficiency of that code.</p>
<p>Sometimes these spec files can be large, and it may be difficult to determine
simply by inspection which expressions in a given spec file are faster or slower.
ActivitySim now offers an expression-level profiling tool to assist in diagnosing
performance problems that arise from inefficient spec files.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>At this time,
expression profiling only works for the evaluation of expressions in “legacy” mode.
It does not work in “sharrow” mode, as the compiled expressions run with sharrow
are not run in a serial fashion and are not able to be profiled in the same way.</p>
</div>
<section id="profiling-an-entire-model-run">
<h2>Profiling an Entire Model Run<a class="headerlink" href="#profiling-an-entire-model-run" title="Permalink to this heading">#</a></h2>
<p>The simplest way to use the expression profiler is to set the
<a class="reference internal" href="../_generated/activitysim.core.configuration.Settings.html#activitysim.core.configuration.Settings.expression_profile" title="activitysim.core.configuration.Settings.expression_profile"><span class="xref myst py py-obj"><code class="docutils literal notranslate"><span class="pre">expression_profile</span></code></span></a>
configuration setting in the top level model settings (typically <code class="docutils literal notranslate"><span class="pre">settings.yaml</span></code>):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">expression_profile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>This will cause the profiler to be activated for all expressions in the model,
across all components. This includes expressions in the spec files, as well as
expressions in all preprocessors and annotators.  Each time the expressions in
any spec file are evaluated, the profiler will record the time taken to evaluate
each expression.  An “expr-performance” subdirectory will be created in the model’s
logging directory, and a new log file will be created each time the expressions in
any spec file are evaluated. The file is named according to the <code class="docutils literal notranslate"><span class="pre">trace_label</span></code> found
where the expressions are being evaluated. It will include a list of all the evaluated
expressions from the spec file, along with the time taken to evaluate each expression.
For multi-processed models, each subprocess will create its own log file directory,
similar to the logging directory structure for the other model components.</p>
</section>
<section id="summary-outputs">
<h2>Summary Outputs<a class="headerlink" href="#summary-outputs" title="Permalink to this heading">#</a></h2>
<p>At the end of a model run where the <code class="docutils literal notranslate"><span class="pre">expression_profile</span></code> setting is active,
ActivitySim will also create a pair of summary files in the “expr-performance”
subdirectory.  The first is named “expression-timing-subcomponents.html”,
and contains a simple concatenation of the runtimes of
expressions in the various subcomponents stored in the log files,
filtered to only include expressions that tool a notable amount of time.
By default, this is set to 0.1 seconds, but can be changed by setting the
<a class="reference internal" href="../_generated/activitysim.core.configuration.Settings.html#activitysim.core.configuration.Settings.expression_profile_cutoff" title="activitysim.core.configuration.Settings.expression_profile_cutoff"><span class="xref myst py py-obj"><code class="docutils literal notranslate"><span class="pre">expression_profile_cutoff</span></code></span></a>
configuration setting in the model settings.</p>
<p>The second file, “expression-timing-components.html”, shows an aggregate
summary of the runtimes for each expression,
aggregated across all the log files. The aggregation is by model component and
expression, so that this summary includes the total time taken to evaluate each
expression within each model component, recognizing that identical expressions
may be evaluated multiple times in different model subcomponents (e.g. across
different purposes, or tour numbers, etc.).  This more aggregated summary is
typically the one that will be most useful for identifying expressions that
provide the most overall potential for performance improvement via streamlining.</p>
<p>Users should note that the expression profiler is not a substitute for good coding
practices.  It will not necessarily identify all performance problems, and it is not
able to suggest improvements to the expressions.  It is simply a tool to help users
identify which expressions are taking the most time to evaluate, and therefore
which expressions are the best candidates for improvement.</p>
<p>Also, users should understand that the expression profiler is not directly measuring the
computational complexity of the expressions, but rather the time taken to evaluate
the expressions. This time can be affected by a number of factors, including the
complexity of the expression, the size of the data being processed, and whether
there are other processes running on the machine at the same time competing for
resources. For multiprocessing model runs, those other processes may include
other the subprocesses of ActivitySim, which may lead to surprising results.</p>
<p>There is also no adjustment made for parallelization of the expression evaluations.
For example, if the same expression is evaluated in parallel across 8 processes on
a machine with 8 cores, and each process takes 0.1 seconds to evaluate the expression,
the profiler will still show that the expression took 0.8 seconds to evaluate, even
though the total wall clock time taken to evaluate the expression across all processes
was only 0.1 seconds.</p>
<p>Profiling expressions also adds some overhead to the model run, increasing the
total runtime of the model by a modest but noticeable amount. In consortium
<a class="reference external" href="https://github.com/ActivitySim/activitysim/pull/936#issuecomment-3165410169">experiments</a>
with this tool, runtime for the full-scale SANDAG model was found to
increase by approximately 12.5% when the profiler was enabled, adding more than
13 minutes to a model run that already took 105 minutes. Users should thus
be careful about using the profiler in production runs.  It is recommended turn off
the profiler in production runs, and only use it for debugging and development.</p>
</section>
<section id="profiling-individual-components">
<h2>Profiling Individual Components<a class="headerlink" href="#profiling-individual-components" title="Permalink to this heading">#</a></h2>
<p>The expression profiler can also be used to profile individual components, rather
than the entire model. This is done by setting the <code class="docutils literal notranslate"><span class="pre">compute_settings.performance_log</span></code>
attribute for the component in the model settings. This attribute can be set to the
filename where the profiler log file should be written, which will override
the default behavior of writing the log file to the “expr-performance” subdirectory.
This feature only works for components that are run in a single process, and which
have a <code class="docutils literal notranslate"><span class="pre">compute_settings</span></code> attribute. It is generally not recommended to use this
feature unless a specific component is suspected of having atypical performance
problems, as it will not provide the same summary reporting as profiling the entire
model.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="skim-data-format.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Skims Data File Formatting</p>
      </div>
    </a>
    <a class="right-next"
       href="../run_primary_example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Run the Primary Example</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-an-entire-model-run">Profiling an Entire Model Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-outputs">Summary Outputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-individual-components">Profiling Individual Components</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/users-guide/performance/expr-profiling.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.4.1.dev14+g1a94629e1, documentation last updated Sep 26, 2025.<br/>
</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>