
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Multithreading &#8212; ActivitySim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=86d88d25" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=45b7e9ca"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'users-guide/performance/multithreading';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://activitysim.github.io/activitysim/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3.3';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Chunking" href="chunking.html" />
    <link rel="prev" title="Multiprocessing" href="multiprocessing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Feb 25, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ActivitySim</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../modelsetup.html">Model Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ways_to_run.html">Ways to Run the Model</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Runtime Performance</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="multiprocessing.html">Multiprocessing</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="chunking.html">Chunking to Reduce Peak Memory Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="sharrow.html">Compiling with Sharrow</a></li>
<li class="toctree-l2"><a class="reference internal" href="skim-data-format.html">Skim Data Format</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../run_primary_example.html">Run the Primary Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_anatomy.html">Anatomy of a Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howitworks.html">How the System Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_dev.html">Model Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_models.html">Example Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_performance.html">Example Model Performance Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other_examples.html">Other Example Models</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Users Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Runtime Performance</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Multithreading</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="multithreading">
<h1>Multithreading<a class="headerlink" href="#multithreading" title="Link to this heading">#</a></h1>
<p>Some parts of ActivitySim are also multithreaded, using various different
multithreading technologies. This includes large matrix multiplication operations
used in certain utility calculations (multithreaded by the MKL library where
available) as well as computations accelerated using the sharrow library (which
uses numba to parallelize certain operations), as well as potentially other
parallelization subroutines in other libraries upon which ActivitySim depends.</p>
<p>In general, it is desirable to fully or partially <em>disable</em> multithreading in
ActivitySim when using multiprocessing, as the two technologies can interfere
with each other.</p>
<p>When ActivitySim is run from the command line, using either <code class="docutils literal notranslate"><span class="pre">activitysim</span> <span class="pre">run</span></code> or
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">activitysim</span> <span class="pre">run</span></code>, by default multithreading is disabled.  This can
be overridden by using the <code class="docutils literal notranslate"><span class="pre">--fast</span></code> command line flag, which will not disable
multithreading, leaving whatever existing environment settings for threading
unchanged.  When running ActivitySim from within a Python script,
or by calling it from a Jupyter notebook, it is up to the user to enable or
disable multithreading if desired, as these settings need to be made before
libraries that use multithreading are loaded.</p>
<p>Disabling multithreading can be done two ways, either by setting environment
variables before starting a Python instance that will run ActivitySim, or by
setting certain environment variables within Python before loading ActivitySim
or its dependencies (especially numba).  Once certain libraries (e.g., numba)
are loaded, it is too late to set global process limits on multithreading.</p>
<section id="disabling-multithreading-via-environment-variables">
<h2>Disabling Multithreading via Environment Variables<a class="headerlink" href="#disabling-multithreading-via-environment-variables" title="Link to this heading">#</a></h2>
<p>Setting environment variables before starting a Python instance is the most
reliable way to disable multithreading in ActivitySim, as it ensures that the
settings are made before any Python libraries are loaded. The environment
variables that need to be set are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MKL_NUM_THREADS</span></code> - This environment variable controls the number of threads
used by the Intel Math Kernel Library (MKL), which is used by numpy and pandas
for certain operations.  Setting this to 1 will disable multithreading in MKL.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code> - This environment variable controls the number of threads
used by the numba library, which is used by ActivitySim for certain operations.
Setting this to 1 will disable multithreading in numba.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> - This environment variable controls the number of threads
used by the OpenMP library, which is used by some libraries that ActivitySim
depends on.  Setting this to 1 will disable multithreading in OpenMP.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NUMEXPR_NUM_THREADS</span></code> - This environment variable controls the number of threads
used by the numexpr library, which is used by pandas for certain operations.
Setting this to 1 will disable multithreading in numexpr.</p></li>
</ul>
<p>The downside of this is that the exact commands needed are platform and
shell-specific (i.e. the commands for Powershell, Windows <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>, and Linux’s
bash are all different).</p>
<section id="windows-command-line">
<h3>Windows Command Line<a class="headerlink" href="#windows-command-line" title="Link to this heading">#</a></h3>
</section>
<section id="linux-macos-bash-zsh">
<h3>Linux / MacOS (bash / zsh)<a class="headerlink" href="#linux-macos-bash-zsh" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="disabling-multithreading-via-python">
<h2>Disabling Multithreading via Python<a class="headerlink" href="#disabling-multithreading-via-python" title="Link to this heading">#</a></h2>
<p>Disabling multithreading via Python is also possible, and doing so can be done
in a more platform-independent way.  However, this method requires some care, as
it must be completed before many of the other libraries that ActivitySim depends
on are loaded.  This can be accomplished by setting the environment variables at
the very top of the Python script used to run ActivitySim, before any other imports:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>```python
import os

os.environ[&quot;MKL_NUM_THREADS&quot;] = &quot;1&quot;
os.environ[&quot;OMP_NUM_THREADS&quot;] = &quot;1&quot;
os.environ[&quot;OPENBLAS_NUM_THREADS&quot;] = &quot;1&quot;
os.environ[&quot;NUMBA_NUM_THREADS&quot;] = &quot;1&quot;
os.environ[&quot;VECLIB_MAXIMUM_THREADS&quot;] = &quot;1&quot;
os.environ[&quot;NUMEXPR_NUM_THREADS&quot;] = &quot;1&quot;

import activitysim
...
```
</pre></div>
</div>
<p>If you accidentally import <code class="docutils literal notranslate"><span class="pre">activitysim</span></code> or its dependencies before setting the
environment variables, the environment variables may not be respected.  Note that
certain auto-formatting tools (e.g. isort) may automatically reorder imports and group
them all at the top of a Python script; when using these tools it is important to make
sure that the <code class="docutils literal notranslate"><span class="pre">os.environ</span></code> setting commands stay in front of the <code class="docutils literal notranslate"><span class="pre">import</span></code> statments
other than <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">os</span></code>.</p>
</section>
<section id="how-many-threads">
<h2>How Many Threads<a class="headerlink" href="#how-many-threads" title="Link to this heading">#</a></h2>
<p>Sometimes, using more than one thread per process can be beneficial.  In the discussion
above, threading is effectively disabled by setting the number of threads to 1.  However,
if you have a machine with many cores, you may want to experiment with using more than
one thread per process.  Depending on your particular model and hardware, you may find
that using multiple threads per process can improve performance.  However, it is likely
that the optimal number of threads per process will be less than the number of CPU cores
per process, so it is recommended to start with a small number of threads per process
and work up from there to see if gains are possible.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="multiprocessing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Multiprocessing</p>
      </div>
    </a>
    <a class="right-next"
       href="chunking.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chunking</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disabling-multithreading-via-environment-variables">Disabling Multithreading via Environment Variables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#windows-command-line">Windows Command Line</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linux-macos-bash-zsh">Linux / MacOS (bash / zsh)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disabling-multithreading-via-python">Disabling Multithreading via Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-many-threads">How Many Threads</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/users-guide/performance/multithreading.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.3.3.dev6+gbf64b7be, documentation last updated Feb 25, 2025.<br/>
</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>