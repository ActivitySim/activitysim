
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>School Location &#8212; ActivitySim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=86d88d25" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=200b4715"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'users-guide/school_escorting';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://activitysim.github.io/activitysim/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3.2';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Sep 19, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ActivitySim</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Users Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../dev-guide/index.html">
    Developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">School Location</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="school-location">
<h1>School Location<a class="headerlink" href="#school-location" title="Link to this heading">#</a></h1>
<p>Now that the persons, households, and other data are in memory, and also annotated with additional fields
for later calculations, the school location model can be run.  The school location model is defined
in <code class="xref py py-mod docutils literal notranslate"><span class="pre">activitysim.abm.models.location_choice</span></code>.  As shown below, the school location model
actually uses the <code class="docutils literal notranslate"><span class="pre">persons_merged</span></code> table, which includes joined household, land use, and accessibility
tables as well.  The school location model also requires the network_los object, which is discussed next.
Before running the generic iterate location choice function, the model reads the model settings file, which
defines various settings, including the expression files, sample size, mode choice logsum
calculation settings, time periods for skim lookups, shadow pricing settings, etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#persons.py</span>
<span class="c1"># another common merge for persons</span>
<span class="nd">@inject</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">persons_merged</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">land_use</span><span class="p">,</span> <span class="n">accessibility</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">inject</span><span class="o">.</span><span class="n">merge_tables</span><span class="p">(</span><span class="n">persons</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">land_use</span><span class="p">,</span> <span class="n">accessibility</span><span class="p">])</span>

<span class="c1">#location_choice.py</span>
<span class="nd">@inject</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">school_location</span><span class="p">(</span>
     <span class="n">persons_merged</span><span class="p">,</span> <span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span>
     <span class="n">network_los</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">,</span> <span class="n">locutor</span>
     <span class="p">):</span>

  <span class="n">trace_label</span> <span class="o">=</span> <span class="s1">&#39;school_location&#39;</span>
  <span class="n">model_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">read_model_settings</span><span class="p">(</span><span class="s1">&#39;school_location.yaml&#39;</span><span class="p">)</span>

  <span class="n">iterate_location_choice</span><span class="p">(</span>
     <span class="n">model_settings</span><span class="p">,</span>
     <span class="n">persons_merged</span><span class="p">,</span> <span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span>
     <span class="n">network_los</span><span class="p">,</span>
     <span class="n">chunk_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">,</span> <span class="n">locutor</span><span class="p">,</span> <span class="n">trace_label</span>
</pre></div>
</div>
<p>Deep inside the method calls, the skim matrix lookups required for this model are configured via <code class="docutils literal notranslate"><span class="pre">network_los</span></code>. The following
code sets the keys for looking up the skim values for this model. In this case there is a <code class="docutils literal notranslate"><span class="pre">TAZ</span></code> column
in the households table that is renamed to <cite>TAZ_chooser`</cite> and a <code class="docutils literal notranslate"><span class="pre">TAZ</span></code> in the alternatives generation code.
The skims are lazy loaded under the name “skims” and are available in the expressions using the <code class="docutils literal notranslate"><span class="pre">&#64;skims</span></code> expression.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create wrapper with keys for this lookup - in this case there is a home_zone_id in the choosers</span>
<span class="c1"># and a zone_id in the alternatives which get merged during interaction</span>
<span class="c1"># (logit.interaction_dataset suffixes duplicate chooser column with &#39;_chooser&#39;)</span>
<span class="c1"># the skims will be available under the name &quot;skims&quot; for any @ expressions</span>
<span class="n">skim_dict</span> <span class="o">=</span> <span class="n">network_los</span><span class="o">.</span><span class="n">get_default_skim_dict</span><span class="p">()</span>
<span class="n">skims</span> <span class="o">=</span> <span class="n">skim_dict</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="s1">&#39;home_zone_id&#39;</span><span class="p">,</span> <span class="s1">&#39;zone_id&#39;</span><span class="p">)</span>

<span class="n">locals_d</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;skims&#39;</span><span class="p">:</span> <span class="n">skims</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The next step is to call the <a class="reference internal" href="../core.html#activitysim.core.interaction_sample.interaction_sample" title="activitysim.core.interaction_sample.interaction_sample"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.interaction_sample.interaction_sample()</span></code></a> function which
selects a sample of alternatives by running a MNL choice model simulation in which alternatives must be
merged with choosers because there are interaction terms.  The choosers table, the alternatives table, the
sample size, the model specification expressions file, the skims, the skims lookups, the chunk size, and the
trace labels are passed in.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#interaction_sample</span>
<span class="n">choices</span> <span class="o">=</span> <span class="n">interaction_sample</span><span class="p">(</span>
   <span class="n">choosers</span><span class="p">,</span>
   <span class="n">alternatives</span><span class="p">,</span>
   <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
   <span class="n">alt_col_name</span><span class="o">=</span><span class="n">alt_dest_col_name</span><span class="p">,</span>
   <span class="n">spec</span><span class="o">=</span><span class="n">spec_for_segment</span><span class="p">(</span><span class="n">model_spec</span><span class="p">,</span> <span class="n">segment_name</span><span class="p">),</span>
   <span class="n">skims</span><span class="o">=</span><span class="n">skims</span><span class="p">,</span>
   <span class="n">locals_d</span><span class="o">=</span><span class="n">locals_d</span><span class="p">,</span>
   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
   <span class="n">trace_label</span><span class="o">=</span><span class="n">trace_label</span><span class="p">)</span>
</pre></div>
</div>
<p>This function solves the utilities, calculates probabilities, draws random numbers, selects choices with
replacement, and returns the choices. This is done in a for loop of chunks of chooser records in order to avoid
running out of RAM when building the often large data tables. This method does a lot, and eventually
calls <a class="reference internal" href="../core.html#activitysim.core.interaction_simulate.eval_interaction_utilities" title="activitysim.core.interaction_simulate.eval_interaction_utilities"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.interaction_simulate.eval_interaction_utilities()</span></code></a>, which loops through each
expression in  the expression file and solves it at once for all records in the chunked chooser
table using Python’s <code class="docutils literal notranslate"><span class="pre">eval</span></code>.</p>
<p>The <a class="reference internal" href="../core.html#activitysim.core.interaction_sample.interaction_sample" title="activitysim.core.interaction_sample.interaction_sample"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.interaction_sample.interaction_sample()</span></code></a> method is currently only a multinomial
logit choice model.  The <a class="reference internal" href="../core.html#activitysim.core.simulate.simple_simulate" title="activitysim.core.simulate.simple_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.simulate.simple_simulate()</span></code></a> method supports both MNL and NL as specified by
the <code class="docutils literal notranslate"><span class="pre">LOGIT_TYPE</span></code> setting in the model settings YAML file.   The <code class="docutils literal notranslate"><span class="pre">auto_ownership.yaml</span></code> file for example specifies
the <code class="docutils literal notranslate"><span class="pre">LOGIT_TYPE</span></code> as <code class="docutils literal notranslate"><span class="pre">MNL.</span></code></p>
<p>If the expression is a skim matrix, then the entire column of chooser OD pairs is retrieved from the matrix (i.e. numpy array)
in one vectorized step.  The <code class="docutils literal notranslate"><span class="pre">orig</span></code> and <code class="docutils literal notranslate"><span class="pre">dest</span></code> objects in <code class="docutils literal notranslate"><span class="pre">self.data[orig,</span> <span class="pre">dest]</span></code> in <a class="reference internal" href="../core.html#module-activitysim.core.los" title="activitysim.core.los"><code class="xref py py-mod docutils literal notranslate"><span class="pre">activitysim.core.los</span></code></a> are vectors
and selecting numpy array items with vector indexes returns a vector.  Trace data is also written out if configured (not shown below).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate expressions from the spec multiply by coefficients and sum</span>
<span class="n">interaction_utilities</span><span class="p">,</span> <span class="n">trace_eval_results</span> \
    <span class="o">=</span> <span class="n">eval_interaction_utilities</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">interaction_df</span><span class="p">,</span> <span class="n">locals_d</span><span class="p">,</span> <span class="n">trace_label</span><span class="p">,</span> <span class="n">trace_rows</span><span class="p">)</span>

<span class="c1"># reshape utilities (one utility column and one row per row in model_design)</span>
<span class="c1"># to a dataframe with one row per chooser and one column per alternative</span>
<span class="n">utilities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">interaction_utilities</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choosers</span><span class="p">),</span> <span class="n">alternative_count</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">choosers</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># convert to probabilities (utilities exponentiated and normalized to probs)</span>
<span class="c1"># probs is same shape as utilities, one row per chooser and one column for alternative</span>
<span class="n">probs</span> <span class="o">=</span> <span class="n">logit</span><span class="o">.</span><span class="n">utils_to_probs</span><span class="p">(</span><span class="n">utilities</span><span class="p">,</span> <span class="n">allow_zero_probs</span><span class="o">=</span><span class="n">allow_zero_probs</span><span class="p">,</span>
                             <span class="n">trace_label</span><span class="o">=</span><span class="n">trace_label</span><span class="p">,</span> <span class="n">trace_choosers</span><span class="o">=</span><span class="n">choosers</span><span class="p">)</span>

<span class="n">choices_df</span> <span class="o">=</span> <span class="n">make_sample_choices</span><span class="p">(</span>
    <span class="n">choosers</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">alternative_count</span><span class="p">,</span> <span class="n">alt_col_name</span><span class="p">,</span>
    <span class="n">allow_zero_probs</span><span class="o">=</span><span class="n">allow_zero_probs</span><span class="p">,</span> <span class="n">trace_label</span><span class="o">=</span><span class="n">trace_label</span><span class="p">)</span>

<span class="c1"># pick_count is number of duplicate picks</span>
<span class="n">pick_group</span> <span class="o">=</span> <span class="n">choices_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">choosers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">alt_col_name</span><span class="p">])</span>

<span class="c1"># number each item in each group from 0 to the length of that group - 1.</span>
<span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pick_group</span><span class="o">.</span><span class="n">cumcount</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># flag duplicate rows after first</span>
<span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_dup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="c1"># add reverse cumcount to get total pick_count (conveniently faster than groupby.count + merge)</span>
<span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pick_group</span><span class="o">.</span><span class="n">cumcount</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># drop the duplicates</span>
<span class="n">choices_df</span> <span class="o">=</span> <span class="n">choices_df</span><span class="p">[</span><span class="o">~</span><span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_dup&#39;</span><span class="p">]]</span>
<span class="k">del</span> <span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;pick_dup&#39;</span><span class="p">]</span>

<span class="k">return</span> <span class="n">choices_df</span>
</pre></div>
</div>
<p>The model creates the <code class="docutils literal notranslate"><span class="pre">location_sample_df</span></code> table using the choices above.  This table is
then used for the next model step - solving the logsums for the sample.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># - location_logsums</span>
<span class="n">location_sample_df</span> <span class="o">=</span> <span class="n">run_location_logsums</span><span class="p">(</span>
           <span class="n">segment_name</span><span class="p">,</span>
           <span class="n">choosers</span><span class="p">,</span>
           <span class="n">network_los</span><span class="p">,</span>
           <span class="n">location_sample_df</span><span class="p">,</span>
           <span class="n">model_settings</span><span class="p">,</span>
           <span class="n">chunk_size</span><span class="p">,</span>
           <span class="n">trace_hh_id</span><span class="p">,</span>
           <span class="n">tracing</span><span class="o">.</span><span class="n">extend_trace_label</span><span class="p">(</span><span class="n">trace_label</span><span class="p">,</span> <span class="s1">&#39;logsums.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">segment_name</span><span class="p">))</span>
</pre></div>
</div>
<p>The next steps are similar to what the sampling model does, except this time the sampled locations
table is the choosers and the model is calculating and adding the tour mode choice logsums using the
logsums settings and expression files.  The resulting logsums are added to the chooser table as the
<code class="docutils literal notranslate"><span class="pre">mode_choice_logsum</span></code> column.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#inside run_location_logsums() defined in location_choice.py</span>
<span class="n">logsums</span> <span class="o">=</span> <span class="n">logsum</span><span class="o">.</span><span class="n">compute_logsums</span><span class="p">(</span>
   <span class="n">choosers</span><span class="p">,</span>
   <span class="n">tour_purpose</span><span class="p">,</span>
   <span class="n">logsum_settings</span><span class="p">,</span> <span class="n">model_settings</span><span class="p">,</span>
   <span class="n">network_los</span><span class="p">,</span>
   <span class="n">chunk_size</span><span class="p">,</span>
   <span class="n">trace_label</span><span class="p">)</span>

<span class="n">location_sample_df</span><span class="p">[</span><span class="s1">&#39;mode_choice_logsum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logsums</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.abm.models.util.logsums.compute_logsums()</span></code> method goes through a similar series
of steps as the interaction_sample function but ends up calling
<code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.simulate.simple_simulate_logsums()</span></code> since it supports nested logit models, which
are required for the mode choice logsum calculation.  The
<code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.simulate.simple_simulate_logsums()</span></code> returns a vector of logsums (instead of a vector
choices).</p>
<p>The final school location choice model operates on the <code class="docutils literal notranslate"><span class="pre">location_sample_df</span></code> table created
above and is called as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># - location_simulate</span>
<span class="n">choices</span> <span class="o">=</span> \
    <span class="n">run_location_simulate</span><span class="p">(</span>
        <span class="n">segment_name</span><span class="p">,</span>
        <span class="n">choosers</span><span class="p">,</span>
        <span class="n">location_sample_df</span><span class="p">,</span>
        <span class="n">network_los</span><span class="p">,</span>
        <span class="n">dest_size_terms</span><span class="p">,</span>
        <span class="n">model_settings</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">,</span>
        <span class="n">tracing</span><span class="o">.</span><span class="n">extend_trace_label</span><span class="p">(</span><span class="n">trace_label</span><span class="p">,</span> <span class="s1">&#39;simulate.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">segment_name</span><span class="p">))</span>

<span class="n">choices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
</pre></div>
</div>
<p>The operations executed by this model are very similar to the earlier models, except
this time the sampled locations table is the choosers and the model selects one alternative for
each chooser using the school location simulate expression files and the
<a class="reference internal" href="../core.html#activitysim.core.interaction_sample_simulate.interaction_sample_simulate" title="activitysim.core.interaction_sample_simulate.interaction_sample_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.core.interaction_sample_simulate.interaction_sample_simulate()</span></code></a> function.</p>
<p>Back in <code class="docutils literal notranslate"><span class="pre">iterate_location_choice()</span></code>, the model adds the choices as a column to the <code class="docutils literal notranslate"><span class="pre">persons</span></code> table and adds
additional output columns using a postprocessor table annotation if specified in the settings file.  Refer
to <span class="xref std std-ref">table_annotation</span> for more information and the <code class="xref py py-func docutils literal notranslate"><span class="pre">activitysim.abm.models.util.expressions.assign_columns()</span></code>
function.  The overall school location model is run within a shadow pricing iterative loop as shown below.  Refer
to <span class="xref std std-ref">shadow_pricing</span> for more information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># in iterate_location_choice() in location_choice.py</span>
      <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

     <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">use_shadow_pricing</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">spc</span><span class="o">.</span><span class="n">update_shadow_prices</span><span class="p">()</span>

     <span class="n">choices</span> <span class="o">=</span> <span class="n">run_location_choice</span><span class="p">(</span>
         <span class="n">persons_merged_df</span><span class="p">,</span>
         <span class="n">network_los</span><span class="p">,</span>
         <span class="n">spc</span><span class="p">,</span>
         <span class="n">model_settings</span><span class="p">,</span>
         <span class="n">chunk_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">,</span>
         <span class="n">trace_label</span><span class="o">=</span><span class="n">tracing</span><span class="o">.</span><span class="n">extend_trace_label</span><span class="p">(</span><span class="n">trace_label</span><span class="p">,</span> <span class="s1">&#39;i</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">))</span>

     <span class="n">choices_df</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;dest_choice&#39;</span><span class="p">)</span>
     <span class="n">choices_df</span><span class="p">[</span><span class="s1">&#39;segment_id&#39;</span><span class="p">]</span> <span class="o">=</span> \
         <span class="n">persons_merged_df</span><span class="p">[</span><span class="n">chooser_segment_column</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">choices_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

     <span class="n">spc</span><span class="o">.</span><span class="n">set_choices</span><span class="p">(</span><span class="n">choices_df</span><span class="p">)</span>

     <span class="k">if</span> <span class="n">locutor</span><span class="p">:</span>
         <span class="n">spc</span><span class="o">.</span><span class="n">write_trace_files</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

     <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">use_shadow_pricing</span> <span class="ow">and</span> <span class="n">spc</span><span class="o">.</span><span class="n">check_fit</span><span class="p">(</span><span class="n">iteration</span><span class="p">):</span>
         <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> converged after iteration </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trace_label</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,))</span>
         <span class="k">break</span>

 <span class="c1"># - shadow price table</span>
 <span class="k">if</span> <span class="n">locutor</span><span class="p">:</span>
     <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">use_shadow_pricing</span> <span class="ow">and</span> <span class="s1">&#39;SHADOW_PRICE_TABLE&#39;</span> <span class="ow">in</span> <span class="n">model_settings</span><span class="p">:</span>
         <span class="n">inject</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">model_settings</span><span class="p">[</span><span class="s1">&#39;SHADOW_PRICE_TABLE&#39;</span><span class="p">],</span> <span class="n">spc</span><span class="o">.</span><span class="n">shadow_prices</span><span class="p">)</span>
     <span class="k">if</span> <span class="s1">&#39;MODELED_SIZE_TABLE&#39;</span> <span class="ow">in</span> <span class="n">model_settings</span><span class="p">:</span>
         <span class="n">inject</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">model_settings</span><span class="p">[</span><span class="s1">&#39;MODELED_SIZE_TABLE&#39;</span><span class="p">],</span> <span class="n">spc</span><span class="o">.</span><span class="n">modeled_size</span><span class="p">)</span>

 <span class="n">dest_choice_column_name</span> <span class="o">=</span> <span class="n">model_settings</span><span class="p">[</span><span class="s1">&#39;DEST_CHOICE_COLUMN_NAME&#39;</span><span class="p">]</span>
 <span class="n">tracing</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">dest_choice_column_name</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">value_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

 <span class="n">persons_df</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

 <span class="c1"># We only chose school locations for the subset of persons who go to school</span>
 <span class="c1"># so we backfill the empty choices with -1 to code as no school location</span>
 <span class="n">NO_DEST_TAZ</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
 <span class="n">persons_df</span><span class="p">[</span><span class="n">dest_choice_column_name</span><span class="p">]</span> <span class="o">=</span> \
     <span class="n">choices</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">persons_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">NO_DEST_TAZ</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

 <span class="c1"># - annotate persons table</span>
 <span class="k">if</span> <span class="s1">&#39;annotate_persons&#39;</span> <span class="ow">in</span> <span class="n">model_settings</span><span class="p">:</span>
     <span class="n">expressions</span><span class="o">.</span><span class="n">assign_columns</span><span class="p">(</span>
         <span class="n">df</span><span class="o">=</span><span class="n">persons_df</span><span class="p">,</span>
         <span class="n">model_settings</span><span class="o">=</span><span class="n">model_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;annotate_persons&#39;</span><span class="p">),</span>
         <span class="n">trace_label</span><span class="o">=</span><span class="n">tracing</span><span class="o">.</span><span class="n">extend_trace_label</span><span class="p">(</span><span class="n">trace_label</span><span class="p">,</span> <span class="s1">&#39;annotate_persons&#39;</span><span class="p">))</span>

     <span class="n">pipeline</span><span class="o">.</span><span class="n">replace_table</span><span class="p">(</span><span class="s2">&quot;persons&quot;</span><span class="p">,</span> <span class="n">persons_df</span><span class="p">)</span>
</pre></div>
</div>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/users-guide/school_escorting.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
<p class="last-updated">
ActivitySim 1.3.2.dev2+gecb00b54, documentation last updated Sep 19, 2024.<br/>
</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>