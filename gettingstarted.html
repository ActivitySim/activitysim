

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Getting Started &mdash; ActivitySim 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="ActivitySim 0.1 documentation" href="index.html"/>
        <link rel="next" title="Data Schema" href="dataschema.html"/>
        <link rel="prev" title="ActivitySim" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> ActivitySim
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#anaconda">Anaconda</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#activitysim">ActivitySim</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#release">Release</a></li>
<li class="toctree-l4"><a class="reference internal" href="#development">Development</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#expressions">Expressions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#conventions">Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-expressions-file">Example Expressions File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#folder-file-setup">Folder/File Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inputs">Inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#logging-files">Logging Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-specification-files">Model Specification Files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-example-model">Running the Example Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#outputs">Outputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tracing">Tracing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-the-system-works">How the System Works</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-basic-flow-of-execution">The Basic Flow of Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-new-tables">Creating New Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#skims3dwrapper">Skims3dWrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessibilities">Accessibilities</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dataschema.html">Data Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="core.html">Core Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ActivitySim</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Getting Started</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/gettingstarted.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<p>This page describes how to install ActivitySim and setup and run the included example.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ActivitySim is under development</p>
</div>
<div class="section" id="installation">
<span id="index-0"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The following installation instructions are for Windows or Mac users.  ActivitySim is built
to run on one machine with sufficient available RAM to fit all required data and calculations
in memory.</p>
<div class="section" id="anaconda">
<h3>Anaconda<a class="headerlink" href="#anaconda" title="Permalink to this headline">¶</a></h3>
<p>ActivitySim is a Python 2.7 library that uses a number of packages from the
scientific Python ecosystem, most notably <a class="reference external" href="http://pandas.pydata.org">pandas</a>
and pandas and <a class="reference external" href="http://numpy.org">numpy</a>.</p>
<p>The recommended way to get your own scientific Python installation is to
install <a class="reference external" href="http://docs.continuum.io/anaconda/index.html">Anaconda</a>, which contains many of the libraries upon which
ActivitySim depends + some handy Python installation management tools.</p>
<p>Anaconda includes the <code class="docutils literal"><span class="pre">conda</span></code> command line tool, which does a number of useful
things, including creating <a class="reference external" href="http://conda.pydata.org/docs/using/envs.html">environments</a>
(i.e. stand-alone Python installations/instances/sandboxes) that are the recommended
way to work with multiple versions of Python on one machine.  Using conda
environments keeps multiple Python setups from conflicting with one another.</p>
<p>After installing Anaconda, create an ActivitySim test environment
with the following commands:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#Windows</span>
<span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">asimtest</span> <span class="n">python</span><span class="o">=</span><span class="mf">2.7</span>
<span class="n">activate</span> <span class="n">asimtest</span>

<span class="c1">#Mac</span>
<span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">asimtest</span> <span class="n">python</span><span class="o">=</span><span class="mf">2.7</span>
<span class="n">source</span> <span class="n">activate</span> <span class="n">asimtest</span>
</pre></div>
</div>
<p>This will create a new conda environment named <code class="docutils literal"><span class="pre">asimtest</span></code> and set it as the
active conda environment.  You need to activate the environment each time you
start a new command session.  You can remove an environment with
<code class="docutils literal"><span class="pre">conda</span> <span class="pre">remove</span> <span class="pre">-n</span> <span class="pre">asimtest</span> <span class="pre">--all</span></code> and check the current active environment with
<code class="docutils literal"><span class="pre">conda</span> <span class="pre">info</span> <span class="pre">-e</span></code>.</p>
</div>
<div class="section" id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
<p>ActivitySim depends on the following libraries, some of which* are pre-installed
with Anaconda:</p>
<ul class="simple">
<li><a class="reference external" href="http://numpy.org">numpy</a> &gt;= 1.8.0 *</li>
<li><a class="reference external" href="http://pandas.pydata.org">pandas</a> &gt;= 0.18.0 *</li>
<li><a class="reference external" href="http://pyyaml.org/wiki/PyYAML">pyyaml</a> &gt;= 3.0 *</li>
<li><a class="reference external" href="http://www.pytables.org/moin">tables</a> &gt;= 3.1.0, &lt;3.3.0 *</li>
<li><a class="reference external" href="http://toolz.readthedocs.org/en/latest/">toolz</a> or
<a class="reference external" href="https://github.com/pytoolz/cytoolz">cytoolz</a> &gt;= 0.7 *</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/psutil">psutil</a> &gt;= 4.1</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/zbox">zbox</a> &gt;= 1.2</li>
<li><a class="reference external" href="https://udst.github.io/orca">orca</a> &gt;= 1.1</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/OpenMatrix/0.2.3">openmatrix</a> &gt;= 0.2.2</li>
</ul>
<p>To install the dependencies with conda, first make sure to activate the correct
conda environment and then install each package using <a class="reference external" href="https://pip.pypa.io/en/stable/">pip</a>.  Pip will
attempt to install any dependencies that are not already installed.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#required packages for running ActivitySim</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">cytoolz</span> <span class="n">numpy</span> <span class="n">pandas</span> <span class="n">tables</span> <span class="n">pyyaml</span> <span class="n">psutil</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">orca</span> <span class="n">openmatrix</span> <span class="n">zbox</span>

<span class="c1">#optional required packages for testing and building documentation</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">pytest</span> <span class="n">pytest</span><span class="o">-</span><span class="n">cov</span> <span class="n">coveralls</span> <span class="n">pep8</span> <span class="n">pytest</span><span class="o">-</span><span class="n">xdist</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">sphinx</span> <span class="n">numpydoc</span> <span class="n">sphinx_rtd_theme</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">numexpr</span></code> (which <code class="docutils literal"><span class="pre">numpy</span></code> requires) fails to install, you may need
the <a class="reference external" href="http://aka.ms/vcpython27">Microsoft Visual C++ Compiler for Python</a>.</p>
</div>
<div class="section" id="activitysim">
<h3>ActivitySim<a class="headerlink" href="#activitysim" title="Permalink to this headline">¶</a></h3>
<p>The current <code class="docutils literal"><span class="pre">release</span></code> version of ActivitySim can be installed
from <a class="reference external" href="https://pypi.python.org/pypi/activitysim">PyPI</a>  as well using <a class="reference external" href="https://pip.pypa.io/en/stable/">pip</a>.
The development version can be installed directly from the source.</p>
<div class="section" id="release">
<h4>Release<a class="headerlink" href="#release" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#new install</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">activitysim</span>

<span class="c1">#update to a new release</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">activitysim</span>
</pre></div>
</div>
</div>
<div class="section" id="development">
<h4>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h4>
<p>The development version of ActivitySim can be installed as follows:</p>
<ul class="simple">
<li>Clone or fork the source from the <a class="reference external" href="https://github.com/udst/activitysim">GitHub repository</a></li>
<li>Activate the correct conda environment if needed</li>
<li>Navigate to your local activitysim git directory</li>
<li>Run the command <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></code></li>
</ul>
<p>The <code class="docutils literal"><span class="pre">develop</span></code> command is required in order to make changes to the
source and see the results without reinstalling.  You may need to first uninstall the
the pip installed version before installing the development version from source.  This is
done with <code class="docutils literal"><span class="pre">pip</span> <span class="pre">uninstall</span> <span class="pre">activitysim</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="expressions">
<span id="expressions-in-detail"></span><h2>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h2>
<p>Much of the power of ActivitySim comes from being able to specify Python, pandas, and
numpy expressions for calculations. Refer to the pandas help for a general
introduction to expressions.  ActivitySim provides two ways to evaluate expressions:</p>
<ul class="simple">
<li>Simple table expressions are evaluated using <code class="docutils literal"><span class="pre">DataFrame.eval()</span></code>.  <a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.eval.html">pandas&#8217; eval</a> operates on the current table.</li>
<li>Python expressions, denoted by beginning with the <code class="docutils literal"><span class="pre">&#64;</span></code>, are evaluated with <a class="reference external" href="https://docs.python.org/2/library/functions.html#eval">Python&#8217;s eval()</a>.</li>
</ul>
<div class="section" id="conventions">
<h3>Conventions<a class="headerlink" href="#conventions" title="Permalink to this headline">¶</a></h3>
<p>Here are a few conventions for writing expressions in ActivitySim.</p>
<ul class="simple">
<li>each expression is applied to all rows in the table being operated on</li>
<li>expressions must be vectorized expressions and can use most numpy and pandas expressions</li>
<li>global constants are specified in the settings file</li>
<li>comments are specified with <code class="docutils literal"><span class="pre">#</span></code></li>
<li>you can refer to the current table as <code class="docutils literal"><span class="pre">df</span></code></li>
<li>often an object called <code class="docutils literal"><span class="pre">skims</span></code>, <code class="docutils literal"><span class="pre">skims_od</span></code>, or similar is available and is used to lookup the relevant skim information.  See <a class="reference internal" href="core.html#skims-in-detail"><span class="std std-ref">Skim</span></a> for more information.</li>
<li>when editing the CSV files in Excel, use single quote &#8216; or space at the start of a cell to get Excel to accept the expression</li>
</ul>
</div>
<div class="section" id="example-expressions-file">
<h3>Example Expressions File<a class="headerlink" href="#example-expressions-file" title="Permalink to this headline">¶</a></h3>
<p>An expressions file has the following basic form:</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="36%" />
<col width="13%" />
<col width="12%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Description</th>
<th class="head">Expression</th>
<th class="head">cars0</th>
<th class="head">cars1</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2 Adults (age 16+)</td>
<td>drivers==2</td>
<td>0</td>
<td>3.0773</td>
</tr>
<tr class="row-odd"><td>Persons age 35-34</td>
<td>num_young_adults</td>
<td>0</td>
<td>-0.4849</td>
</tr>
<tr class="row-even"><td>Number of workers, capped at 3</td>
<td>&#64;df.workers.clip(upper=3)</td>
<td>0</td>
<td>0.2936</td>
</tr>
<tr class="row-odd"><td>Distance, from 0 to 1 miles</td>
<td>&#64;skims[&#8216;DIST&#8217;].clip(1)</td>
<td>-3.2451</td>
<td>-0.9523</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Rows are vectorized expressions that will be calculated for every record in the current table</li>
<li>A Description column to describe the expression</li>
<li>An Expression column with a valid vectorized Python/pandas/numpy expression.  In the example above, <code class="docutils literal"><span class="pre">drivers</span></code> is a column in the current table.  Use <code class="docutils literal"><span class="pre">&#64;</span></code> to refer to data outside the current table</li>
<li>A column for each alternative and its relevant coefficient</li>
</ul>
<p>There are some variations on this setup, but the functionality is similar.  For example,
in the destination choice model, the size terms expressions file has market segments as rows and employment type
coefficients as columns.  Broadly speaking, there are currently four types of model expression configurations:</p>
<ul class="simple">
<li>simple choice model - select from a fixed set of choices defined in the specification file, such as the example above</li>
<li>destination choice model - combine the destination choice expressions with the destination choice alternatives files since the alternatives are not listed in the expressions file</li>
<li>complex choice model - an expressions file, a coefficients file, and a YAML settings file with model structural definition.  The mode models are examples of this and are illustrated below</li>
<li>combinatorial choice model - first generate a set of alternatives based on a combination of alternatives across choosers, and then make choices.  The CDAP model implements this approach as illustrated below</li>
</ul>
<p>The <a class="reference internal" href="models.html#mode-choice"><span class="std std-ref">Mode (Tour and Trip)</span></a> model is a complex choice model since the expressions file is structured a little bit differently, as shown below.
Each row is an expression for one alternative and columns are for tour purposes.  The alternatives, as well as template expressions such as
<code class="docutils literal"><span class="pre">$IN_N_OUT_EXPR.format(sk='SOV_TIME')</span></code> are specified in the YAML settings file for the model.  The tour mode choice model is a nested logit (NL) model
and the nesting structure (including nesting coefficients) is specified in the YAML settings file as well.</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="34%" />
<col width="18%" />
<col width="9%" />
<col width="8%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Description</th>
<th class="head">Expression</th>
<th class="head">Alternative</th>
<th class="head">school</th>
<th class="head">shopping</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>DA - Unavailable</td>
<td>sov_available == False</td>
<td>DRIVEALONEFREE</td>
<td>0</td>
<td>3.0773</td>
</tr>
<tr class="row-odd"><td>DA - In-vehicle time</td>
<td>$IN_N_OUT_EXPR.format(sk=&#8217;SOV_TIME&#8217;)</td>
<td>DRIVEALONEFREE</td>
<td>0</td>
<td>-0.4849</td>
</tr>
<tr class="row-even"><td>DAP - Unavailable for age less than 16</td>
<td>age &lt; 16</td>
<td>DRIVEALONEPAY</td>
<td>0</td>
<td>0.2936</td>
</tr>
<tr class="row-odd"><td>DAP - Unavailable for joint tours</td>
<td>is_joint</td>
<td>DRIVEALONEPAY</td>
<td>-3.2451</td>
<td>-0.9523</td>
</tr>
</tbody>
</table>
<p>The <a class="reference internal" href="models.html#cdap"><span class="std std-ref">Coordinated Daily Activity Pattern (CDAP)</span></a> model operates as a series of vectorized table operations:</p>
<ul class="simple">
<li>create a person level table and rank each person in the household for inclusion in the CDAP model</li>
<li>solve individual M/N/H utilities for each person</li>
<li>take as input an interaction coefficients table and then programatically produce and write out the expression files for households size 1, 2, 3, 4, and 5 models independent of one another</li>
<li>select households of size 1, join all required person attributes, and then read and solve the automatically generated expressions</li>
<li>repeat for households size 2, 3, 4, and 5. Each model is independent of one another.</li>
</ul>
<span class="target" id="index-1"></span></div>
</div>
<div class="section" id="example">
<span id="index-2"></span><h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>This section describes how to setup and run the example, as well as how the example works.  The example
is a small subset of households and zones and so it requires less than 1 GB of RAM to run.</p>
<div class="section" id="folder-file-setup">
<h3>Folder/File Setup<a class="headerlink" href="#folder-file-setup" title="Permalink to this headline">¶</a></h3>
<p>The example has the following root folder/file setup:</p>
<blockquote>
<div><ul class="simple">
<li>configs - settings, expressions files, etc.</li>
<li>data - input data such as land use, synthetic population files, and skims</li>
<li>simulation.py - main script to run the model</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Permalink to this headline">¶</a></h3>
<p>In order to run the example, you first need two input files in the <code class="docutils literal"><span class="pre">data</span></code> folder as identified in the <code class="docutils literal"><span class="pre">configs\settings.yaml</span></code> file:</p>
<ul>
<li><p class="first">store: mtc_asim.h5 - an HDF5 file containing the following MTC travel model one tables as pandas DataFrames for a subset of zones:</p>
<blockquote>
<div><ul class="simple">
<li>skims/accessibility - Zone-based accessibility measures</li>
<li>land_use/taz_data - Zone-based land use data (population and employment for example)</li>
<li>persons - Synthetic population person records</li>
<li>households - Synthetic population household records</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">skims_file: skims.omx - an OMX matrix file containing the MTC travel model one skim matrices for a subset of zones.</p>
</li>
</ul>
<p>Both of these files are used in the tests as well and are available here <code class="docutils literal"><span class="pre">activitysim\defaults\test\data</span></code>.  Alternatively,
these files can be downloaded from the <code class="docutils literal"><span class="pre">SF</span> <span class="pre">25</span> <span class="pre">zone</span> <span class="pre">example</span></code> example data folder on
MTC&#8217;s <a class="reference external" href="https://mtcdrive.app.box.com/v/activitysim">box account</a>.  Both files can
be viewed with the <a class="reference external" href="https://github.com/osPlanning/omx/wiki/OMX-Viewer">OMX Viewer</a>.
The pandas DataFrames are stored in an efficient pandas format within the HDF5 file so they are a
bit cumbersome to inspect.</p>
<p>The <code class="docutils literal"><span class="pre">scripts\data_mover.ipynb</span></code> was used to create the mtc_asim.h5 file from the raw CSV files.
This script reads the CSV files, creates DataFrame indexes, and writes the pandas objects to the HDF5
file.</p>
<p>The full set of MTC travel model one OMX skims are also on the box account. The <code class="docutils literal"><span class="pre">scripts\build_omx.py</span></code> script
will build one OMX file containing all the skims. The original MTC travel model one skims were converted from
Cube to OMX using the <a class="reference external" href="https://github.com/osPlanning/omx/wiki/Cube-OMX-Converter">Cube to OMX converter</a>.</p>
<p>Finally, the example inputs were created by the <code class="docutils literal"><span class="pre">scripts\create_sf_example.py</span></code> script,
which creates the land use, synthetic population, and skim inputs for a subset of user-defined zones.</p>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">configs</span></code> folder contains settings, expressions files, and other files required for specifying
model utilities and form.  The first place to start in the <code class="docutils literal"><span class="pre">configs</span></code> folder is <code class="docutils literal"><span class="pre">settings.yaml</span></code>, which
is the main settings file for the model run.  This file includes:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">store</span></code> - HDF5 input file and also output file</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">skims_file</span></code> - skim matrices in one OMX file</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">households_sample_size</span></code> - number of households to sample and simulate; comment out to simulate all households</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">trace_hh_id</span></code> - trace household id; comment out for no trace</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">trace_od</span></code> - trace origin, destination pair in accessibility calculation; comment out for no trace</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">chunk_size</span></code> - batch size for processing choosers</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">check_for_variability</span></code> - disable check for variability in an expression result debugging feature in order to speed-up runtime</p>
</li>
<li><p class="first">global variables that can be used in expressions tables and Python code such as:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">urban_threshold</span></code> - urban threshold area type max value</li>
<li><code class="docutils literal"><span class="pre">county_map</span></code> - mapping of county codes to county names</li>
<li><code class="docutils literal"><span class="pre">time_periods</span></code> - time period upper bound values and labels</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="section" id="logging-files">
<h4>Logging Files<a class="headerlink" href="#logging-files" title="Permalink to this headline">¶</a></h4>
<p>Included in the <code class="docutils literal"><span class="pre">configs</span></code> folder is the <code class="docutils literal"><span class="pre">logging.yaml</span></code>, which configures Python logging
library and defines two key log files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">asim.log</span></code> - overall system log file</li>
<li><code class="docutils literal"><span class="pre">hhtrace.log</span></code> - household trace log file if tracing is on</li>
</ul>
<p>Refer to the <a class="reference internal" href="#tracing"><span class="std std-ref">Tracing</span></a> section for more detail on tracing.</p>
</div>
<div class="section" id="model-specification-files">
<h4>Model Specification Files<a class="headerlink" href="#model-specification-files" title="Permalink to this headline">¶</a></h4>
<p>Included in the <code class="docutils literal"><span class="pre">configs</span></code> folder are the model specification files that store the
Python/pandas/numpy expressions, alternatives, and other settings used by each model.  Some models includes an
alternatives file since the alternatives are not easily described as columns in the expressions file.  An example
of this is the non_mandatory_tour_frequency_alternatives.csv file, which lists each alternative as a row and each
columns indicates the number of non-mandatory tours by purpose.</p>
<p>The current set of files are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">accessibility.csv,</span> <span class="pre">,</span> <span class="pre">accessibility.yaml</span></code> - accessibility model</li>
<li><code class="docutils literal"><span class="pre">auto_ownership.csv,</span> <span class="pre">auto_ownership.yaml</span></code> - auto ownership model</li>
<li><code class="docutils literal"><span class="pre">cdap_indiv_and_hhsize1.csv,</span> <span class="pre">cdap_interaction_coefficients.csv,</span> <span class="pre">cdap_fixed_relative_proportions.csv</span></code> - CDAP model</li>
<li><code class="docutils literal"><span class="pre">destination_choice.csv,</span> <span class="pre">destination_choice_size_terms.csv</span></code> - destination choice model</li>
<li><code class="docutils literal"><span class="pre">mandatory_tour_frequency.csv</span></code> - mandatory tour frequency model</li>
<li><code class="docutils literal"><span class="pre">non_mandatory_tour_frequency.csv,</span> <span class="pre">non_mandatory_tour_frequency_alternatives.csv</span></code> - non mandatory tour frequency model</li>
<li><code class="docutils literal"><span class="pre">school_location.csv</span></code> - school location model</li>
<li><code class="docutils literal"><span class="pre">tour_departure_and_duration_alternatives.csv,</span> <span class="pre">tour_departure_and_duration_nonmandatory.csv,</span> <span class="pre">tour_departure_and_duration_school.csv,</span> <span class="pre">tour_departure_and_duration_work.csv</span></code> - tour departure and duration model</li>
<li><code class="docutils literal"><span class="pre">tour_mode_choice.csv,</span> <span class="pre">tour_mode_choice.yaml,</span> <span class="pre">tour_mode_choice_coeffs.csv</span></code> - tour mode choice model</li>
<li><code class="docutils literal"><span class="pre">trip_mode_choice.csv,</span> <span class="pre">trip_mode_choice.yaml,</span> <span class="pre">trip_mode_choice_coeffs.csv</span></code> - trip mode choice model</li>
<li><code class="docutils literal"><span class="pre">workplace_location.csv</span></code> - work location model</li>
</ul>
</div>
</div>
<div class="section" id="running-the-example-model">
<h3>Running the Example Model<a class="headerlink" href="#running-the-example-model" title="Permalink to this headline">¶</a></h3>
<p>To run the example, do the following:</p>
<ul class="simple">
<li>Open a command line window in the <code class="docutils literal"><span class="pre">example</span></code> folder</li>
<li>Activate the correct conda environment if needed</li>
<li>Run <code class="docutils literal"><span class="pre">python</span> <span class="pre">simulation.py</span></code></li>
<li>ActivitySim will print some logging information and write some outputs to the <code class="docutils literal"><span class="pre">outputs</span></code> folder.</li>
</ul>
<p>The example should complete within a couple minutes since it is running a small sample of households.</p>
</div>
<div class="section" id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">¶</a></h3>
<p>ActivitySim writes log and trace files to the <code class="docutils literal"><span class="pre">outputs</span></code> folder.  The asim.log file, which
is the overall log file is always produced.  If tracing is specified, then trace files are output
as well.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently the example produces no standard outputs, such as trip lists.  The next
phase of development will address creating and writing of outputs.  In the
meantime, the example writes the in-memory households table to a CSV file
for illustrative purposes.</p>
</div>
</div>
<div class="section" id="tracing">
<span id="id2"></span><h3>Tracing<a class="headerlink" href="#tracing" title="Permalink to this headline">¶</a></h3>
<p>There are two types of tracing in ActivtiySim: household and OD pair.  If a household trace ID
is specified, then ActivitySim will output a comprehensive set of trace files for all
calculations for all household members:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">hhtrace.log</span></code> - household trace log file, which specifies the CSV files traced. The order of output files is consistent with the model sequence.</li>
<li><code class="docutils literal"><span class="pre">various</span> <span class="pre">CSV</span> <span class="pre">files</span></code> - every input, intermediate, and output data table - chooser, expressions/utilities, probabilities, choices, etc. - for the trace household for every sub-model</li>
</ul>
<p>If an OD pair trace is specified, then ActivitySim will output the acessibility calculations trace
file:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">accessibility.result.csv</span></code> - accessibility expression results for the OD pair</li>
</ul>
<p>With the set of output CSV files, the user can trace ActivitySim&#8217;s calculations in order to ensure they are correct and/or to
help debug data and/or logic errors.</p>
</div>
</div>
<div class="section" id="how-the-system-works">
<span id="id3"></span><h2>How the System Works<a class="headerlink" href="#how-the-system-works" title="Permalink to this headline">¶</a></h2>
<p>This section describes ActivitySim&#8217;s flow of execution.</p>
<div class="section" id="the-basic-flow-of-execution">
<h3>The Basic Flow of Execution<a class="headerlink" href="#the-basic-flow-of-execution" title="Permalink to this headline">¶</a></h3>
<p>The example model run starts by running <code class="docutils literal"><span class="pre">simulation.py</span></code>, which calls:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">orca</span>
<span class="kn">from</span> <span class="nn">activitysim</span> <span class="k">import</span> <span class="n">defaults</span>
</pre></div>
</div>
<p>which starts orca, which will now take over running the system and defines the orca/pandas tables and their data sources
but does not load the data.  The second statement loads <code class="docutils literal"><span class="pre">defaults.__init__</span></code>, which calls:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">misc</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">import</span> <span class="nn">models</span>
</pre></div>
</div>
<p>which then loads the misc, tables, and models class definitions.  Loading <code class="docutils literal"><span class="pre">misc</span></code> defines orca injectables (functions)
for the <code class="docutils literal"><span class="pre">settings</span></code> object based on the setting.yaml file and the <code class="docutils literal"><span class="pre">store</span></code> based on the HDF5 input file.  The
Python decorator <code class="docutils literal"><span class="pre">&#64;orca.injectable</span></code> overrides the function definition <code class="docutils literal"><span class="pre">store</span></code> to execute this function
whenever <code class="docutils literal"><span class="pre">store</span></code> is called by orca.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nd">@orca</span><span class="o">.</span><span class="n">injectable</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, the following import statement define the dynamic orca tables households, persons, skims, etc., but does not load them.
It also defines the dynamic orca table columns (calculated fields) and injectables (functions) defined in the classes.  The
Python decorator <code class="docutils literal"><span class="pre">&#64;orca.table</span></code> and <code class="docutils literal"><span class="pre">&#64;orca.column(&quot;households&quot;)</span></code> override the function definitions so the function name
becomes the table name in the first case, whereas the function name becomes the column in the second case.  The argument to
<code class="docutils literal"><span class="pre">households</span></code> in <code class="docutils literal"><span class="pre">&#64;orca.column(&quot;households&quot;)</span></code> is table (either real or virtual) that the column is added to.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">households</span>
<span class="kn">import</span> <span class="nn">persons</span>
<span class="kn">import</span> <span class="nn">skims</span>
<span class="c1">#etc...</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">households</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;households&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">income_in_thousands</span><span class="p">(</span><span class="n">households</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">households</span><span class="o">.</span><span class="n">income</span> <span class="o">/</span> <span class="mi">1000</span>
</pre></div>
</div>
<p>The first microsimulation model run is school location, which is called via the following command.  The <code class="docutils literal"><span class="pre">&#64;orca.step()</span></code> decorator registers
the function as runnable by orca.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">orca</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;school_location_simulate&quot;</span><span class="p">])</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">school_location_simulate</span><span class="p">(</span>
  <span class="n">persons_merged</span><span class="p">,</span>
  <span class="n">school_location_spec</span><span class="p">,</span> <span class="n">school_location_settings</span><span class="p">,</span>
  <span class="n">skims</span><span class="p">,</span>
  <span class="n">destination_size_terms</span><span class="p">,</span>
  <span class="n">chunk_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">):</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">school_location_simulate</span></code> step requires the objects defined in the function definition above.  Since they are not yet loaded,
orca goes looking for them.  This is called lazy loading (or on-demand loading).  The steps to get the persons data loaded is illustrated below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#persons_merged is in the step function signature</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">persons_merged</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">land_use</span><span class="p">,</span> <span class="n">accessibility</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">orca</span><span class="o">.</span><span class="n">merge_tables</span><span class="p">(</span><span class="n">persons</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span>
      <span class="n">persons</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">land_use</span><span class="p">,</span> <span class="n">accessibility</span><span class="p">])</span>

<span class="c1">#it required persons, households, land_use, accessibility</span>
<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">persons</span><span class="p">(</span><span class="n">persons_internal</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">persons_internal</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

<span class="c1">#persons requires persons_internal</span>
<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">persons_internal</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">households</span><span class="p">):</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s2">&quot;persons&quot;</span><span class="p">]</span>
  <span class="k">if</span> <span class="s2">&quot;households_sample_size&quot;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
      <span class="c1"># keep all persons in the sampled households</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">household_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">households</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">df</span>

<span class="c1">#persons_internal requires store, settings, households</span>
<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">households</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">households_sample_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">):</span>

  <span class="n">df_full</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s2">&quot;households&quot;</span><span class="p">]</span>

  <span class="c1"># if we are tracing hh exclusively</span>
  <span class="k">if</span> <span class="n">trace_hh_id</span> <span class="ow">and</span> <span class="n">households_sample_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="c1"># if we need sample a subset of full store</span>
  <span class="k">elif</span> <span class="n">households_sample_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_full</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">households_sample_size</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">df_full</span>

  <span class="k">if</span> <span class="n">trace_hh_id</span><span class="p">:</span>
      <span class="n">tracing</span><span class="o">.</span><span class="n">register_households</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">)</span>
      <span class="n">tracing</span><span class="o">.</span><span class="n">trace_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;households&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">df</span>

<span class="c1">#households calls asim.random_rows to read a sample of households records</span>
<span class="c1">#households calls tracing.register_households to setup tracing</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">school_location_simulate</span></code> also reads the expressions specification file, settings yaml file,
destination_size_terms file, sets the persons merged table as choosers, and sets the chunk size, trace id, and random seed.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">school_location_simulate</span><span class="p">(</span>
  <span class="n">persons_merged</span><span class="p">,</span>
  <span class="n">school_location_spec</span><span class="p">,</span> <span class="n">school_location_settings</span><span class="p">,</span>
  <span class="n">skims</span><span class="p">,</span>
  <span class="n">destination_size_terms</span><span class="p">,</span>
  <span class="n">chunk_size</span><span class="p">,</span> <span class="n">trace_hh_id</span><span class="p">):</span>
</pre></div>
</div>
<p>Next the method sets up the skims required for this model.
The following code set the keys for looking up the skim values for this model. In this case there is a <code class="docutils literal"><span class="pre">TAZ</span></code> column in the choosers,
which was in the <code class="docutils literal"><span class="pre">households</span></code> table that was joined with <code class="docutils literal"><span class="pre">persons</span></code> to make <code class="docutils literal"><span class="pre">persons_merged</span></code> and a <code class="docutils literal"><span class="pre">TAZ</span></code> in the alternatives
generation code which get merged during interaction as renamed <code class="docutils literal"><span class="pre">TAZ_r</span></code>.  The skims are lazy loaded under the name
&#8220;skims&#8221; and are available in the expressions using <code class="docutils literal"><span class="pre">&#64;skims</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">skims</span><span class="o">.</span><span class="n">set_keys</span><span class="p">(</span><span class="s2">&quot;TAZ&quot;</span><span class="p">,</span> <span class="s2">&quot;TAZ_r&quot;</span><span class="p">)</span>
<span class="n">locals_d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;skims&quot;</span><span class="p">:</span> <span class="n">skims</span><span class="p">}</span>
</pre></div>
</div>
<p>The next step is to call <code class="docutils literal"><span class="pre">asim.interaction_simulate</span></code> function which run a MNL choice model simulation in which alternatives
must be merged with choosers because there are interaction terms or because alternatives are sampled.  The choosers table, the
alternatives table, the model specification expressions file, the skims, and the sample size are all passed in.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">asim</span><span class="o">.</span><span class="n">interaction_simulate</span><span class="p">(</span><span class="n">choosers_segment</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">,</span> <span class="n">spec</span><span class="p">[[</span><span class="n">school_type</span><span class="p">]],</span>
  <span class="n">skims</span><span class="o">=</span><span class="n">skims</span><span class="p">,</span> <span class="n">locals_d</span><span class="o">=</span><span class="n">locals_d</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trace_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trace_choice_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>This function solves the utilities, calculates probabilities, draws random numbers, selects choices, and returns a column of choices.
This is done in a for loop of chunks of choosers in order to avoid running out of RAM when building the often large data tables.
The <code class="docutils literal"><span class="pre">eval_variables</span></code> loops through each expression and solves it at once for all records in the chunked chooser table using
either pandas&#8217; eval() or Python&#8217;s eval().</p>
<p>The <code class="docutils literal"><span class="pre">asim.interaction_simulate</span></code> method is currently only a multinomial logit choice model.  The <code class="docutils literal"><span class="pre">asim.simple_simulate</span></code> method
supports both MNL and NL as specified by the <code class="docutils literal"><span class="pre">LOGIT_TYPE</span></code> setting in the model settings YAML file.   The <code class="docutils literal"><span class="pre">auto_ownership.yaml</span></code>
file for example specifies the <code class="docutils literal"><span class="pre">LOGIT_TYPE</span></code> as <code class="docutils literal"><span class="pre">MNL.</span></code></p>
<p>If the expression is a skim matrix, then the entire column of chooser OD pairs is retrieved from the matrix (i.e. numpy array)
in one vectorized step.  The <code class="docutils literal"><span class="pre">orig</span></code> and <code class="docutils literal"><span class="pre">dest</span></code> objects in <code class="docutils literal"><span class="pre">self.data[orig,</span> <span class="pre">dest]</span></code> in <code class="docutils literal"><span class="pre">activitysim.skim.py</span></code> are vectors
and selecting numpy array items with vector indexes returns a vector.  Trace data is also written out if configured.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># evaluate variables from the spec</span>
<span class="n">model_design</span> <span class="o">=</span> <span class="n">eval_variables</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">choosers</span><span class="p">,</span> <span class="n">locals_d</span><span class="p">)</span>

<span class="c1"># multiply by coefficients and reshape into choosers by alts</span>
<span class="n">utilities</span> <span class="o">=</span> <span class="n">model_design</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

<span class="c1"># convert to probabilities and make choices</span>
<span class="n">probs</span> <span class="o">=</span> <span class="n">utils_to_probs</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span>
<span class="n">choices</span> <span class="o">=</span> <span class="n">make_choices</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>

<span class="c1">#write trace information</span>
<span class="k">if</span> <span class="n">trace_label</span><span class="p">:</span>
    <span class="c1">#write trace information</span>

<span class="c1">#return choices</span>
<span class="k">return</span> <span class="n">choices</span>
</pre></div>
</div>
<p>Finally, the model adds the choices as a column to the applicable table - <code class="docutils literal"><span class="pre">persons</span></code> - and adds
additional dependent columns.  The dependent columns are those orca columns with the virtual table
name <code class="docutils literal"><span class="pre">persons_school</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">orca</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;persons&quot;</span><span class="p">,</span> <span class="s2">&quot;school_taz&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
<span class="n">add_dependent_columns</span><span class="p">(</span><span class="s2">&quot;persons&quot;</span><span class="p">,</span> <span class="s2">&quot;persons_school&quot;</span><span class="p">)</span>

<span class="c1"># columns to update after the school location choice model</span>
<span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">persons_school</span><span class="p">(</span><span class="n">persons</span><span class="p">):</span>
 <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">persons</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;persons_school&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">distance_to_school</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">skim_dict</span><span class="p">):</span>
    <span class="n">distance_skim</span> <span class="o">=</span> <span class="n">skim_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DIST&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">distance_skim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">persons</span><span class="o">.</span><span class="n">home_taz</span><span class="p">,</span>
                                       <span class="n">persons</span><span class="o">.</span><span class="n">school_taz</span><span class="p">),</span>
                     <span class="n">index</span><span class="o">=</span><span class="n">persons</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="nd">@orca</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;persons_school&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">roundtrip_auto_time_to_school</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">skim_dict</span><span class="p">):</span>
    <span class="n">sovmd_skim</span> <span class="o">=</span> <span class="n">skim_dict</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;SOV_TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;MD&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sovmd_skim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">persons</span><span class="o">.</span><span class="n">home_taz</span><span class="p">,</span>
                                    <span class="n">persons</span><span class="o">.</span><span class="n">school_taz</span><span class="p">)</span> <span class="o">+</span>
                     <span class="n">sovmd_skim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">persons</span><span class="o">.</span><span class="n">school_taz</span><span class="p">,</span>
                                    <span class="n">persons</span><span class="o">.</span><span class="n">home_taz</span><span class="p">),</span>
                     <span class="n">index</span><span class="o">=</span><span class="n">persons</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
<p>Any orca columns that are required are calculated-on-the-fly, such as <code class="docutils literal"><span class="pre">roundtrip_auto_time_to_school</span></code>
which i turn uses skims from the skim_dict orca injectable.</p>
<p>The rest of the microsimulation models operate in a similar fashion with a few notable additions:</p>
<ul class="simple">
<li>creating new tables</li>
<li>using 3D skims instead of skims (which is 2D)</li>
<li>accessibilities</li>
</ul>
</div>
<div class="section" id="creating-new-tables">
<h3>Creating New Tables<a class="headerlink" href="#creating-new-tables" title="Permalink to this headline">¶</a></h3>
<p>The mandatory tour frequency model sets the <code class="docutils literal"><span class="pre">persons.mandatory_tour_frequency</span></code> column.  Once the number of tours
is known, then the next step is to create tours records for subsequent models.  This is done with the following code,
which requires the <code class="docutils literal"><span class="pre">persons</span></code> table and returns a new pandas DataFrame which is registered as an
orca table named <code class="docutils literal"><span class="pre">mandatory_tours</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nd">@orca</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mandatory_tours</span><span class="p">(</span><span class="n">persons</span><span class="p">):</span>
  <span class="n">persons</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mandatory_tour_frequency&quot;</span><span class="p">,</span><span class="s2">&quot;is_worker&quot;</span><span class="p">])</span>
  <span class="n">persons</span> <span class="o">=</span> <span class="n">persons</span><span class="p">[</span><span class="o">~</span><span class="n">persons</span><span class="o">.</span><span class="n">mandatory_tour_frequency</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
  <span class="k">return</span> <span class="n">process_mandatory_tours</span><span class="p">(</span><span class="n">persons</span><span class="p">)</span>

<span class="c1">#processes the mandatory_tour_frequency column that comes out of the model</span>
<span class="c1">#and turns into a DataFrame that represents the mandatory tours that were generated</span>
<span class="k">def</span> <span class="nf">process_mandatory_tours</span><span class="p">(</span><span class="n">persons</span><span class="p">):</span>
  <span class="c1">#...</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tours</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tour_type&quot;</span><span class="p">,</span> <span class="s2">&quot;tour_num&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="skims3dwrapper">
<span id="skims-3d"></span><h3>Skims3dWrapper<a class="headerlink" href="#skims3dwrapper" title="Permalink to this headline">¶</a></h3>
<p>The mode choice model uses the Skims3dWrapper class in addition to the skims (2D) class.  The Skims3dWrapper class represents
a collection of skims with a third dimension, which in this case in time period.  Setting up the 3D index for
Skims3dWrapper is done as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#setup two indexes - tour inbound skims and tour outbound skims</span>
<span class="n">in_skims</span> <span class="o">=</span> <span class="n">askim</span><span class="o">.</span><span class="n">Skims3dWrapper</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">left_key</span><span class="o">=</span><span class="n">orig_key</span><span class="p">,</span> <span class="n">right_key</span><span class="o">=</span><span class="n">dest_key</span><span class="p">,</span> <span class="n">skim_key</span><span class="o">=</span><span class="s2">&quot;in_period&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">out_skims</span> <span class="o">=</span> <span class="n">askim</span><span class="o">.</span><span class="n">Skims3dWrapper</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">left_key</span><span class="o">=</span><span class="n">dest_key</span><span class="p">,</span> <span class="n">right_key</span><span class="o">=</span><span class="n">orig_key</span><span class="p">,</span> <span class="n">skim_key</span><span class="o">=</span><span class="s2">&quot;out_period&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#where:</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">askim</span><span class="o">.</span><span class="n">SkimStack</span><span class="p">(</span><span class="n">skims</span><span class="p">)</span>       <span class="c1">#build 3D skim object from 2D skims table object</span>
<span class="n">orig_key</span> <span class="o">=</span> <span class="s1">&#39;TAZ&#39;</span>                     <span class="c1">#TAZ column</span>
<span class="n">dest_key</span> <span class="o">=</span> <span class="s1">&#39;destination&#39;</span>             <span class="c1">#destination column</span>
<span class="n">skim_key</span><span class="o">=</span><span class="s2">&quot;in_period&quot;</span> <span class="ow">or</span> <span class="s2">&quot;out_period&quot;</span> <span class="c1">#in_period or out_period column</span>
</pre></div>
</div>
<p>When model expressions such as <code class="docutils literal"><span class="pre">&#64;in_skims['WLK_LOC_WLK_TOTIVT']</span></code> are solved,
the <code class="docutils literal"><span class="pre">WLK_LOC_WLK_TOTIVT</span></code> skim matrix values for all chooser table origins, destinations, and
in_periods can be retrieved in one request.</p>
<p>Depending on the settings, Skims3D can either get the requested OMX data from disk every time
a vectorized request is made or preload (cache) all the skims at the beginning of a model run.
Preload is faster and is the default.</p>
<p>See <a class="reference internal" href="core.html#skims-in-detail"><span class="std std-ref">Skim</span></a> for more information on skim handling.</p>
</div>
<div class="section" id="accessibilities">
<h3>Accessibilities<a class="headerlink" href="#accessibilities" title="Permalink to this headline">¶</a></h3>
<p>Unlike the microsimulation models, which operate on a table of choosers, the accessibilities model is
an aggregate model that calculates accessibility measures by origin zone to all destination zones.  This
model could be implemented with a matrix library such as <code class="docutils literal"><span class="pre">numpy</span></code> since it involves a series of matrix
and vector operations.  However, all the other ActivitySim models - the
microsimulation models - are implemented with <code class="docutils literal"><span class="pre">pandas.DataFrame</span></code> tables, and so this would be a
different approach for just this model.  The benefits of keeping with the same table approach to
data setup, expression management, and solving means ActivitySim has one expression syntax, is
easier to understand and document, and is more efficiently implemented.</p>
<p>As illustrated below, in order to convert the
accessibility calculation into a table operation, a table of OD pairs is first built using <code class="docutils literal"><span class="pre">numpy</span></code>
<code class="docutils literal"><span class="pre">repeat</span></code> and <code class="docutils literal"><span class="pre">tile</span></code> functions.  Once constructed, the additional data columns are added to the
table in order to solve the accessibility calculations.  The <code class="docutils literal"><span class="pre">skim</span></code> data is also added in column form.
After solving the expressions for each OD pair row, the accessibility module aggregates the results
to origin zone and write them to the datastore.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># create OD dataframe</span>
  <span class="n">od_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
      <span class="n">data</span><span class="o">=</span><span class="p">{</span>
          <span class="s1">&#39;orig&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">land_use_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">zone_count</span><span class="p">),</span>
          <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">land_use_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">zone_count</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dataschema.html" class="btn btn-neutral float-right" title="Data Schema" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="ActivitySim" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright contributing authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>