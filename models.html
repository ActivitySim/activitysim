

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Models &mdash; ActivitySim 0.9.9 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Core Components" href="core.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> ActivitySim
          

          
          </a>

          
            
            
              <div class="version">
                0.9.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#initialize">Initialize</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialize-tvpb">Initialize LOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessibility">Accessibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#work-location">School Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">Work Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shadow-pricing">Shadow Pricing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auto-ownership">Auto Ownership</a></li>
<li class="toctree-l2"><a class="reference internal" href="#free-parking-eligibility">Free Parking Eligibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#work-from-home">Work From Home</a></li>
<li class="toctree-l2"><a class="reference internal" href="#telecommute-frequency">Telecommute Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coordinated-daily-activity-pattern">Coordinated Daily Activity Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mandatory-tour-frequency">Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#representative-logsums">Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joint-tour-frequency">Joint Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joint-tour-composition">Joint Tour Composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joint-tour-participation">Joint Tour Participation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joint-tour-destination-choice">Joint Tour Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joint-tour-scheduling">Joint Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-frequency">Non-Mandatory Tour Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-destination-choice">Non-Mandatory Tour Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-scheduling">Non-Mandatory Tour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tour-mode-choice">Tour Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtours-frequency">At-work Subtours Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtours-destination-choice">At-work Subtours Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtour-scheduling">At-work Subtour Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtour-mode">At-work Subtour Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#intermediate-stop-frequency">Intermediate Stop Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-purpose">Trip Purpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-destination-choice">Trip Destination Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-purpose-and-destination">Trip Purpose and Destination</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-scheduling-probablistic">Trip Scheduling (Probablistic)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-scheduling-choice-logit-choice">Trip Scheduling Choice (Logit Choice)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-departure-choice-logit-choice">Trip Departure Choice (Logit Choice)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trip-mode-choice">Trip Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parking-location-choice">Parking Location Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#write-trip-matrices">Write Trip Matrices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#util">Util</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id28">CDAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#estimation">Estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.logsums">Logsums</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.mode">Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.overlap">Overlap</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.tour_destination">Tour Destination</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.tour_frequency">Tour Frequency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.trip">Trip</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.util.vectorize_tour_scheduling">Vectorize Tour Scheduling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tests">Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="core.html">Core Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="estimation.html">Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="howitworks.html">How the System Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Software Development</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ActivitySim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/models.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="models">
<span id="index-0"></span><span id="id1"></span><h1>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h1>
<p>The currently implemented example ActivitySim AB models are described below.  See the example
model <a class="reference internal" href="examples.html#sub-model-spec-files"><span class="std std-ref">Sub-Model Specification Files</span></a>, <a class="reference internal" href="examples.html#arc-sub-model-spec-files"><span class="std std-ref">Example ARC Sub-Model Specification Files</span></a>, and <a class="reference internal" href="examples.html#semcog-sub-model-spec-files"><span class="std std-ref">Example SEMCOG Sub-Model Specification Files</span></a> for more information.</p>
<div class="section" id="initialize">
<span id="initialize-tours"></span><span id="initialize-households"></span><span id="initialize-landuse"></span><h2>Initialize<a class="headerlink" href="#initialize" title="Permalink to this headline">¶</a></h2>
<p>The initialize model isn’t really a model, but rather a few data processing steps in the data pipeline.
The initialize data processing steps code variables used in downstream models, such as household and person
value-of-time.  This step also pre-loads the land_use, households, persons, and person_windows tables because
random seeds are set differently for each step and therefore the sampling of households depends on which step
they are initially loaded in.</p>
<p>The main interface to the initialize land use step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_landuse()</span></code>
function. The main interface to the initialize household step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_households()</span></code>
function.  The main interface to the initialize tours step is the <code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_tours()</span></code>
function.  These functions are registered as orca steps in the example Pipeline.</p>
<span class="target" id="module-activitysim.abm.models.initialize"></span><dl class="py function">
<dt id="activitysim.abm.models.initialize.preload_injectables">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize.</span></code><code class="sig-name descname"><span class="pre">preload_injectables</span></code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize.preload_injectables" title="Permalink to this definition">¶</a></dt>
<dd><p>preload bulky injectables up front - stuff that isn’t inserted into the pipeline</p>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.initialize_tours"></span></div>
<div class="section" id="initialize-tvpb">
<span id="initialize-los"></span><span id="id2"></span><h2>Initialize LOS<a class="headerlink" href="#initialize-tvpb" title="Permalink to this headline">¶</a></h2>
<p>The initialize LOS model isn’t really a model, but rather a series of data processing steps in the data pipeline.
The initialize LOS model does two things:</p>
<blockquote>
<div><ul class="simple">
<li><p>Loads skims and cache for later if desired</p></li>
<li><p>Loads network LOS inputs for transit virtual path building (see <a class="reference internal" href="core.html#transit-virtual-path-builder"><span class="std std-ref">Transit Virtual Path Builder</span></a>), pre-computes tap-to-tap total utilities and cache for later if desired</p></li>
</ul>
</div></blockquote>
<p>The main interface to the initialize LOS step is the <a class="reference internal" href="#activitysim.abm.models.initialize_los.initialize_los" title="activitysim.abm.models.initialize_los.initialize_los"><code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_los()</span></code></a>
function.  The main interface to the initialize TVPB step is the <a class="reference internal" href="#activitysim.abm.models.initialize_los.initialize_tvpb" title="activitysim.abm.models.initialize_los.initialize_tvpb"><code class="xref py py-func docutils literal notranslate"><span class="pre">initialize_tvpb()</span></code></a>
function.  These functions are registered as orca steps in the example Pipeline.</p>
<span class="target" id="module-activitysim.abm.models.initialize_los"></span><dl class="py function">
<dt id="activitysim.abm.models.initialize_los.initialize_los">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize_los.</span></code><code class="sig-name descname"><span class="pre">initialize_los</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize_los.initialize_los" title="Permalink to this definition">¶</a></dt>
<dd><p>Currently, this step is only needed for THREE_ZONE systems in which the tap_tap_utilities are precomputed
in the (presumably subsequent) initialize_tvpb step.</p>
<p>Adds attribute_combinations_df table to the pipeline so that it can be used to as the slicer
for multiprocessing the initialize_tvpb s.tep</p>
<p>FIXME - this step is only strictly necessary when multiprocessing, but initialize_tvpb would need to be tweaked
FIXME - to instantiate attribute_combinations_df if the pipeline table version were not available.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.initialize_los.initialize_tvpb">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize_los.</span></code><code class="sig-name descname"><span class="pre">initialize_tvpb</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">attribute_combinations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize_los.initialize_tvpb" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize STATIC tap_tap_utility cache and write mmap to disk.</p>
<p>uses pipeline attribute_combinations table created in initialize_los to determine which attribute tuples
to compute utilities for.</p>
<p>if we are single-processing, this will be the entire set of attribute tuples required to fully populate cache</p>
<p>if we are multiprocessing, then the attribute_combinations will have been sliced and we compute only a subset
of the tuples (and the other processes will compute the rest). All process wait until the cache is fully
populated before returning, and the locutor process writes the results.</p>
<p>FIXME - if we did not close this, we could avoid having to reload it from mmap when single-process?</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.initialize_los.initialize_tvpb_calc_row_size">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.initialize_los.</span></code><code class="sig-name descname"><span class="pre">initialize_tvpb_calc_row_size</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize_los.initialize_tvpb_calc_row_size" title="Permalink to this definition">¶</a></dt>
<dd><p>rows_per_chunk calculator for trip_purpose</p>
</dd></dl>

</div>
<div class="section" id="accessibility">
<span id="id3"></span><h2>Accessibility<a class="headerlink" href="#accessibility" title="Permalink to this headline">¶</a></h2>
<p>The accessibilities model is an aggregate model that calculates multiple origin-based accessibility
measures by origin zone to all destination zones.</p>
<p>The accessibility measure first multiplies an employment variable by a mode-specific decay function.  The
product reflects the difficulty of accessing the activities the farther (in terms of round-trip travel time)
the jobs are from the location in question. The products to each destination zone are next summed over
each origin zone, and the logarithm of the product mutes large differences.  The decay function on
the walk accessibility measure is steeper than automobile or transit.  The minimum accessibility is zero.</p>
<p>Level-of-service variables from three time periods are used, specifically the AM peak period (6 am to 10 am), the
midday period (10 am to 3 pm), and the PM peak period (3 pm to 7 pm).</p>
<p><em>Inputs</em></p>
<ul class="simple">
<li><p>Highway skims for the three periods.  Each skim is expected to include a table named “TOLLTIMEDA”, which is the drive alone in-vehicle travel time for automobiles willing to pay a “value” (time-savings) toll.</p></li>
<li><p>Transit skims for the three periods.  Each skim is expected to include the following tables: (i) “IVT”, in-vehicle time; (ii) “IWAIT”, initial wait time; (iii) “XWAIT”, transfer wait time; (iv) “WACC”, walk access time; (v) “WAUX”, auxiliary walk time; and, (vi) “WEGR”, walk egress time.</p></li>
<li><p>Zonal data with the following fields: (i) “TOTEMP”, total employment; (ii) “RETEMPN”, retail trade employment per the NAICS classification.</p></li>
</ul>
<p><em>Outputs</em></p>
<ul class="simple">
<li><p>taz, travel analysis zone number</p></li>
<li><p>autoPeakRetail, the accessibility by automobile during peak conditions to retail employment for this TAZ</p></li>
<li><p>autoPeakTotal, the accessibility by automobile during peak conditions to all employment</p></li>
<li><p>autoOffPeakRetail, the accessibility by automobile during off-peak conditions to retail employment</p></li>
<li><p>autoOffPeakTotal, the accessibility by automobile during off-peak conditions to all employment</p></li>
<li><p>transitPeakRetail, the accessibility by transit during peak conditions to retail employment</p></li>
<li><p>transitPeakTotal, the accessibility by transit during peak conditions to all employment</p></li>
<li><p>transitOffPeakRetail, the accessiblity by transit during off-peak conditions to retail employment</p></li>
<li><p>transitOffPeakTotal, the accessiblity by transit during off-peak conditions to all employment</p></li>
<li><p>nonMotorizedRetail, the accessibility by walking during all time periods to retail employment</p></li>
<li><p>nonMotorizedTotal, the accessibility by walking during all time periods to all employment</p></li>
</ul>
<p>The main interface to the accessibility model is the
<a class="reference internal" href="#activitysim.abm.models.accessibility.compute_accessibility" title="activitysim.abm.models.accessibility.compute_accessibility"><code class="xref py py-func docutils literal notranslate"><span class="pre">compute_accessibility()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">skims</span></code> | Result Table: <code class="docutils literal notranslate"><span class="pre">accessibility</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">O-D,</span> <span class="pre">D-O</span></code></p>
<span class="target" id="module-activitysim.abm.models.accessibility"></span><dl class="py function">
<dt id="activitysim.abm.models.accessibility.accessibility_calc_row_size">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.accessibility.</span></code><code class="sig-name descname"><span class="pre">accessibility_calc_row_size</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">accessibility_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">land_use_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">assignment_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.accessibility.accessibility_calc_row_size" title="Permalink to this definition">¶</a></dt>
<dd><p>rows_per_chunk calculator for accessibility</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.accessibility.compute_accessibility">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.accessibility.</span></code><code class="sig-name descname"><span class="pre">compute_accessibility</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">land_use</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">accessibility</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_od</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.accessibility.compute_accessibility" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute accessibility for each zone in land use file using expressions from accessibility_spec</p>
<p>The actual results depend on the expressions in accessibility_spec, but this is initially
intended to permit implementation of the mtc accessibility calculation as implemented by
Accessibility.job</p>
<p>Compute measures of accessibility used by the automobile ownership model.
The accessibility measure first multiplies an employment variable by a mode-specific decay
function.  The product reflects the difficulty of accessing the activities the farther
(in terms of round-trip travel time) the jobs are from the location in question. The products
to each destination zone are next summed over each origin zone, and the logarithm of the
product mutes large differences.  The decay function on the walk accessibility measure is
steeper than automobile or transit.  The minimum accessibility is zero.</p>
</dd></dl>

</div>
<div class="section" id="work-location">
<span id="school-location"></span><span id="id4"></span><h2>School Location<a class="headerlink" href="#work-location" title="Permalink to this headline">¶</a></h2>
<p>The usual school location choice models assign a usual school location for the primary
mandatory activity of each child and university student in the
synthetic population. The models are composed of a set of accessibility-based parameters
(including one-way distance between home and primary destination and the tour mode choice
logsum - the expected maximum utility in the mode choice model which is given by the
logarithm of the sum of exponentials in the denominator of the logit formula) and size terms,
which describe the quantity of grade-school or university opportunities in each possible
destination.</p>
<dl class="simple">
<dt>The school location model is made up of four steps:</dt><dd><ul class="simple">
<li><p>sampling - selects a sample of alternative school locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative school location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final school location, this time with the mode choice logsum included.</p></li>
<li><p>shadow prices - compare modeled zonal destinations to target zonal size terms and calculate updated shadow prices.</p></li>
</ul>
</dd>
</dl>
<p>These steps are repeated until shadow pricing convergence criteria are satisfied or a max number of iterations is reached.  See <a class="reference internal" href="#shadow-pricing"><span class="std std-ref">Shadow Pricing</span></a>.</p>
<p>School location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interfaces to the model is the <a class="reference internal" href="#activitysim.abm.models.location_choice.school_location" title="activitysim.abm.models.location_choice.school_location"><code class="xref py py-func docutils literal notranslate"><span class="pre">school_location()</span></code></a> function.
This function is registered as an orca step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">school_taz</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">AM</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
</div>
<div class="section" id="id5">
<h2>Work Location<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>The usual work location choice models assign a usual work location for the primary
mandatory activity of each employed person in the
synthetic population. The models are composed of a set of accessibility-based parameters
(including one-way distance between home and primary destination and the tour mode choice
logsum - the expected maximum utility in the mode choice model which is given by the
logarithm of the sum of exponentials in the denominator of the logit formula) and size terms,
which describe the quantity of work opportunities in each possible destination.</p>
<dl class="simple">
<dt>The work location model is made up of four steps:</dt><dd><ul class="simple">
<li><p>sample - selects a sample of alternative work locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative work location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final work location, this time with the mode choice logsum included.</p></li>
<li><p>shadow prices - compare modeled zonal destinations to target zonal size terms and calculate updated shadow prices.</p></li>
</ul>
</dd>
</dl>
<p>These steps are repeated until shadow pricing convergence criteria are satisfied or a max number of iterations is reached.  See <a class="reference internal" href="#shadow-pricing"><span class="std std-ref">Shadow Pricing</span></a>.</p>
<p>Work location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interfaces to the model is the <a class="reference internal" href="#activitysim.abm.models.location_choice.workplace_location" title="activitysim.abm.models.location_choice.workplace_location"><code class="xref py py-func docutils literal notranslate"><span class="pre">workplace_location()</span></code></a> function.
This function is registered as an orca step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">workplace_taz</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">AM</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">PM</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.location_choice"></span><dl class="py function">
<dt id="activitysim.abm.models.location_choice.iterate_location_choice">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">iterate_location_choice</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.iterate_location_choice" title="Permalink to this definition">¶</a></dt>
<dd><p>iterate run_location_choice updating shadow pricing until convergence criteria satisfied
or max_iterations reached.</p>
<p>(If use_shadow_pricing not enabled, then just iterate once)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>persons_merged</strong><span class="classifier">injected table</span></dt><dd></dd>
<dt><strong>persons</strong><span class="classifier">injected table</span></dt><dd></dd>
<dt><strong>network_los</strong><span class="classifier">los.Network_LOS</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>locutor</strong><span class="classifier">bool</span></dt><dd><p>whether this process is the privileged logger of shadow_pricing when multiprocessing</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>adds choice column model_settings[‘DEST_CHOICE_COLUMN_NAME’]</dt><dd></dd>
<dt>adds logsum column model_settings[‘DEST_CHOICE_LOGSUM_COLUMN_NAME’]- if provided</dt><dd></dd>
<dt>adds annotations to persons table</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.run_location_choice">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">run_location_choice</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shadow_price_calculator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_sample_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_choice" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the three-part location choice algorithm to generate a location choice for each chooser</p>
<p>Handle the various segments separately and in turn for simplicity of expression files</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons_merged_df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>persons table merged with households and land_use</p>
</dd>
<dt><strong>network_los</strong><span class="classifier">los.Network_LOS</span></dt><dd></dd>
<dt><strong>shadow_price_calculator</strong><span class="classifier">ShadowPriceCalculator</span></dt><dd><p>to get size terms</p>
</dd>
<dt><strong>want_logsums</strong><span class="classifier">boolean</span></dt><dd></dd>
<dt><strong>want_sample_table</strong><span class="classifier">boolean</span></dt><dd></dd>
<dt><strong>estimator: Estimator object</strong></dt><dd></dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>chunk_size</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd></dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame indexed by persons_merged_df.index</span></dt><dd><p>‘choice’ : location choices (zone ids)
‘logsum’ : float logsum of choice utilities across alternatives</p>
</dd>
<dt>logsums optional &amp; only returned if DEST_CHOICE_LOGSUM_COLUMN_NAME specified in model_settings</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.run_location_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">run_location_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">location_sample_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>add logsum column to existing location_sample table</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_zone_id) pair
in location_sample, and computing the logsum of all the utilities</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 20%" />
<col style="width: 23%" />
<col style="width: 17%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>PERID</p></th>
<th class="head"><p>dest_zone_id</p></th>
<th class="head"><p>rand</p></th>
<th class="head"><p>pick_count</p></th>
<th class="head"><p>logsum (added)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>23750</p></td>
<td><p>14</p></td>
<td><p>0.565502716034</p></td>
<td><p>4</p></td>
<td><p>1.85659498857</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>23750</p></td>
<td rowspan="2"><p>16</p></td>
<td rowspan="2"><p>0.711135838871</p></td>
<td rowspan="2"><p>6</p></td>
<td rowspan="2"><p>1.92315598631</p></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2"><p>…</p></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td><p>23751</p></td>
<td><p>12</p></td>
<td><p>0.408038878552</p></td>
<td><p>1</p></td>
<td><p>2.40612135416</p></td>
</tr>
<tr class="row-even"><td><p>23751</p></td>
<td><p>14</p></td>
<td><p>0.972732479292</p></td>
<td><p>2</p></td>
<td><p>1.44009018355</p></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.run_location_sample">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">run_location_sample</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>select a sample of alternative locations.</p>
<p>Logsum calculations are expensive, so we build a table of persons * all zones
and then select a sample subset of potential locations</p>
<p>The sample subset is generated by making multiple choices (&lt;sample_size&gt; number of choices)
which results in sample containing up to &lt;sample_size&gt; choices for each choose (e.g. person)
and a pick_count indicating how many times that choice was selected for that chooser.)</p>
<p>person_id,  dest_zone_id, rand,            pick_count
23750,      14,           0.565502716034,  4
23750,      16,           0.711135838871,  6
…
23751,      12,           0.408038878552,  1
23751,      14,           0.972732479292,  2</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.run_location_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">run_location_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">location_sample_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.run_location_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>run location model on location_sample annotated with mode_choice logsum
to select a dest zone from sample alternatives</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame indexed by persons_merged_df.index</span></dt><dd><p>choice : location choices (zone ids)
logsum : float logsum of choice utilities across alternatives</p>
</dd>
<dt>logsums optional &amp; only returned if DEST_CHOICE_LOGSUM_COLUMN_NAME specified in model_settings</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.school_location">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">school_location</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.school_location" title="Permalink to this definition">¶</a></dt>
<dd><p>School location choice model</p>
<p>iterate_location_choice adds location choice column and annotations to persons table</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.workplace_location">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">workplace_location</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locutor</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.workplace_location" title="Permalink to this definition">¶</a></dt>
<dd><p>workplace location choice model</p>
<p>iterate_location_choice adds location choice column and annotations to persons table</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.location_choice.write_estimation_specs">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.location_choice.</span></code><code class="sig-name descname"><span class="pre">write_estimation_specs</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">settings_file</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.location_choice.write_estimation_specs" title="Permalink to this definition">¶</a></dt>
<dd><p>write sample_spec, spec, and coefficients to estimation data bundle</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong></dt><dd></dd>
<dt><strong>settings_file</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="shadow-pricing">
<span id="index-1"></span><span id="id6"></span><h2>Shadow Pricing<a class="headerlink" href="#shadow-pricing" title="Permalink to this headline">¶</a></h2>
<p>The shadow pricing calculator used by work and school location choice.</p>
<span class="target" id="module-activitysim.abm.tables.shadow_pricing"></span><dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.add_size_tables">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">add_size_tables</span></code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.add_size_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>inject tour_destination_size_terms tables for each model_selector (e.g. school, workplace)</p>
<p>Size tables are pandas dataframes with locations counts for model_selector by zone and segment
tour_destination_size_terms</p>
<p>if using shadow pricing, we scale size_table counts to sample population
(in which case, they have to be created while single-process)</p>
<p>Scaling is problematic as it breaks household result replicability across sample sizes
It also changes the magnitude of the size terms so if they are used as utilities in
expression files, their importance will diminish relative to other utilities as the sample
size decreases.</p>
<p>Scaling makes most sense for a full sample in conjunction with shadow pricing, where
shadow prices can be adjusted iteratively to bring modelled counts into line with desired
(size table) counts.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.block_name">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">block_name</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.block_name" title="Permalink to this definition">¶</a></dt>
<dd><p>return canonical block name for model_selector</p>
<p>Ordinarily and ideally this would just be model_selector, but since mp_tasks saves all
shared data blocks in a common dict to pass to sub-tasks, we want to be able override
block naming convention to handle any collisions between model_selector names and skim names.
Until and unless that happens, we just use model_selector name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_selector</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>block_name</strong><span class="classifier">str</span></dt><dd><p>canonical block name</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">buffers_for_shadow_pricing</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shadow_pricing_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.buffers_for_shadow_pricing" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocate shared_data buffers for multiprocess shadow pricing</p>
<p>Allocates one buffer per model_selector.
Buffer datatype and shape specified by shadow_pricing_info</p>
<p>buffers are multiprocessing.Array (RawArray protected by a multiprocessing.Lock wrapper)
We don’t actually use the wrapped version as it slows access down and doesn’t provide
protection for numpy-wrapped arrays, but it does provide a convenient way to bundle
RawArray and an associated lock. (ShadowPriceCalculator uses the lock to coordinate access to
the numpy-wrapped RawArray.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>shadow_pricing_info</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>data_buffers</strong><span class="classifier">dict {&lt;model_selector&gt;</span></dt><dd><p>dict of multiprocessing.Array keyed by model_selector</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.get_shadow_pricing_info">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">get_shadow_pricing_info</span></code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.get_shadow_pricing_info" title="Permalink to this definition">¶</a></dt>
<dd><p>return dict with info about dtype and shapes of desired and modeled size tables</p>
<p>block shape is (num_zones, num_segments + 1)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>shadow_pricing_info: dict</dt><dd><p>dtype: &lt;sp_dtype&gt;,
block_shapes: dict {&lt;model_selector&gt;: &lt;block_shape&gt;}</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.load_shadow_price_calculator">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">load_shadow_price_calculator</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.load_shadow_price_calculator" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize ShadowPriceCalculator for model_selector (e.g. school or workplace)</p>
<p>If multiprocessing, get the shared_data buffer to coordinate global_desired_size
calculation across sub-processes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>spc</strong><span class="classifier">ShadowPriceCalculator</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt id="activitysim.abm.tables.shadow_pricing.logger">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">logger</span></code><em class="property"> <span class="pre">=</span> <span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.tables.shadow_pricing</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.logger" title="Permalink to this definition">¶</a></dt>
<dd><p>ShadowPriceCalculator and associated utility methods</p>
<p>See docstrings for documentation on:</p>
<p>update_shadow_prices    how shadow_price coefficients are calculated
synchronize_choices     interprocess communication to compute aggregate modeled_size
check_fit               convergence criteria for shadow_pric iteration</p>
<p>Import concepts and variables:</p>
<dl class="simple">
<dt>model_selector: str</dt><dd><p>Identifies a specific location choice model (e.g. ‘school’, ‘workplace’)
The various models work similarly, but use different expression files, model settings, etc.</p>
</dd>
<dt>segment: str</dt><dd><p>Identifies a specific demographic segment of a model (e.g. ‘elementary’ segment of ‘school’)
Models can have different size term coefficients (in destinatin_choice_size_terms file) and
different utility coefficients in models’s location and location_sample csv expression files</p>
</dd>
</dl>
<p>size_table: pandas.DataFrame</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">shadow_price_data_from_buffers</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_buffers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shadow_pricing_info</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.shadow_price_data_from_buffers" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>data_buffers</strong><span class="classifier">dict of {&lt;model_selector&gt;</span></dt><dd><p>multiprocessing.Array is simply a convenient way to bundle Array and Lock
we extract the lock and wrap the RawArray in a numpy array for convenience in indexing
The shared data buffer has shape (&lt;num_zones, &lt;num_segments&gt; + 1)
extra column is for reverse semaphores with TALLY_CHECKIN and TALLY_CHECKOUT</p>
</dd>
<dt><strong>shadow_pricing_info</strong><span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>dict of useful info</dt><dd><p>dtype: sp_dtype,
block_shapes : OrderedDict({&lt;model_selector&gt;: &lt;shape tuple&gt;})
dict mapping model_selector to block shape (including extra column for semaphores)
e.g. {‘school’: (num_zones, num_segments + 1)</p>
</dd>
</dl>
</dd>
<dt><strong>model_selector</strong><span class="classifier">str</span></dt><dd><p>location type model_selector (e.g. school or workplace)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>shared_data, shared_data_lock</dt><dd><p>shared_data : multiprocessing.Array or None (if single process)
shared_data_lock : numpy array wrapping multiprocessing.RawArray or None (if single process)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.tables.shadow_pricing.size_table_name">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.tables.shadow_pricing.</span></code><code class="sig-name descname"><span class="pre">size_table_name</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.tables.shadow_pricing.size_table_name" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns canonical name of injected destination desired_size table</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_selector</strong><span class="classifier">str</span></dt><dd><p>e.g. school or workplace</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>table_name</strong><span class="classifier">str</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="auto-ownership">
<span id="id7"></span><h2>Auto Ownership<a class="headerlink" href="#auto-ownership" title="Permalink to this headline">¶</a></h2>
<p>The auto ownership model selects a number of autos for each household in the simulation.
The primary model components are household demographics, zonal density, and accessibility.</p>
<p>The main interface to the auto ownership model is the
<a class="reference internal" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="activitysim.abm.models.auto_ownership.auto_ownership_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">auto_ownership_simulate()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">households</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">auto_ownership</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.auto_ownership"></span><dl class="py function">
<dt id="activitysim.abm.models.auto_ownership.auto_ownership_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.auto_ownership.</span></code><code class="sig-name descname"><span class="pre">auto_ownership_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Auto ownership is a standard model which predicts how many cars a household
with given characteristics owns</p>
</dd></dl>

</div>
<div class="section" id="free-parking-eligibility">
<span id="freeparking"></span><h2>Free Parking Eligibility<a class="headerlink" href="#free-parking-eligibility" title="Permalink to this headline">¶</a></h2>
<p>The Free Parking Eligibility model predicts the availability of free parking at a person’s
workplace.  It is applied for people who work in zones that have parking charges, which are
generally located in the Central Business Districts. The purpose of the model is to adequately
reflect the cost of driving to work in subsequent models, particularly in mode choice.</p>
<p>The main interface to the free parking eligibility model is the
<a class="reference internal" href="#activitysim.abm.models.free_parking.free_parking" title="activitysim.abm.models.free_parking.free_parking"><code class="xref py py-func docutils literal notranslate"><span class="pre">free_parking()</span></code></a> function.  This function is registered
as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">free_parking_at_work</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.free_parking"></span><dl class="py function">
<dt id="activitysim.abm.models.free_parking.free_parking">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.free_parking.</span></code><code class="sig-name descname"><span class="pre">free_parking</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.free_parking.free_parking" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="work-from-home">
<span id="id8"></span><h2>Work From Home<a class="headerlink" href="#work-from-home" title="Permalink to this headline">¶</a></h2>
<p>Telecommuting is defined as workers who work from home instead of going
to work. It only applies to workers with a regular workplace outside of home.
The telecommute model consists of two submodels - this work from home model and a
person <a class="reference internal" href="#telecommute-frequency"><span class="std std-ref">Telecommute Frequency</span></a> model.</p>
<p>The work from home model is typically run after usual work location choice and before the
coordinated daily activity pattern (CDAP) model. It predicts for all workers whether they
usually work from home. If work from home is chosen, then the work from home model
overrides the previously calculated usual work location field since it is no longer valid.</p>
<p>The work from home model includes the ability to adjust the work from home alternative
constant to attempt to realize a work from home percent for what-if type analysis.
This iterative procedure takes as input a number of iterations, a target work from home
percent, a tolerance percent for convergence, and the name of the coefficient to adjust.
An example setup is below and the coefficient adjustment at each iteration is:
<code class="docutils literal notranslate"><span class="pre">new_coefficient</span> <span class="pre">=</span> <span class="pre">log(</span> <span class="pre">target_percent</span> <span class="pre">/</span> <span class="pre">current_percent</span> <span class="pre">)</span> <span class="pre">+</span> <span class="pre">current_coefficient</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># iterative what-if analysis example</span>
<span class="c1"># omit these settings to not iterate</span>
<span class="n">WORK_FROM_HOME_ITERATIONS</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">WORK_FROM_HOME_TARGET_PERCENT</span><span class="p">:</span> <span class="mf">0.1</span>
<span class="n">WORK_FROM_HOME_TARGET_PERCENT_TOLERANCE</span><span class="p">:</span> <span class="mf">0.01</span>
<span class="n">WORK_FROM_HOME_COEFFICIENT_CONSTANT</span><span class="p">:</span> <span class="n">coef_work_from_home_constant</span>
</pre></div>
</div>
<p>The main interface to the work from home model is the
<a class="reference internal" href="#module-activitysim.examples.example_semcog.extensions.work_from_home" title="activitysim.examples.example_semcog.extensions.work_from_home"><code class="xref py py-func docutils literal notranslate"><span class="pre">work_from_home()</span></code></a> function.  This
function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">work_from_home</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.examples.example_semcog.extensions.work_from_home"></span><dl class="py function">
<dt id="activitysim.examples.example_semcog.extensions.work_from_home.work_from_home">
<code class="sig-prename descclassname"><span class="pre">activitysim.examples.example_semcog.extensions.work_from_home.</span></code><code class="sig-name descname"><span class="pre">work_from_home</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.examples.example_semcog.extensions.work_from_home.work_from_home" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts whether a person (worker) works from home. The output
from this model is TRUE (if works from home) or FALSE (works away from home).
The workplace location choice is overridden for workers who work from home
and set to -1.</p>
</dd></dl>

</div>
<div class="section" id="telecommute-frequency">
<span id="id9"></span><h2>Telecommute Frequency<a class="headerlink" href="#telecommute-frequency" title="Permalink to this headline">¶</a></h2>
<p>Telecommuting is defined as workers who work from home instead of going to work. It only applies to
workers with a regular workplace outside of home. The telecommute model consists of two
submodels - a person <a class="reference internal" href="#work-from-home"><span class="std std-ref">Work From Home</span></a> model and this person telecommute frequency model.</p>
<p>For all workers that work out of the home, the telecommute models predicts the
level of telecommuting. The model alternatives are the frequency of telecommuting in
days per week (0 days, 1 day, 2 to 3 days, 4+ days).</p>
<p>The main interface to the work from home model is the
<a class="reference internal" href="#module-activitysim.examples.example_semcog.extensions.telecommute_frequency" title="activitysim.examples.example_semcog.extensions.telecommute_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">telecommute_frequency()</span></code></a> function.  This
function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">telecommute_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.examples.example_semcog.extensions.telecommute_frequency"></span><dl class="py function">
<dt id="activitysim.examples.example_semcog.extensions.telecommute_frequency.telecommute_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.examples.example_semcog.extensions.telecommute_frequency.</span></code><code class="sig-name descname"><span class="pre">telecommute_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.examples.example_semcog.extensions.telecommute_frequency.telecommute_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of telecommute for a person (worker) who
does not works from home. The alternatives of this model are ‘No Telecommute’,
‘1 day per week’, ‘2 to 3 days per week’ and ‘4 days per week’. This model
reflects the choices of people who prefer a combination of working from home and
office during a week.</p>
</dd></dl>

</div>
<div class="section" id="coordinated-daily-activity-pattern">
<span id="cdap"></span><h2>Coordinated Daily Activity Pattern<a class="headerlink" href="#coordinated-daily-activity-pattern" title="Permalink to this headline">¶</a></h2>
<p>The Coordinated Daily Activity Pattern (CDAP) model predicts the choice of daily activity pattern (DAP)
for each member in the household, simultaneously. The DAP is categorized in to three types as
follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>Mandatory: the person engages in travel to at least one out-of-home mandatory activity - work, university, or school. The mandatory pattern may also include non-mandatory activities such as separate home-based tours or intermediate stops on mandatory tours.</p></li>
<li><p>Non-mandatory: the person engages in only maintenance and discretionary tours, which, by definition, do not contain mandatory activities.</p></li>
<li><p>Home: the person does not travel outside the home.</p></li>
</ul>
</div></blockquote>
<p>The CDAP model is a sequence of vectorized table operations:</p>
<ul class="simple">
<li><p>create a person level table and rank each person in the household for inclusion in the CDAP model.  Priority is given to full time workers (up to two), then to part time workers (up to two workers, of any type), then to children (youngest to oldest, up to three).  Additional members up to five are randomly included for the CDAP calculation.</p></li>
<li><p>solve individual M/N/H utilities for each person</p></li>
<li><p>take as input an interaction coefficients table and then programmatically produce and write out the expression files for households size 1, 2, 3, 4, and 5 models independent of one another</p></li>
<li><p>select households of size 1, join all required person attributes, and then read and solve the automatically generated expressions</p></li>
<li><p>repeat for households size 2, 3, 4, and 5. Each model is independent of one another.</p></li>
</ul>
<p>The main interface to the CDAP model is the <a class="reference internal" href="#activitysim.abm.models.util.cdap.run_cdap" title="activitysim.abm.models.util.cdap.run_cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_cdap()</span></code></a>
function.  This function is called by the orca step <code class="docutils literal notranslate"><span class="pre">cdap_simulate</span></code> which is
registered as an orca step in the example Pipeline.  There are two cdap class definitions in
ActivitySim.  The first is at <a class="reference internal" href="#module-activitysim.abm.models.cdap" title="activitysim.abm.models.cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">cdap()</span></code></a> and contains the orca
wrapper for running it as part of the model pipeline.  The second is
at <a class="reference internal" href="#module-activitysim.abm.models.util.cdap" title="activitysim.abm.models.util.cdap"><code class="xref py py-func docutils literal notranslate"><span class="pre">cdap()</span></code></a> and contains CDAP model logic.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">cdap_activity</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.cdap"></span><dl class="py function">
<dt id="activitysim.abm.models.cdap.cdap_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.cdap.</span></code><code class="sig-name descname"><span class="pre">cdap_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>CDAP stands for Coordinated Daily Activity Pattern, which is a choice of
high-level activity pattern for each person, in a coordinated way with other
members of a person’s household.</p>
<p>Because Python requires vectorization of computation, there are some specialized
routines in the cdap directory of activitysim for this purpose.  This module
simply applies those utilities using the simulation framework.</p>
</dd></dl>

</div>
<div class="section" id="mandatory-tour-frequency">
<span id="id10"></span><h2>Mandatory Tour Frequency<a class="headerlink" href="#mandatory-tour-frequency" title="Permalink to this headline">¶</a></h2>
<p>The individual mandatory tour frequency model predicts the number of work and school tours
taken by each person with a mandatory DAP. The primary drivers of mandatory tour frequency
are demographics, accessibility-based parameters such as drive time to work, and household
automobile ownership.  It also creates mandatory tours in the data pipeline.</p>
<p>The main interface to the mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">mandatory_tour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.mandatory_tour_frequency"></span><dl class="py function">
<dt id="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.mandatory_tour_frequency.</span></code><code class="sig-name descname"><span class="pre">mandatory_tour_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making mandatory trips (see the
alternatives above) - these trips include work and school in some combination.</p>
</dd></dl>

</div>
<div class="section" id="representative-logsums">
<span id="mandatory-tour-scheduling"></span><span id="id11"></span><h2>Mandatory Tour Scheduling<a class="headerlink" href="#representative-logsums" title="Permalink to this headline">¶</a></h2>
<p>The mandatory tour scheduling model selects a tour departure and duration period (and therefore a
start and end period as well) for each mandatory tour.   The primary drivers in the model are
accessibility-based parameters such as the mode choice logsum for the departure/arrival hour
combination, demographics, and time pattern characteristics such as the time windows available
from previously scheduled tours. This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">tour_departure_and_duration_segments.csv</span></code> is included in the configs, then the model
will use these representative start and end time periods when calculating mode choice logsums
instead of the specific start and end combinations for each alternative to reduce runtime.  This
feature, know as <code class="docutils literal notranslate"><span class="pre">representative</span> <span class="pre">logsums</span></code>, takes advantage of the fact that the mode choice logsum,
say, from 6 am to 2 pm is very similar to the logsum from 6 am to 3 pm, and 6 am to 4 pm, and so using
just 6 am to 3 pm (with the idea that 3 pm is the “representative time period”) for these alternatives is
sufficient for tour scheduling.  By reusing the 6 am to 3 pm mode choice logsum, ActivitySim saves
significant runtime.</p>
<p>The main interface to the mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">workplace_taz,</span> <span class="pre">school_taz,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.mandatory_scheduling"></span><dl class="py function">
<dt id="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.mandatory_scheduling.</span></code><code class="sig-name descname"><span class="pre">mandatory_tour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for mandatory tours</p>
</dd></dl>

</div>
<div class="section" id="joint-tour-frequency">
<span id="id12"></span><h2>Joint Tour Frequency<a class="headerlink" href="#joint-tour-frequency" title="Permalink to this headline">¶</a></h2>
<p>The joint tour generation models are divided into three sub-models: the joint tour frequency
model, the party composition model, and the person participation model. In the joint tour
frequency model, the household chooses the purposes and number (up to two) of its fully joint
travel tours.  It also creates joints tours in the data pipeline.</p>
<p>The main interface to the joint tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_frequency.joint_tour_frequency" title="activitysim.abm.models.joint_tour_frequency.joint_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">households</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">num_hh_joint_tours</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_frequency"></span><dl class="py function">
<dt id="activitysim.abm.models.joint_tour_frequency.joint_tour_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_frequency.</span></code><code class="sig-name descname"><span class="pre">joint_tour_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_frequency.joint_tour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making fully joint trips (see the
alternatives above).</p>
</dd></dl>

</div>
<div class="section" id="joint-tour-composition">
<span id="id13"></span><h2>Joint Tour Composition<a class="headerlink" href="#joint-tour-composition" title="Permalink to this headline">¶</a></h2>
<p>In the joint tour party composition model, the makeup of the travel party (adults, children, or
mixed - adults and children) is determined for each joint tour.  The party composition determines the
general makeup of the party of participants in each joint tour in order to allow the micro-simulation
to faithfully represent the prevalence of adult-only, children-only, and mixed joint travel tours
for each purpose while permitting simplicity in the subsequent person participation model.</p>
<p>The main interface to the joint tour composition model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_composition.joint_tour_composition" title="activitysim.abm.models.joint_tour_composition.joint_tour_composition"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_composition()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">composition</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_composition"></span><dl class="py function">
<dt id="activitysim.abm.models.joint_tour_composition.joint_tour_composition">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_composition.</span></code><code class="sig-name descname"><span class="pre">joint_tour_composition</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_composition.joint_tour_composition" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the makeup of the travel party (adults, children, or mixed).</p>
</dd></dl>

</div>
<div class="section" id="joint-tour-participation">
<span id="id14"></span><h2>Joint Tour Participation<a class="headerlink" href="#joint-tour-participation" title="Permalink to this headline">¶</a></h2>
<p>In the joint tour person participation model, each eligible person sequentially makes a
choice to participate or not participate in each joint tour.  Since the party composition model
determines what types of people are eligible to join a given tour, the person participation model
can operate in an iterative fashion, with each household member choosing to join or not to join
a travel party independent of the decisions of other household members. In the event that the
constraints posed by the result of the party composition model are not met, the person
participation model cycles through the household members multiple times until the required
types of people have joined the travel party.</p>
<p>This step also creates the <code class="docutils literal notranslate"><span class="pre">joint_tour_participants</span></code> table in the pipeline, which stores the
person ids for each person on the tour.</p>
<p>The main interface to the joint tour participation model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_participation.joint_tour_participation" title="activitysim.abm.models.joint_tour_participation.joint_tour_participation"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_participation()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">number_of_participants,</span> <span class="pre">person_id</span> <span class="pre">(for</span> <span class="pre">the</span> <span class="pre">point</span> <span class="pre">person)</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_participation"></span><dl class="py function">
<dt id="activitysim.abm.models.joint_tour_participation.joint_tour_participation">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_participation.</span></code><code class="sig-name descname"><span class="pre">joint_tour_participation</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_participation.joint_tour_participation" title="Permalink to this definition">¶</a></dt>
<dd><p>Predicts for each eligible person to participate or not participate in each joint tour.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.joint_tour_participation.participants_chooser">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_participation.</span></code><code class="sig-name descname"><span class="pre">participants_chooser</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">probs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_participation.participants_chooser" title="Permalink to this definition">¶</a></dt>
<dd><p>custom alternative to logit.make_choices for simulate.simple_simulate</p>
<p>Choosing participants for mixed tours is trickier than adult or child tours becuase we
need at least one adult and one child participant in a mixed tour. We call logit.make_choices
and then check to see if the tour statisfies this requirement, and rechoose for any that
fail until all are satisfied.</p>
<p>In principal, this shold always occur eventually, but we fail after MAX_ITERATIONS,
just in case there is some failure in program logic (haven’t seen this occur.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>probs</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rows for choosers and columns for the alternatives from which they
are choosing. Values are expected to be valid probabilities across
each row, e.g. they should sum to 1.</p>
</dd>
<dt><strong>choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>simple_simulate choosers df</p>
</dd>
<dt><strong>spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>simple_simulate spec df
We only need spec so we can know the column index of the ‘participate’ alternative
indicating that the participant has been chosen to participate in the tour</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd></dd>
<dt><strong>Returns - same as logit.make_choices</strong></dt><dd></dd>
<dt><strong>——-</strong></dt><dd></dd>
<dt><strong>choices, rands</strong></dt><dd><p>choices, rands as returned by logit.make_choices (in same order as probs)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="joint-tour-destination-choice">
<span id="id15"></span><h2>Joint Tour Destination Choice<a class="headerlink" href="#joint-tour-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The joint tour destination choice model operate similarly to the usual work and
school location choice model, selecting the primary destination for travel tours. The only
procedural difference between the models is that the usual work and school location choice
model selects the usual location of an activity whether or not the activity is undertaken during the
travel day, while the joint tour destination choice model selects the location for an
activity which has already been generated.</p>
<p>The tour’s primary destination is the location of the activity that is assumed to provide the greatest
impetus for engaging in the travel tour. In the household survey, the primary destination was not asked, but
rather inferred from the pattern of stops in a closed loop in the respondents’ travel diaries. The
inference was made by weighing multiple criteria including a defined hierarchy of purposes, the
duration of activities, and the distance from the tour origin. The model operates in the reverse
direction, designating the primary purpose and destination and then adding intermediate stops
based on spatial, temporal, and modal characteristics of the inbound and outbound journeys to
the primary destination.</p>
<dl class="simple">
<dt>The joint tour destination choice model is made up of three model steps:</dt><dd><ul class="simple">
<li><p>sample - selects a sample of alternative locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final location, this time with the mode choice logsum included.</p></li>
</ul>
</dd>
</dl>
<p>Joint tour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interface to the model is the <a class="reference internal" href="#activitysim.abm.models.joint_tour_destination.joint_tour_destination" title="activitysim.abm.models.joint_tour_destination.joint_tour_destination"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_destination()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how
to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.joint_tour_destination"></span><dl class="py function">
<dt id="activitysim.abm.models.joint_tour_destination.joint_tour_destination">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_destination.</span></code><code class="sig-name descname"><span class="pre">joint_tour_destination</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">households_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_destination.joint_tour_destination" title="Permalink to this definition">¶</a></dt>
<dd><p>Given the tour generation from the above, each tour needs to have a
destination, so in this case tours are the choosers (with the associated
person that’s making the tour)</p>
</dd></dl>

</div>
<div class="section" id="joint-tour-scheduling">
<span id="id16"></span><h2>Joint Tour Scheduling<a class="headerlink" href="#joint-tour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The joint tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each joint tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>. The primary drivers in the
models are accessibility-based parameters such
as the auto travel time for the departure/arrival hour combination, demographics, and time
pattern characteristics such as the time windows available from previously scheduled tours.
The joint tour scheduling model does not use mode choice logsums.</p>
<p>The main interface to the joint tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling" title="activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">joint_tour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: `` TAZ, destination, MD time period, MD time period``</p>
<span class="target" id="module-activitysim.abm.models.joint_tour_scheduling"></span><dl class="py function">
<dt id="activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.joint_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">joint_tour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.joint_tour_scheduling.joint_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each joint tour</p>
</dd></dl>

</div>
<div class="section" id="non-mandatory-tour-frequency">
<span id="id17"></span><h2>Non-Mandatory Tour Frequency<a class="headerlink" href="#non-mandatory-tour-frequency" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour frequency model selects the number of non-mandatory tours made by each person on the simulation day.
It also adds non-mandatory tours to the tours in the data pipeline. The individual non-mandatory tour frequency model
operates in two stages:</p>
<blockquote>
<div><ul class="simple">
<li><p>A choice is made using a random utility model between combinations of tours containing zero, one, and two or more escort tours, and between zero and one or more tours of each other purpose.</p></li>
<li><p>Up to two additional tours of each purpose are added according to fixed extension probabilities.</p></li>
</ul>
</div></blockquote>
<p>The main interface to the non-mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal notranslate"><span class="pre">non_mandatory_tour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_tour_frequency"></span><dl class="py function">
<dt id="activitysim.abm.models.non_mandatory_tour_frequency.extend_tour_counts">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_tour_frequency.</span></code><code class="sig-name descname"><span class="pre">extend_tour_counts</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.extend_tour_counts" title="Permalink to this definition">¶</a></dt>
<dd><p>extend tour counts based on a probability table</p>
<p>counts can only be extended if original count is between 1 and 4
and tours can only be extended if their count is at the max possible
(e.g. 2 for escort, 1 otherwise) so escort might be increased to 3 or 4
and other tour types might be increased to 2 or 3</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons: pandas dataframe</strong></dt><dd><p>(need this for join columns)</p>
</dd>
<dt><strong>tour_counts: pandas dataframe</strong></dt><dd><p>one row per person, once column per tour_type</p>
</dd>
<dt><strong>alternatives</strong></dt><dd><p>alternatives from nmtv interaction_simulate
only need this to know max possible frequency for a tour type</p>
</dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>extended tour_counts</dt><dd></dd>
<dt>tour_counts looks like this:</dt><dd><p>escort  shopping  othmaint  othdiscr    eatout    social</p>
</dd>
<dt>parent_id</dt><dd></dd>
<dt>2588676         2         0         0         1         1         0</dt><dd></dd>
<dt>2588677         0         1         0         1         0         0</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_tour_frequency.</span></code><code class="sig-name descname"><span class="pre">non_mandatory_tour_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making non-mandatory trips
(alternatives for this model come from a separate csv file which is
configured by the user) - these trips include escort, shopping, othmaint,
othdiscr, eatout, and social trips in various combination.</p>
</dd></dl>

</div>
<div class="section" id="non-mandatory-tour-destination-choice">
<span id="id18"></span><h2>Non-Mandatory Tour Destination Choice<a class="headerlink" href="#non-mandatory-tour-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour destination choice model chooses a destination zone for
non-mandatory tours.  The three step (sample, logsums, final choice) process also used for
mandatory tour destination choice is used for non-mandatory tour destination choice.</p>
<p>Non-mandatory tour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interface to the non-mandatory tour destination choice model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination" title="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_destination()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a>
for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_destination"></span><dl class="py function">
<dt id="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_destination.</span></code><code class="sig-name descname"><span class="pre">non_mandatory_tour_destination</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination" title="Permalink to this definition">¶</a></dt>
<dd><p>Given the tour generation from the above, each tour needs to have a
destination, so in this case tours are the choosers (with the associated
person that’s making the tour)</p>
</dd></dl>

</div>
<div class="section" id="non-mandatory-tour-scheduling">
<span id="id19"></span><h2>Non-Mandatory Tour Scheduling<a class="headerlink" href="#non-mandatory-tour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each non-mandatory tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.  Includes support
for <a class="reference internal" href="#representative-logsums"><span class="std std-ref">Mandatory Tour Scheduling</span></a>.</p>
<p>The main interface to the non-mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">non_mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">destination,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.non_mandatory_scheduling"></span><dl class="py function">
<dt id="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.non_mandatory_scheduling.</span></code><code class="sig-name descname"><span class="pre">non_mandatory_tour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for non-mandatory tours</p>
</dd></dl>

</div>
<div class="section" id="tour-mode-choice">
<span id="id20"></span><h2>Tour Mode Choice<a class="headerlink" href="#tour-mode-choice" title="Permalink to this headline">¶</a></h2>
<p>The mandatory, non-mandatory, and joint tour mode choice model assigns to each tour the “primary” mode that
is used to get from the origin to the primary destination. The tour-based modeling approach requires a reconsideration
of the conventional mode choice structure. Instead of a single mode choice model used in a four-step
structure, there are two different levels where the mode choice decision is modeled: (a) the
tour mode level (upper-level choice); and, (b) the trip mode level (lower-level choice conditional
upon the upper-level choice).</p>
<p>The mandatory, non-mandatory, and joint tour mode level represents the decisions that apply to the entire tour, and
that will affect the alternatives available for each individual trip or joint trip. These decisions include the choice to use a private
car versus using public transit, walking, or biking; whether carpooling will be considered; and
whether transit will be accessed by car or by foot. Trip-level decisions correspond to details of
the exact mode used for each trip, which may or may not change over the trips in the tour.</p>
<p>The mandatory, non-mandatory, and joint tour mode choice structure is a nested logit model which separates
similar modes into different nests to more accurately model the cross-elasticities between the alternatives. The
eighteen modes are incorporated into the nesting structure specified in the model settings file. The
first level of nesting represents the use a private car, non-motorized
means, or transit. In the second level of nesting, the auto nest is divided into vehicle occupancy
categories, and transit is divided into walk access and drive access nests. The final level splits
the auto nests into free or pay alternatives and the transit nests into the specific line-haul modes.</p>
<p>The primary variables are in-vehicle time, other travel times, cost (the influence of which is derived
from the automobile in-vehicle time coefficient and the persons’ modeled value of time),
characteristics of the destination zone, demographics, and the household’s level of auto
ownership.</p>
<p>The main interface to the mandatory, non-mandatory, and joint tour mode model is the
<a class="reference internal" href="#activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate" title="activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate"><code class="xref py py-func docutils literal notranslate"><span class="pre">tour_mode_choice_simulate()</span></code></a> function.  This function is
called in the orca step <code class="docutils literal notranslate"><span class="pre">tour_mode_choice_simulate</span></code> and is registered as an orca step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">TAZ,</span> <span class="pre">destination,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.tour_mode_choice"></span><dl class="py data">
<dt id="activitysim.abm.models.tour_mode_choice.logger">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></code><code class="sig-name descname"><span class="pre">logger</span></code><em class="property"> <span class="pre">=</span> <span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.models.tour_mode_choice</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.logger" title="Permalink to this definition">¶</a></dt>
<dd><p>Tour mode choice is run for all tours to determine the transportation mode that
will be used for the tour</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.tour_mode_choice.</span></code><code class="sig-name descname"><span class="pre">tour_mode_choice_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.tour_mode_choice.tour_mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Tour mode choice simulate</p>
</dd></dl>

</div>
<div class="section" id="at-work-subtours-frequency">
<span id="atwork-subtour-frequency"></span><h2>At-work Subtours Frequency<a class="headerlink" href="#at-work-subtours-frequency" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtour frequency model selects the number of at-work subtours made for each work tour.
It also creates at-work subtours by adding them to the tours table in the data pipeline.
These at-work sub-tours are travel tours taken during the workday with their origin at the work
location, rather than from home. Explanatory variables include employment status,
income, auto ownership, the frequency of other tours, characteristics of the parent work tour, and
characteristics of the workplace zone.</p>
<p>Choosers: work tours
Alternatives: none, 1 eating out tour, 1 business tour, 1 maintenance tour, 2 business tours, 1 eating out tour + 1 business tour
Dependent tables: household, person, accessibility
Outputs: work tour subtour frequency choice, at-work tours table (with only tour origin zone at this point)</p>
<p>The main interface to the at-work subtours frequency model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">atwork_subtour_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_frequency"></span><dl class="py function">
<dt id="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_frequency.</span></code><code class="sig-name descname"><span class="pre">atwork_subtour_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making at-work subtour tours
(alternatives for this model come from a separate csv file which is
configured by the user).</p>
</dd></dl>

</div>
<div class="section" id="at-work-subtours-destination-choice">
<span id="atwork-subtour-destination"></span><h2>At-work Subtours Destination Choice<a class="headerlink" href="#at-work-subtours-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtours destination choice model is made up of three model steps:</p>
<blockquote>
<div><ul class="simple">
<li><p>sample - selects a sample of alternative locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</p></li>
<li><p>logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative location.</p></li>
<li><p>simulate - starts with the table created above and chooses a final location, this time with the mode choice logsum included.</p></li>
</ul>
</div></blockquote>
<p>At-work subtour location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Table: <code class="docutils literal notranslate"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<p>The main interface to the at-work subtour destination model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_destination()</span></code>
function.  This function is registered as an orca step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_destination"></span></div>
<div class="section" id="at-work-subtour-scheduling">
<span id="atwork-subtour-scheduling"></span><h2>At-work Subtour Scheduling<a class="headerlink" href="#at-work-subtour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtours scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each at-work subtour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>This model is the same as the mandatory tour scheduling model except it operates on the at-work tours and
constrains the alternative set to available person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.  The at-work subtour scheduling model does not use mode choice logsums.
The at-work subtour frequency model can choose multiple tours so this model must process all first tours and then second
tours since isFirstAtWorkTour is an explanatory variable.</p>
<p>Choosers: at-work tours
Alternatives: alternative departure time and arrival back at origin time pairs WITHIN the work tour departure time and arrival time back at origin AND the person time window. If no time window is available for the tour, make the first and last time periods within the work tour available, make the choice, and log the number of times this occurs.
Dependent tables: skims, person, land use, work tour
Outputs: at-work tour departure time and arrival back at origin time, updated person time windows</p>
<p>The main interface to the at-work subtours scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">start,</span> <span class="pre">end,</span> <span class="pre">duration</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">alt_dest,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_scheduling"></span><dl class="py function">
<dt id="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_scheduling.</span></code><code class="sig-name descname"><span class="pre">atwork_subtour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tdd_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for at work subtours tours</p>
</dd></dl>

</div>
<div class="section" id="at-work-subtour-mode">
<span id="atwork-subtour-mode-choice"></span><h2>At-work Subtour Mode<a class="headerlink" href="#at-work-subtour-mode" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtour mode choice model assigns a travel mode to each at-work subtour using the <a class="reference internal" href="#tour-mode-choice"><span class="std std-ref">Tour Mode Choice</span></a> model.</p>
<p>The main interface to the at-work subtour mode choice model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice" title="activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice"><code class="xref py py-func docutils literal notranslate"><span class="pre">atwork_subtour_mode_choice()</span></code></a>
function.  This function is called in the orca step <code class="docutils literal notranslate"><span class="pre">atwork_subtour_mode_choice</span></code> and
is registered as an orca step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tour</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">tour_mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">workplace_taz,</span> <span class="pre">destination,</span> <span class="pre">start,</span> <span class="pre">end</span></code></p>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_mode_choice"></span><dl class="py function">
<dt id="activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.atwork_subtour_mode_choice.</span></code><code class="sig-name descname"><span class="pre">atwork_subtour_mode_choice</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_mode_choice.atwork_subtour_mode_choice" title="Permalink to this definition">¶</a></dt>
<dd><p>At-work subtour mode choice simulate</p>
</dd></dl>

</div>
<div class="section" id="intermediate-stop-frequency">
<span id="id21"></span><h2>Intermediate Stop Frequency<a class="headerlink" href="#intermediate-stop-frequency" title="Permalink to this headline">¶</a></h2>
<p>The stop frequency model assigns to each tour the number of intermediate destinations a person
will travel to on each leg of the tour from the origin to tour primary destination and back.
The model incorporates the ability for more than one stop in each direction,
up to a maximum of 3, for a total of 8 trips per tour (four on each tour leg).</p>
<p>Intermediate stops are not modeled for drive-transit tours because doing so can have unintended
consequences because of the difficulty of tracking the location of the vehicle. For example,
consider someone who used a park and ride for work and then took transit to an intermediate
shopping stop on the way home. Without knowing the vehicle location, it cannot be determined
if it is reasonable to allow the person to drive home. Even if the tour were constrained to allow
driving only on the first and final trip, the trip home from an intermediate stop may not use the
same park and ride where the car was dropped off on the outbound leg, which is usually as close
as possible to home because of the impracticality of coding drive access links from every park
and ride lot to every zone.</p>
<p>This model also creates a trips table in the pipeline for later models.</p>
<p>The main interface to the intermediate stop frequency model is the
<a class="reference internal" href="#activitysim.abm.models.stop_frequency.stop_frequency" title="activitysim.abm.models.stop_frequency.stop_frequency"><code class="xref py py-func docutils literal notranslate"><span class="pre">stop_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">stop_frequency</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.stop_frequency"></span><dl class="py function">
<dt id="activitysim.abm.models.stop_frequency.stop_frequency">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.stop_frequency.</span></code><code class="sig-name descname"><span class="pre">stop_frequency</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">stop_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.stop_frequency.stop_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>stop frequency model</p>
<p>For each tour, shoose a number of intermediate inbound stops and outbound stops.
Create a trip table with inbound and outbound trips.</p>
<p>Thus, a tour with stop_frequency ‘2out_0in’ will have two outbound and zero inbound stops,
and four corresponding trips: three outbound, and one inbound.</p>
<p>Adds stop_frequency str column to trips, with fields</p>
<p>creates trips table with columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">person_id</span>
<span class="o">-</span> <span class="n">household_id</span>
<span class="o">-</span> <span class="n">tour_id</span>
<span class="o">-</span> <span class="n">primary_purpose</span>
<span class="o">-</span> <span class="n">atwork</span>
<span class="o">-</span> <span class="n">trip_num</span>
<span class="o">-</span> <span class="n">outbound</span>
<span class="o">-</span> <span class="n">trip_count</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="trip-purpose">
<span id="id22"></span><h2>Trip Purpose<a class="headerlink" href="#trip-purpose" title="Permalink to this headline">¶</a></h2>
<p>For trip other than the last trip outbound or inbound, assign a purpose based on an
observed frequency distribution.  The distribution is segmented by tour purpose, tour
direction and person type. Work tours are also segmented by departure or arrival time period.</p>
<p>The main interface to the trip purpose model is the
<a class="reference internal" href="#activitysim.abm.models.trip_purpose.trip_purpose" title="activitysim.abm.models.trip_purpose.trip_purpose"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_purpose()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">purpose</span></code> | Skims Keys: NA</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trip purpose and trip destination choice can be run iteratively together via <a class="reference internal" href="#trip-purpose-and-destination"><span class="std std-ref">Trip Purpose and Destination</span></a>.</p>
</div>
<span class="target" id="module-activitysim.abm.models.trip_purpose"></span><dl class="py function">
<dt id="activitysim.abm.models.trip_purpose.choose_intermediate_trip_purpose">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></code><code class="sig-name descname"><span class="pre">choose_intermediate_trip_purpose</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.choose_intermediate_trip_purpose" title="Permalink to this definition">¶</a></dt>
<dd><p>chose purpose for intermediate trips based on probs_spec
which assigns relative weights (summing to 1) to the possible purpose choices</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>purpose: pandas.Series of purpose (str) indexed by trip_id</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_purpose.run_trip_purpose">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></code><code class="sig-name descname"><span class="pre">run_trip_purpose</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.run_trip_purpose" title="Permalink to this definition">¶</a></dt>
<dd><p>trip purpose - main functionality separated from model step so it can be called iteratively</p>
<p>For each intermediate stop on a tour (i.e. trip other than the last trip outbound or inbound)
Each trip is assigned a purpose based on an observed frequency distribution</p>
<p>The distribution is segmented by tour purpose, tour direction, person type,
and, optionally, trip depart time .</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>purpose: pandas.Series of purpose (str) indexed by trip_id</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_purpose.trip_purpose">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></code><code class="sig-name descname"><span class="pre">trip_purpose</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.trip_purpose" title="Permalink to this definition">¶</a></dt>
<dd><p>trip purpose model step - calls run_trip_purpose to run the actual model</p>
<p>adds purpose column to trips</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_purpose.trip_purpose_calc_row_size">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_purpose.</span></code><code class="sig-name descname"><span class="pre">trip_purpose_calc_row_size</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_purpose.trip_purpose_calc_row_size" title="Permalink to this definition">¶</a></dt>
<dd><p>rows_per_chunk calculator for trip_purpose</p>
</dd></dl>

</div>
<div class="section" id="trip-destination-choice">
<span id="id23"></span><h2>Trip Destination Choice<a class="headerlink" href="#trip-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The trip (or stop) location choice model predicts the location of trips (or stops) along the tour other than the primary
destination. The stop-location model is structured as a multinomial logit model using a zone
attraction size variable and route deviation measure as impedance. The alternatives are sampled from
the full set of zones, subject to availability of a zonal attraction size term. The sampling mechanism
is also based on accessibility between tour origin and primary destination, and is subject to certain rules
based on tour mode.</p>
<p>All destinations are available for auto tour modes, so long as there is a positive
size term for the zone. Intermediate stops on walk tours must be within X miles of both the tour
origin and primary destination zones. Intermediate stops on bike tours must be within X miles of both
the tour origin and primary destination zones. Intermediate stops on walk-transit tours must either be
within X miles walking distance of both the tour origin and primary destination, or have transit access to
both the tour origin and primary destination. Additionally, only short and long walk zones are
available destinations on walk-transit tours.</p>
<p>The intermediate stop location choice model works by cycling through stops on tours. The level-of-service
variables (including mode choice logsums) are calculated as the additional utility between the
last location and the next known location on the tour. For example, the LOS variable for the first stop
on the outbound direction of the tour is based on additional impedance between the tour origin and the
tour primary destination. The LOS variable for the next outbound stop is based on the additional
impedance between the previous stop and the tour primary destination. Stops on return tour legs work
similarly, except that the location of the first stop is a function of the additional impedance between the
tour primary destination and the tour origin. The next stop location is based on the additional
impedance between the first stop on the return leg and the tour origin, and so on.</p>
<p>Trip location choice for <a class="reference internal" href="examples.html#multiple-zone-systems"><span class="std std-ref">example_multiple_zones</span></a> models uses <a class="reference internal" href="examples.html#presampling"><span class="std std-ref">Presampling</span></a> by default.</p>
<p>The main interface to the trip destination choice model is the
<a class="reference internal" href="#activitysim.abm.models.trip_destination.trip_destination" title="activitysim.abm.models.trip_destination.trip_destination"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_destination()</span></code></a> function.
This function is registered as an orca step in the example Pipeline.
See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">(trip)</span> <span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">(tour</span> <span class="pre">primary)</span> <span class="pre">destination,</span> <span class="pre">dest_taz,</span> <span class="pre">trip_period</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trip purpose and trip destination choice can be run iteratively together via <a class="reference internal" href="#trip-purpose-and-destination"><span class="std std-ref">Trip Purpose and Destination</span></a>.</p>
</div>
<span class="target" id="module-activitysim.abm.models.trip_destination"></span><dl class="py function">
<dt id="activitysim.abm.models.trip_destination.choose_MAZ_for_TAZ">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">choose_MAZ_for_TAZ</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">taz_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">MAZ_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alt_dest_col_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.choose_MAZ_for_TAZ" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert taz_sample table with TAZ zone sample choices to a table with a MAZ zone chosen for each TAZ
choose MAZ probabilistically (proportionally by size_term) from set of MAZ zones in parent TAZ</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>taz_sample: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: &lt;alt_dest_col_name&gt;, prob, pick_count</strong></dt><dd></dd>
<dt><strong>MAZ_size_terms: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: zone_id, dest_TAZ, size_term</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>dataframe with with duplicated index &lt;chooser_id_col&gt; and columns: &lt;alt_dest_col_name&gt;, prob, pick_count</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.compute_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">compute_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">primary_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_hotel</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.compute_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate mode choice logsums using the same recipe as for trip_mode_choice, but do it twice
for each alternative since we need out-of-direction logsum
(i.e . origin to alt_dest, and alt_dest to half-tour destination)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>adds od_logsum and dp_logsum columns to trips (in place)</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.compute_ood_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">compute_ood_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">od_skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.compute_ood_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute one (of two) out-of-direction logsums for destination alternatives</p>
<p>Will either be trip_origin -&gt; alt_dest or alt_dest -&gt; primary_dest</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.run_trip_destination">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">run_trip_destination</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fail_some_trips_for_testing</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.run_trip_destination" title="Permalink to this definition">¶</a></dt>
<dd><p>trip destination - main functionality separated from model step so it can be called iteratively</p>
<p>Run the trip_destination model, assigning destinations for each (intermediate) trip
(last trips already have a destination - either the tour primary destination or Home)</p>
<p>Set trip destination and origin columns, and a boolean failed flag for any failed trips
(destination for flagged failed trips will be set to -1)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips</strong></dt><dd></dd>
<dt><strong>tours_merged</strong></dt><dd></dd>
<dt><strong>want_sample_table</strong></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.trip_destination">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">trip_destination</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.trip_destination" title="Permalink to this definition">¶</a></dt>
<dd><p>Choose a destination for all ‘intermediate’ trips based on trip purpose.</p>
<p>Final trips already have a destination (the primary tour destination for outbound trips,
and home for inbound trips.)</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.trip_destination_sample">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">trip_destination_sample</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">primary_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alternatives</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size_term_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_hotel</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.trip_destination_sample" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl>
<dt>destination_sample: pandas.dataframe</dt><dd><p>choices_df from interaction_sample with (up to) sample_size alts for each chooser row
index (non unique) is trip_id from trips (duplicated for each alt)
and columns dest_zone_id, prob, and pick_count</p>
<dl class="simple">
<dt>dest_zone_id: int</dt><dd><p>alt identifier from alternatives[&lt;alt_col_name&gt;]</p>
</dd>
<dt>prob: float</dt><dd><p>the probability of the chosen alternative</p>
</dd>
<dt>pick_count<span class="classifier">int</span></dt><dd><p>number of duplicate picks for chooser, alt</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_destination.trip_destination_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_destination.</span></code><code class="sig-name descname"><span class="pre">trip_destination_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">primary_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size_term_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skim_hotel</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_destination.trip_destination_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Chose destination from destination_sample (with od_logsum and dp_logsum columns added)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>choices - pandas.Series</dt><dd><p>destination alt chosen</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="trip-purpose-and-destination">
<span id="id24"></span><h2>Trip Purpose and Destination<a class="headerlink" href="#trip-purpose-and-destination" title="Permalink to this headline">¶</a></h2>
<p>After running trip purpose and trip destination separately, the two model can be ran together in an iterative fashion on
the remaining failed trips (i.e. trips that cannot be assigned a destination).  Each iteration uses new random numbers.</p>
<p>The main interface to the trip purpose model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">trip_purpose_and_destination()</span></code>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">purpose,</span> <span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">(tour</span> <span class="pre">primary)</span> <span class="pre">destination,</span> <span class="pre">dest_taz,</span> <span class="pre">trip_period</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_purpose_and_destination"></span></div>
<div class="section" id="trip-scheduling-probablistic">
<span id="trip-scheduling"></span><h2>Trip Scheduling (Probablistic)<a class="headerlink" href="#trip-scheduling-probablistic" title="Permalink to this headline">¶</a></h2>
<p>For each trip, assign a departure hour based on an input lookup table of percents by tour purpose,
direction (inbound/outbound), tour hour, and trip index.</p>
<blockquote>
<div><ul class="simple">
<li><p>The tour hour is the tour start hour for outbound trips and the tour end hour for inbound trips.  The trip index is the trip sequence on the tour, with up to four trips per half tour</p></li>
<li><p>For outbound trips, the trip depart hour must be greater than or equal to the previously selected trip depart hour</p></li>
<li><p>For inbound trips, trips are handled in reverse order from the next-to-last trip in the leg back to the first. The tour end hour serves as the anchor time point from which to start assigning trip time periods.</p></li>
<li><p>Outbound trips on at-work subtours are assigned the tour depart hour and inbound trips on at-work subtours are assigned the tour end hour.</p></li>
</ul>
</div></blockquote>
<p>The assignment of trip depart time is run iteratively up to a max number of iterations since it is possible that
the time period selected for an earlier trip in a half-tour makes selection of a later trip time
period impossible (or very low probability). Thus, the sampling is re-run until a feasible set of trip time
periods is found. If a trip can’t be scheduled after the max iterations, then the trip is assigned
the previous trip’s choice (i.e. assumed to happen right after the previous trip) or dropped, as configured by the user.
The trip scheduling model does not use mode choice logsums.</p>
<p>Alternatives: Available time periods in the tour window (i.e. tour start and end period).  When processing stops on
work tours, the available time periods is constrained by the at-work subtour start and end period as well.</p>
<p>The main interface to the trip scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.trip_scheduling.trip_scheduling" title="activitysim.abm.models.trip_scheduling.trip_scheduling"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_scheduling()</span></code></a> function.
This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">depart</span></code> | Skims Keys: NA</p>
<span class="target" id="module-activitysim.abm.models.trip_scheduling"></span><dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.clip_probs">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">clip_probs</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.clip_probs" title="Permalink to this definition">¶</a></dt>
<dd><p>zero out probs before trips.earliest or after trips.latest</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips: pd.DataFrame</strong></dt><dd></dd>
<dt><strong>probs: pd.DataFrame</strong></dt><dd><p>one row per trip, one column per time period, with float prob of picking that time period</p>
</dd>
<dt><strong>depart_alt_base: int</strong></dt><dd><p>int to add to probs column index to get time period it represents.
e.g. depart_alt_base = 5 means first column (column 0) represents 5 am</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>probs: pd.DataFrame</dt><dd><p>clipped version of probs</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt id="activitysim.abm.models.trip_scheduling.logger">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">logger</span></code><em class="property"> <span class="pre">=</span> <span class="pre">&lt;Logger</span> <span class="pre">activitysim.abm.models.trip_scheduling</span> <span class="pre">(WARNING)&gt;</span></em><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.logger" title="Permalink to this definition">¶</a></dt>
<dd><p>StopDepartArrivePeriodModel</p>
<p>StopDepartArriveProportions.csv
tourpurp,isInbound,interval,trip,p1,p2,p3,p4,p5…p40</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.report_bad_choices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">report_bad_choices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bad_row_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filename</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choosers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.report_bad_choices" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>bad_row_map</strong></dt><dd></dd>
<dt><strong>df</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>utils or probs dataframe</p>
</dd>
<dt><strong>trace_choosers</strong><span class="classifier">pandas.dataframe</span></dt><dd><p>the choosers df (for interaction_simulate) to facilitate the reporting of hh_id
because we  can’t deduce hh_id from the interaction_dataset which is indexed on index
values from alternatives df</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.schedule_nth_trips">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">schedule_nth_trips</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_trip_in_leg</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">report_failed_trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.schedule_nth_trips" title="Permalink to this definition">¶</a></dt>
<dd><p>We join each trip with the appropriate row in probs_spec by joining on probs_join_cols,
which should exist in both trips, probs_spec dataframe.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips: pd.DataFrame</strong></dt><dd></dd>
<dt><strong>probs_spec: pd.DataFrame</strong></dt><dd><p>Dataframe of probs for choice of depart times and join columns to match them with trips.
Depart columns names are irrelevant. Instead, they are position dependent,
time period choice is their index + depart_alt_base</p>
</dd>
<dt><strong>depart_alt_base: int</strong></dt><dd><p>int to add to probs column index to get time period it represents.
e.g. depart_alt_base = 5 means first column (column 0) represents 5 am</p>
</dd>
<dt><strong>report_failed_trips</strong><span class="classifier">bool</span></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>choices: pd.Series</dt><dd><p>time periods depart choices, one per trip (except for trips with zero probs)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.schedule_trips_in_leg">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">schedule_trips_in_leg</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outbound</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probs_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_iteration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.schedule_trips_in_leg" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>outbound</strong></dt><dd></dd>
<dt><strong>trips</strong></dt><dd></dd>
<dt><strong>probs_spec</strong></dt><dd></dd>
<dt><strong>depart_alt_base</strong></dt><dd></dd>
<dt><strong>last_iteration</strong></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>choices: pd.Series</dt><dd><p>depart choice for trips, indexed by trip_id</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.set_tour_hour">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">set_tour_hour</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.set_tour_hour" title="Permalink to this definition">¶</a></dt>
<dd><p>add columns ‘tour_hour’, ‘earliest’, ‘latest’ to trips</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>trips: pd.DataFrame</strong></dt><dd></dd>
<dt><strong>tours: pd.DataFrame</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>modifies trips in place</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_scheduling.trip_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_scheduling.</span></code><code class="sig-name descname"><span class="pre">trip_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_scheduling.trip_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>Trip scheduling assigns depart times for trips within the start, end limits of the tour.</p>
<p>The algorithm is simplistic:</p>
<p>The first outbound trip starts at the tour start time, and subsequent outbound trips are
processed in trip_num order, to ensure that subsequent trips do not depart before the
trip that preceeds them.</p>
<p>Inbound trips are handled similarly, except in reverse order, starting with the last trip,
and working backwards to ensure that inbound trips do not depart after the trip that
succeeds them.</p>
<p>The probability spec assigns probabilities for depart times, but those possible departs must
be clipped to disallow depart times outside the tour limits, the departs of prior trips, and
in the case of work tours, the start/end times of any atwork subtours.</p>
<p>Scheduling can fail if the probability table assigns zero probabilities to all the available
depart times in a trip’s depart window. (This could be avoided by giving every window a small
probability, rather than zero, but the existing mtctm1 prob spec does not do this. I believe
this is due to the its having been generated from a small household travel survey sample
that lacked any departs for some time periods.)</p>
<p>Rescheduling the trips that fail (along with their inbound or outbound leg-mates) can sometimes
fix this problem, if it was caused by an earlier trip’s depart choice blocking a subsequent
trip’s ability to schedule a depart within the resulting window. But it can also happen if
a tour is very short (e.g. one time period) and the prob spec having a zero probability for
that tour hour.</p>
<p>Therefore we need to handle trips that could not be scheduled. There are two ways (at least)
to solve this problem:</p>
<p>1) choose_most_initial
simply assign a depart time to the trip, even if it has a zero probability. It makes
most sense, in this case, to assign the ‘most initial’ depart time, so that subsequent trips
are minimally impacted. This can be done in the final iteration, thus affecting only the
trips that could no be scheduled by the standard approach</p>
<p>2) drop_and_cleanup
drop trips that could no be scheduled, and adjust their leg mates, as is done for failed
trips in trip_destination.</p>
<p>Which option is applied is determined by the FAILFIX model setting</p>
</dd></dl>

</div>
<div class="section" id="trip-scheduling-choice-logit-choice">
<span id="trip-scheduling-choice"></span><h2>Trip Scheduling Choice (Logit Choice)<a class="headerlink" href="#trip-scheduling-choice-logit-choice" title="Permalink to this headline">¶</a></h2>
<p>This model uses a logit-based formulation to determine potential trip windows for the three
main components of a tour.</p>
<ul class="simple">
<li><p>Outbound Leg: The time from leaving the origin location to the time second to last outbound stop.</p></li>
<li><p>Main Leg: The time window from the last outbound stop through the main tour destination to the first inbound stop.</p></li>
<li><p>Inbound Leg: The time window from the first inbound stop to the tour origin location.</p></li>
</ul>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">outbound_duration</span></code>, <code class="docutils literal notranslate"><span class="pre">main_leg_duration</span></code>, <code class="docutils literal notranslate"><span class="pre">inbound_duration</span></code> | Skims Keys: NA</p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="trip-departure-choice-logit-choice">
<span id="trip-departure-choice"></span><h2>Trip Departure Choice (Logit Choice)<a class="headerlink" href="#trip-departure-choice-logit-choice" title="Permalink to this headline">¶</a></h2>
<p>Used in conjuction with Trip Scheduling Choice (Logit Choice), this model chooses departure
time periods consistent with the time windows for the appropriate leg of the trip.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">depart</span></code> | Skims Keys: NA</p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="trip-mode-choice">
<span id="id25"></span><h2>Trip Mode Choice<a class="headerlink" href="#trip-mode-choice" title="Permalink to this headline">¶</a></h2>
<p>The trip mode choice model assigns a travel mode for each trip on a given tour. It
operates similarly to the tour mode choice model, but only certain trip modes are available for
each tour mode. The correspondence rules are defined according to the following principles:</p>
<blockquote>
<div><ul class="simple">
<li><p>Pay trip modes are only available for pay tour modes (for example, drive-alone pay is only available at the trip mode level if drive-alone pay is selected as a tour mode).</p></li>
<li><p>The auto occupancy of the tour mode is determined by the maximum occupancy across all auto trips that make up the tour. Therefore, the auto occupancy for the tour mode is the maximum auto occupancy for any trip on the tour.</p></li>
<li><p>Transit tours can include auto shared-ride trips for particular legs. Therefore, ‘casual carpool’, wherein travelers share a ride to work and take transit back to the tour origin, is explicitly allowed in the tour/trip mode choice model structure.</p></li>
<li><p>The walk mode is allowed for any trip.</p></li>
<li><p>The availability of transit line-haul submodes on transit tours depends on the skimming and tour mode choice hierarchy. Free shared-ride modes are also available in walk-transit tours, albeit with a low probability. Paid shared-ride modes are not allowed on transit tours because no stated preference data is available on the sensitivity of transit riders to automobile value tolls, and no observed data is available to verify the number of people shifting into paid shared-ride trips on transit tours.</p></li>
</ul>
</div></blockquote>
<p>The trip mode choice models explanatory variables include household and person variables, level-of-service
between the trip origin and destination according to the time period for the tour leg, urban form
variables, and alternative-specific constants segmented by tour mode.</p>
<p>The main interface to the trip mode choice model is the
<a class="reference internal" href="#activitysim.abm.models.trip_mode_choice.trip_mode_choice" title="activitysim.abm.models.trip_mode_choice.trip_mode_choice"><code class="xref py py-func docutils literal notranslate"><span class="pre">trip_mode_choice()</span></code></a> function.  This function
is registered as an orca step in the example Pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write logsums for estimation.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal notranslate"><span class="pre">trip_mode</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">destination,</span> <span class="pre">trip_period</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_mode_choice"></span><dl class="py function">
<dt id="activitysim.abm.models.trip_mode_choice.trip_mode_choice">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_mode_choice.</span></code><code class="sig-name descname"><span class="pre">trip_mode_choice</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_mode_choice.trip_mode_choice" title="Permalink to this definition">¶</a></dt>
<dd><p>Trip mode choice - compute trip_mode (same values as for tour_mode) for each trip.</p>
<p>Modes for each primary tour putpose are calculated separately because they have different
coefficient values (stored in trip_mode_choice_coefficients.csv coefficient file.)</p>
<p>Adds trip_mode column to trip table</p>
</dd></dl>

</div>
<div class="section" id="parking-location-choice">
<span id="id26"></span><h2>Parking Location Choice<a class="headerlink" href="#parking-location-choice" title="Permalink to this headline">¶</a></h2>
<p>The parking location choice model selects a parking location for specified trips. While the model does not
require parking location be applied to any specific set of trips, it is usually applied for drive trips to
specific zones (e.g., CBD) in the model.</p>
<p>The model provides provides a filter for both the eligible choosers and eligible parking location zone. The
trips dataframe is the chooser of this model. The zone selection filter is applied to the land use zones
dataframe.</p>
<p>If this model is specified in the pipeline, the <a class="reference internal" href="#id27">Write Trip Matrices</a> step will using the parking location
choice results to build trip tables in lieu of the trip destination.</p>
<p>The main interface to the trip mode choice model is the
<code class="xref py py-func docutils literal notranslate"><span class="pre">parking_location_choice()</span></code> function.  This function
is registered as an orca step, and it is available from the pipeline.  See <a class="reference internal" href="examples.html#writing-logsums"><span class="std std-ref">Writing Logsums</span></a> for how to write
logsums for estimation.</p>
<p><strong>Skims</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">odt_skims</span></code>: Origin to Destination by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dot_skims</span></code>: Destination to Origin by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opt_skims</span></code>: Origin to Parking Zone by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pdt_skims</span></code>: Parking Zone to Destination by Time of Day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">od_skims</span></code>: Origin to Destination</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">do_skims</span></code>: Destination to Origin</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">op_skims</span></code>: Origin to Parking Zone</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pd_skims</span></code>: Parking Zone to Destination</p></li>
</ul>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code></p>
<p><strong>Required YAML attributes:</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SPECIFICATION</span></code></dt><dd><p>This file defines the logit specification for each chooser segment.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">COEFFICIENTS</span></code></dt><dd><p>Specification coefficients</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">PREPROCESSOR</span></code>:</dt><dd><p>Preprocessor definitions to run on the chooser dataframe (trips) before the model is run</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CHOOSER_FILTER_COLUMN_NAME</span></code></dt><dd><p>Boolean field on the chooser table defining which choosers are eligible to parking location choice model. If no
filter is specified, all choosers (trips) are eligible for the model.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CHOOSER_SEGMENT_COLUMN_NAME</span></code></dt><dd><p>Column on the chooser table defining the parking segment for the logit model</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SEGMENTS</span></code></dt><dd><p>List of eligible chooser segments in the logit specification</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ALTERNATIVE_FILTER_COLUMN_NAME</span></code></dt><dd><p>Boolean field used to filter land use zones as eligible parking location choices. If no filter is specified,
then all land use zones are considered as viable choices.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ALT_DEST_COL_NAME</span></code></dt><dd><p>The column name to append with the parking location choice results. For choosers (trips) ineligible for this
model, a -1 value will be placed in column.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TRIP_ORIGIN</span></code></dt><dd><p>Origin field on the chooser trip table</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TRIP_DESTINATION</span></code></dt><dd><p>Destination field on the chooser trip table</p>
</dd>
</dl>
</li>
</ul>
<span class="target" id="module-activitysim.abm.models.parking_location_choice"></span><dl class="py function">
<dt id="activitysim.abm.models.parking_location_choice.parking_destination_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></code><code class="sig-name descname"><span class="pre">parking_destination_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.parking_destination_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Chose destination from destination_sample (with od_logsum and dp_logsum columns added)</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>choices - pandas.Series</dt><dd><p>destination alt chosen</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.parking_location_choice.parking_location">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></code><code class="sig-name descname"><span class="pre">parking_location</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trips_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">land_use</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.parking_location" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a set of trips, each trip needs to have a parking location if
it is eligible for remote parking.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.parking_location_choice.wrap_skims">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.parking_location_choice.</span></code><code class="sig-name descname"><span class="pre">wrap_skims</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.parking_location_choice.wrap_skims" title="Permalink to this definition">¶</a></dt>
<dd><p>wrap skims of trip destination using origin, dest column names from model settings.
Various of these are used by destination_sample, compute_logsums, and destination_simulate
so we create them all here with canonical names.</p>
<p>Note that compute_logsums aliases their names so it can use the same equations to compute
logsums from origin to alt_dest, and from alt_dest to primarly destination</p>
<p>odt_skims - SkimStackWrapper: trip origin, trip alt_dest, time_of_day
dot_skims - SkimStackWrapper: trip alt_dest, trip origin, time_of_day
dpt_skims - SkimStackWrapper: trip alt_dest, trip primary_dest, time_of_day
pdt_skims - SkimStackWrapper: trip primary_dest,trip alt_dest, time_of_day
od_skims - SkimDictWrapper: trip origin, trip alt_dest
dp_skims - SkimDictWrapper: trip alt_dest, trip primary_dest</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>dict containing skims, keyed by canonical names relative to tour orientation</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="write-trip-matrices">
<span id="id27"></span><h2>Write Trip Matrices<a class="headerlink" href="#write-trip-matrices" title="Permalink to this headline">¶</a></h2>
<p>Write open matrix (OMX) trip matrices for assignment.  Reads the trips table post preprocessor and run expressions
to code additional data fields, with one data fields for each matrix specified.  The matrices are scaled by a
household level expansion factor, which is the household sample rate by default, which is calculated when
households are read in at the beginning of a model run.  The main interface to write trip
matrices is the <a class="reference internal" href="#activitysim.abm.models.trip_matrices.write_trip_matrices" title="activitysim.abm.models.trip_matrices.write_trip_matrices"><code class="xref py py-func docutils literal notranslate"><span class="pre">write_trip_matrices()</span></code></a> function.  This function
is registered as an orca step in the example Pipeline.</p>
<p>If the <a class="reference internal" href="#id26">Parking Location Choice</a> model is defined in the pipeline, the parking location zone will be used in
lieu of the destination zone.</p>
<p>Core Table: <code class="docutils literal notranslate"><span class="pre">trips</span></code> | Result: <code class="docutils literal notranslate"><span class="pre">omx</span> <span class="pre">trip</span> <span class="pre">matrices</span></code> | Skims Keys: <code class="docutils literal notranslate"><span class="pre">origin,</span> <span class="pre">destination</span></code></p>
<span class="target" id="module-activitysim.abm.models.trip_matrices"></span><dl class="py function">
<dt id="activitysim.abm.models.trip_matrices.annotate_trips">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></code><code class="sig-name descname"><span class="pre">annotate_trips</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.annotate_trips" title="Permalink to this definition">¶</a></dt>
<dd><p>Add columns to local trips table. The annotator has
access to the origin/destination skims and everything
defined in the model settings CONSTANTS.</p>
<p>Pipeline tables can also be accessed by listing them under
TABLES in the preprocessor settings.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_matrices.write_matrices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></code><code class="sig-name descname"><span class="pre">write_matrices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">aggregate_trips</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">zone_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">orig_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_tap</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.write_matrices" title="Permalink to this definition">¶</a></dt>
<dd><p>Write aggregated trips to OMX format.</p>
<p>The MATRICES setting lists the new OMX files to write.
Each file can contain any number of ‘tables’, each specified by a
table key (‘name’) and a trips table column (‘data_field’) to use
for aggregated counts.</p>
<p>Any data type may be used for columns added in the annotation phase,
but the table ‘data_field’s must be summable types: ints, floats, bools.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.trip_matrices.write_trip_matrices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.trip_matrices.</span></code><code class="sig-name descname"><span class="pre">write_trip_matrices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.trip_matrices.write_trip_matrices" title="Permalink to this definition">¶</a></dt>
<dd><p>Write trip matrices step.</p>
<p>Adds boolean columns to local trips table via annotation expressions,
then aggregates trip counts and writes OD matrices to OMX.  Save annotated
trips table to pipeline if desired.</p>
<p>Writes taz trip tables for one and two zone system.  Writes taz and tap
trip tables for three zone system.  Add <code class="docutils literal notranslate"><span class="pre">is_tap:True</span></code> to the settings file
to identify an output matrix as tap level trips as opposed to taz level trips.</p>
<p>For one zone system, uses the land use table for the set of possible tazs.
For two zone system, uses the taz skim zone names for the set of possible tazs.
For three zone system, uses the taz skim zone names for the set of possible tazs
and uses the tap skim zone names for the set of possible taps.</p>
</dd></dl>

</div>
<div class="section" id="util">
<span id="utility-steps"></span><h2>Util<a class="headerlink" href="#util" title="Permalink to this headline">¶</a></h2>
<p>Additional helper classes</p>
<div class="section" id="id28">
<h3>CDAP<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.util.cdap"></span><dl class="py function">
<dt id="activitysim.abm.models.util.cdap.add_interaction_column">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">add_interaction_column</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_tup</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_interaction_column" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an interaction column in place to choosers, listing the ptypes of the persons in p_tup</p>
<p>The name of the interaction column will be determined by the cdap_ranks from p_tup,
and the rows in the column contain the ptypes of those persons in that household row.</p>
<p>For instance, for p_tup = (1,3) choosers interaction column name will be ‘p1_p3’</p>
<p>For a household where person 1 is part-time worker (ptype=2) and person 3 is infant (ptype 8)
the corresponding row value interaction code will be 28</p>
<p>We take advantage of the fact that interactions are symmetrical to simplify spec expressions:
We name the interaction_column in increasing pnum (cdap_rank) order (p1_p2 and not p3_p1)
And we format row values in increasing ptype order (28 and not 82)
This simplifies the spec expressions as we don’t have to test for p1_p3 == 28 | p1_p3 == 82</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>household choosers, indexed on _hh_index_
choosers should contain columns ptype_p1, ptype_p2 for each cdap_rank person in hh</p>
</dd>
<dt><strong>p_tup</strong><span class="classifier">int tuple</span></dt><dd><p>tuple specifying the cdap_ranks for the interaction column
p_tup = (1,3) means persons with cdap_rank 1 and 3</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.add_pn">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">add_pn</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pnum</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_pn" title="Permalink to this definition">¶</a></dt>
<dd><p>return the canonical column name for the indiv_util column or columns
in merged hh_chooser df for individual with cdap_rank pnum</p>
<p>e.g. M_p1, ptype_p2 but leave _hh_id_ column unchanged</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.assign_cdap_rank">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">assign_cdap_rank</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">person_type_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.assign_cdap_rank" title="Permalink to this definition">¶</a></dt>
<dd><p>Assign an integer index, cdap_rank, to each household member. (Starting with 1, not 0)</p>
<p>Modifies persons df in place</p>
<p>The cdap_rank order is important, because cdap only assigns activities to the first
MAX_HHSIZE persons in each household.</p>
<p>This will preferentially be two working adults and the three youngest children.</p>
<p>Rank is assigned starting at 1. This necessitates some care indexing, but is preferred as
it follows the convention of 1-based pnums in expression files.</p>
<p>According to the documentation of reOrderPersonsForCdap in mtctm2.abm.ctramp
HouseholdCoordinatedDailyActivityPatternModel:</p>
<p>“Method reorders the persons in the household for use with the CDAP model,
which only explicitly models the interaction of five persons in a HH. Priority
in the reordering is first given to full time workers (up to two), then to
part time workers (up to two workers, of any type), then to children (youngest
to oldest, up to three). If the method is called for a household with less
than 5 people, the cdapPersonArray is the same as the person array.”</p>
<p>We diverge from the above description in that a cdap_rank is assigned to all persons,
including ‘extra’ household members, whose activity is assigned subsequently.
The pair _hh_id_, cdap_rank will uniquely identify each household member.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data. Must contain columns _hh_size_, _hh_id_, _ptype_, _age_</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>cdap_rank</strong><span class="classifier">pandas.Series</span></dt><dd><p>integer cdap_rank of every person, indexed on _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.build_cdap_spec">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">build_cdap_spec</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.build_cdap_spec" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a spec file for computing utilities of alternative household member interaction patterns
for households of specified size.</p>
<p>We generate this spec automatically from a table of rules and coefficients because the
interaction rules are fairly simple and can be expressed compactly whereas
there is a lot of redundancy between the spec files for different household sizes, as well as
in the vectorized expression of the interaction alternatives within the spec file itself</p>
<dl class="simple">
<dt>interaction_coefficients has five columns:</dt><dd><dl class="simple">
<dt>activity</dt><dd><p>A single character activity type name (M, N, or H)</p>
</dd>
<dt>interaction_ptypes</dt><dd><p>List of ptypes in the interaction (in order of increasing ptype) or empty for wildcards
(meaning that the interaction applies to all ptypes in that size hh)</p>
</dd>
<dt>cardinality</dt><dd><p>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</p>
</dd>
<dt>slug</dt><dd><p>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is replaced with the numerical coefficient value after we dump the trace file</p>
</dd>
<dt>coefficient</dt><dd><p>The coefficient to apply for all hh interactions for this activity and set of ptypes</p>
</dd>
</dl>
</dd>
</dl>
<p>The generated spec will have the eval expression in the index, and a utility column for each
alternative (e.g. [‘HH’, ‘HM’, ‘HN’, ‘MH’, ‘MM’, ‘MN’, ‘NH’, ‘NM’, ‘NN’] for hhsize 2)</p>
<p>In order to be able to dump the spec in a human-friendly fashion to facilitate debugging the
cdap_interaction_coefficients table, we first populate utility columns in the spec file
with the coefficient slugs, dump the spec file, and then replace the slugs with coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>household size for which the spec should be built.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>spec: pandas.DataFrame</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.extra_hh_member_choices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">extra_hh_member_choices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_fixed_relative_proportions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.extra_hh_member_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate the activity choices for the ‘extra’ household members who weren’t handled by cdap</p>
<p>Following the CTRAMP HouseholdCoordinatedDailyActivityPatternModel, “a separate,
simple cross-sectional distribution is looked up for the remaining household members”</p>
<p>The cdap_fixed_relative_proportions spec is handled like an activitysim logit utility spec,
EXCEPT that the values computed are relative proportions, not utilities
(i.e. values are not exponentiated before being normalized to probabilities summing to 1.0)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><dl class="simple">
<dt>Table of persons data indexed on _persons_index_</dt><dd><p>We expect, at least, columns [_hh_id_, _ptype_]</p>
</dd>
</dl>
</dd>
<dt><strong>cdap_fixed_relative_proportions</strong></dt><dd><p>spec to compute/specify the relative proportions of each activity (M, N, H)
that should be used to choose activities for additional household members
not handled by CDAP.</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>dictionary of local variables that eval_variables adds to the environment
for an evaluation of an expression that begins with &#64;</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>list of alternatives chosen for all extra members, indexed by _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.hh_choosers">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">hh_choosers</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indiv_utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.hh_choosers" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a chooser table for calculating house utilities for all households of specified hhsize</p>
<p>The choosers table will have one row per household with columns containing the indiv_utils
for all non-extra (i.e. cdap_rank &lt;- MAX_HHSIZE) persons. That makes 3 columns for each
individual. e.g. the utilities of person with cdap_rank 1 will be included as M_p1, N_p1, H_p1</p>
<p>The chooser table will also contain interaction columns for all possible interactions involving
from 2 to 3 persons (actually MAX_INTERACTION_CARDINALITY, which is currently 3).</p>
<p>The interaction columns list the ptypes of the persons in the interaction set, sorted by ptype.
For instance the interaction between persons with cdap_rank 1 and three and ptypes will
be listed in a column named ‘p1_p3’ and for a household where persons p1 and p3 are 2 and 4
will a row value of 24 in the p1_p3 column.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>indiv_utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP utilities for each individual, ignoring interactions.
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>household size for which the choosers table should be built. Households with more than
MAX_HHSIZE members will be included with MAX_HHSIZE choosers since the are handled the
same, and the activities of the extra members are assigned afterwards</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choosers</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>choosers households of hhsize with activity utility columns interaction columns
for all (non-extra) household members</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.household_activity_choices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">household_activity_choices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indiv_utils</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hhsize</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.household_activity_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate household utilities for each activity pattern alternative for households of hhsize
The resulting activity pattern for each household will be coded as a string of activity codes.
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>indiv_utils</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP utilities for each individual, ignoring interactions
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</dd>
<dt><strong>interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>hhsize</strong><span class="classifier">int</span></dt><dd><p>the size of household for which activity perttern should be calculated (1..MAX_HHSIZE)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>the chosen cdap activity pattern for each household represented as a string (e.g. ‘MNH’)
with same index (_hh_index_) as utils</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.individual_utilities">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">individual_utilities</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_indiv_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.individual_utilities" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate CDAP utilities for all individuals.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>DataFrame of individual persons data.</p>
</dd>
<dt><strong>cdap_indiv_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP spec applied to individuals.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>utilities</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Will have index of <cite>persons</cite> and columns for each of the alternatives.
plus some ‘useful columns’ [_hh_id_, _ptype_, ‘cdap_rank’, _hh_size_]</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.preprocess_interaction_coefficients">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">preprocess_interaction_coefficients</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">interaction_coefficients</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.preprocess_interaction_coefficients" title="Permalink to this definition">¶</a></dt>
<dd><p>The input cdap_interaction_coefficients.csv file has three columns:</p>
<dl class="simple">
<dt>activity</dt><dd><p>A single character activity type name (M, N, or H)</p>
</dd>
<dt>interaction_ptypes</dt><dd><p>List of ptypes in the interaction (in order of increasing ptype)
Stars <cite>(***)</cite> instead of ptypes means the interaction applies to all ptypes in that size hh.</p>
</dd>
<dt>coefficient</dt><dd><p>The coefficient to apply for all hh interactions for this activity and set of ptypes</p>
</dd>
</dl>
<p>To facilitate building the spec for a given hh ssize, we add two additional columns:</p>
<dl class="simple">
<dt>cardinality</dt><dd><p>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</p>
</dd>
<dt>slug</dt><dd><p>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is then replaced with the numerical coefficient value prior to evaluation</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.run_cdap">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">run_cdap</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">person_type_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_indiv_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_interaction_coefficients</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cdap_fixed_relative_proportions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.run_cdap" title="Permalink to this definition">¶</a></dt>
<dd><p>Choose individual activity patterns for persons.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data. Must contain at least a household ID, household size,
person type category, and age, plus any columns used in cdap_indiv_spec</p>
</dd>
<dt><strong>cdap_indiv_spec</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>CDAP spec for individuals without taking any interactions into account.</p>
</dd>
<dt><strong>cdap_interaction_coefficients</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd>
<dt><strong>cdap_fixed_relative_proportions</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Spec to for the relative proportions of each activity (M, N, H)
to choose activities for additional household members not handled by CDAP</p>
</dd>
<dt><strong>locals_d</strong><span class="classifier">Dict</span></dt><dd><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;
in either the cdap_indiv_spec or cdap_fixed_relative_proportions expression files</p>
</dd>
<dt><strong>chunk_size: int</strong></dt><dd><p>Chunk size or 0 for no chunking</p>
</dd>
<dt><strong>trace_hh_id</strong><span class="classifier">int</span></dt><dd><p>hh_id to trace or None if no hh tracing</p>
</dd>
<dt><strong>trace_label</strong><span class="classifier">str</span></dt><dd><p>label for tracing or None if no tracing</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>choices</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>dataframe is indexed on _persons_index_ and has two columns:</p>
<dl class="simple">
<dt>cdap_activity<span class="classifier">str</span></dt><dd><p>activity for that person expressed as ‘M’, ‘N’, ‘H’</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.cdap.</span></code><code class="sig-name descname"><span class="pre">unpack_cdap_indiv_activity_choices</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hh_choices</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_hh_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Unpack the household activity choice list into choices for each (non-extra) household member</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>Table of persons data indexed on _persons_index_
We expect, at least, columns [_hh_id_, ‘cdap_rank’]</p>
</dd>
<dt><strong>hh_choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>household activity pattern is encoded as a string (of length hhsize) of activity codes
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>cdap_indiv_activity_choices</strong><span class="classifier">pandas.Series</span></dt><dd><p>series contains one activity per individual hh member, indexed on _persons_index_</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="estimation">
<span id="table-annotation"></span><span id="index-2"></span><h3>Estimation<a class="headerlink" href="#estimation" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="estimation.html#estimation"><span class="std std-ref">Estimation</span></a> for more information.</p>
<span class="target" id="module-activitysim.abm.models.util.estimation"></span></div>
<div class="section" id="module-activitysim.abm.models.util.logsums">
<span id="logsums"></span><h3>Logsums<a class="headerlink" href="#module-activitysim.abm.models.util.logsums" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.logsums.compute_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.logsums.</span></code><code class="sig-name descname"><span class="pre">compute_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.logsums.compute_logsums" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>tour_purpose</strong></dt><dd></dd>
<dt><strong>logsum_settings</strong></dt><dd></dd>
<dt><strong>model_settings</strong></dt><dd></dd>
<dt><strong>network_los</strong></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>trace_hh_id</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>logsums: pandas series</dt><dd><p>computed logsums with same index as choosers</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.mode">
<span id="mode"></span><h3>Mode<a class="headerlink" href="#module-activitysim.abm.models.util.mode" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.mode.mode_choice_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.mode.</span></code><code class="sig-name descname"><span class="pre">mode_choice_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nest_spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_d</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_column_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>common method for  both tour_mode_choice and trip_mode_choice</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>choosers</strong></dt><dd></dd>
<dt><strong>spec</strong></dt><dd></dd>
<dt><strong>nest_spec</strong></dt><dd></dd>
<dt><strong>skims</strong></dt><dd></dd>
<dt><strong>locals_d</strong></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>mode_column_name</strong></dt><dd></dd>
<dt><strong>logsum_column_name</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
<dt><strong>trace_choice_name</strong></dt><dd></dd>
<dt><strong>estimator</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.mode.run_tour_mode_choice_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.mode.</span></code><code class="sig-name descname"><span class="pre">run_tour_mode_choice_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">choosers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">constants</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_choice_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.run_tour_mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>This is a utility to run a mode choice model for each segment (usually
segments are tour/trip purposes).  Pass in the tours/trip that need a mode,
the Skim object, the spec to evaluate with, and any additional expressions
you want to use in the evaluation of variables.</p>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.overlap">
<span id="overlap"></span><h3>Overlap<a class="headerlink" href="#module-activitysim.abm.models.util.overlap" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.overlap.p2p_time_window_overlap">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.overlap.</span></code><code class="sig-name descname"><span class="pre">p2p_time_window_overlap</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">p1_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p2_ids</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.overlap.p2p_time_window_overlap" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>p1_ids</strong></dt><dd></dd>
<dt><strong>p2_ids</strong></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.overlap.rle">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.overlap.</span></code><code class="sig-name descname"><span class="pre">rle</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">a</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.overlap.rle" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute run lengths of values in rows of a two dimensional ndarry of ints.</p>
<p>We assume the first and last columns are buffer columns
(because this is the case for time windows)  and so don’t include them in results.</p>
<p>Return arrays giving row_id, start_pos, run_length, and value of each run of any length.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>a</strong><span class="classifier">numpy.ndarray of int shape(n, &lt;num_time_periods_in_a_day&gt;)</span></dt><dd><p>The input array would normally only have values of 0 or 1 to detect overlapping
time period availability but we don’t assume this, and will detect and report
runs of any values. (Might prove useful in future?…)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>row_id</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>start_pos</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>run_length</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
<dt><strong>run_val</strong><span class="classifier">numpy.ndarray int shape(&lt;num_runs&gt;)</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.tour_destination">
<span id="tour-destination"></span><h3>Tour Destination<a class="headerlink" href="#module-activitysim.abm.models.util.tour_destination" title="Permalink to this headline">¶</a></h3>
<dl class="py class">
<dt id="activitysim.abm.models.util.tour_destination.SizeTermCalculator">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></code><code class="sig-name descname"><span class="pre">SizeTermCalculator</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">size_term_selector</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.SizeTermCalculator" title="Permalink to this definition">¶</a></dt>
<dd><p>convenience object to provide size_terms for a selector (e.g. non_mandatory)
for various segments (e.g. tour_type or purpose)
returns size terms for specified segment in df or series form</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_destination.choose_MAZ_for_TAZ">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></code><code class="sig-name descname"><span class="pre">choose_MAZ_for_TAZ</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">taz_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">MAZ_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.choose_MAZ_for_TAZ" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert taz_sample table with TAZ zone sample choices to a table with a MAZ zone chosen for each TAZ
choose MAZ probabilistically (proportionally by size_term) from set of MAZ zones in parent TAZ</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>taz_sample: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: &lt;DEST_TAZ&gt;, prob, pick_count</strong></dt><dd></dd>
<dt><strong>MAZ_size_terms: dataframe with duplicated index &lt;chooser_id_col&gt; and columns: zone_id, dest_TAZ, size_term</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>dataframe with with duplicated index &lt;chooser_id_col&gt; and columns: &lt;DEST_MAZ&gt;, prob, pick_count</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_destination.run_destination_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></code><code class="sig-name descname"><span class="pre">run_destination_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.run_destination_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>add logsum column to existing tour_destination_sample table</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_zone_id) pair
in destination_sample, and computing the logsum of all the utilities</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 20%" />
<col style="width: 23%" />
<col style="width: 17%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>person_id</p></th>
<th class="head"><p>dest_zone_id</p></th>
<th class="head"><p>rand</p></th>
<th class="head"><p>pick_count</p></th>
<th class="head"><p>logsum (added)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>23750</p></td>
<td><p>14</p></td>
<td><p>0.565502716034</p></td>
<td><p>4</p></td>
<td><p>1.85659498857</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>23750</p></td>
<td rowspan="2"><p>16</p></td>
<td rowspan="2"><p>0.711135838871</p></td>
<td rowspan="2"><p>6</p></td>
<td rowspan="2"><p>1.92315598631</p></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2"><p>…</p></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
<td rowspan="2"></td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td><p>23751</p></td>
<td><p>12</p></td>
<td><p>0.408038878552</p></td>
<td><p>1</p></td>
<td><p>2.40612135416</p></td>
</tr>
<tr class="row-even"><td><p>23751</p></td>
<td><p>14</p></td>
<td><p>0.972732479292</p></td>
<td><p>2</p></td>
<td><p>1.44009018355</p></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_destination.run_destination_simulate">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_destination.</span></code><code class="sig-name descname"><span class="pre">run_destination_simulate</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec_segment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_sample</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">want_logsums</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network_los</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination_size_terms</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_destination.run_destination_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>run destination_simulate on tour_destination_sample
annotated with mode_choice logsum to select a destination from sample alternatives</p>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.tour_frequency">
<span id="tour-frequency"></span><h3>Tour Frequency<a class="headerlink" href="#module-activitysim.abm.models.util.tour_frequency" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.create_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">create_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_category</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">parent_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'person_id'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.create_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the tours that were generated</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tour_counts: DataFrame</strong></dt><dd><p>table specifying how many tours of each type to create
one row per person (or parent_tour for atwork subtours)
one (int) column per tour_type, with number of tours to create</p>
</dd>
<dt><strong>tour_category</strong><span class="classifier">str</span></dt><dd><p>one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
<p>tours.tour_type       - tour type (e.g. school, work, shopping, eat)
tours.tour_type_num   - if there are two ‘school’ type tours, they will be numbered 1 and 2
tours.tour_type_count - number of tours of tour_type parent has (parent’s max tour_type_num)
tours.tour_num        - index of tour (of any type) for parent
tours.tour_count      - number of tours of any type) for parent (parent’s max tour_num)
tours.tour_category   - one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.process_atwork_subtours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">process_atwork_subtours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">work_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atwork_subtour_frequency_alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_atwork_subtours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the atwork_subtour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the subtours tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>work_tours: DataFrame</strong></dt><dd><p>A series which has parent work tour tour_id as the index and
columns with person_id and atwork_subtour_frequency.</p>
</dd>
<dt><strong>atwork_subtour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index with atwork_subtour_frequency values
and frequency counts for the subtours to be generated for that choice</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.process_joint_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">process_joint_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">joint_tour_frequency</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joint_tour_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">point_persons</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_joint_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the joint_tour_frequency column that comes out of
the model of the same name and turns into a DataFrame that represents the
joint tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>joint_tour_frequency</strong><span class="classifier">pandas.Series</span></dt><dd><p>household joint_tour_frequency (which came out of the joint tour frequency model)
indexed by household_id</p>
</dd>
<dt><strong>joint_tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index with joint_tour_frequency values
and frequency counts for the tours to be generated for that choice</p>
</dd>
<dt><strong>point_persons</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>table with columns for (at least) person_ids and home_zone_id indexed by household_id</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a tour identifier, a household_id
column, a tour_type column and tour_type_num and tour_num columns
which is set to 1 or 2 depending whether it is the first or second joint tour
made by the household.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.process_mandatory_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">process_mandatory_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mandatory_tour_frequency_alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_mandatory_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the mandatory_tour_frequency column that comes out of
the model of the same name and turns into a DataFrame that represents the
mandatory tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons</strong><span class="classifier">DataFrame</span></dt><dd><p>Persons is a DataFrame which has a column call
mandatory_tour_frequency (which came out of the mandatory tour
frequency model) and a column is_worker which indicates the person’s
worker status.  The only valid values of the mandatory_tour_frequency
column to take are “work1”, “work2”, “school1”, “school2” and
“work_and_school”</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a tour identifier, a person_id
column, a tour_type column which is “work” or “school” and a tour_num
column which is set to 1 or 2 depending whether it is the first or
second mandatory tour made by the person.  The logic for whether the
work or school tour comes first given a “work_and_school” choice
depends on the is_worker column: work tours first for workers, second for non-workers</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">process_non_mandatory_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">persons</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_counts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the non_mandatory_tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the non mandatory tours that were generated</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>persons: pandas.DataFrame</strong></dt><dd><p>persons table containing a non_mandatory_tour_frequency column
which has the index of the chosen alternative as the value</p>
</dd>
<dt><strong>non_mandatory_tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.tour_frequency.process_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.tour_frequency.</span></code><code class="sig-name descname"><span class="pre">process_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tour_frequency</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_frequency_alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_category</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">parent_col</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'person_id'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the tours that were generated</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tour_frequency: Series</strong></dt><dd><p>A series which has &lt;parent_col&gt; as the index and the chosen alternative
index as the value</p>
</dd>
<dt><strong>tour_frequency_alts: DataFrame</strong></dt><dd><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</dd>
<dt><strong>tour_category</strong><span class="classifier">str</span></dt><dd><p>one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
<dt><strong>parent_col: str</strong></dt><dd><p>the name of the index (parent_tour_id for atwork subtours, otherwise person_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>tours</strong><span class="classifier">pandas.DataFrame</span></dt><dd><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
<p>tours.tour_type       - tour type (e.g. school, work, shopping, eat)
tours.tour_type_num   - if there are two ‘school’ type tours, they will be numbered 1 and 2
tours.tour_type_count - number of tours of tour_type parent has (parent’s max tour_type_num)
tours.tour_num        - index of tour (of any type) for parent
tours.tour_count      - number of tours of any type) for parent (parent’s max tour_num)
tours.tour_category   - one of ‘mandatory’, ‘non_mandatory’, ‘atwork’, or ‘joint’</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.trip">
<span id="trip"></span><h3>Trip<a class="headerlink" href="#module-activitysim.abm.models.util.trip" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.trip.cleanup_failed_trips">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></code><code class="sig-name descname"><span class="pre">cleanup_failed_trips</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.cleanup_failed_trips" title="Permalink to this definition">¶</a></dt>
<dd><p>drop failed trips and cleanup fields in leg_mates:</p>
<p>trip_num        assign new ordinal trip num after failed trips are dropped
trip_count      assign new count of trips in leg, sans failed trips
first           update first flag as we may have dropped first trip (last trip can’t fail)
next_trip_id    assign id of next trip in leg after failed trips are dropped</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.trip.flag_failed_trip_leg_mates">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></code><code class="sig-name descname"><span class="pre">flag_failed_trip_leg_mates</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">trips_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">col_name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.flag_failed_trip_leg_mates" title="Permalink to this definition">¶</a></dt>
<dd><p>set boolean flag column of specified name to identify failed trip leg_mates in place</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.trip.generate_alternative_sizes">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></code><code class="sig-name descname"><span class="pre">generate_alternative_sizes</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_duration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_trips</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.generate_alternative_sizes" title="Permalink to this definition">¶</a></dt>
<dd><p>Builds a lookup Numpy array pattern sizes based on the
number of trips in the leg and the duration available
to the leg.
:param max_duration:
:param max_trips:
:return:</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.trip.get_time_windows">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.trip.</span></code><code class="sig-name descname"><span class="pre">get_time_windows</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">residual</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">level</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.trip.get_time_windows" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>residual</strong> – </p></li>
<li><p><strong>level</strong> – </p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.vectorize_tour_scheduling">
<span id="vectorize-tour-scheduling"></span><h3>Vectorize Tour Scheduling<a class="headerlink" href="#module-activitysim.abm.models.util.vectorize_tour_scheduling" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.compute_logsums">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">compute_logsums</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alt_tdd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tours_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.compute_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute logsums for the tour alt_tdds, which will differ based on their different start, stop
times of day, which translate to different odt_skim out_period and in_periods.</p>
<p>In mtctm1, tdds are hourly, but there are only 5 skim time periods, so some of the tdd_alts
will be the same, once converted to skim time periods. With 5 skim time periods there are
15 unique out-out period pairs but 190 tdd alternatives.</p>
<p>For efficiency, rather compute a lot of redundant logsums, we compute logsums for the unique
(out-period, in-period) pairs and then join them back to the alt_tdds.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">get_previous_tour_by_tourid</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">current_tour_window_ids</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">previous_tour_by_window_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid" title="Permalink to this definition">¶</a></dt>
<dd><p>Matches current tours with attributes of previous tours for the same
person.  See the return value below for more information.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>current_tour_window_ids</strong><span class="classifier">Series</span></dt><dd><p>A Series of parent ids for the tours we’re about make the choice for
- index should match the tours DataFrame.</p>
</dd>
<dt><strong>previous_tour_by_window_id</strong><span class="classifier">Series</span></dt><dd><p>A Series where the index is the parent (window) id and the value is the index
of the alternatives of the scheduling.</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>The alternatives of the scheduling.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>prev_alts</strong><span class="classifier">DataFrame</span></dt><dd><p>A DataFrame with an index matching the CURRENT tours we’re making a
decision for, but with columns from the PREVIOUS tour of the person
associated with each of the CURRENT tours.  Columns listed in PREV_TOUR_COLUMNS
from the alternatives will have “_previous” added as a suffix to keep
differentiated from the current alternatives that will be part of the
interaction.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.run_alts_preprocessor">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">run_alts_preprocessor</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">segment</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">locals_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.run_alts_preprocessor" title="Permalink to this definition">¶</a></dt>
<dd><p>run preprocessor on alts, as specified by ALTS_PREPROCESSOR in model_settings</p>
<p>we are agnostic on whether alts are merged or not</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_settings: dict</strong></dt><dd><p>yaml model settings file as dict</p>
</dd>
<dt><strong>alts: pandas.DataFrame</strong></dt><dd><p>tdd_alts or tdd_alts merged wiht choosers (we are agnostic)</p>
</dd>
<dt><strong>segment: string</strong></dt><dd><p>segment selector as understood by caller (e.g. logsum_tour_purpose)</p>
</dd>
<dt><strong>locals_dict: dict</strong></dt><dd><p>we let caller worry about what needs to be in it. though actually depends on modelers needs</p>
</dd>
<dt><strong>trace_label: string</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>alts: pandas.DataFrame</dt><dd><p>annotated copy of alts</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">schedule_tours</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logsum_tour_purpose</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable_window_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">previous_tour</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_owner_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>chunking wrapper for _schedule_tours</p>
<p>While interaction_sample_simulate provides chunking support, the merged tours, persons
dataframe and the tdd_interaction_dataset are very big, so we want to create them inside
the chunking loop to minimize memory footprint. So we implement the chunking loop here,
and pass a chunk_size of 0 to interaction_sample_simulate to disable its chunking support.</p>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">tdd_interaction_dataset</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choice_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">window_id_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset" title="Permalink to this definition">¶</a></dt>
<dd><p>interaction_sample_simulate expects
alts index same as choosers (e.g. tour_id)
name of choice column in alts</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>must have person_id column and index on tour_id</p>
</dd>
<dt><strong>alts</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>alts index must be timetable tdd id</p>
</dd>
<dt><strong>timetable</strong><span class="classifier">TimeTable object</span></dt><dd></dd>
<dt><strong>choice_column</strong><span class="classifier">str</span></dt><dd><p>name of column to store alt index in alt_tdd DataFrame
(since alt_tdd is duplicate index on person_id but unique on person_id,alt_id)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>alt_tdd</strong><span class="classifier">pandas DataFrame</span></dt><dd><p>columns: start, end , duration, &lt;choice_column&gt;
index: tour_id</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_joint_tour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">vectorize_joint_tour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">joint_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joint_tour_participants</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_joint_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>Like vectorize_tour_scheduling but specifically for joint tours</p>
<p>joint tours have a few peculiarities necessitating separate treatment:</p>
<p>Timetable has to be initialized to set all timeperiods…</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of tours containing tour attributes, as well as a person_id
column to define the nth tour for each person.</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(or dict of specs keyed on tour_type if tour_types is not None)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the tours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
<dt><strong>persons_timetable</strong><span class="classifier">TimeTable</span></dt><dd><p>timetable updated with joint tours (caller should replace_table for it to persist)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">vectorize_subtour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subtours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spec</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>Like vectorize_tour_scheduling but specifically for atwork subtours</p>
<p>subtours have a few peculiarities necessitating separate treatment:</p>
<p>Timetable has to be initialized to set all timeperiods outside parent tour footprint as
unavailable. So atwork subtour timewindows are limited to the footprint of the parent work
tour. And parent_tour_id’ column of tours is used instead of parent_id as timetable row_id.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>parent_tours</strong><span class="classifier">DataFrame</span></dt><dd><p>parent tours of the subtours (because we need to know the tdd of the parent tour to
assign_subtour_mask of timetable indexed by parent_tour id</p>
</dd>
<dt><strong>subtours</strong><span class="classifier">DataFrame</span></dt><dd><p>atwork subtours to schedule</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(all subtours share same spec regardless of subtour type)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
<dt><strong>chunk_size</strong></dt><dd></dd>
<dt><strong>trace_label</strong></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the subtours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling">
<code class="sig-prename descclassname"><span class="pre">activitysim.abm.models.util.vectorize_tour_scheduling.</span></code><code class="sig-name descname"><span class="pre">vectorize_tour_scheduling</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tours</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">persons_merged</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timetable</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_segments</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tour_segment_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_settings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trace_label</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>The purpose of this method is fairly straightforward - it takes tours
and schedules them into time slots.  Alternatives should be specified so
as to define those time slots (usually with start and end times).</p>
<p>schedule_tours adds variables that can be used in the spec which have
to do with the previous tours per person.  Every column in the
alternatives table is appended with the suffix “_previous” and made
available.  So if your alternatives table has columns for start and end,
then start_previous and end_previous will be set to the start and end of
the most recent tour for a person.  The first time through,
start_previous and end_previous are undefined, so make sure to protect
with a tour_num &gt;= 2 in the variable computation.</p>
<p>FIXME - fix docstring: tour_segments, tour_segment_col</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>tours</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of tours containing tour attributes, as well as a person_id
column to define the nth tour for each person.</p>
</dd>
<dt><strong>persons_merged</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</dd>
<dt><strong>alts</strong><span class="classifier">DataFrame</span></dt><dd><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</dd>
<dt><strong>spec</strong><span class="classifier">DataFrame</span></dt><dd><p>The spec which will be passed to interaction_simulate.
(or dict of specs keyed on tour_type if tour_types is not None)</p>
</dd>
<dt><strong>model_settings</strong><span class="classifier">dict</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>choices</strong><span class="classifier">Series</span></dt><dd><p>A Series of choices where the index is the index of the tours
DataFrame and the values are the index of the alts DataFrame.</p>
</dd>
<dt><strong>timetable</strong><span class="classifier">TimeTable</span></dt><dd><p>persons timetable updated with tours (caller should replace_table for it to persist)</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h2>
<p>See <code class="docutils literal notranslate"><span class="pre">activitysim.abm.test</span></code> and <code class="docutils literal notranslate"><span class="pre">activitysim.abm.models.util.test</span></code></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="core.html" class="btn btn-neutral float-right" title="Core Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright contributing authors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>