

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Models &mdash; ActivitySim 0.5.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="ActivitySim 0.5.1 documentation" href="index.html"/>
        <link rel="next" title="Development" href="development.html"/>
        <link rel="prev" title="Core Components" href="core.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> ActivitySim
          

          
          </a>

          
            
            
              <div class="version">
                0.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="abmexample.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="howitworks.html">How the System Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataschema.html">Data Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="core.html">Core Components</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#initialize">Initialize</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-activitysim.abm.models.initialize">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#accessibility">Accessibility</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#school-location">School Location</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#workplace-location">Workplace Location</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#auto-ownership">Auto Ownership</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#coordinated-daily-activity-pattern">Coordinated Daily Activity Pattern</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">cdap</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-activitysim.abm.models.util.cdap">util.cdap</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mandatory-tour-frequency">Mandatory Tour Frequency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mandatory-tour-scheduling">Mandatory Tour Scheduling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-frequency">Non-Mandatory Tour Frequency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id16">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-destination-choice">Non-Mandatory Tour Destination Choice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#annotate-table">Annotate Table</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id20">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#non-mandatory-tour-scheduling">Non-Mandatory Tour Scheduling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id22">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tour-mode">Tour Mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id23">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtours-frequency">At-work Subtours Frequency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id24">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtours-destination-choice">At-work Subtours Destination Choice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#at-work-subtour-location-sample">At-work Subtour Location Sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="#at-work-subtour-logsums">At-work Subtour Logsums</a></li>
<li class="toctree-l3"><a class="reference internal" href="#at-work-subtour-location">At-work Subtour Location</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtour-scheduling">At-work Subtour Scheduling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id26">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#at-work-subtour-mode">At-work Subtour Mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id27">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create-trips">Create Trips</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id28">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#trip-mode">Trip Mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#util">Util</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id30">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tests">Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ActivitySim</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/models.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="models">
<h1>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h1>
<p>The currently implemented example ActivitySim AB models are described below.</p>
<div class="section" id="initialize">
<span id="id1"></span><h2>Initialize<a class="headerlink" href="#initialize" title="Permalink to this headline">¶</a></h2>
<p>The initialize model isn’t really a model, but a step in the data pipeline.  This step pre-loads the land_use,
households, persons, and person_windows tables because random seeds are set differently for each step
and therefore the sampling of households depends on which step they are initially loaded in.  So, we
load them explicitly up front.</p>
<p>The main interface to the initialize model is the <a class="reference internal" href="#activitysim.abm.models.initialize.initialize" title="activitysim.abm.models.initialize.initialize"><code class="xref py py-func docutils literal"><span class="pre">initialize()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<div class="section" id="module-activitysim.abm.models.initialize">
<span id="api"></span><h3>API<a class="headerlink" href="#module-activitysim.abm.models.initialize" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="activitysim.abm.models.initialize.initialize">
<code class="descclassname">activitysim.abm.models.initialize.</code><code class="descname">initialize</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize.initialize" title="Permalink to this definition">¶</a></dt>
<dd><p>Because random seed is set differently for each step, the sampling of households depends
on which step they are initially loaded in.</p>
<p>We load them explicitly up front, so that</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.initialize.preload_injectables">
<code class="descclassname">activitysim.abm.models.initialize.</code><code class="descname">preload_injectables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.initialize.preload_injectables" title="Permalink to this definition">¶</a></dt>
<dd><p>called after pipeline is</p>
</dd></dl>

</div>
</div>
<div class="section" id="accessibility">
<span id="id2"></span><h2>Accessibility<a class="headerlink" href="#accessibility" title="Permalink to this headline">¶</a></h2>
<p>The accessibilities model is an aggregate model that calculates multiple origin-based accessibility
measures by origin zone to all destination zones.</p>
<p>The accessibility measure first multiplies an employment variable by a mode-specific decay function.  The
product reflects the difficulty of accessing the activities the farther (in terms of round-trip travel time)
the jobs are from the location in question. The products to each destination zone are next summed over
each origin zone, and the logarithm of the product mutes large differences.  The decay function on
the walk accessibility measure is steeper than automobile or transit.  The minimum accessibility is zero.</p>
<p>Level-of-service variables from three time periods are used, specifically the AM peak period (6 am to 10 am), the
midday period (10 am to 3 pm), and the PM peak period (3 pm to 7 pm).</p>
<p><em>Inputs</em></p>
<ul class="simple">
<li>Highway skims for the three periods.  Each skim is expected to include a table named “TOLLTIMEDA”, which is the drive alone in-vehicle travel time for automobiles willing to pay a “value” (time-savings) toll.</li>
<li>Transit skims for the three periods.  Each skim is expected to include the following tables: (i) “IVT”, in-vehicle time; (ii) “IWAIT”, initial wait time; (iii) “XWAIT”, transfer wait time; (iv) “WACC”, walk access time; (v) “WAUX”, auxiliary walk time; and, (vi) “WEGR”, walk egress time.</li>
<li>Zonal data with the following fields: (i) “TOTEMP”, total employment; (ii) “RETEMPN”, retail trade employment per the NAICS classification.</li>
</ul>
<p><em>Outputs</em></p>
<ul class="simple">
<li>taz, travel analysis zone number</li>
<li>autoPeakRetail, the accessibility by automobile during peak conditions to retail employment for this TAZ</li>
<li>autoPeakTotal, the accessibility by automobile during peak conditions to all employment</li>
<li>autoOffPeakRetail, the accessibility by automobile during off-peak conditions to retail employment</li>
<li>autoOffPeakTotal, the accessibility by automobile during off-peak conditions to all employment</li>
<li>transitPeakRetail, the accessibility by transit during peak conditions to retail employment</li>
<li>transitPeakTotal, the accessibility by transit during peak conditions to all employment</li>
<li>transitOffPeakRetail, the accessiblity by transit during off-peak conditions to retail employment</li>
<li>transitOffPeakTotal, the accessiblity by transit during off-peak conditions to all employment</li>
<li>nonMotorizedRetail, the accessibility by walking during all time periods to retail employment</li>
<li>nonMotorizedTotal, the accessibility by walking during all time periods to all employment</li>
</ul>
<p>The main interface to the accessibility model is the
<a class="reference internal" href="#activitysim.abm.models.accessibility.compute_accessibility" title="activitysim.abm.models.accessibility.compute_accessibility"><code class="xref py py-func docutils literal"><span class="pre">compute_accessibility()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">skims</span></code> | Result Table: <code class="docutils literal"><span class="pre">accessibility</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">O-D,</span> <span class="pre">D-O</span></code></p>
<div class="section" id="id3">
<h3>API<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.accessibility"></span><dl class="class">
<dt id="activitysim.abm.models.accessibility.AccessibilitySkims">
<em class="property">class </em><code class="descclassname">activitysim.abm.models.accessibility.</code><code class="descname">AccessibilitySkims</code><span class="sig-paren">(</span><em>skim_dict</em>, <em>omx</em>, <em>length</em>, <em>transpose=False</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.accessibility.AccessibilitySkims" title="Permalink to this definition">¶</a></dt>
<dd><p>Wrapper for skim arrays to facilitate use of skims by accessibility model</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>skims</strong> : 2D array</p>
<p><strong>omx: open omx file object</strong></p>
<blockquote>
<div><p>this is only used to load skims on demand that were not preloaded</p>
</div></blockquote>
<p><strong>length: int</strong></p>
<blockquote>
<div><p>number of zones in skim to return in skim matrix
in case the skims contain additional external zones that should be trimmed out so skim
array is correct shape to match (flattened) O-D tiled columns in the od dataframe</p>
</div></blockquote>
<p><strong>transpose: bool</strong></p>
<blockquote class="last">
<div><p>whether to transpose the matrix before flattening. (i.e. act as a D-O instead of O-D skim)</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.accessibility.compute_accessibility">
<code class="descclassname">activitysim.abm.models.accessibility.</code><code class="descname">compute_accessibility</code><span class="sig-paren">(</span><em>settings</em>, <em>accessibility_spec</em>, <em>accessibility_settings</em>, <em>skim_dict</em>, <em>omx_file</em>, <em>land_use</em>, <em>trace_od</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.accessibility.compute_accessibility" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute accessibility for each zone in land use file using expressions from accessibility_spec</p>
<p>The actual results depend on the expressions in accessibility_spec, but this is initially
intended to permit implementation of the mtc accessibility calculation as implemented by
Accessibility.job</p>
<p>Compute measures of accessibility used by the automobile ownership model.
The accessibility measure first multiplies an employment variable by a mode-specific decay
function.  The product reflects the difficulty of accessing the activities the farther
(in terms of round-trip travel time) the jobs are from the location in question. The products
to each destination zone are next summed over each origin zone, and the logarithm of the
product mutes large differences.  The decay function on the walk accessibility measure is
steeper than automobile or transit.  The minimum accessibility is zero.</p>
</dd></dl>

</div>
</div>
<div class="section" id="school-location">
<span id="id4"></span><h2>School Location<a class="headerlink" href="#school-location" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>The school location model is made up of three model steps:</dt>
<dd><ul class="first last simple">
<li>school_location_sample - selects a sample of alternative school locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</li>
<li>school_location_logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative school location.</li>
<li>school_location_simulate - starts with the table created above and chooses a final school location, this time with the mode choice logsum included.</li>
</ul>
</dd>
</dl>
<p>The interfaces to the model steps are
<a class="reference internal" href="#activitysim.abm.models.school_location.school_location_sample" title="activitysim.abm.models.school_location.school_location_sample"><code class="xref py py-func docutils literal"><span class="pre">school_location_sample()</span></code></a>,
<a class="reference internal" href="#activitysim.abm.models.school_location.school_location_logsums" title="activitysim.abm.models.school_location.school_location_logsums"><code class="xref py py-func docutils literal"><span class="pre">school_location_logsums()</span></code></a>,
<a class="reference internal" href="#activitysim.abm.models.school_location.school_location_simulate" title="activitysim.abm.models.school_location.school_location_simulate"><code class="xref py py-func docutils literal"><span class="pre">school_location_simulate()</span></code></a>.
These functions are registered as orca steps in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal"><span class="pre">school_taz</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">TAZ,</span> <span class="pre">TAZ_r</span></code></p>
<div class="section" id="id5">
<h3>API<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.school_location"></span><dl class="function">
<dt id="activitysim.abm.models.school_location.school_location_logsums">
<code class="descclassname">activitysim.abm.models.school_location.</code><code class="descname">school_location_logsums</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>land_use</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>school_location_sample</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_location.school_location_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>add logsum column to existing school_location_sample able</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_taz) pair
in school_location_sample, and computing the logsum of all the utilities</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="25%" />
<col width="18%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">PERID</th>
<th class="head">dest_TAZ</th>
<th class="head">rand</th>
<th class="head">pick_count</th>
<th class="head">logsum (added)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>23750</td>
<td>14</td>
<td>0.565502716034</td>
<td>4</td>
<td>1.85659498857</td>
</tr>
<tr class="row-odd"><td rowspan="2">23750</td>
<td rowspan="2">16</td>
<td rowspan="2">0.711135838871</td>
<td rowspan="2">6</td>
<td rowspan="2">1.92315598631</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2">…</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td>23751</td>
<td>12</td>
<td>0.408038878552</td>
<td>1</td>
<td>2.40612135416</td>
</tr>
<tr class="row-even"><td>23751</td>
<td>14</td>
<td>0.972732479292</td>
<td>2</td>
<td>1.44009018355</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.school_location.school_location_sample">
<code class="descclassname">activitysim.abm.models.school_location.</code><code class="descname">school_location_sample</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>school_location_sample_spec</em>, <em>school_location_settings</em>, <em>skim_dict</em>, <em>destination_size_terms</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_location.school_location_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>build a table of persons * all zones to select a sample of alternative school locations.</p>
<p>PERID,  dest_TAZ, rand,            pick_count
23750,  14,       0.565502716034,  4
23750,  16,       0.711135838871,  6
…
23751,  12,       0.408038878552,  1
23751,  14,       0.972732479292,  2</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.school_location.school_location_simulate">
<code class="descclassname">activitysim.abm.models.school_location.</code><code class="descname">school_location_simulate</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>school_location_sample</em>, <em>school_location_spec</em>, <em>school_location_settings</em>, <em>skim_dict</em>, <em>destination_size_terms</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.school_location.school_location_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>School location model on school_location_sample annotated with mode_choice logsum
to select a school_taz from sample alternatives</p>
</dd></dl>

</div>
</div>
<div class="section" id="workplace-location">
<span id="work-location"></span><h2>Workplace Location<a class="headerlink" href="#workplace-location" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>The work location model is made up of three model steps:</dt>
<dd><ul class="first last simple">
<li>workplace_location_sample - selects a sample of alternative work locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</li>
<li>workplace_location_logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative work location.</li>
<li>workplace_location_simulate - starts with the table created above and chooses a final work location, this time with the mode choice logsum included.</li>
</ul>
</dd>
</dl>
<p>The interfaces to the model steps are
<a class="reference internal" href="#activitysim.abm.models.workplace_location.workplace_location_sample" title="activitysim.abm.models.workplace_location.workplace_location_sample"><code class="xref py py-func docutils literal"><span class="pre">workplace_location_sample()</span></code></a>,
<a class="reference internal" href="#activitysim.abm.models.workplace_location.workplace_location_logsums" title="activitysim.abm.models.workplace_location.workplace_location_logsums"><code class="xref py py-func docutils literal"><span class="pre">workplace_location_logsums()</span></code></a>,
<a class="reference internal" href="#activitysim.abm.models.workplace_location.workplace_location_simulate" title="activitysim.abm.models.workplace_location.workplace_location_simulate"><code class="xref py py-func docutils literal"><span class="pre">workplace_location_simulate()</span></code></a>.
These functions are registered as orca steps in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal"><span class="pre">workplace_taz</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">TAZ,</span> <span class="pre">TAZ_r</span></code></p>
<div class="section" id="id6">
<h3>API<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.workplace_location"></span><dl class="function">
<dt id="activitysim.abm.models.workplace_location.workplace_location_logsums">
<code class="descclassname">activitysim.abm.models.workplace_location.</code><code class="descname">workplace_location_logsums</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>land_use</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>workplace_location_sample</em>, <em>workplace_location_settings</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.workplace_location.workplace_location_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>add logsum column to existing workplace_location_sample able</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_taz) pair
in workplace_location_sample, and computing the logsum of all the utilities</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="25%" />
<col width="18%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">PERID</th>
<th class="head">dest_TAZ</th>
<th class="head">rand</th>
<th class="head">pick_count</th>
<th class="head">logsum (added)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>23750</td>
<td>14</td>
<td>0.565502716034</td>
<td>4</td>
<td>1.85659498857</td>
</tr>
<tr class="row-odd"><td rowspan="2">23750</td>
<td rowspan="2">16</td>
<td rowspan="2">0.711135838871</td>
<td rowspan="2">6</td>
<td rowspan="2">1.92315598631</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2">…</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td>23751</td>
<td>12</td>
<td>0.408038878552</td>
<td>1</td>
<td>2.40612135416</td>
</tr>
<tr class="row-even"><td>23751</td>
<td>14</td>
<td>0.972732479292</td>
<td>2</td>
<td>1.44009018355</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.workplace_location.workplace_location_sample">
<code class="descclassname">activitysim.abm.models.workplace_location.</code><code class="descname">workplace_location_sample</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>workplace_location_sample_spec</em>, <em>workplace_location_settings</em>, <em>skim_dict</em>, <em>destination_size_terms</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.workplace_location.workplace_location_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>build a table of workers * all zones in order to select a sample of alternative work locations.</p>
<p>PERID,  dest_TAZ, rand,            pick_count
23750,  14,       0.565502716034,  4
23750,  16,       0.711135838871,  6
…
23751,  12,       0.408038878552,  1
23751,  14,       0.972732479292,  2</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.workplace_location.workplace_location_simulate">
<code class="descclassname">activitysim.abm.models.workplace_location.</code><code class="descname">workplace_location_simulate</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>workplace_location_sample</em>, <em>workplace_location_spec</em>, <em>workplace_location_settings</em>, <em>skim_dict</em>, <em>destination_size_terms</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.workplace_location.workplace_location_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Workplace location model on workplace_location_sample annotated with mode_choice logsum
to select a work_taz from sample alternatives</p>
</dd></dl>

</div>
</div>
<div class="section" id="auto-ownership">
<span id="id7"></span><h2>Auto Ownership<a class="headerlink" href="#auto-ownership" title="Permalink to this headline">¶</a></h2>
<p>The auto ownership model selects a number of autos for each household in the simulation.</p>
<p>The main interface to the auto ownership model is the
<a class="reference internal" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="activitysim.abm.models.auto_ownership.auto_ownership_simulate"><code class="xref py py-func docutils literal"><span class="pre">auto_ownership_simulate()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">households</span></code> | Result Field: <code class="docutils literal"><span class="pre">auto_ownership</span></code> | Skims Keys: NA</p>
<div class="section" id="id8">
<h3>API<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.auto_ownership"></span><dl class="function">
<dt id="activitysim.abm.models.auto_ownership.auto_ownership_simulate">
<code class="descclassname">activitysim.abm.models.auto_ownership.</code><code class="descname">auto_ownership_simulate</code><span class="sig-paren">(</span><em>households_merged</em>, <em>auto_ownership_spec</em>, <em>auto_ownership_settings</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.auto_ownership.auto_ownership_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Auto ownership is a standard model which predicts how many cars a household
with given characteristics owns</p>
</dd></dl>

</div>
</div>
<div class="section" id="coordinated-daily-activity-pattern">
<span id="cdap"></span><h2>Coordinated Daily Activity Pattern<a class="headerlink" href="#coordinated-daily-activity-pattern" title="Permalink to this headline">¶</a></h2>
<p>The Coordinated Daily Activity Pattern (CDAP) model is a sequence of vectorized table operations:</p>
<ul class="simple">
<li>create a person level table and rank each person in the household for inclusion in the CDAP model</li>
<li>solve individual M/N/H utilities for each person</li>
<li>take as input an interaction coefficients table and then programatically produce and write out the expression files for households size 1, 2, 3, 4, and 5 models independent of one another</li>
<li>select households of size 1, join all required person attributes, and then read and solve the automatically generated expressions</li>
<li>repeat for households size 2, 3, 4, and 5. Each model is independent of one another.</li>
</ul>
<p>The main interface to the CDAP model is the <a class="reference internal" href="#activitysim.abm.models.util.cdap.run_cdap" title="activitysim.abm.models.util.cdap.run_cdap"><code class="xref py py-func docutils literal"><span class="pre">run_cdap()</span></code></a>
function.  This function is called by the orca step <code class="docutils literal"><span class="pre">cdap_simulate</span></code> which is
registered as an orca step in the example Pipeline.  There are two cdap class definitions in
ActivitySim.  The first is at <a class="reference internal" href="#module-activitysim.abm.models.cdap" title="activitysim.abm.models.cdap"><code class="xref py py-func docutils literal"><span class="pre">cdap()</span></code></a> and contains the orca
wrapper for running it as part of the model pipeline.  The second is
at <a class="reference internal" href="#module-activitysim.abm.models.util.cdap" title="activitysim.abm.models.util.cdap"><code class="xref py py-func docutils literal"><span class="pre">cdap()</span></code></a> and contains CDAP model logic.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">persons</span></code> | Result Field: <code class="docutils literal"><span class="pre">cdap_activity</span></code> | Skims Keys: NA</p>
<div class="section" id="id9">
<h3>API<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id10">
<h4>cdap<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<span class="target" id="module-activitysim.abm.models.cdap"></span><dl class="function">
<dt id="activitysim.abm.models.cdap.cdap_fixed_relative_proportions">
<code class="descclassname">activitysim.abm.models.cdap.</code><code class="descname">cdap_fixed_relative_proportions</code><span class="sig-paren">(</span><em>configs_dir</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_fixed_relative_proportions" title="Permalink to this definition">¶</a></dt>
<dd><p>spec to compute/specify the relative proportions of each activity (M, N, H)
that should be used to choose activities for additional household members
not handled by CDAP</p>
<p>This spec is handled much like an activitysim logit utility spec,
EXCEPT that the values computed are relative proportions, not utilities
(i.e. values are not exponentiated before being normalized to probabilities summing to 1.0)</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.cdap.cdap_indiv_spec">
<code class="descclassname">activitysim.abm.models.cdap.</code><code class="descname">cdap_indiv_spec</code><span class="sig-paren">(</span><em>configs_dir</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_indiv_spec" title="Permalink to this definition">¶</a></dt>
<dd><p>spec to compute the activity utilities for each individual hh member
with no interactions with other household members taken into account</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.cdap.cdap_interaction_coefficients">
<code class="descclassname">activitysim.abm.models.cdap.</code><code class="descname">cdap_interaction_coefficients</code><span class="sig-paren">(</span><em>configs_dir</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_interaction_coefficients" title="Permalink to this definition">¶</a></dt>
<dd><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.cdap.cdap_settings">
<code class="descclassname">activitysim.abm.models.cdap.</code><code class="descname">cdap_settings</code><span class="sig-paren">(</span><em>configs_dir</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_settings" title="Permalink to this definition">¶</a></dt>
<dd><p>canonical model settings file to permit definition of local constants for by
cdap_indiv_spec and cdap_fixed_relative_proportions</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.cdap.cdap_simulate">
<code class="descclassname">activitysim.abm.models.cdap.</code><code class="descname">cdap_simulate</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>cdap_settings</em>, <em>cdap_indiv_spec</em>, <em>cdap_interaction_coefficients</em>, <em>cdap_fixed_relative_proportions</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.cdap.cdap_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>CDAP stands for Coordinated Daily Activity Pattern, which is a choice of
high-level activity pattern for each person, in a coordinated way with other
members of a person’s household.</p>
<p>Because Python requires vectorization of computation, there are some specialized
routines in the cdap directory of activitysim for this purpose.  This module
simply applies those utilities using the simulation framework.</p>
</dd></dl>

</div>
<div class="section" id="module-activitysim.abm.models.util.cdap">
<span id="util-cdap"></span><h4>util.cdap<a class="headerlink" href="#module-activitysim.abm.models.util.cdap" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="activitysim.abm.models.util.cdap.add_interaction_column">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">add_interaction_column</code><span class="sig-paren">(</span><em>choosers</em>, <em>p_tup</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_interaction_column" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an interaction column in place to choosers, listing the ptypes of the persons in p_tup</p>
<p>The name of the interaction column will be determined by the cdap_ranks from p_tup,
and the rows in the column contain the ptypes of those persons in that household row.</p>
<p>For instance, for p_tup = (1,3) choosers interaction column name will be ‘p1_p3’</p>
<p>For a household where person 1 is part-time worker (ptype=2) and person 3 is infant (ptype 8)
the corresponding row value interaction code will be 28</p>
<p>We take advantage of the fact that interactions are symmetrical to simplify spec expressions:
We name the interaction_column in increasing pnum (cdap_rank) order (p1_p2 and not p3_p1)
And we format row values in increasing ptype order (28 and not 82)
This simplifies the spec expressions as we don’t have to test for p1_p3 == 28 | p1_p3 == 82</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>choosers</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>household choosers, indexed on _hh_index_
choosers should contain columns ptype_p1, ptype_p2 for each cdap_rank person in hh</p>
</div></blockquote>
<p><strong>p_tup</strong> : int tuple</p>
<blockquote class="last">
<div><p>tuple specifying the cdap_ranks for the interaction column
p_tup = (1,3) means persons with cdap_rank 1 and 3</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.add_pn">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">add_pn</code><span class="sig-paren">(</span><em>col</em>, <em>pnum</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.add_pn" title="Permalink to this definition">¶</a></dt>
<dd><p>return the canonical column name for the indiv_util column or columns
in merged hh_chooser df for individual with cdap_rank pnum</p>
<p>e.g. M_p1, ptype_p2 but leave _hh_id_ column unchanged</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.assign_cdap_rank">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">assign_cdap_rank</code><span class="sig-paren">(</span><em>persons</em>, <em>trace_hh_id=None</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.assign_cdap_rank" title="Permalink to this definition">¶</a></dt>
<dd><p>Assign an integer index, cdap_rank, to each household member. (Starting with 1, not 0)</p>
<p>Modifies persons df in place</p>
<p>The cdap_rank order is important, because cdap only assigns activities to the first
MAX_HHSIZE persons in each household.</p>
<p>This will preferentially be two working adults and the three youngest children.</p>
<p>Rank is assigned starting at 1. This necessitates some care indexing, but is preferred as
it follows the convention of 1-based pnums in expression files.</p>
<p>According to the documentation of reOrderPersonsForCdap in mtctm2.abm.ctramp
HouseholdCoordinatedDailyActivityPatternModel:</p>
<p>“Method reorders the persons in the household for use with the CDAP model,
which only explicitly models the interaction of five persons in a HH. Priority
in the reordering is first given to full time workers (up to two), then to
part time workers (up to two workers, of any type), then to children (youngest
to oldest, up to three). If the method is called for a household with less
than 5 people, the cdapPersonArray is the same as the person array.”</p>
<p>We diverge from the above description in that a cdap_rank is assigned to all persons,
including ‘extra’ householld members, whose activity is assigned subsequently.
The pair _hh_id_, cdap_rank will uniquely identify each household member.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Table of persons data. Must contain columns _hh_size_, _hh_id_, _ptype_, _age_</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>cdap_rank</strong> : pandas.Series</p>
<blockquote class="last">
<div><p>integer cdap_rank of every person, indexed on _persons_index_</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.build_cdap_spec">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">build_cdap_spec</code><span class="sig-paren">(</span><em>interaction_coefficients</em>, <em>hhsize</em>, <em>trace_spec=False</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.build_cdap_spec" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a spec file for computing utilities of alternative household member interaction patterns
for households of specified size.</p>
<p>We generate this spec automatically from a table of rules and coefficients because the
interaction rulkes are fairly simple and can be expressed compactly whereas
there is a lot of redundancy between the spec files for different household sizes, as well as
in the vectorized expression of the interaction alternatives within the spec file itself</p>
<dl class="docutils">
<dt>interaction_coefficients has five columns:</dt>
<dd><dl class="first last docutils">
<dt>activity</dt>
<dd>A single character activity type name (M, N, or H)</dd>
<dt>interaction_ptypes</dt>
<dd>List of ptypes in the interaction (in order of increasing ptype) or empty for wildcards
(meaning that the interaction applies to all ptypes in that size hh)</dd>
<dt>cardinality</dt>
<dd>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</dd>
<dt>slug</dt>
<dd>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is replaced with the numerical coefficient value after we dump the trace file</dd>
<dt>coefficient</dt>
<dd>The coefficient to apply for all hh interactions for this activity and set of ptypes</dd>
</dl>
</dd>
</dl>
<p>The generated spec will have the eval expression in the index, and a utility column for each
alternative (e.g. [‘HH’, ‘HM’, ‘HN’, ‘MH’, ‘MM’, ‘MN’, ‘NH’, ‘NM’, ‘NN’] for hhsize 2)</p>
<p>In order to be able to dump the spec in a human-friendly fashion to facilitate debugging the
cdap_interaction_coefficients table, we first populate utility columns in the spec file
with the coefficient slugs, dump the spec file, and then replace the slugs with coefficients.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>interaction_coefficients</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</div></blockquote>
<p><strong>hhsize</strong> : int</p>
<blockquote>
<div><p>household size for which the spec should be built.</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">spec: pandas.DataFrame</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.extra_hh_member_choices">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">extra_hh_member_choices</code><span class="sig-paren">(</span><em>persons</em>, <em>cdap_fixed_relative_proportions</em>, <em>locals_d</em>, <em>trace_hh_id</em>, <em>trace_label</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.extra_hh_member_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate the activity choices for the ‘extra’ household members who weren’t handled by cdap</p>
<p>Following the CTRAMP HouseholdCoordinatedDailyActivityPatternModel, “a separate,
simple cross-sectional distribution is looked up for the remaining household members”</p>
<p>The cdap_fixed_relative_proportions spec is handled like an activitysim logit utility spec,
EXCEPT that the values computed are relative proportions, not utilities
(i.e. values are not exponentiated before being normalized to probabilities summing to 1.0)</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : pandas.DataFrame</p>
<blockquote>
<div><dl class="docutils">
<dt>Table of persons data indexed on _persons_index_</dt>
<dd><p class="first last">We expect, at least, columns [_hh_id_, _ptype_]</p>
</dd>
</dl>
</div></blockquote>
<p><strong>cdap_fixed_relative_proportions</strong></p>
<blockquote>
<div><p>spec to compute/specify the relative proportions of each activity (M, N, H)
that should be used to choose activities for additional household members
not handled by CDAP.</p>
</div></blockquote>
<p><strong>locals_d</strong> : Dict</p>
<blockquote>
<div><p>dictionary of local variables that eval_variables adds to the environment
for an evaluation of an expression that begins with &#64;</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>choices</strong> : pandas.Series</p>
<blockquote class="last">
<div><p>list of alternatives chosen for all extra members, indexed by _persons_index_</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.hh_choosers">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">hh_choosers</code><span class="sig-paren">(</span><em>indiv_utils</em>, <em>hhsize</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.hh_choosers" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a chooser table for calculating house utilities for all households of specified hhsize</p>
<p>The choosers table will have one row per household with columns containing the indiv_utils
for all non-extra (i.e. cdap_rank &lt;- MAX_HHSIZE) persons. That makes 3 columns for each
individual. e.g. the utilities of person with cdap_rank 1 will be included as M_p1, N_p1, H_p1</p>
<p>The chooser table will also contain interaction columns for all possible interactions involving
from 2 to 3 persons (actually MAX_INTERACTION_CARDINALITY, which is currently 3).</p>
<p>The interaction columns list the ptypes of the persons in the interaction set, sorted by ptype.
For instance the interaction between persons with cdap_rank 1 and three and ptypes will
be listed in a column named ‘p1_p3’ and for a household where persons p1 and p3 are 2 and 4
will a row value of 24 in the p1_p3 column.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>indiv_utils</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>CDAP utilities for each individual, ignoring interactions.
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</div></blockquote>
<p><strong>hhsize</strong> : int</p>
<blockquote>
<div><p>household size for which the choosers table should be built. Households with more than
MAX_HHSIZE members will be included with MAX_HHSIZE choosers since the are handled the
same, and the activities of the extra members are assigned afterwards</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>choosers</strong> : pandas.DataFrame</p>
<blockquote class="last">
<div><p>choosers households of hhsize with activity utility columns interaction columns
for all (non-extra) household members</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.household_activity_choices">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">household_activity_choices</code><span class="sig-paren">(</span><em>indiv_utils</em>, <em>interaction_coefficients</em>, <em>hhsize</em>, <em>trace_hh_id=None</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.household_activity_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate household utilities for each activity pattern alternative for households of hhsize
The resulting activity pattern for each household will be coded as a string of activity codes.
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>indiv_utils</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>CDAP utilities for each individual, ignoring interactions
ind_utils has index of _persons_index_ and a column for each alternative
i.e. three columns ‘M’ (Mandatory), ‘N’ (NonMandatory), ‘H’ (Home)</p>
</div></blockquote>
<p><strong>interaction_coefficients</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</div></blockquote>
<p><strong>hhsize</strong> : int</p>
<blockquote>
<div><p>the size of household for which activity perttern should be calculated (1..MAX_HHSIZE)</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>choices</strong> : pandas.Series</p>
<blockquote class="last">
<div><p>the chosen cdap activity pattern for each household represented as a string (e.g. ‘MNH’)
with same index (_hh_index_) as utils</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.individual_utilities">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">individual_utilities</code><span class="sig-paren">(</span><em>persons</em>, <em>cdap_indiv_spec</em>, <em>locals_d</em>, <em>trace_hh_id=None</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.individual_utilities" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate CDAP utilities for all individuals.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>DataFrame of individual persons data.</p>
</div></blockquote>
<p><strong>cdap_indiv_spec</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>CDAP spec applied to individuals.</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>utilities</strong> : pandas.DataFrame</p>
<blockquote class="last">
<div><p>Will have index of <cite>persons</cite> and columns for each of the alternatives.
plus some ‘useful columns’ [_hh_id_, _ptype_, ‘cdap_rank’, _hh_size_]</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.preprocess_interaction_coefficients">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">preprocess_interaction_coefficients</code><span class="sig-paren">(</span><em>interaction_coefficients</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.preprocess_interaction_coefficients" title="Permalink to this definition">¶</a></dt>
<dd><p>The input cdap_interaction_coefficients.csv file has three columns:</p>
<dl class="docutils">
<dt>activity</dt>
<dd>A single character activity type name (M, N, or H)</dd>
<dt>interaction_ptypes</dt>
<dd>List of ptypes in the interaction (in order of increasing ptype)
Stars (***) instead of ptypes means the interaction applies to all ptypes in that size hh</dd>
<dt>coefficient</dt>
<dd>The coefficient to apply for all hh interactions for this activity and set of ptypes</dd>
</dl>
<p>To facilitate building the spec for a given hh ssize, we add two additional columns:</p>
<dl class="docutils">
<dt>cardinality</dt>
<dd>the number of persons in the interaction (e.g. 3 for a 3-way interaction)</dd>
<dt>slug</dt>
<dd>a human friendly efficient name so we can dump a readable spec trace file for debugging
this slug is then replaced with the numerical coefficient value prior to evaluation</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.run_cdap">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">run_cdap</code><span class="sig-paren">(</span><em>persons</em>, <em>cdap_indiv_spec</em>, <em>cdap_interaction_coefficients</em>, <em>cdap_fixed_relative_proportions</em>, <em>locals_d</em>, <em>chunk_size=0</em>, <em>trace_hh_id=None</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.run_cdap" title="Permalink to this definition">¶</a></dt>
<dd><p>Choose individual activity patterns for persons.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Table of persons data. Must contain at least a household ID, household size,
person type category, and age, plus any columns used in cdap_indiv_spec</p>
</div></blockquote>
<p><strong>cdap_indiv_spec</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>CDAP spec for individuals without taking any interactions into account.</p>
</div></blockquote>
<p><strong>cdap_interaction_coefficients</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Rules and coefficients for generating interaction specs for different household sizes</p>
</div></blockquote>
<p><strong>cdap_fixed_relative_proportions</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Spec to for the relative proportions of each activity (M, N, H)
to choose activities for additional household members not handled by CDAP</p>
</div></blockquote>
<p><strong>locals_d</strong> : Dict</p>
<blockquote>
<div><p>This is a dictionary of local variables that will be the environment
for an evaluation of an expression that begins with &#64;
in either the cdap_indiv_spec or cdap_fixed_relative_proportions expression files</p>
</div></blockquote>
<p><strong>chunk_size: int</strong></p>
<blockquote>
<div><p>Chunk size or 0 for no chunking</p>
</div></blockquote>
<p><strong>trace_hh_id</strong> : int</p>
<blockquote>
<div><p>hh_id to trace or None if no hh tracing</p>
</div></blockquote>
<p><strong>trace_label</strong> : str</p>
<blockquote>
<div><p>label for tracing or None if no tracing</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>choices</strong> : pandas.DataFrame</p>
<blockquote class="last">
<div><p>dataframe is indexed on _persons_index_ and has two columns:</p>
<dl class="docutils">
<dt>cdap_activity <span class="classifier-delimiter">:</span> <span class="classifier">str</span></dt>
<dd><p class="first last">activity for that person expressed as ‘M’, ‘N’, ‘H’</p>
</dd>
<dt>cdap_rank <span class="classifier-delimiter">:</span> <span class="classifier">int</span></dt>
<dd><p class="first last">activities for persons with cdap_rank &lt;= MAX_HHSIZE are determined by cdap
‘extra’ household members activities are assigned by cdap_fixed_relative_proportions</p>
</dd>
</dl>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices">
<code class="descclassname">activitysim.abm.models.util.cdap.</code><code class="descname">unpack_cdap_indiv_activity_choices</code><span class="sig-paren">(</span><em>persons</em>, <em>hh_choices</em>, <em>trace_hh_id</em>, <em>trace_label</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.cdap.unpack_cdap_indiv_activity_choices" title="Permalink to this definition">¶</a></dt>
<dd><p>Unpack the household activity choice list into choices for each (non-extra) household member</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : pandas.DataFrame</p>
<blockquote>
<div><p>Table of persons data indexed on _persons_index_
We expect, at least, columns [_hh_id_, ‘cdap_rank’]</p>
</div></blockquote>
<p><strong>hh_choices</strong> : pandas.Series</p>
<blockquote>
<div><p>household activity pattern is encoded as a string (of length hhsize) of activity codes
e.g. ‘MNHH’ for a 4 person household with activities Mandatory, NonMandatory, Home, Home</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>cdap_indiv_activity_choices</strong> : pandas.Series</p>
<blockquote class="last">
<div><p>series contains one activity per individual hh member, indexed on _persons_index_</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>
<div class="section" id="mandatory-tour-frequency">
<span id="id11"></span><h2>Mandatory Tour Frequency<a class="headerlink" href="#mandatory-tour-frequency" title="Permalink to this headline">¶</a></h2>
<p>The mandatory tour frequency model selects the number of mandatory tours made by each person on the simulation day.
It also creates mandatory tours in the data pipeline.</p>
<p>The main interface to the mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency"><code class="xref py py-func docutils literal"><span class="pre">mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal"><span class="pre">mandatory_tour_frequency,</span> <span class="pre">persons_mtf</span></code> | Skims Keys: NA</p>
<div class="section" id="id12">
<h3>API<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.mandatory_tour_frequency"></span><dl class="function">
<dt id="activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency">
<code class="descclassname">activitysim.abm.models.mandatory_tour_frequency.</code><code class="descname">mandatory_tour_frequency</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>mandatory_tour_frequency_spec</em>, <em>mandatory_tour_frequency_settings</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_tour_frequency.mandatory_tour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making mandatory trips (see the
alternatives above) - these trips include work and school in some combination.</p>
</dd></dl>

</div>
</div>
<div class="section" id="mandatory-tour-scheduling">
<span id="id13"></span><h2>Mandatory Tour Scheduling<a class="headerlink" href="#mandatory-tour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The mandatory tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each mandatory tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>The main interface to the mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling"><code class="xref py py-func docutils literal"><span class="pre">mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal"><span class="pre">tour_departure_and_duration</span></code> | Skims Keys: NA</p>
<div class="section" id="id14">
<h3>API<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.mandatory_scheduling"></span><dl class="function">
<dt id="activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling">
<code class="descclassname">activitysim.abm.models.mandatory_scheduling.</code><code class="descname">mandatory_tour_scheduling</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>tdd_alts</em>, <em>tdd_school_spec</em>, <em>tdd_work_spec</em>, <em>mandatory_tour_scheduling_settings</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mandatory_scheduling.mandatory_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for mandatory tours</p>
</dd></dl>

</div>
</div>
<div class="section" id="non-mandatory-tour-frequency">
<span id="id15"></span><h2>Non-Mandatory Tour Frequency<a class="headerlink" href="#non-mandatory-tour-frequency" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour frequency model selects the number of non-mandatory tours made by each person on the simulation day.
It also creates non-mandatory tours in the data pipeline.</p>
<p>The main interface to the non-mandatory tour purpose frequency model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency"><code class="xref py py-func docutils literal"><span class="pre">non_mandatory_tour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">persons</span></code> | Result Fields: <code class="docutils literal"><span class="pre">non_mandatory_tour_frequency,</span> <span class="pre">persons_nmtf</span></code> | Skims Keys: NA</p>
<div class="section" id="id16">
<h3>API<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.non_mandatory_tour_frequency"></span><dl class="function">
<dt id="activitysim.abm.models.non_mandatory_tour_frequency.create_non_mandatory_tours">
<code class="descclassname">activitysim.abm.models.non_mandatory_tour_frequency.</code><code class="descname">create_non_mandatory_tours</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.create_non_mandatory_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>We have now generated non-mandatory tours, but they are attributes of the person table
Now we create a “tours” table which has one row per tour that has been generated
(and the person id it is associated with)</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency">
<code class="descclassname">activitysim.abm.models.non_mandatory_tour_frequency.</code><code class="descname">non_mandatory_tour_frequency</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>non_mandatory_tour_frequency_alts</em>, <em>non_mandatory_tour_frequency_spec</em>, <em>non_mandatory_tour_frequency_settings</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_tour_frequency.non_mandatory_tour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making non-mandatory trips
(alternatives for this model come from a separate csv file which is
configured by the user) - these trips include escort, shopping, othmaint,
othdiscr, eatout, and social trips in various combination.</p>
</dd></dl>

</div>
</div>
<div class="section" id="non-mandatory-tour-destination-choice">
<span id="id17"></span><h2>Non-Mandatory Tour Destination Choice<a class="headerlink" href="#non-mandatory-tour-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour destination choice model chooses a destination zone for
non-mandatory tours.</p>
<p>The main interface to the non-mandatory tour destination choice model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination_choice" title="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination_choice"><code class="xref py py-func docutils literal"><span class="pre">non_mandatory_tour_destination_choice()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal"><span class="pre">destination</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">TAZ,</span> <span class="pre">TAZ_r</span></code></p>
<div class="section" id="id18">
<h3>API<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.non_mandatory_destination"></span><dl class="function">
<dt id="activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination_choice">
<code class="descclassname">activitysim.abm.models.non_mandatory_destination.</code><code class="descname">non_mandatory_tour_destination_choice</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>skim_dict</em>, <em>non_mandatory_tour_destination_choice_spec</em>, <em>non_mandatory_tour_destination_choice_settings</em>, <em>destination_size_terms</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_destination.non_mandatory_tour_destination_choice" title="Permalink to this definition">¶</a></dt>
<dd><p>Given the tour generation from the above, each tour needs to have a
destination, so in this case tours are the choosers (with the associated
person that’s making the tour)</p>
</dd></dl>

</div>
</div>
<div class="section" id="annotate-table">
<span id="id19"></span><h2>Annotate Table<a class="headerlink" href="#annotate-table" title="Permalink to this headline">¶</a></h2>
<p>The annotate table model isn’t really a model, but a step in the data pipeline.  This step adds fields
to a user specified data table in the pipeline.  The main interface to annotate table is the
<code class="xref py py-func docutils literal"><span class="pre">annotate_table()</span></code> function.  This function is registered
as an orca step in the example Pipeline.  Annotate_table make use of optional step arguments, as shown
below.  In the example below, <code class="docutils literal"><span class="pre">annotate_tours</span></code> is passed as the <code class="docutils literal"><span class="pre">model_name</span></code>, which causes annotate table
to read the annotate_tours.yaml settings file and the annotate_tours.csv expressions file.  These expressions
are processed are added to the dataframe specified in the yaml file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">annotate_table</span><span class="o">.</span><span class="n">model_name</span><span class="o">=</span><span class="n">annotate_tours</span>
</pre></div>
</div>
<div class="section" id="id20">
<h3>API<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.annotate_table"></span></div>
</div>
<div class="section" id="non-mandatory-tour-scheduling">
<span id="id21"></span><h2>Non-Mandatory Tour Scheduling<a class="headerlink" href="#non-mandatory-tour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The non-mandatory tour scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each non-mandatory tour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>The main interface to the non-mandatory tour purpose scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling"><code class="xref py py-func docutils literal"><span class="pre">non_mandatory_tour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal"><span class="pre">tour_departure_and_duration</span></code> | Skims Keys: NA</p>
<div class="section" id="id22">
<h3>API<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.non_mandatory_scheduling"></span><dl class="function">
<dt id="activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling">
<code class="descclassname">activitysim.abm.models.non_mandatory_scheduling.</code><code class="descname">non_mandatory_tour_scheduling</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>tdd_alts</em>, <em>tdd_non_mandatory_spec</em>, <em>non_mandatory_tour_scheduling_settings</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.non_mandatory_scheduling.non_mandatory_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for non-mandatory tours</p>
</dd></dl>

</div>
</div>
<div class="section" id="tour-mode">
<span id="tour-mode-choice"></span><h2>Tour Mode<a class="headerlink" href="#tour-mode" title="Permalink to this headline">¶</a></h2>
<p>The tour mode choice model assigns a travel mode to each tour.</p>
<p>The main interface to the tour mode model is the
<a class="reference internal" href="#activitysim.abm.models.mode_choice.tour_mode_choice_simulate" title="activitysim.abm.models.mode_choice.tour_mode_choice_simulate"><code class="xref py py-func docutils literal"><span class="pre">tour_mode_choice_simulate()</span></code></a> function.  This function is
called in the orca step <code class="docutils literal"><span class="pre">tour_mode_choice_simulate</span></code> and is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal"><span class="pre">mode</span></code> | Skims od_skims Keys: <code class="docutils literal"><span class="pre">TAZ,</span> <span class="pre">destination</span></code> |
SkimStackWrapper odt_skims Keys: <code class="docutils literal"><span class="pre">TAZ,</span> <span class="pre">destination,</span> <span class="pre">in_period</span></code> | SkimStackWrapper dot_skims Keys:
<code class="docutils literal"><span class="pre">destination,</span> <span class="pre">TAZ,</span> <span class="pre">out_period</span></code></p>
<div class="section" id="id23">
<h3>API<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.mode_choice"></span><dl class="function">
<dt id="activitysim.abm.models.mode_choice.atwork_subtour_mode_choice_simulate">
<code class="descclassname">activitysim.abm.models.mode_choice.</code><code class="descname">atwork_subtour_mode_choice_simulate</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>tour_mode_choice_spec</em>, <em>tour_mode_choice_settings</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mode_choice.atwork_subtour_mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>At-work subtour mode choice simulate</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.mode_choice.get_segment_and_unstack">
<code class="descclassname">activitysim.abm.models.mode_choice.</code><code class="descname">get_segment_and_unstack</code><span class="sig-paren">(</span><em>omnibus_spec</em>, <em>segment</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mode_choice.get_segment_and_unstack" title="Permalink to this definition">¶</a></dt>
<dd><p>This does what it says.  Take the spec, get the column from the spec for
the given segment, and unstack.  It is assumed that the last column of
the multiindex is alternatives so when you do this unstacking,
each alternative is in a column (which is the format this as used for the
simple_simulate call.  The weird nuance here is the “Rowid” column -
since many expressions are repeated (e.g. many are just “1”) a Rowid
column is necessary to identify which alternatives are actually part of
which original row - otherwise the unstack is incorrect (i.e. the index
is not unique)</p>
</dd></dl>

<dl class="data">
<dt id="activitysim.abm.models.mode_choice.logger">
<code class="descclassname">activitysim.abm.models.mode_choice.</code><code class="descname">logger</code><em class="property"> = &lt;logging.Logger object&gt;</em><a class="headerlink" href="#activitysim.abm.models.mode_choice.logger" title="Permalink to this definition">¶</a></dt>
<dd><p>Generic functions for both tour and trip mode choice</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.mode_choice.tour_mode_choice_simulate">
<code class="descclassname">activitysim.abm.models.mode_choice.</code><code class="descname">tour_mode_choice_simulate</code><span class="sig-paren">(</span><em>tours_merged</em>, <em>tour_mode_choice_spec</em>, <em>tour_mode_choice_settings</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mode_choice.tour_mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Tour mode choice simulate</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.mode_choice.trip_mode_choice_simulate">
<code class="descclassname">activitysim.abm.models.mode_choice.</code><code class="descname">trip_mode_choice_simulate</code><span class="sig-paren">(</span><em>trips_merged</em>, <em>trip_mode_choice_spec</em>, <em>trip_mode_choice_settings</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.mode_choice.trip_mode_choice_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>Trip mode choice simulate</p>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.util.mode"></span><dl class="function">
<dt id="activitysim.abm.models.util.mode.evaluate_expression_list">
<code class="descclassname">activitysim.abm.models.util.mode.</code><code class="descname">evaluate_expression_list</code><span class="sig-paren">(</span><em>expressions</em>, <em>constants</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.evaluate_expression_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate a list of expressions - each one can depend on the one before
it.  These are usually used for the coefficients which have relationships
to each other.  So ivt=.7 and then ivt_lr=ivt*.9.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>expressions</strong> : Series</p>
<blockquote>
<div><p>Same as below except the values are accumulated from expression to
expression and there is no assumed “$” at the beginning.  This is a
Series because the index are the names of the expressions which are
used in subsequent evals - thus naming the expressions is required.
For better or worse, the expressions are assumed to evaluate to
floats and this is guaranteed by casting to float after eval-ing.</p>
</div></blockquote>
<p><strong>constants</strong> : dict</p>
<blockquote>
<div><p>will be passed as the scope of eval - usually a separate set of
constants are passed in here</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"><strong>expressions</strong> : Series</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.mode.expand_alternatives">
<code class="descclassname">activitysim.abm.models.util.mode.</code><code class="descname">expand_alternatives</code><span class="sig-paren">(</span><em>df</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.expand_alternatives" title="Permalink to this definition">¶</a></dt>
<dd><p>Alternatives are kept as a comma separated list.  At this stage we need
need to split them up so that there is only one alternative per row, and
where an expression is shared among alternatives, that row is copied
with each alternative alternative value (pun intended) substituted for
the alternative value for each row.  The DataFrame needs an Alternative
column which is a comma separated list of alternatives.  See the test for
an example.</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.mode.pre_process_expressions">
<code class="descclassname">activitysim.abm.models.util.mode.</code><code class="descname">pre_process_expressions</code><span class="sig-paren">(</span><em>expressions</em>, <em>variable_templates</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.pre_process_expressions" title="Permalink to this definition">¶</a></dt>
<dd><p>This one is pretty simple - pass in a list of expressions which contain
references to templates and pass a dictionary of the templates themselves.
Strings will only be evaluated which are prepended with $.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>expressions</strong> : list of strs</p>
<blockquote>
<div><p>These are the expressions that will be evaluated - generally these
contain templates that get passed below.  So will be something like
[‘$SKIM_TEMPLATE.format(sk=”AMPEAK”)’]</p>
</div></blockquote>
<p><strong>variable_templates</strong> : dict of templates</p>
<blockquote>
<div><p>Will be passed as the scope of eval.  Keys are usually template names
and values are strings.  The dict could be something like
{‘SKIM_TEMPLATE’: ‘skims[{sk}]’}</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>expressions</strong> : list of strs</p>
<blockquote class="last">
<div><p>Each expression is evaluated with variable_templates in the scope and
the result is returned.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.mode.substitute_coefficients">
<code class="descclassname">activitysim.abm.models.util.mode.</code><code class="descname">substitute_coefficients</code><span class="sig-paren">(</span><em>expressions</em>, <em>constants</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.mode.substitute_coefficients" title="Permalink to this definition">¶</a></dt>
<dd><p>Substitute the named coeffcients in expressions with their numeric values</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>expressions</strong> : Series</p>
<blockquote>
<div><p>Same as below except there is no assumed “$” at the beginning.
For better or worse, the expressions are assumed to evaluate to
floats and this is guaranteed by casting to float after eval-ing.</p>
</div></blockquote>
<p><strong>constants</strong> : dict</p>
<blockquote>
<div><p>will be passed as the scope of eval - usually a separate set of
constants are passed in here</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"><strong>expressions</strong> : Series</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="at-work-subtours-frequency">
<span id="atwork-subtour-frequency"></span><h2>At-work Subtours Frequency<a class="headerlink" href="#at-work-subtours-frequency" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtour frequency model selects the number of at-work subtours made for each work tour.
It also creates at-work subtours by adding them to the tours table in the data pipeline.</p>
<p>Choosers: work tours
Alternatives: none, 1 eating out tour, 1 business tour, 1 maintenance tour, 2 business tours, 1 eating out tour + 1 business tour
Dependent tables: household, person, accessibility
Outputs: work tour subtour frequency choice, at-work tours table (with only tour origin zone at this point)</p>
<p>The main interface to the at-work subtours model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency"><code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_frequency()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Table: <code class="docutils literal"><span class="pre">tours</span></code> | Skims Keys: NA</p>
<div class="section" id="id24">
<h3>API<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_frequency"></span><dl class="function">
<dt id="activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency">
<code class="descclassname">activitysim.abm.models.atwork_subtour_frequency.</code><code class="descname">atwork_subtour_frequency</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>atwork_subtour_frequency_spec</em>, <em>atwork_subtour_frequency_settings</em>, <em>atwork_subtour_frequency_alternatives</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_frequency.atwork_subtour_frequency" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the frequency of making at-work subtour tours
(alternatives for this model come from a separate csv file which is
configured by the user).</p>
</dd></dl>

</div>
</div>
<div class="section" id="at-work-subtours-destination-choice">
<span id="atwork-subtour-destination"></span><h2>At-work Subtours Destination Choice<a class="headerlink" href="#at-work-subtours-destination-choice" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtours destination choice model is made up of three model steps:</p>
<blockquote>
<div><ul class="simple">
<li>atwork_subtour_destination_sample - selects a sample of alternative locations for the next model step. This selects X locations from the full set of model zones using a simple utility.</li>
<li>atwork_subtour_destination_logsums - starts with the table created above and calculates and adds the mode choice logsum expression for each alternative location.</li>
<li>atwork_subtour_destination_simulate - starts with the table created above and chooses a final location, this time with the mode choice logsum included.</li>
</ul>
</div></blockquote>
<div class="section" id="at-work-subtour-location-sample">
<h3>At-work Subtour Location Sample<a class="headerlink" href="#at-work-subtour-location-sample" title="Permalink to this headline">¶</a></h3>
<p>This model is the same as the workplace location sample model except it operates on the at-work tours.</p>
<p>Choosers: at-work tours
Alternatives: all zones
Dependent tables: skims, size terms, land use
Outputs: alternative zone set for each at-work tour</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Table: <code class="docutils literal"><span class="pre">atwork_subtour_destination_sample</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">workplace_taz,</span> <span class="pre">alt</span> <span class="pre">zone,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<p>The main interface to the at-work subtours destination choice sample model is the
<code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_destination_sample()</span></code>
function.  This function is registered as an orca step in the example Pipeline.</p>
</div>
<div class="section" id="at-work-subtour-logsums">
<h3>At-work Subtour Logsums<a class="headerlink" href="#at-work-subtour-logsums" title="Permalink to this headline">¶</a></h3>
<p>This model is the same as the workplace location logsums model except it operates on the at-work tours.</p>
<p>Choosers: at-work tours * number of alternative zones
Alternatives: N/A
Dependent tables: skims, size terms, household, person, land use, accessibility, work tour
Outputs: logsums for the alternative zone set for each at-work tour</p>
<p>Core Table: <code class="docutils literal"><span class="pre">atwork_subtour_destination_sample</span></code> | Result Table: <code class="docutils literal"><span class="pre">atwork_subtour_destination_sample</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">workplace_taz,</span> <span class="pre">alt</span> <span class="pre">zone,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<p>The main interface to the at-work subtours destination choice logsums model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_logsums" title="activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_logsums"><code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_destination_logsums()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
</div>
<div class="section" id="at-work-subtour-location">
<h3>At-work Subtour Location<a class="headerlink" href="#at-work-subtour-location" title="Permalink to this headline">¶</a></h3>
<p>This model is the same as the workplace location model except it operates on the at-work tours.</p>
<p>Choosers: at-work tours
Alternatives: alternative zones from the sample step
Dependent tables: skims, size terms, land use
Outputs: at-work tour destination zone</p>
<p>Core Table: <code class="docutils literal"><span class="pre">atwork_subtour_destination_sample</span></code> | Result Table: <code class="docutils literal"><span class="pre">tours</span></code> | Skims Keys: <code class="docutils literal"><span class="pre">workplace_taz,</span> <span class="pre">alt</span> <span class="pre">zone,</span> <span class="pre">MD</span> <span class="pre">time</span> <span class="pre">period</span></code></p>
<p>The main interface to the at-work subtours destination choice location model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_simulate" title="activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_simulate"><code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_destination_simulate()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
</div>
<div class="section" id="id25">
<h3>API<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_destination"></span><dl class="function">
<dt id="activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_logsums">
<code class="descclassname">activitysim.abm.models.atwork_subtour_destination.</code><code class="descname">atwork_subtour_destination_logsums</code><span class="sig-paren">(</span><em>persons_merged</em>, <em>land_use</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>atwork_subtour_destination_sample</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_logsums" title="Permalink to this definition">¶</a></dt>
<dd><p>add logsum column to existing workplace_location_sample able</p>
<p>logsum is calculated by running the mode_choice model for each sample (person, dest_taz) pair
in workplace_location_sample, and computing the logsum of all the utilities</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="25%" />
<col width="18%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">PERID</th>
<th class="head">dest_TAZ</th>
<th class="head">rand</th>
<th class="head">pick_count</th>
<th class="head">logsum (added)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>23750</td>
<td>14</td>
<td>0.565502716034</td>
<td>4</td>
<td>1.85659498857</td>
</tr>
<tr class="row-odd"><td rowspan="2">23750</td>
<td rowspan="2">16</td>
<td rowspan="2">0.711135838871</td>
<td rowspan="2">6</td>
<td rowspan="2">1.92315598631</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="2">…</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
<td rowspan="2">&#160;</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td>23751</td>
<td>12</td>
<td>0.408038878552</td>
<td>1</td>
<td>2.40612135416</td>
</tr>
<tr class="row-even"><td>23751</td>
<td>14</td>
<td>0.972732479292</td>
<td>2</td>
<td>1.44009018355</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_simulate">
<code class="descclassname">activitysim.abm.models.atwork_subtour_destination.</code><code class="descname">atwork_subtour_destination_simulate</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>atwork_subtour_destination_sample</em>, <em>atwork_subtour_destination_spec</em>, <em>skim_dict</em>, <em>destination_size_terms</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_destination.atwork_subtour_destination_simulate" title="Permalink to this definition">¶</a></dt>
<dd><p>atwork_subtour_destination model on atwork_subtour_destination_sample
annotated with mode_choice logsum to select a destination from sample alternatives</p>
</dd></dl>

</div>
</div>
<div class="section" id="at-work-subtour-scheduling">
<span id="atwork-subtour-scheduling"></span><h2>At-work Subtour Scheduling<a class="headerlink" href="#at-work-subtour-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtours scheduling model selects a tour departure and duration period (and therefore a start and end
period as well) for each at-work subtour.  This model uses person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.</p>
<p>This model is the same as the mandatory tour scheduling model except it operates on the at-work tours and
constrains the alternative set to available person <a class="reference internal" href="core.html#time-windows"><span class="std std-ref">Person Time Windows</span></a>.  Unlike the other departure time and duration models,
the at-work subtour model does not require mode choice logsums. The at-work subtour frequency model can choose multiple
tours so this model must process all first tours and then second tours since isFirstAtWorkTour is an explanatory variable.</p>
<p>Choosers: at-work tours
Alternatives: alternative departure time and arrival back at origin time pairs WITHIN the work tour departure time and arrival time back at origin AND the person time window. If no time window is available for the tour, make the first and last time periods within the work tour available, make the choice, and log the number of times this occurs.
Dependent tables: skims, person, land use, work tour
Outputs: at-work tour departure time and arrival back at origin time, updated person time windows</p>
<p>The main interface to the at-work subtours scheduling model is the
<a class="reference internal" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling"><code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_scheduling()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Field: <code class="docutils literal"><span class="pre">tour_departure_and_duration</span></code> | Skims Keys: Currently not implemented</p>
<div class="section" id="id26">
<h3>API<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.atwork_subtour_scheduling"></span><dl class="function">
<dt id="activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling">
<code class="descclassname">activitysim.abm.models.atwork_subtour_scheduling.</code><code class="descname">atwork_subtour_scheduling</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>tdd_alts</em>, <em>tdd_subtour_spec</em>, <em>atwork_subtour_scheduling_settings</em>, <em>configs_dir</em>, <em>chunk_size</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.atwork_subtour_scheduling.atwork_subtour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>This model predicts the departure time and duration of each activity for at work subtours tours</p>
</dd></dl>

</div>
</div>
<div class="section" id="at-work-subtour-mode">
<span id="atwork-subtour-mode-choice"></span><h2>At-work Subtour Mode<a class="headerlink" href="#at-work-subtour-mode" title="Permalink to this headline">¶</a></h2>
<p>The at-work subtour mode choice model assigns a travel mode to each at-work subtour.</p>
<p>Choosers: at-work tours
Alternatives: modes
Dependent tables: skims, size terms, household, person, land use, accessibility, work tour
Outputs: at-work tour mode</p>
<p>The main interface to the at-work subtour mode choice model is the
<a class="reference internal" href="#activitysim.abm.models.mode_choice.atwork_subtour_mode_choice_simulate" title="activitysim.abm.models.mode_choice.atwork_subtour_mode_choice_simulate"><code class="xref py py-func docutils literal"><span class="pre">atwork_subtour_mode_choice_simulate()</span></code></a>
function.  This function is called in the orca step <code class="docutils literal"><span class="pre">atwork_subtour_mode_choice_simulate</span></code> and
is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal"><span class="pre">mode</span></code> | Skims od_skims Keys: <code class="docutils literal"><span class="pre">workplace_taz,destination</span></code> |
SkimStackWrapper odt_skims Keys: <code class="docutils literal"><span class="pre">workplace_taz,destination,out_period</span></code> |
SkimStackWrapper dot_skims Keys: <code class="docutils literal"><span class="pre">destination,workplace_taz,in_period</span></code></p>
<div class="section" id="id27">
<h3>API<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="#tour-mode-choice"><span class="std std-ref">Tour Mode</span></a> API.</p>
</div>
</div>
<div class="section" id="create-trips">
<h2>Create Trips<a class="headerlink" href="#create-trips" title="Permalink to this headline">¶</a></h2>
<p>The create trips model simply creates a new trips table in the data pipeline with two trips for each tour:</p>
<ul class="simple">
<li>outbound - from tour origin to tour destination</li>
<li>inbound - from tour destination to tour origin</li>
</ul>
<p>The main interface to the create trips model is the
<a class="reference internal" href="#activitysim.abm.models.create_trips.create_simple_trips" title="activitysim.abm.models.create_trips.create_simple_trips"><code class="xref py py-func docutils literal"><span class="pre">create_simple_trips()</span></code></a>
function.  This function is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">tours</span></code> | Result Table: <code class="docutils literal"><span class="pre">trips</span></code> | Skims Keys: NA</p>
<div class="section" id="id28">
<h3>API<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.create_trips"></span><dl class="function">
<dt id="activitysim.abm.models.create_trips.create_simple_trips">
<code class="descclassname">activitysim.abm.models.create_trips.</code><code class="descname">create_simple_trips</code><span class="sig-paren">(</span><em>tours</em>, <em>households</em>, <em>persons</em>, <em>trace_hh_id</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.create_trips.create_simple_trips" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a simple trip table from the tours table.  Two trips are created
for each tour: from tour origin to tour destination (outbound) and from tour
destination to tour origin (inbound).</p>
</dd></dl>

</div>
</div>
<div class="section" id="trip-mode">
<span id="trip-mode-choice"></span><h2>Trip Mode<a class="headerlink" href="#trip-mode" title="Permalink to this headline">¶</a></h2>
<p>The trip mode choice model assigns a travel mode to each trip.</p>
<p>The main interface to the trip mode model is the
<a class="reference internal" href="#activitysim.abm.models.mode_choice.trip_mode_choice_simulate" title="activitysim.abm.models.mode_choice.trip_mode_choice_simulate"><code class="xref py py-func docutils literal"><span class="pre">trip_mode_choice_simulate()</span></code></a>
function.  This function is called in the orca step <code class="docutils literal"><span class="pre">trip_mode_choice_simulate</span></code> and
is registered as an orca step in the example Pipeline.</p>
<p>Core Table: <code class="docutils literal"><span class="pre">trips</span></code> | Result Field: <code class="docutils literal"><span class="pre">mode</span></code> | Skims od_skims Keys: <code class="docutils literal"><span class="pre">TAZ,destination</span></code> |
SkimStackWrapper odt_skims Keys: <code class="docutils literal"><span class="pre">TAZ,destination,start_period</span></code></p>
<div class="section" id="id29">
<h3>API<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="#tour-mode-choice"><span class="std std-ref">Tour Mode</span></a> API.</p>
</div>
</div>
<div class="section" id="util">
<h2>Util<a class="headerlink" href="#util" title="Permalink to this headline">¶</a></h2>
<p>Additional helper classes</p>
<div class="section" id="id30">
<h3>API<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-activitysim.abm.models.util.expressions"></span><dl class="function">
<dt id="activitysim.abm.models.util.expressions.assign_columns">
<code class="descclassname">activitysim.abm.models.util.expressions.</code><code class="descname">assign_columns</code><span class="sig-paren">(</span><em>df</em>, <em>model_settings</em>, <em>configs_dir=None</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.expressions.assign_columns" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate expressions in context of df and assign rusulting target columns to df</p>
<p>Can add new or modify existing columns (if target same as existing df column name)</p>
<p>Parameters - same as for compute_columns except df must not be None
Returns - nothing since we modify df in place</p>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.expressions.compute_columns">
<code class="descclassname">activitysim.abm.models.util.expressions.</code><code class="descname">compute_columns</code><span class="sig-paren">(</span><em>df</em>, <em>model_settings</em>, <em>configs_dir</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.expressions.compute_columns" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate expressions_spec in context of df, with optional additional pipeline tables in locals</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>df</strong> : pandas DataFrame</p>
<blockquote>
<div><p>or if None, expect name of pipeline table to be specified by DF in model_settings</p>
</div></blockquote>
<p><strong>model_settings</strong> : dict or str</p>
<blockquote>
<div><dl class="docutils">
<dt>dict with keys:</dt>
<dd><p class="first last">DF - df_alias and (additionally, if df is None) name of pipeline table to load as df
SPEC - name of expressions file (csv suffix optional) if different from model_settings
TABLES - list of pipeline tables to load and make available as (read only) locals</p>
</dd>
<dt>str:</dt>
<dd><p class="first last">name of yaml file in confirs_dir to load dict from</p>
</dd>
</dl>
</div></blockquote>
<p><strong>configs_dir</strong></p>
<p><strong>trace_label</strong></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">results: pandas.DataFrame</p>
<blockquote class="last">
<div><p>one column for each expression (except temps with ALL_CAP target names)
same index as df</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.expressions.local_utilities">
<code class="descclassname">activitysim.abm.models.util.expressions.</code><code class="descname">local_utilities</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.expressions.local_utilities" title="Permalink to this definition">¶</a></dt>
<dd><p>Dict of useful modules and functions to provides as locals for use in eval of expressions</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>utility_dict</strong> : dict</p>
<blockquote class="last">
<div><p>name, entity pairs of locals</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.expressions.skim_time_period_label">
<code class="descclassname">activitysim.abm.models.util.expressions.</code><code class="descname">skim_time_period_label</code><span class="sig-paren">(</span><em>time</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.expressions.skim_time_period_label" title="Permalink to this definition">¶</a></dt>
<dd><p>convert time period times to skim time period labels (e.g. 9 -&gt; ‘AM’)</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>time</strong> : pandas Series</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">pandas Series</p>
<blockquote class="last">
<div><p>string time period labels</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.util.logsums"></span><dl class="function">
<dt id="activitysim.abm.models.util.logsums.compute_logsums">
<code class="descclassname">activitysim.abm.models.util.logsums.</code><code class="descname">compute_logsums</code><span class="sig-paren">(</span><em>choosers</em>, <em>logsum_spec</em>, <em>logsum_settings</em>, <em>skim_dict</em>, <em>skim_stack</em>, <em>chooser_col_name</em>, <em>alt_col_name</em>, <em>chunk_size</em>, <em>trace_hh_id</em>, <em>trace_label</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.logsums.compute_logsums" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>choosers</strong></p>
<p><strong>logsum_spec</strong></p>
<p><strong>logsum_settings</strong></p>
<p><strong>skim_dict</strong></p>
<p><strong>skim_stack</strong></p>
<p><strong>alt_col_name</strong></p>
<p><strong>chunk_size</strong></p>
<p><strong>trace_hh_id</strong></p>
<p><strong>trace_label</strong></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">logsums: pandas series</p>
<blockquote class="last">
<div><p>computed logsums with same index as choosers</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.util.tour_frequency"></span><dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.canonical_tours">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">canonical_tours</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.canonical_tours" title="Permalink to this definition">¶</a></dt>
<dd><blockquote>
<div>create labels for every the possible tour by combining tour_type/tour_num.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">list of canonical tour labels in alphabetical order</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.process_atwork_subtours">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">process_atwork_subtours</code><span class="sig-paren">(</span><em>work_tours</em>, <em>atwork_subtour_frequency_alts</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_atwork_subtours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the atwork_subtour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the subtours tours that were generated</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>work_tours: DataFrame</strong></p>
<blockquote>
<div><p>A series which has parent work tour tour_id as the index and
columns with person_id and atwork_subtour_frequency.</p>
</div></blockquote>
<p><strong>atwork_subtour_frequency_alts: DataFrame</strong></p>
<blockquote>
<div><p>A DataFrame which has as a unique index with atwork_subtour_frequency values
and frequency counts for the subtours to be generated for that choice</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote class="last">
<div><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.process_mandatory_tours">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">process_mandatory_tours</code><span class="sig-paren">(</span><em>persons</em>, <em>mandatory_tour_frequency_alts</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_mandatory_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the mandatory_tour_frequency column that comes out of
the model of the same name and turns into a DataFrame that represents the
mandatory tours that were generated</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>persons</strong> : DataFrame</p>
<blockquote>
<div><p>Persons is a DataFrame which has a column call
mandatory_tour_frequency (which came out of the mandatory tour
frequency model) and a column is_worker which indicates the person’s
worker status.  The only valid values of the mandatory_tour_frequency
column to take are “work1”, “work2”, “school1”, “school2” and
“work_and_school”</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote class="last">
<div><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a tour identifier, a person_id
column, a tour_type column which is “work” or “school” and a tour_num
column which is set to 1 or 2 depending whether it is the first or
second mandatory tour made by the person.  The logic for whether the
work or school tour comes first given a “work_and_school” choice
depends on the is_worker column: work tours first for workers, second for non-workers</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">process_non_mandatory_tours</code><span class="sig-paren">(</span><em>non_mandatory_tour_frequency</em>, <em>non_mandatory_tour_frequency_alts</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_non_mandatory_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the non_mandatory_tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the non mandatory tours that were generated</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>non_mandatory_tour_frequency: Series</strong></p>
<blockquote>
<div><p>A series which has person id as the index and the chosen alternative
index as the value</p>
</div></blockquote>
<p><strong>non_mandatory_tour_frequency_alts: DataFrame</strong></p>
<blockquote>
<div><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote class="last">
<div><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.process_tours">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">process_tours</code><span class="sig-paren">(</span><em>tour_frequency</em>, <em>tour_frequency_alts</em>, <em>tour_category</em>, <em>parent_col='person_id'</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.process_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>This method processes the tour_frequency column that comes
out of the model of the same name and turns into a DataFrame that
represents the tours that were generated</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>tour_frequency: Series</strong></p>
<blockquote>
<div><p>A series which has person id as the index and the chosen alternative
index as the value</p>
</div></blockquote>
<p><strong>tour_frequency_alts: DataFrame</strong></p>
<blockquote>
<div><p>A DataFrame which has as a unique index which relates to the values
in the series above typically includes columns which are named for trip
purposes with values which are counts for that trip purpose.  Example
trip purposes include escort, shopping, othmaint, othdiscr, eatout,
social, etc.  A row would be an alternative which might be to take
one shopping trip and zero trips of other purposes, etc.</p>
</div></blockquote>
<p><strong>tour_category</strong> : str</p>
<blockquote>
<div><p>one of ‘mandatory’, ‘non_mandatory’ or ‘subtour’</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote class="last">
<div><p>An example of a tours DataFrame is supplied as a comment in the
source code - it has an index which is a unique tour identifier,
a person_id column, and a tour type column which comes from the
column names of the alternatives DataFrame supplied above.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.tour_frequency.set_tour_index">
<code class="descclassname">activitysim.abm.models.util.tour_frequency.</code><code class="descname">set_tour_index</code><span class="sig-paren">(</span><em>tours</em>, <em>tour_num_col</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.tour_frequency.set_tour_index" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote class="last">
<div><p>Tours dataframe to reindex.
The new index values are stable based on the person_id, tour_type, and tour_num.
The existing index is ignored and replaced.</p>
<p>This gives us a stable (predictable) tour_id
It also simplifies attaching random number streams to tours that are stable
(even across simulations)</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="module-activitysim.abm.models.util.vectorize_tour_scheduling"></span><dl class="function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid">
<code class="descclassname">activitysim.abm.models.util.vectorize_tour_scheduling.</code><code class="descname">get_previous_tour_by_tourid</code><span class="sig-paren">(</span><em>current_tour_window_ids</em>, <em>previous_tour_by_window_id</em>, <em>alts</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.get_previous_tour_by_tourid" title="Permalink to this definition">¶</a></dt>
<dd><p>Matches current tours with attributes of previous tours for the same
person.  See the return value below for more information.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>current_tour_window_ids</strong> : Series</p>
<blockquote>
<div><p>A Series of parent ids for the tours we’re about make the choice for
- index should match the tours DataFrame.</p>
</div></blockquote>
<p><strong>previous_tour_by_window_id</strong> : Series</p>
<blockquote>
<div><p>A Series where the index is the parent (window) id and the value is the index
of the alternatives of the scheduling.</p>
</div></blockquote>
<p><strong>alts</strong> : DataFrame</p>
<blockquote>
<div><p>The alternatives of the scheduling.</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>prev_alts</strong> : DataFrame</p>
<blockquote class="last">
<div><p>A DataFrame with an index matching the CURRENT tours we’re making a
decision for, but with columns from the PREVIOUS tour of the person
associated with each of the CURRENT tours.  Columns listed in PREV_TOUR_COLUMNS
from the alternatives will have “_previous” added as a suffix to keep
differentiated from the current alternatives that will be part of the
interaction.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours">
<code class="descclassname">activitysim.abm.models.util.vectorize_tour_scheduling.</code><code class="descname">schedule_tours</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>alts</em>, <em>spec</em>, <em>constants</em>, <em>timetable</em>, <em>previous_tour</em>, <em>window_id_col</em>, <em>chunk_size</em>, <em>tour_trace_label</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.schedule_tours" title="Permalink to this definition">¶</a></dt>
<dd><p>previous_tour stores values used to add columns that can be used in the spec
which have to do with the previous tours per person.  Every column in the
alternatives table is appended with the suffix “_previous” and made
available.  So if your alternatives table has columns for start and end,
then start_previous and end_previous will be set to the start and end of
the most recent tour for a person.  The first time through,
start_previous and end_previous are undefined, so make sure to protect
with a tour_num &gt;= 2 in the variable computation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote>
<div><p>chunk of tours to schedule with unique window_id_col (person_id or parent_tour_id)</p>
</div></blockquote>
<p><strong>persons_merged</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of persons to be merged with tours containing attributes referenced
by expressions in spec</p>
</div></blockquote>
<p><strong>alts</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of alternatives which represent all possible time slots.
tdd_interaction_dataset function will use timetable to filter them to omit
unavailable alternatives</p>
</div></blockquote>
<p><strong>spec</strong> : DataFrame</p>
<blockquote>
<div><p>The spec which will be passed to interaction_simulate.</p>
</div></blockquote>
<p><strong>constants</strong> : dict</p>
<blockquote>
<div><p>dict of model-specific constants for eval</p>
</div></blockquote>
<p><strong>timetable</strong> : TimeTable</p>
<blockquote>
<div><p>timetable of timewidows for person (or subtour) with rows for tours[window_id_col]</p>
</div></blockquote>
<p><strong>previous_tour: Series</strong></p>
<blockquote>
<div><p>series with value of tdd_alt choice for last previous tour scheduled for</p>
</div></blockquote>
<p><strong>window_id_col</strong> : str</p>
<blockquote>
<div><p>column name from tours that identifies ‘owner’ of this tour
(person_id for non/mandatory tours or parent_tout_id for subtours)</p>
</div></blockquote>
<p><strong>chunk_size</strong></p>
<p class="last"><strong>tour_trace_label</strong></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset">
<code class="descclassname">activitysim.abm.models.util.vectorize_tour_scheduling.</code><code class="descname">tdd_interaction_dataset</code><span class="sig-paren">(</span><em>tours</em>, <em>alts</em>, <em>timetable</em>, <em>choice_column</em>, <em>window_id_col</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.tdd_interaction_dataset" title="Permalink to this definition">¶</a></dt>
<dd><p>interaction_sample_simulate expects
alts index same as choosers (e.g. tour_id)
name of choice column in alts</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>tours</strong> : pandas DataFrame</p>
<blockquote>
<div><p>must have person_id column and index on tour_id</p>
</div></blockquote>
<p><strong>alts</strong> : pandas DataFrame</p>
<blockquote>
<div><p>alts index must be timetable tdd id</p>
</div></blockquote>
<p><strong>timetable</strong> : TimeTable object</p>
<p><strong>choice_column</strong> : str</p>
<blockquote>
<div><p>name of column to store alt index in alt_tdd DataFrame
(since alt_tdd is duplicate index on person_id but unique on person_id,alt_id)</p>
</div></blockquote>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>alt_tdd</strong> : pandas DataFrame</p>
<blockquote class="last">
<div><p>columns: start, end , duration, &lt;choice_column&gt;
index: tour_id</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling">
<code class="descclassname">activitysim.abm.models.util.vectorize_tour_scheduling.</code><code class="descname">vectorize_subtour_scheduling</code><span class="sig-paren">(</span><em>parent_tours</em>, <em>subtours</em>, <em>persons_merged</em>, <em>alts</em>, <em>spec</em>, <em>constants</em>, <em>chunk_size=0</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_subtour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>Like vectorize_tour_scheduling but specifically for atwork subtours</p>
<p>subtours have a few peculiarities necessitating separate treatment:</p>
<p>Timetable has to be initialized to set all timeperiods outside parent tour footprint as
unavailable. So atwork subtour timewindows are limited to the foorprint of the parent work
tour. And parent_tour_id’ column of tours is used instead of parent_id as timetable row_id.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>parent_tours</strong> : DataFrame</p>
<blockquote>
<div><p>parent tours of the subtours (because we need to know the tdd of the parent tour to
assign_subtour_mask of timetable indexed by parent_tour id</p>
</div></blockquote>
<p><strong>subtours</strong> : DataFrame</p>
<blockquote>
<div><p>atwork subtours to schedule</p>
</div></blockquote>
<p><strong>persons_merged</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</div></blockquote>
<p><strong>alts</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</div></blockquote>
<p><strong>spec</strong> : DataFrame</p>
<blockquote>
<div><p>The spec which will be passed to interaction_simulate.
(all subtours share same spec regardless of subtour type)</p>
</div></blockquote>
<p><strong>constants</strong> : dict</p>
<blockquote>
<div><p>dict of model-specific constants for eval    chunk_size</p>
</div></blockquote>
<p><strong>trace_label</strong></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><strong>choices</strong> : Series</p>
<blockquote class="last">
<div><p>A Series of choices where the index is the index of the subtours
DataFrame and the values are the index of the alts DataFrame.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling">
<code class="descclassname">activitysim.abm.models.util.vectorize_tour_scheduling.</code><code class="descname">vectorize_tour_scheduling</code><span class="sig-paren">(</span><em>tours</em>, <em>persons_merged</em>, <em>alts</em>, <em>spec</em>, <em>constants={}</em>, <em>chunk_size=0</em>, <em>trace_label=None</em><span class="sig-paren">)</span><a class="headerlink" href="#activitysim.abm.models.util.vectorize_tour_scheduling.vectorize_tour_scheduling" title="Permalink to this definition">¶</a></dt>
<dd><p>The purpose of this method is fairly straightforward - it takes tours
and schedules them into time slots.  Alternatives should be specified so
as to define those time slots (usually with start and end times).</p>
<p>schedule_tours adds variables that can be used in the spec which have
to do with the previous tours per person.  Every column in the
alternatives table is appended with the suffix “_previous” and made
available.  So if your alternatives table has columns for start and end,
then start_previous and end_previous will be set to the start and end of
the most recent tour for a person.  The first time through,
start_previous and end_previous are undefined, so make sure to protect
with a tour_num &gt;= 2 in the variable computation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first"><strong>tours</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of tours containing tour attributes, as well as a person_id
column to define the nth tour for each person.</p>
</div></blockquote>
<p><strong>persons_merged</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of persons containing attributes referenced by expressions in spec</p>
</div></blockquote>
<p><strong>alts</strong> : DataFrame</p>
<blockquote>
<div><p>DataFrame of alternatives which represent time slots.  Will be passed to
interaction_simulate in batches for each nth tour.</p>
</div></blockquote>
<p><strong>spec</strong> : DataFrame</p>
<blockquote>
<div><p>The spec which will be passed to interaction_simulate.
(or dict of specs keyed on tour_type if tour_types is not None)</p>
</div></blockquote>
<p><strong>constants</strong> : dict</p>
<blockquote>
<div><p>dict of model-specific constants for eval</p>
</div></blockquote>
<p><strong>Returns</strong></p>
<p><strong>——-</strong></p>
<p><strong>choices</strong> : Series</p>
<blockquote class="last">
<div><p>A Series of choices where the index is the index of the tours
DataFrame and the values are the index of the alts DataFrame.</p>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h2>
<p>See activitysim.abm.test and activitysim.abm.models.util.test</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="development.html" class="btn btn-neutral float-right" title="Development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core.html" class="btn btn-neutral" title="Core Components" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright contributing authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.5.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>